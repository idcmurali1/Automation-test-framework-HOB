general:
  tags: C2657139 , unified-p0-ecomm-teflon-e2e, unified-teflon-e2e, p0-fulfillment
  inherit:
    filesRunAll:
      - us-errors-helpers.yaml
  testCaseId: C2657139
  metadata:
    - name: scenarioId
      string: EC130

scenarios:

  - name: Before
    before: true
    endTestOnFailure: true
    flow:

    #Get Environment Values and Setting Platform
      - executeFunction:
          name: unified.us.function.utils.getEnvironmentValueAndSetPlatformInfo

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_POST_TRANSACTION'
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: Main
    flow:

      - log: Start Main

    # Navigate onboarding to home
      - executeFunction:
          name: unified.us.functions.global.onboarding.navigateOnboardingToHome
    
      - executeFunction:
          name: unified.us.functions.authentication.signInInfo
          params:
            - name: android.email
              string: us.data.flow043.email
            - name: android.password
              string: us.data.flow043.password
            - name: ios.email
              string: us.data.C2657139.ios.email
            - name: ios.password
              string: us.data.teflon.password

    # Clear items in cart
      - executeFunction:
          name: unified.us.functions.utils.astro.clearCart

    #Navigate to sign in page
      - executeFunction:
          name: unified.us.functions.home.navigateHomeToSignIn

      - executeFunction:
          name: unified.us.functions.global.authentication.signInAccount

      - executeFunction:
          name: unified.us.functions.global.navigation.accountToHome

    # Set store
      - executeFunction:
          name: unified.us.functions.home.setStore
          params:
            - name: store
              string: 32144
            - name: storeName
              string: San Jose Supercenter 
     
      - executeFunction:
          name: unified.us.functions.gic.changeFulfillment
          params:
            - name: option
              string: Delivery

      - executeFunction:
          name: unified.us.functions.utils.fetchFulcrumAvailableItem
          params:
            - name: itemType
              string: STORE_SCHEDULED_DELIVERY
            - name: store
              string: 32144
            - name: itemFilter
              string: ebtsnap

      - storeIn:
          key: item1
          value: $itemFetched

      #Using Deeplink URL instead of above search
      - executeFunction:
          name: unified.us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://item/$item1

      - executeFunction:
           name: unified.us.functions.item.addItemToCart

      - executeFunction:
          name: unified.us.functions.utils.fetchFulcrumAvailableItem
          params:
            - name: itemType
              string: STORE_SCHEDULED_DELIVERY
            - name: store
              string: 32144

      - storeIn:
          key: item2
          value: $itemFetched

      #Using Deeplink URL instead of above search
      - executeFunction:
          name: unified.us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://item/$item2

      - executeFunction:
           name: unified.us.functions.item.addItemToCart

    # Navigate to cart
      - executeFunction:
          name: unified.us.functions.global.navigation.toCartFromNavBar

      - executeFunction:
          name: unified.us.functions.cart.checkoutWithSlotBooking

    # Enter cutom tip amount $5
      - executeFunction:
          name: unified.us.functions.tippingAndFeedback.driverTipAmountVerification.on.orderReviewPage
          params:
            - name: custTip
              string: true
            - name: custTipAmount
              string: 5

    # Place order
      - executeFunction:
          name: unified.us.functions.checkout.placeOrder
          params:
            - name: ebtExists
              string: true

    # Validate Thank you order page.
      - executeFunction:
          name: unified.us.functions.orderConfirmation.ratings

      - executeFunction:
          name: unified.us.functions.orderConfirmation.getOrderNumber

      - log: ${orderNo}

      - executeFunction:
          name: unified.us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://orders/$orderNo

    # Validate ODP page delivery details
      - executeFunction:
          name: unified.us.functions.orderDetails.scheduledDelivery.verifyDeliveryAddressAndDeliveryInstrutions
     
 #***************************************************************************************************************
      # Astro Update Change the status of the order as Out for Delivery / Email was triggered
 #***************************************************************************************************************

      - executeFunction:
          name: unified.us.functions.utils.astro.getOrderStatus
          params:
            - name: orderNo
              string: ${orderNo}

    # Move to PO Acknowledged
      - executeFunction:
          name: unified.us.functions.utils.astro.setOrderStatus
          params:
            - name: orderNo
              string: ${orderNo}
            - name: orderType
              string: STORE_SCHEDULED_DELIVERY
            - name: status
              string: PO Acknowledged

    # Validate Driver Tip when the Order is in PO Acknowledged status
      - executeFunction:
          name: unified.us.functions.utils.astro.validateDriverTip
          params:
            - name: orderNo
              string: ${orderNo}
            - name: orderType
              string: STORE_SCHEDULED_DELIVERY
            - name: status
              string: PO Acknowledged
            - name: driverTipAmt
              string: ${custTipAmount}
            - name: tipType
              string: PostTip

      - executeFunction:
          name: unified.us.functions.utils.astro.getOrderStatus
          params:
            - name: orderNo
              string: ${orderNo}

      - executeFunction:
          name: unified.us.functions.utils.astro.setOrderStatus
          params:
            - name: orderNo
              string: ${orderNo}
            - name: orderType
              string: STORE_SCHEDULED_DELIVERY
            - name: status
              string: PO Out for Delivery

      - executeFunction:
          name: unified.us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://orders/$orderNo

    # Verify order status in order details page
      - executeFunction:
          name: unified.us.functions.orderDetails.ost.scheduledDelivery.verifyOrderStatus
          params:
            - name: fulfillmentType
              string: Delivery from store
            - name: orderStatus
              string: On the way

    # Verify LOT
      - executeFunction:
          name: unified.us.functions.orderDetails.scheduleDelivery.lot.verifyLot

    # Edit tip to $10
      - executeFunction:
          name: unified.us.functions.orderDetails.editTip.OnTheWayStatus
          params:
            - name: custTipAmount
              string: 10

 #***************************************************************************************************************
      # Astro Update Change the status of the order as Delivered
 #***************************************************************************************************************

      - executeFunction:
          name: unified.us.functions.utils.astro.setOrderStatus
          params:
            - name: orderNo
              string: ${orderNo}
            - name: orderType
              string: STORE_SCHEDULED_DELIVERY
            - name: status
              string: Delivered

#     # Validate Driver Tip when the Order is in Delivered status
#       - executeFunction:
#           name: unified.us.functions.utils.astro.validateDriverTip
#           params:
#             - name: orderNo
#               string: ${orderNo}
#             - name: orderType
#               string: STORE_SCHEDULED_DELIVERY
#             - name: status
#               string: Delivered
#             - name: driverTipAmt
#               string: ${custTipAmount}
#             - name: tipType
#               string: PostTip
              
    # Deeplink into order details page
      - executeFunction:
          name: unified.us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://orders/$orderNo
      
    # Verify order status in order details page
      - executeFunction:
          name: unified.us.functions.orderDetails.ost.scheduledDelivery.verifyOrderStatus
          params:
            - name: fulfillmentType
              string: Delivery from store
            - name: orderStatus
              string: Delivered

      - executeFunction:
          name: unified.us.functions.tippingAndFeedback.editTipFromRateDriverButton

      - executeFunction:
          name: unified.us.functions.tippingAndFeedback.deliveryDetails

      - executeFunction:
          name: unified.us.functions.tippingAndFeedback.fairFeedback
      
      # Verify payment clarity screen to ensure the tip is shown as $5
      - executeFunction:
          name: us.functions.oderDetailPage.paymentClarity
          params: 
            - name: paymentMethod
              string: EBT and CC
            - name: orderStatus
              string: Delivered

      - executeFunction:
           name: unified.us.functions.purchaseOrderPage.VerifyCustomDriverTip
           params:
              - name: custTipAmount
                string: 10

      - storeIn:
          key: testStatus
          value: passed

  - name: After
    after: true
    useTestConfigErrors: false
    flow:
      - executeFunction:
          name: unified.us.functions.utils.afterSteps                                                     