functions:
  
  - name: unified.us.function.services.pharmacy.myPrescriptions
    flow:
      - storeIn:
          key: executionStage
          value: Transactions
      - try:
          flow:
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.popularServices.pharmacy.myPrescriptions
            - click:
                identifier: us.mappings.popularServices.pharmacy.myPrescriptions
          catch:
            flow:
              - log: "Need to scroll down to end of page as myPrescriptions is not visible due to pending orders"
              - scroll:
                  direction: down
                  untilIdentifier: us.mappings.popularServices.pharmacy.myPrescriptions
          # Adding scroll if not visible as the above scoll has a limit of 15 scrolls 
              - executeFunction:
                  name: unified.us.functions.utils.scrollIfNotVisible
                  params:
                    - name: identifier
                      string: us.mappings.popularServices.pharmacy.myPrescriptions
                    - name: direction
                      string: down
              - verifyIdentifier:
                  present:
                    - identifier: us.mappings.popularServices.pharmacy.myPrescriptions
              - click:
                  identifier: us.mappings.popularServices.pharmacy.myPrescriptions
      - sleep:
          duration: 6000

  - name: unified.us.function.services.pharmacy.myPrescriptions.refill
    flow:
      - storeIn:
          key: executionStage
          value: Transactions
      - sleep:
          duration: 7000
      - loop:
         begin: 0
         end: 3
         storeIndex: i
         flow:
           - log: $i
           - if:
                identifier:
                  present: 
                    - identifier: us.mappings.global.onboarding.technicalError
                then:
                  - click:
                      identifier: us.mappings.error.dismissButton
                else:
                  - break: true
      - click:
          identifier: us.mappings.popularServices.pharmacy.prescriptions.sortAndFilter
      - click:
          identifier: us.mappings.popularServices.pharmacy.prescriptions.activePrescriptionRadioButton
      - click:
          identifier: us.mappings.popularServices.pharmacy.prescriptions.filterApplyButton
      - if:
          identifier:
            present: 
              - identifier: us.mappings.popularServices.pharmacy.prescriptions.noPrescriptionFoundText
          then:
            - failTest:
                message: "DATA_FAILURE - No active Prescription was found for the given account"
      - click:
          identifier: us.mappings.popularServices.pharmacy.prescriptions.refill
      - click:
          identifier: us.mappings.popularServices.pharmacy.prescriptions.refill.continue

  - name: unified.us.functions.services.pharmacy.reviewOrderPageValidation
    flow:
      - storeIn:
          key: executionStage
          value: Transactions
      - scroll:
          direction: up
      - if:
          identifier:
            present:
              - identifier: us.mappings.popularServices.pharmacy.reviewOrder.medications
          then:
            - log: "Pharmacy reviewOrder screen displayed correctly"
            - verifyIdentifier:
                timeout: 15000
                present:
                  - identifier: us.mappings.popularServices.pharmacy.reviewOrder.estimatedTotal
                  - identifier: us.mappings.popularServices.pharmacy.reviewOrder.payment
                  - identifier: us.mappings.popularServices.pharmacy.reviewOrder.pharmacyPickup
                  - identifier: us.mappings.popularServices.pharmacy.reviewOrder.storeName
                  - identifier: us.mappings.popularServices.pharmacy.reviewOrder.changeDeliveryMethod
                  - identifier: us.mappings.popularServices.pharmacy.reviewOrder.address
                  - identifier: us.mappings.popularServices.pharmacy.reviewOrder.placeOrderBtn
            - scroll:
                direction: down
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.popularServices.pharmacy.reviewOrder.editPayment
                 
          else:
            - failTest:
                message: "ENV_FAILURE - ${env} - Review order page for pharmacy not displayed as expected"
      - if:
          identifier:
            present:
              - identifier: us.mappings.popularServices.pharmacy.reviewOrder.signature
          then:
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.popularServices.pharmacy.reviewOrder.signature
                  - identifier: us.mappings.popularServices.pharmacy.reviewOrder.signatureDetails

  - name: unified.us.function.services.pharmacy.signatureCheckAndPlaceOrder
    flow:
      - storeIn:
          key: executionStage
          value: Transactions
      - if:
          identifier:
            present:
              - identifier: us.mappings.popularServices.pharmacy.reviewOrder.signatureCheck
          then:
            - scroll:
                direction: down
                untilIdentifier: us.mappings.popularServices.pharmacy.reviewOrder.signatureCheck
            - click:
                identifier: us.mappings.popularServices.pharmacy.reviewOrder.signatureCheck
      - click:
          identifier: us.mappings.popularServices.pharmacy.reviewOrder.placeOrderBtn
      - sleep:
          duration: 3000
      - if:
          identifier:
            present:
              - identifier: us.mappings.popularServices.pharmacy.prescriptionExpirayMessage
          then:
            - failTest:
                message: "DATA_FAILURE - The Prescription has Expired Cannot filled online"
      - sleep:
          duration: 2000      
      - if:
          identifier:
            present:
              - identifier: us.mappings.popularServices.pharmacy.morePrescriptionNeedsToBeFilledMessage
          then:
            - failTest:
                message: "DATA_FAILURE - Other Prescriptions also need to fill to complete order "
      - verifyIdentifier:
          timeout: 20000
          present:
            - identifier: us.mappings.popularServices.pharmacy.orderConfirmation.confirmation

  - name: unified.us.functions.services.pharmacy.orderConfirmationPageValidation
    flow:
      - storeIn:
          key: executionStage
          value: Transactions
      - verifyIdentifier:
          present:
            - identifier: us.mappings.popularServices.pharmacy.orderConfirmation.pharmacyOrderconfirmationTxt
            - identifier: us.mappings.popularServices.pharmacy.orderConfirmation.estimatedTotal
            - identifier: us.mappings.popularServices.pharmacy.orderConfirmation.estimatedTotalAmount
            - identifier: us.mappings.popularServices.pharmacy.orderConfirmation.payment
            - identifier: us.mappings.popularServices.pharmacy.orderConfirmation.pharmacyPickup
      - if:
          identifier:
            notPresent:
              - identifier: us.mappings.popularServices.pharmacy.orderConfirmation.giveFeedback
          then:
            - scroll:
                direction: down
                position: center
                untilIdentifier: us.mappings.popularServices.pharmacy.orderConfirmation.giveFeedback
          else:
            - scroll:
                direction: down
                position: center
                untilIdentifier: us.mappings.popularServices.pharmacy.orderConfirmation.giveFeedback
      - verifyIdentifier:
          present:
            - identifier: us.mappings.popularServices.pharmacy.orderConfirmation.googleMap
            - identifier: us.mappings.popularServices.pharmacy.orderConfirmation.pharmacyStoreNumber
            - identifier: us.mappings.popularServices.pharmacy.orderConfirmation.pharmacyOpenHours
            - identifier: us.mappings.popularServices.pharmacy.orderConfirmation.done
      - click:
          identifier: us.mappings.popularServices.pharmacy.orderConfirmation.done
      - sleep:
          duration: 5000
      - if:
          identifier:
            present:
              - identifier: us.mappings.popularServices.pharmacy.orderConfirmation.close
          then:
            - click:
                identifier: us.mappings.popularServices.pharmacy.orderConfirmation.close

  - name: unified.us.function.services.pharmacy.scanToRefill
    flow:
      - sleep:
          duration: 5000
      - if:
          identifier: 
            present:
              - identifier: us.mappings.popularServices.pharmacy.prescriptionAvailable.popup.title
          then:
            - click:
                identifier: us.mappings.popularServices.pharmacy.prescriptionAvailable.popup.closeBtn
      - sleep:
          duration: 5000
      - try:
          flow:
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.popularServices.pharmacy.scanToRefill
            - click:
                identifier: us.mappings.popularServices.pharmacy.scanToRefill
          catch:
            flow:
              - log: "Need to scroll down to end of page as scanToRefill is not visible due to pending orders"
              - scroll:
                  direction: down
                  untilIdentifier: us.mappings.popularServices.pharmacy.scanToRefill
          # Adding scroll if not visible as the above scoll has a limit of 15 scrolls 
              - executeFunction:
                  name: unified.us.functions.utils.scrollIfNotVisible
                  params:
                    - name: identifier
                      string: us.mappings.popularServices.pharmacy.scanToRefill
                    - name: direction
                      string: down
              - click:
                  identifier: us.mappings.popularServices.pharmacy.scanToRefill
      - sleep:
          duration: 3000
      - if:
          identifier: 
            present:
              - identifier: us.mappings.popularServices.pharmacy.allowCameraAccess
          then:
            - click:
                identifier: us.mappings.popularServices.pharmacy.allowCameraAccess
      - sleep:
          duration: 6000
      - click:
          identifier: us.mappings.popularServices.pharmacy.enterManually
      - sleep:
          duration: 7000
      
  - name: unified.us.functions.services.enterPrescriptionDetails
    flow:
      - sleep:
          duration: 3000
      - verifyIdentifier:
          present:
            - identifier: us.mappings.popularServices.pharmacy.prescriptionNumber
      - enterText:
          identifier: us.mappings.popularServices.pharmacy.prescriptionNumber
          string: us.data.scanToRefill.prescriptionNumber
          clearField: true
      - click:
          identifier: us.mappings.popularServices.pharmacy.storeNumber
      - enterText:
          identifier: us.mappings.popularServices.pharmacy.storeNumber
          string: us.data.scanToRefill.storeNumber
          clearField: true
          pressEnter: true
      - scroll: 
          direction: down
      - click:
          identifier: us.mappings.popularServices.pharmacy.dateOfBirth
      - enterText:
          identifier: us.mappings.popularServices.pharmacy.dateOfBirth
          string: us.data.scanToRefill.dateofBirth
          clearField: true
      - sleep:
          duration: 6000
      - verifyIdentifier:
          present:
            - identifier: us.mappings.popularServices.pharmacy.continueBtn
      - click:
          identifier: us.mappings.popularServices.pharmacy.continueBtn
      - sleep:
          duration: 3000
      - verifyIdentifier:
          present:
            - identifier: us.mappings.popularServices.pharmacy.rxName
            - identifier: us.mappings.popularServices.pharmacy.rxNumber
      - click:
          identifier: us.mappings.popularServices.pharmacy.continueButton

  - name: unified.us.function.services.pharmacy.refillPrescriptions
    flow:
      - sleep:
          duration: 3000
      - verifyIdentifier:
          present:
            - identifier: us.mappings.popularServices.pharmacy.reviewRefill
            - identifier: us.mappings.popularServices.pharmacy.estimatedReadyTime
            - identifier: us.mappings.popularServices.pharmacy.prescriptionName
            - identifier: us.mappings.popularServices.pharmacy.estimatedTotal
      - click:
          identifier: us.mappings.popularServices.pharmacy.requestRefill
      - sleep:
          duration: 3000
      - verifyIdentifier:
          present: 
            - identifier: us.mappings.popularServices.pharmacy.orderConfirmatiion
            - identifier: us.mappings.popularServices.pharmacy.estimatedReadyTime
      - sleep:
          duration: 3000
      - executeFunction:
          name: unified.us.functions.utils.scrollIfNotVisible
          params:
            - name: identifier
              string: us.mappings.popularServices.pharmacy.backToPharmacy
            - name: direction
              string: down
      - verifyIdentifier:
          present: 
            - identifier: us.mappings.popularServices.pharmacy.backToPharmacy

  - name: unified.us.functions.services.pharmacy.pharmacyPageTopValidation
    flow:
      - if:
          identifier:
            present:
              - identifier: us.mappings.popularServices.pharmacy.pharmacyIcon
          then:
            - log: "Pharmacy page displayed correctly"
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.popularServices.pharmacy.visionCenterIcon
                  - identifier: us.mappings.popularServices.pharmacy.insuranceServicesIcon
          else:
            - failTest:
                message: "ENV_FAILURE - ${env} - Pharmacy page not displayed as expected"

  - name: unified.us.function.services.pharmacy.myPrescriptions.details
    flow:
      - verifyIdentifier:
          present:
            - identifier: us.mappings.popularServices.pharmacy.prescriptions.details
      - click:
          identifier: us.mappings.popularServices.pharmacy.prescriptions.details
      - verifyIdentifier:
          present:
            - identifier: us.mappings.popularServices.pharmacy.prescriptions.details.prescriptionsText
            - identifier: us.mappings.popularServices.pharmacy.prescriptions.details.prescribedByText
            - identifier: us.mappings.popularServices.pharmacy.prescriptions.details.patientText
            - identifier: us.mappings.popularServices.pharmacy.prescriptions.details.prescribedOnText
            - identifier: us.mappings.popularServices.pharmacy.prescriptions.details.fillsLeftText
            - identifier: us.mappings.popularServices.pharmacy.prescriptions.details.expirationText
            - identifier: us.mappings.popularServices.pharmacy.prescriptions.details.pharmacyText
      - executeFunction:
          name: unified.us.functions.utils.scrollIfNotVisible
          params:
            - name: identifier
              string: us.mappings.popularServices.pharmacy.prescriptions.details.pharmacyPhoneText
            - name: direction
              string: down
            - name: scrollPosition
              string: center
      - verifyIdentifier:
          present:
            - identifier: us.mappings.popularServices.pharmacy.prescriptions.details.pharmacyPhoneText  

            