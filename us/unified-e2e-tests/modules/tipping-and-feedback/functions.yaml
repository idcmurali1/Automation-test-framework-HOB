functions:

  - name: unified.us.functions.tippingAndFeedback.driverTipAmountVerification.on.orderReviewPage
    flow:
      - executeFunction:
          name: unified.us.functions.checkout.reviewOrder.scrollToTopOfReviewOrder
      - if:
          condition: ${lessThan35Dollars}
          then:
            - log: Delivery Tip amount verification for Orders lessThan 35$, is in-Progress!!!
            - if:
                identifier:
                  notPresent:
                    - identifier: us.mappings.tipping.driverTipAmount.dollar2
                then:
                  - log: The Driver Tip Section is not Visible, Scrolling Down!
                  - executeFunction:
                      name: unified.us.functions.utils.scrollIfNotVisible
                      params:
                        - name: identifier
                          string: us.mappings.tipping.driverTipAmount.dollar2
                        - name: direction
                          string: down
                        - name: scrollPosition
                          string: center
                  - log: The Driver Tip Section is NOW Visible!
                else:
                  - log: The Driver Tip Section is Visible, Already!
                  - scroll:
                      direction: down
                      wait: 1000
                      position: center
                      scrollLimit: 1
            # Validate that $ tips of $2, $4, $6 and Custom Tip are displayed
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.tipping.driverTipAmount.dollar2
                  - identifier: us.mappings.tipping.driverTipAmount.dollar4
                  - identifier: us.mappings.tipping.driverTipAmount.dollar6 
                  - identifier: us.mappings.tipping.driverTipAmount.customTip.button
            - if:
                condition: ${platform} == 'Android'
                then:  
                  - verifyIdentifier:
                      text:
                        - identifier: us.mappings.tipping.driverTipPercentage.selectedTipAmount
                          contains: $4  
                  - log: "First check with $4 selected"
                else:
                  - verifyIdentifier:
                      value:
                        - identifier: us.mappings.tipping.driverTipPercentage.selectedTipAmount
                          contains: 4
            - click:           
                identifier: us.mappings.tipping.driverTipAmount.dollar2  
                wait: 2000   
            - sleep:
               duration: 5000
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.tipping.driverTipPercentage.container
            - if:
                condition: ${platform} == 'Android'
                then:  
                  - verifyIdentifier:
                      text:
                        - identifier: us.mappings.tipping.driverTipPercentage.selectedTipAmount
                          contains: $2 
                  - log: "Checking with $2 selected"
                else:
                  - verifyIdentifier:
                      value:
                        - identifier: us.mappings.tipping.driverTipPercentage.selectedTipAmount
                          contains: 2
            - sleep:
                duration: 3000
            - click:
                identifier: us.mappings.tipping.driverTipAmount.dollar4
                wait: 1500
            - sleep:
               duration: 4000
            - if:
                condition: ${platform} == 'Android'
                then:  
                  - verifyIdentifier:
                      text:
                        - identifier: us.mappings.tipping.driverTipPercentage.selectedTipAmount
                          contains: $4    
                  - log: "Again check with $4 selected"
                else:
                  - verifyIdentifier:
                      value:
                        - identifier: us.mappings.tipping.driverTipPercentage.selectedTipAmount
                          contains: 4
            - click:
                identifier: us.mappings.tipping.driverTipAmount.dollar6
                wait: 1500
            - sleep:
               duration: 5000
            - if:
                condition: ${platform} == 'Android'
                then:  
                  - verifyIdentifier:
                      text:
                        - identifier: us.mappings.tipping.driverTipPercentage.selectedTipAmount
                          contains: $6    
                  - log: "Checking with $6 selected"
                else:
                  - verifyIdentifier:
                      value:
                        - identifier: us.mappings.tipping.driverTipPercentage.selectedTipAmount
                          contains: 6
            - log: Inside the default flow, where the driver tip amount is selected with the defaults available !!!
            - click:
                identifier: us.mappings.tipping.driverTipAmount.dollar4
                wait: 1500
            - sleep:
               duration: 5000
            - if:
                condition: ${platform} == 'Android'
                then:  
                  - verifyIdentifier:
                      text:
                        - identifier: us.mappings.tipping.driverTipPercentage.selectedTipAmount
                          contains: $4    
                else:
                  - verifyIdentifier:
                      value:
                        - identifier: us.mappings.tipping.driverTipPercentage.selectedTipAmount
                          contains: 4
            - if:
                identifier:
                  notPresent:
                    - identifier: us.mappings.tipping.driverTipSelected.underSubTotal
                then:
                  - log: The Driver Tip Section under subTotal is not Visible, Scrolling Down!
                  - executeFunction:
                      name: unified.us.functions.utils.scrollIfNotVisible
                      params:
                        - name: identifier
                          string: us.mappings.tipping.driverTipSelected.underSubTotal
                        - name: direction
                          string: down
                        - name: scrollPosition
                          string: center
                  - log: The Driver Tip Section under subTotal is NOW Visible!
                else:
                  - log: The Driver Tip Section under subTotal is Visible, Already!
            - if:
                condition: ${platform} == 'Android'
                then:  
                  - verifyIdentifier:
                      text:
                        - identifier: us.mappings.tipping.driverTipSelected.underSubTotal
                          contains: $4    
                else:
                  - verifyIdentifier:
                      value:
                        - identifier: us.mappings.tipping.driverTipPercentage.selectedTipAmount
                          contains: 4             
      - if:
          condition: ${custTip} == true
          then:
            - executeFunction:
                name: unified.us.functions.checkout.reviewOrder.scrollToTopOfReviewOrder
            - if:
                condition: ${platform} == 'Android'
                then:
                  - scroll:
                      direction: down
                      untilIdentifier: us.mappings.reviewOrder.storeDeliveryTip.Custom
                  - click:
                      identifier: us.mappings.reviewOrder.storeDeliveryTip.Custom
                else:
                  - scroll:
                      direction: down
                      untilIdentifier: us.mappings.reviewOrder.storeDeliveryTip.yourTipText
                  - click:
                      identifier: us.mappings.reviewOrder.storeDeliveryTip.yourTipText
                      wait: 1500
            - enterText:
                identifier: us.mappings.reviewOrder.storeDeliveryTip.yourTipText
                string: ${custTipAmount}
                pressEnter: true
            - log: "Entered custom tip ${custTipAmount}"
            - if:
                condition: ${platform} == 'iOS'
                then:        
                  - click:
                      identifier: us.mappings.default.keyboardDoneButton
                      wait: 1500
            - if:
                condition: ${platform} == 'Android'
                then:  
                  - verifyIdentifier:
                      text:
                        - identifier: us.mappings.tipping.driverTipPercentage.selectedTipAmount
                          contains: ${custTipAmount}    
                else:
                  - verifyIdentifier:
                      value:
                        - identifier: us.mappings.tipping.driverTipPercentage.selectedTipAmount
                          contains: ${custTipAmount}   
            - executeFunction:
                name: unified.us.functions.utils.scrollIfNotVisible
                params:
                  - name: identifier
                    string: us.mappings.reviewOrder.taxLabel
                  - name: direction
                    string: down
                  - name: scrollPosition
                    string: center
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.reviewOrder.subTotalEffectiveAmount
                  - identifier: us.mappings.reviewOrder.taxLabel
            - executeFunction:
                name: unified.us.functions.utils.scrollIfNotVisible
                params:
                  - name: identifier
                    string: us.mappings.reviewOrder.estimateTotalAmount
                  - name: direction
                    string: down
            - verifyIdentifier:
                present:
                 - identifier: us.mappings.reviewOrder.estimateTotalAmount
                 - identifier: us.mappings.reviewOrder.storeDeliveryTip.amount
            - sleep:
                duration: 5000
            - if:
                condition: ${platform} == 'Android'
                then:  
                  - verifyIdentifier:
                      text:
                        - identifier: us.mappings.reviewOrder.storeDeliveryTip.amount
                          contains: ${custTipAmount}    
                else:
                  - verifyIdentifier:
                      value:
                        - identifier: us.mappings.reviewOrder.storeDeliveryTip.amount
                          contains: ${custTipAmount}   
            - log : Diver tip $${custTipAmount} is correctly displayed

  - name: unified.us.functions.tippingAndFeedback.editTipFromRateDriverButton
    flow:
      - if:
          identifier:
            present:
              - identifier: us.mappings.orderDetails.addTipbutton
          then:
            - log: "Add tip button is present"
          else:
            - failTest:
                message: "ENV_FAILURE - ${env} - Add tip button should be present but is not"

  - name: unified.us.functions.tippingAndFeedback.deliveryDetails
    flow: 
      - verifyIdentifier:
          present:
            - identifier: us.mappings.orderdetails.viewDeliveryDetailsButton
      - verifyIdentifier:
          present:
            - identifier: us.mappings.home.ost.RateDriverButton
      - click:
          identifier: us.mappings.home.ost.RateDriverButton
      - verifyIdentifier:
          present:
            - identifier: us.mappings.tipping.feedbackPoUpHeader
            - identifier: us.mappings.tipping.confirmButton

  - name: unified.us.functions.tippingAndFeedback.fairFeedback
    flow:
      - verifyIdentifier:
          present:
            - identifier: us.mappings.tipping.feedbackStar
      - click:
          identifier: us.mappings.tipping.feedbackStar
          coordinates: 50%,50%
      - verifyIdentifier:
          present:
            - identifier: us.mappings.feedback.threestarRatingSelected
      - sleep:
          duration: 3000
      - click:
          identifier: us.mappings.tipping.reasonDriverLate
      - sleep:
          duration: 3000
      - executeFunction:
          name: unified.us.functions.utils.scrollIfNotVisible
          params:
            - name: identifier
              string: us.mappings.tipping.confirmButton
            - name: direction
              string: down      
      - click:
          identifier: us.mappings.tipping.confirmButton

  - name: unified.us.functions.utils.checkGiftDSCardBalanceAndBalanceifLessThanFive
    flow:
      - executeFunction:
          name: unified.us.functions.utils.checkDSCardBalance
      - if:
          condition: ${gcBalance} <= 1
          then:
            - log: "The giftCard's current balance is: '${gcBalance}'; Proceeding with load balance to GC(as the balance is less than $1.)"
            - executeFunction:
                name: unified.us.functions.utils.addAmountToDsCard
          else:
            - log: "The giftCard's current balance is: '${gcBalance}'; Skipping load balance to GC(as the balance is greater than $1.)"

  - name: unified.us.functions.tippingAndFeedback.verification.for.inProgressODP
    flow:
      - storeIn:
          key: executionStage
          value: Post-transactions
      - log: The user is navigated to Order Detail page!
      - sleep:
          duration: 1000
      - if:
          identifier:
            notPresent:
              - identifier: us.mappings.tipping.driverTip.odpDriverTipValue
          then:
            - log: The Driver Tip Section is not Visible, Scrolling Down!
            - executeFunction:
                name: us.functions.utils.scrollIfNotVisible
                params:
                  - name: identifier
                    string: us.mappings.tipping.driverTip.odpDriverTipValue
                  - name: direction
                    string: down
                  - name: scrollPosition
                    string: center
            - log: The Driver Tip Section is NOW Visible on Order details page!
          else:
            - log: The Driver Tip Section is Visible on Order details page, Already!
      - verifyIdentifier:
          value:
            - identifier: us.mappings.tipping.driverTip.odpDriverTipValue
              contains: ${tipAmount}
      - log: The Driver tip amount selected is matching on the ODP !!!!
      - if:
          condition: ${VerifyCheckoutTotalAmount} == true
          then:
            - scroll:
                direction: down
                untilIdentifier: us.mappings.tipping.TotalLabel
            - log: The ODP Total Section is NOW Visible!
            - getString:
                identifier: us.mappings.tipping.driverTip.odpTotalValue
                attribute: value
                storeIn: odpTotalValue
            - log: The total amount on ODP is ${odpTotalValue}
            - if:
                condition: ${checkoutTotalValue} ==${odpTotalValue}
                then:
                  - log: The Amount on CXO and ODP is MATCHING !!!
                else:
                  - log: The Amount on CXO and ODP is NOT MATCHING !!!
      - if:
          condition: ${verifyCheckoutTempHoldTotalAmount} == true
          then:
            - if:
                identifier:
                  notPresent:
                    - identifier: us.mappings.tipping.driverTip.odpTotalValue
                then:
                  - log: The ODP Temp Hold total Section is not Visible, Scrolling Down!
                  - executeFunction:
                      name: us.functions.utils.scrollIfNotVisible
                      params:
                        - name: identifier
                          string: us.mappings.tipping.driverTip.odpTotalValue
                        - name: direction
                          string: down
                        - name: scrollPosition
                          string: center
                  - log: The ODP Temp Hold Total Section is NOW Visible!
            # - getString:
            #     identifier: us.mappings.tipping.driverTip.odpTempHoldValue
            #     attribute: value
            #     storeIn: odpTempHoldTotalValue
            - verifyIdentifier:
                value:
                  - identifier: us.mappings.tipping.driverTip.odpTempHoldValue 
                    contains: ${checkoutTotalTempHoldValue} 

            - log: The Temp Hold Amount on CXO and ODP is MATCHING !!!
            # - if:
            #     condition: ${checkoutTotalTempHoldValue} ==${odpTempHoldTotalValue}
            #     then:
            #       - log: The Temp Hold Amount on CXO and ODP is MATCHING !!!
            #     else:
            #       - log: The Temp Hold Amount on CXO and ODP is NOT MATCHING !!!

  # Tip amount verification on ODP(After the order Status is set to Delivered
  - name: unified.us.functions.tippingAndFeedback.verification.for.driverTip.onODP
    flow:
      - storeIn:
          key: executionStage
          value: Post-transactions
      - log: The user is navigated to Order Detail page!
      - sleep:
          duration: 1000
      - if:
          condition: ${platform} == 'iOS'
          then:
            - if:
                identifier:
                  notPresent:
                    - identifier: us.mappings.tipping.driverTip.odpDriverTipValue
                then:
                  - log: The Driver Tip Section is not Visible, Scrolling Down!
                  - scroll:
                      direction: down
                      untilIdentifier: us.mappings.tipping.driverTip.odpDriverTipValue
                  - log: The Driver Tip Section is NOW Visible on Order details page!
                else:
                  - log: The Driver Tip Section is Visible on Order details page, Already!
            - verifyIdentifier:
                value:
                  - identifier: us.mappings.tipping.driverTip.odpDriverTipValue
                    contains: ${tipAmount}
            - log: The Driver tip amount selected is matching on the ODP !!!!
      - if:
          condition: ${platform} == 'Android'
          then:
            - if:
                identifier:
                  notPresent:
                    - identifier: us.mappings.tipping.driverTip.amount
                then:
                  - log: The Driver Tip Section is not Visible, Scrolling Down!
                  - scroll:
                      direction: down
                      untilIdentifier: us.mappings.tipping.driverTip.amount
                  - log: The Driver Tip Section is NOW Visible on Order details page!
                else:
                  - log: The Driver Tip Section is Visible on Order details page, Already!
            - if:
                condition: ${tipInPercentage} != null
                then:
                  - verifyIdentifier:
                      text:
                        - identifier: us.mappings.tipping.driverTip.odpDriverTipValue
                          contains: ${percentageAmount}
                else:
                  - verifyIdentifier:
                      text:
                        - identifier: us.mappings.tipping.driverTip.odpDriverTipValue
                          contains: ${tipAmount}
            - log: The Driver tip amount selected is matching on the ODP !!!!


  # Function to check the GiftCard(GC) Balance and if it is equal to 0, then the amount will be added to the GC.
  - name: unified.us.functions.checkGiftCardBalanceAndLoadIfZero
    flow:
      - executeFunction:
          name: unified.us.functions.utils.checkGiftCardBalance 
      - if:
          condition: ${gcBalance} == 0
          then:
            - log: "The giftCard's current balance is:  '${gcBalance}'; Proceeding with load balance to GC(as the balance is ZERO.)"
            - executeFunction:
                name: unified.us.functions.utils.addAmountToGiftCard
          else:
            - log: "The giftCard's current balance is:  '${gcBalance}'; Skipping load balance to GC(as the balance is not ZERO.)"


  - name: unified.us.functions.customDriverTip.amount
    flow:
      - sleep:
          duration: 2000
      - executeFunction:
          name: unified.us.functions.utils.scrollIfNotVisible
          params:
            - name: identifier
              string: us.mappings.tipping.custom.driverTipping
            - name: direction
              string: down
            - name: scrollPosition
              string: center
      - click:
          identifier: us.mappings.tipping.custom.driverTipping
      - enterText:
          identifier: us.mappings.tipping.custom.driverTipping.amountField
          string: ${tipAmount}
          pressEnter: true
      - if:
          identifier:
            present:
              - identifier: us.mappings.tipping.custom.numpad.doneButton
          then:
            - click:
                identifier: us.mappings.tipping.custom.numpad.doneButton
      # - click:
      #     identifier: us.mappings.default.keyboardDoneButton
      - log: "Custom driver tip $${tipAmount} is added"          