functions:
  - name: unified.us.functions.utils.scrollInit
    flow:
      - if:
          condition: ${scrollLimit} == null
          then:
            - storeIn:
                key: scrollLimit
                value: 7
      - log: Scroll limit set to - ${scrollLimit}
      - if:
          condition: ${platform} == 'iOS'        
          then:
            - if:
                identifier:
                  timeout: 1000
                  visible:
                    - identifier: ${identifier}
                then:
                  - log: Element already visible, scrolling is skipped
                  - storeIn:
                      key: scrollNeeded
                      value: false
                else:
                  - storeIn:
                      key: scrollNeeded
                      value: true
          else:
            - if:
                identifier:
                  timeout: 1000
                  present:
                    - identifier: ${identifier}
                then:
                  - log: Required identifier already displayed
                  - storeIn:
                      key: scrollNeeded
                      value: false
                else:
                  - storeIn:
                      key: scrollNeeded
                      value: true

  - name: unified.us.functions.utils.scrollIfNotVisible
    flow:
      - if:
          condition: ${scrollLimit} == null
          then:
            - storeIn:
                key: scrollLimit
                value: 7
      - log: Scroll limit set to - ${scrollLimit}
      - if:
          condition: ${platform} == 'iOS'
          then:
            - if:
                identifier:
                  timeout: 1000
                  visible:
                    - identifier: ${identifier}
                      value: 'true'
                then:
                  - log: Element already visible, scrolling is skipped
                else:
                  - storeIn:
                      key: scrollNeeded
                      value: true
          else:
            - if:
                identifier:
                  present:
                    - identifier: ${identifier}
                then:
                  - log: Required identifier already displayed
                else:
                  - storeIn:
                      key: scrollNeeded
                      value: true
      - if:
          condition: ${scrollNeeded}
          then:
            - if:
                condition: ${scrollPosition} == null
                then:
                  - if:
                      condition: ${identifierScope} == null
                      then:
                        - scroll:
                            direction: ${direction}
                            untilIdentifier: ${identifier}
                            scrollLimit: ${scrollLimit}
                      else:
                        - scroll:
                            direction: ${direction}
                            untilIdentifier: ${identifier}
                            withinIdentifier: ${identifierScope}
                            scrollLimit: ${scrollLimit}
                else:
                  - if:
                      condition: ${identifierScope} == null
                      then:
                        - scroll:
                            direction: ${direction}
                            untilIdentifier: ${identifier}
                            position: ${scrollPosition}
                            scrollLimit: ${scrollLimit}
                      else:
                        - scroll:
                            direction: ${direction}
                            untilIdentifier: ${identifier}
                            withinIdentifier: ${identifierScope}
                            position: ${scrollPosition}
                            scrollLimit: ${scrollLimit}
      - log: Resetting scrollPosition variable to default
      - storeIn:
          key: scrollPosition
          value: "null"
      - storeIn:
          key: identifierScope
          value: "null"
      - storeIn:
          key: scrollLimit
          value: "null"
      - storeIn:
          key: scrollNeeded
          value: false

  - name: unified.us.functions.utils.dragIfNotVisible
    flow:
      - executeFunction:
          name: unified.us.functions.utils.scrollInit
      - loop:
          begin: 0
          end: ${scrollLimit}
          storeIndex: scrollIndex
          mode: increment
          flow:
            - executeFunction:
                name: unified.us.functions.utils.scrollInit
            - if:
                condition: ${scrollNeeded}
                then:
                  - if:
                      condition: ${direction} == 'down'
                      then:
                        - drag:
                            from:
                              x: 50%
                              y: 60%
                            to:
                              x: 50%
                              y: 40%
                      else:
                        - drag:
                            from:
                              x: 50%
                              y: 40%
                            to:
                              x: 50%
                              y: 60%
                else:
                  - break: true
      - storeIn:
          key: scrollLimit
          value: "null"
      - storeIn:
          key: scrollNeeded
          value: false


  - name: unified.us.functions.utils.getStoreInAttribute
    flow:
      - if:
          condition: ${platform} == 'Android'
          then:    
            - storeIn:
                key: attribute
                value: text
      - if:
          condition: ${platform} == 'iOS'
          then:
            - storeIn:
                key: attribute
                value: label

  - name: unified.us.functions.utils.getFulfillmentTextsToCompare
    flow:
      - if:
          condition: ${altFulfillmentText} == null
          then:
            - if:
                condition: ${fulfillmentText} == 'Shipping'
                then:
                  - if:
                      condition: ${newGIC}
                      then:
                        - storeIn:
                            key: fulfillmentText
                            value: Delivery
                        - storeIn:
                            key: altFulfillmentText
                            value: delivery
                      else:
                        - storeIn:
                            key: altFulfillmentText
                            value: shipping
                else:
                  - if:
                      condition: ${fulfillmentText} == 'Pickup'
                      then:
                        - storeIn:
                            key: altFulfillmentText
                            value: pickup
                      else:
                        - if:
                            condition: ${fulfillmentText} == 'Delivery' || ${fulfillmentText} == 'Delivery from store'
                            then:
                              - storeIn:
                                  key: altFulfillmentText
                                  value: delivery
                            else:
                              - if:
                                  condition: ${fulfillmentText} == 'Drone delivery'
                                  then:
                                    - storeIn:
                                        key: altFulfillmentText
                                        value: Drone
                                  else:
                                    - storeIn:
                                        key: altFulfillmentText
                                        value: ${fulfillmentText}

  - name: unified.us.functions.utils.getFulfillmentTextsForIntentSelection
    flow:
      - if:
          condition: ${fulfillmentType} == 'shipping' || ${fulfillmentType} == 'Shipping'
          then:
            - storeIn:
                key: fulfillmentType
                value: ship
            - storeIn:
                key: altFulfillmentType
                value: Ship
          else:
            - if:
                condition: ${fulfillmentType} == 'pickup' || ${fulfillmentType} == 'Pickup'
                then:
                  - storeIn:
                      key: fulfillmentType
                      value: pickup
                  - storeIn:
                      key: altFulfillmentType
                      value: Pickup
                else:
                  - if:
                      condition: ${fulfillmentType} == 'delivery' || ${fulfillmentType} == 'Delivery'
                      then:
                        - storeIn:
                            key: fulfillmentType
                            value: delivery
                        - storeIn:
                            key: altFulfillmentType
                            value: Delivery
                      else:
                        - if:
                            condition: ${fulfillmentType} == 'Retiro' || ${fulfillmentType} == 'retiro'
                            then:
                              - storeIn:
                                  key: fulfillmentType
                                  value: Retiro
                              - storeIn:
                                  key: altFulfillmentType
                                  value: retiro

                            else:
                              - if:
                                  condition: ${fulfillmentType} == 'Entrega' || ${fulfillmentType} == 'entrega'
                                  then:
                                    - storeIn:
                                        key: fulfillmentType
                                        value: Entrega
                                    - storeIn:
                                        key: altFulfillmentType
                                        value: entrega

                                  else:
                                    - if:
                                        condition: ${fulfillmentType} == 'Envío' || ${fulfillmentType} == 'envío'
                                        then:
                                          - storeIn:
                                              key: fulfillmentType
                                              value: Envío
                                          - storeIn:
                                              key: altFulfillmentType
                                              value: envío

  - name: unified.us.functions.utils.closeErrorAlertIfExists
    flow:
      - if:
          condition: ${platform} == 'iOS'
          then:
            - if:
                identifier:
                  present:
                    - identifier: Okay
                then:
                  - click:
                      identifier: Okay

  - name: unified.us.functions.utils.getR2Array
    flow:
      - executeNode:
          file: us/e2e-tests/helpers/generateR2Array.js
          args:
            - value: ${data}
          getResponse:
            storeIn: r2Array

  - name: unified.us.functions.utils.jsonDataParse
    flow:
      - executeNode:
          file: us/e2e-tests/helpers/jsonParser.js
          args:
            - value: ${data}
            - value: ${key}
          getResponse:
            storeIn: keyValue            

  - name: unified.us.function.utils.getEnvironmentValueAndSetPlatformInfo
    flow:
      #Get Environment Values
      - executeFunction:
          name: us.function.utils.getEnvironmentValue

      # Set Platfrom Values
      - executeFunction:
          name: functions.utils.setPlatformInfo            

  - name: unified.us.functions.utils.astro.createOrder
    flow:
      - log: Create order
      - loop:
          begin: 0
          end: 5
          storeIndex: retryCount
          mode: increment
          flow:
            # ${errorCode} used to determine payload format issue
            # ${orderCreationStatus} used to determine order creation success/failure with valid payload
            - storeIn:
                key: errorCode
                value: 'null'
            - storeIn:
                key: orderCreationStatus
                value: 'null'
            - callAPI:
                url: http://astro.walmart.com/api/v2/teflon/order
                requestMethod: POST
                header:
                  - key: segment
                    value: oaoh
                  - key: Content-Type
                    value: application/json
                  - key: payment_version
                    value: smart_allocation
                  - key: response_type
                    value: omni
                  - key: pretripping_auth
                    value: true
                readTimeout: 180000
                requestBody: ${payload}
                getValue:
                  - key: astroDetails.orderSummary.orderInfo.orderId
                    storeIn: orderNo
                  - key: astroStatus
                    storeIn: orderCreationStatus
                  - key: astroDescription
                    storeIn: orderDetailsDescription
                  - key: statusCode
                    storeIn: errorCode
                  - key: error
                    storeIn: errorMessage
                  - key: message
                    storeIn: errorDetails
                retryDelay: 5000
            - if:
                condition: ${orderCreationStatus} == 'SUCCESS'
                then:
                  - log: Order successfully created.
                  - break: true
                else:
                  - log: Failure in order creation. Retrying after 30 secs
                  - sleep:
                      duration: 30000
      - if:
          condition: ${errorCode} == null
          then:
            - if:
                condition: ${orderCreationStatus} != 'SUCCESS'
                then:
                  - failTest:
                      message: "API_FAILURE - ASTRO - CREATE ORDER FAILURE - Error: ${orderDetailsDescription} - Fetched Items: ${fetchedItemDataDetails}"
          else:
            - failTest:
                message: "API_FAILURE - ASTRO - PAYLOAD ERROR. Error: ${errorMessage} - ${errorDetails}"
      - log: ${orderNo}
      - if:
          condition: ${skipOrderWait} == true
          then:
            - log: skipping rest of the steps as skipOrderWait flag is set true
          else:
            - executeNode:
                file: us/e2e-tests/helpers/orderValidation.js
                args:
                  - value: ${payload}
                  - value: ${orderDetailsDescription}
                getResponse:
                  storeIn: validationResult
            - if:
                condition: ${validationResult} == 'No mismatch'
                then:
                  - log: Created order validated for fulfillment type correctness
                else:
                  - failTest:
                      message: ${validationResult} [ Created order fulfillment types - ${orderDetailsDescription} ]
            - sleep:
                duration: 60000

  - name: unified.us.functions.utils.astro.createAccount
    flow:
      - log: Create Account
      - log: ${payload}
      - loop:
          begin: 1
          end: 4
          storeIndex: retryTriggerCount
          mode: increment
          flow:
            - callAPI:
                url: http://astro.walmart.com/api/v2/teflon/customer
                requestMethod: POST
                wait: 5000
                header:
                  - key: Content-Type
                    value: application/json
                  - key: segment
                    value: oaoh
                  - key: tenant-id
                    value: elh9ie
                readTimeout: 30000 
                requestBody: ${payload}
                getValue:
                  - key: astroDetails.addPaymentPreferenceId
                    storeIn: addPaymentPreferenceId
                  - key: astroStatus
                    storeIn: astroStatus
                  - key: astroDetails.statusCode
                    storeIn: responseCode
                  - key: statusCode
                    storeIn: altResponseCode
                  - key: astroDescription
                    storeIn: errorMessage
                  - key: astroDetails.customerDetails.phoneNumber
                    storeIn: astroPhoneNum
                  - key: astroDetails.customerDetails.emailAddress
                    storeIn: astroEmail
            - storeIn: 
                key: astroPhoneNumber
                value: "1${astroPhoneNum}"
          #requestBody: '{"firstName": "Astro","lastName": "Mobile","emailAddress": "$email","phoneNumber": "4088968104","paymentMethods": ["VISA"],"postalAddress": {"address": "1350 Bacchus Dr","city": "San Jose","country": "USA","postalCode": "95122","state": "CA"},"password": "$password"}'
            - if:
                condition: ${astroStatus} == 'SUCCESS'
                then:
                  - if:
                      condition: ${responseCode} == 200
                      then:
                        - log: $addPaymentPreferenceId
                        - if:
                            condition: ${withoutPayment}
                            then:
                              - executeFunction:
                                  name: us.functions.utils.astro.deletePaymentData
                            else:
                              - log: Account created successfully
                        - log: ------- Account created Successfully -------
                        - break: true
                else:
                  - log: TRIGGER RETRY ${retryTriggerCount} - Triggering account creation API again
                  - sleep:
                      duration: 20000

      - if:
          condition: ${astroStatus}!= 'SUCCESS'
          then:
            - if:
                condition: ${responseCode} == 400 || ${altResponseCode} == 400
                then:
                  - failTest:
                      message: "API_FAILURE - ASTRO - PAYLOAD ERROR. Payload used: ${payload}"
                else:
                  - failTest:
                      message: "API_FAILURE - ASTRO - Unable to create account. Error: ${errorMessage}"          

  # Function to get stock available items using API. 
  # STORES item fetched details in ${itemFetched} [ItemId] and ${deeplinkURl} [deeplink]
  # Parameters:
  # [Mandatory] itemType - tag to identify kind of items to fetch [e.g. FC_DELIVERY / FC_OZARK / STORE_SCHEDULED_PICKUP ...]
  # [Optional] source - astro/teflon [default 'astro'] [This is used to call astro/teflon data API accordingly]
  # [Optional] healthCheck - true/false [default 'false'] [If astro APIs health check is FAIL and to recheck specific item's health, set to true]
  # [Optional] storeId - If item fetched to be of a specific store
  # [Optional] backupItem - Item to be used for searching if API call fails
  # [Optional] skipForNext - [true/false] If true, stores item fetched through API for future reference and store in variable ${skipItemId}
  # [Optional] excludeFetchedItem - [true/false] If true, returns an itemId different from the one fetched earlier
  # [Optional] itemFilter - [lessThan35/greaterThan35] Filter to fetch items with price less than/greater than 35$
  - name: unified.us.functions.utils.getSearchableItem
    flow:
      # Set to default values
      - storeIn:
          key: itemFetched
          value: 'null'
      - storeIn:
          key: deeplinkURL
          value: 'null'
      - storeIn:
          key: apiFetch
          value: true
      - if:
          condition: ${TEFLON_DATA} != 'NA'
          then:
            - executeNode:
                file: us/e2e-tests/helpers/itemFetch.js
                args:
                  - value: ${itemType}
                  - value: ${itemFilter}
                  - value: ${TEFLON_DATA}
                getResponse:
                  storeIn: itemToBeUsed
            - log: ${itemToBeUsed}
      - if:
          condition: ${itemToBeUsed} == 'NA' || ${itemToBeUsed} == 'undefined' || ${itemToBeUsed} == 'null' || ${itemToBeUsed} == null
          then:
            - if:
                condition: ${source} == 'teflon'
                then:
                  - log: Item fetched by teflon data API
                  - executeFunction:
                      name: unified.us.functions.utils.fetchAvailableItem
                else:
                  - log: Item fetched by Astro API
                  - executeFunction:
                      name: unified.us.functions.utils.fetchAstroAvailableItem
            # If API call fails or no items available in stock
            - if:
                condition: ${itemDetails} == 'unavailable'
                then:
                  - if:
                      condition: ${backupItem} == null
                      then:
                        # When no backup item available
                        - log: Not able to fetch stock available item and no backup Item available either.
                        - failTest:
                            message: "DATA_FAILURE - teflon, no eligible item for the tag - ${itemType} found"
                      else:
                        # When backup item available
                        - storeIn:
                            key: itemFetched
                            value: ${backupItem}
          else:
            - storeIn:
                key: itemFetched
                value: ${itemToBeUsed}
      # Reset to default value
      - storeIn:
          key: backupItem
          value: 'null'
      - storeIn:
          key: source
          value: 'null'
      - storeIn:
          key: useHardCodedItem
          value: 'null'
      # Generating deeplinkURL based on fetched/backup item
      - storeIn:
          key: deeplinkURl
          value: walmart://item/$itemFetched
      - log: Item:$itemFetched
      - log: deeplinkURL:$deeplinkURl                      

  - name: unified.us.functions.utils.fetchAvailableItem
    flow:
      - log: Fetching Item available in stock for Item type ${itemType}
      #API URL creation based on params passed
      - if:
          condition: ${storeId} == null
          then:
            - storeIn:
                key: param
                value: tag=${itemType}
          else:
            - storeIn:
                key: param
                value: tag=${itemType}&storeId=${storeId}
            - storeIn:
                key: storeId
                value: 'null'
      # Set to default value
      - storeIn:
          key: itemDetails
          value: 'null'
      - try:
          flow: 
            - callAPI:
                url: http://central-ops-server.prod.walmart.net/api/fetchTaggedItem?${param}&limit=5
                requestMethod: GET
                wait: 5000
                verifyResponseCode: 200
                header:
                  - key: Content-Type
                    value: application/json
                  - key: ENVIRONMENT
                    value: glass
                readTimeout: 180000
                verifyResponseBodyContains:
                  - '"tag"'
                getResponse:
                  storeIn: response
                retriesOnFail: 5
                retryDelay: 5000
            - loop:
                each: "${response}"
                storeIndex: i
                storeElement: x
                # Fetching first stock available item
                flow:
                  - log: $x
                  - storeIn:
                      key: searchTerm2
                      value: $x.itemId
                  - storeIn:
                      key: itemFetched
                      value: $x.itemId
                  # Store fetched item id. To be used for skipping same item on the 2nd run
                  - if:
                      condition: ${skipForNext}
                      then:
                        - storeIn:
                            key: skipItemId
                            value: $x.itemId
                  # Skip same item id fetched earlier and return a different item Id
                  - if:
                      condition: ${excludeFetchedItem}
                      then:
                        - if:
                            condition: ${skipItemId} == null
                            then:
                              - storeIn:
                                  key: skipItemId
                                  value: '0'
                        - if:
                            condition: $itemFetched == $skipItemId
                            then:
                              - log: Excluding the earlier fetched item
                            else:
                              - break: true
                      else:
                        - break: true                
            - log: Stock available Item Id ${searchTerm2} for type ${itemType}
            # Reset to default values
            - storeIn:
                key: skipForNext
                value: false
            - storeIn:
                key: excludeFetchedItem
                value: false
          catch:
            flow:
              # API call fails or returns no item with stock availability
              - storeIn:
                  key: itemDetails
                  value: unavailable      

  - name: unified.us.functions.utils.fetchAstroAvailableItem
    flow:
      - log: Fetching Item available in stock using Astro API for Item type ${itemType}
      # API URL creation based on params passed
      - if:
          condition: ${storeId} == null
          then:
            - storeIn:
                key: storeId
                value: 32144
      - if:
          condition: ${nextGen} == null
          then:
            - storeIn:
                key: version
                value: nextgen
      - if:
          condition: ${itemStatusHeader} == null
          then:
            - storeIn:
                key: itemStatusHeader
                value: SUCCESS
      - if:
          condition: ${itemFilter} != null
          then:
            - if:
                condition: ${itemFilter} == 'lessThan35'  && ${itemSubFilter} != null
                then:
                  - storeIn:
                      key: fetchURL
                      value: http://astro.walmart.com/api/v3/teflon/internal/getItemHealth/${storeId}/${itemType}?minPrice=0&maxPrice=35&itemType=${itemSubFilter}
                else:
                  - if:
                      condition: ${itemFilter} == 'lessThan35'
                      then:
                        - storeIn:
                            key: fetchURL
                            value: http://astro.walmart.com/api/v3/teflon/internal/getItemHealth/${storeId}/${itemType}?minPrice=0&maxPrice=35   
                      else:
                        - if:
                            condition: ${itemFilter} == 'greaterThan35' && ${itemSubFilter} != null
                            then:
                              - storeIn:
                                  key: fetchURL
                                  value: http://astro.walmart.com/api/v3/teflon/internal/getItemHealth/${storeId}/${itemType}?minPrice=35&maxPrice=1000&itemType=${itemSubFilter}                                              
                            else:
                              - if:
                                  condition: ${itemFilter} == 'greaterThan35'
                                  then:
                                    - storeIn:
                                        key: fetchURL
                                        value: http://astro.walmart.com/api/v3/teflon/internal/getItemHealth/${storeId}/${itemType}?minPrice=35&maxPrice=1000
                                  else:
                                    - if:
                                        condition: ${itemFilter} != null
                                        then:
                                          - storeIn:
                                              key: fetchURL
                                              value: http://astro.walmart.com/api/v3/teflon/internal/getItemHealth/${storeId}/${itemType}?itemType=$itemFilter

            - storeIn:
                key: version
                value: nextgen
          else:
            - storeIn:
                key: fetchURL
                value: http://astro.walmart.com/api/v3/teflon/internal/getItemHealth/${storeId}/${itemType}
            
      # Set to default value
      - storeIn:
          key: itemDetails
          value: 'null'
      - try:
          flow:
            - if:
                condition: ${version} == 'nextgen'
                then:
                  - log: NextGen API
                  - callAPI:
                      url: ${fetchURL}
                      requestMethod: GET
                      wait: 5000
                      verifyResponseCode: 200
                      header:
                        - key: Content-Type
                          value: application/json
                        - key: ENVIRONMENT
                          value: glass
                        - key: astroStatus
                          value: ${itemStatusHeader}
                        - key: fetchlimit
                          value: 15
                        - key: version
                          value: nextgen
                      readTimeout: 180000
                      getResponse:
                        storeIn: response
                      retriesOnFail: 5
                      retryDelay: 2000
                      getValue:
                        - key: astroDetails
                          storeIn: response
                        - key: astroStatus
                          storeIn: fetchItemStatus
                else:
                  - log: Old API
                  - callAPI:
                      url: ${fetchURL}
                      requestMethod: GET
                      wait: 5000
                      verifyResponseCode: 200
                      header:
                        - key: Content-Type
                          value: application/json
                        - key: ENVIRONMENT
                          value: glass
                        - key: astroStatus
                          value: ${itemStatusHeader}
                        - key: fetchlimit
                          value: 8
                      readTimeout: 180000
                      getResponse:
                        storeIn: response
                      retriesOnFail: 5
                      retryDelay: 2000
                      getValue:
                        - key: astroDetails
                          storeIn: response
                        - key: astroStatus
                          storeIn: fetchItemStatus
            - if:
                condition: ${fetchItemStatus} == 'FAIL'
                then:
                  - failTest:
                      message: "DATA_FAILURE - teflon, no eligible item for the tag - ${itemType} and store ${storeId} found"
                else:
                  - log: SUCCESSFUL item fetched from astro API.
            - loop:
                each: "${response}"
                storeIndex: i
                storeElement: x
                # Fetching first stock available item
                flow:
                  - storeIn:
                      key: itemDetails
                      value: 'null'
                  - log: $x
                  - storeIn:
                      key: itemFetched
                      value: $x.itemId
                  - storeIn:
                      key: itemStatus
                      value: $x.astroStatus
                  - if:
                      condition: ${healthCheck}
                      then:
                        - log: Checking health of failed item ${itemFetched}
                        - executeFunction:
                            name: unified.us.functions.utils.healthCheck
                        - if:
                            condition: ${healthStatus} == 'SUCCESS'
                            then:
                              - log: Order created with item ${itemFetched}
                              - break: true
                            else:
                              - storeIn:
                                  key: itemStatus
                                  value: 'FAIL'
                  - if:
                      condition: ${itemStatus} == 'SUCCESS'
                      then:
                        - executeNode:
                            file: us/e2e-tests/helpers/splitNumberString.js
                            args:
                              - value: ${itemFetched}
                            getResponse:
                              storeIn: itemFetched    
                        - log: $itemFetched                                     
                        # Store fetched item id. To be used for skipping same item on the 2nd run
                        - if:
                            condition: ${skipForNext}
                            then:
                              - storeIn:
                                  key: skipItemId
                                  value: $x.itemId
                        # Skip same item id fetched earlier and return a different item Id
                        - if:
                            condition: ${excludeFetchedItem}
                            then:
                              - if:
                                  condition: ${skipItemId} == null
                                  then:
                                    - storeIn:
                                        key: skipItemId
                                        value: '0'
                              - if:
                                  condition: $itemFetched == $skipItemId
                                  then:
                                    - log: Excluding the earlier fetched item
                                  else:
                                    - executeFunction:
                                        name: unified.us.functions.utils.itemHealthCheck
                                        params:
                                          - name: excludedItemLists
                                            string: us.data.skip.itemIds
                                    - if:
                                        condition: ${itemEligiblity}
                                        then:
                                          - break: true
                            else:
                              - executeFunction:
                                  name: unified.us.functions.utils.itemHealthCheck
                                  params:
                                    - name: excludedItemLists
                                      string: us.data.skip.itemIds
                              - if:
                                  condition: ${itemEligiblity}
                                  then:
                                    - break: true
                      else:
                        - log: Fail status item fetched, checking other fetched items
                        - storeIn:
                            key: itemDetails
                            value: unavailable
                        - storeIn:
                            key: itemFetched
                            value: 'null'
            - log: Stock available Item Id ${itemFetched} for type ${itemType}
            - executeNode:
                file: us/e2e-tests/helpers/jsonParser.js
                args:
                  - value: ${fetchedItemDataDetails}
                  - value: ${itemType}
                  - value: add
                  - value: ${itemFetched}
                getResponse:
                  storeIn: fetchedItemDataDetails
            # Reset to default values
            - storeIn:
                key: skipForNext
                value: false
            - storeIn:
                key: excludeFetchedItem
                value: false
          catch:
            flow:
              # API call fails or returns no item with stock availability
              - storeIn:
                  key: itemDetails
                  value: unavailable
      - if:
          condition: ${fetchItemStatus} == 'FAIL'
          then:
            - failTest:
                message: "DATA_FAILURE - teflon, no eligible item for the tag - ${itemType} and store ${storeId} found"
      - storeIn:
          key: storeId
          value: 'null'
      - storeIn:
          key: itemStatusHeader
          value: 'null'
      - storeIn:
          key: healthCheck
          value: false
      - storeIn:
          key: version
          value: 'null'
      - storeIn:
          key: itemFilter
          value: 'null'
      - storeIn:
          key: noSubSet
          value: false                  

  - name: unified.us.functions.utils.astro.getOrderStatus
    flow:
      - loop:
          begin: 0
          end: 4
          storeIndex: i
          mode: increment
          flow:
            - log: Get order status for ${orderNo}
            - callAPI:
                url: http://astro.walmart.com/api/v2/teflon/order/${orderNo}
                header:
                  - key: segment
                    value: oaoh
                  - key: Content-Type
                    value: application/json
                requestMethod: GET
                getValue:
                  - key: astroStatus
                    storeIn: getOrderStatus
                  - key: astroDescription
                    storeIn: statusDescription
            - if:
                condition: ${getOrderStatus} == 'SUCCESS'
                then:
                  - log: Order ${orderNo} found
                  - break: true
                else:
                  - log: Retry after 15 secs
                  - sleep:
                      duration: 15000
      - if:
          condition: ${getOrderStatus} != 'SUCCESS'
          then:
            - failTest:
                message: "API_FAILURE - ASTRO - ${statusDescription}"          

  # [Utility to move orders with one fulfillment type at a time]
  # [mandatory] ${orderNo}    - Order number that has to be moved
  # [mandatory] ${orderType}  - Fulfillment type in the order to be moved
  # [mandatory] ${status}     - To which status the order needs to be moved
  # -----------------------------------------------------------------------------------------------------------------------
  # Valid orderType-status combinations :
  # STORE_SCHEDULED_PICKUP/STORE_UNSCHEDULED_PICKUP - [PO Acknowledged/PO Pick Complete/PO Ready For Pickup/Customer Picked]
  # STORE_SCHEDULED_DELIVERY                        - [PO Acknowledged/PO Pick Complete/PO Out for Delivery/Delivered]
  # FC_DELIVERY/FC_DELIVERY_WPP                     - [Shipped/Delivered]
  # MP_DELIVERY/MP_WFS_DELIVERY                     - [PO Acknowledged/Shipped/Delivered]
  # -----------------------------------------------------------------------------------------------------------------------
  - name: unified.us.functions.utils.astro.setOrderStatus
    flow:
      - log: -------[START-MOVE UTILITY] - Move order [ ${orderNo}-${orderType} ] to [ ${status} ] status-------

      # Fetch wait time constant set in mapping file
      - executeFunction:
          name: unified.us.functions.utils.getMappingValue
          params:
            - name: mappingVariable
              string: us.data.sleep.time
      # Order movement loop [Total re-attempt - 3 times incase of failure in order movement]
      - loop:
          begin: 1
          end: 4
          storeIndex: retryMovementCount
          mode: increment
          flow:
            - log: ------------------------------------------------------------------------------------
            - log: Order movement attempt - ${retryMovementCount}
            - log: ------------------------------------------------------------------------------------

            - arithmetic:
                expression: ${mappingData} * 3
                storeIn: mappingData

            # Wait for 60/180/540(attempt-wise) secs before triggering the order movement if not successful in earlier attempt
            - log: Waiting for ${mappingData} seconds before order movement trigger on attempt - ${retryMovementCount}
            - sleep:
                duration: ${mappingData}

            # Trigger order movement for the required orderType
            - executeFunction:
                name: unified.us.functions.utils.astro.triggerOrderMovement

            # Wait for 30(each attempt) secs before validating if order movement trigger is successful or not
            - sleep:
                duration: 30000

            # Validating order movement for the required orderType
            - executeFunction:
                name: unified.us.functions.utils.astro.validateOrderMovement

            # Break re-attempt loop if order movement is successful
            - if:
                condition: ${responseValidationStatus} == true
                then:
                  - log: Order [ ${orderNo} ] successfully moved to [ ${status} ] status for fulfillment type [ ${orderType} ]
                  - break: true
                else:
                  - log: Retry after some wait time

      # Fail with appropriate error if orderType is not moved to required status even after all re-attempts
      - if:
          condition: ${responseValidationStatus} == true
          then:
            - log: -------[END-MOVE UTILITY] - Move order [ ${orderNo}-${orderType} ] to [ ${status} ] status-------
          else: 
            - executeFunction:
               name: unified.us.functions.utils.getFailureMessage
            - failTest:
                message: "API_FAILURE - ASTRO - Order [ ${orderNo} ] movement failed due to ${responseDetails} FailAt :[ ${responseDetailsDetailed} ] Description:[ ${responseDetailsDescription} ] ${failureMessage}"                

  - name: unified.us.functions.utils.getMappingValue
    flow:
      - storeIn:
          key: mappingData
          value: ${mappingVariable}                

  # [Utility to trigger order movement using Astro V3 API]
  # [mandatory] ${orderNo}    - Order number that has to be moved
  # [mandatory] ${orderType}  - Fulfillment type in the order to be moved
  # [mandatory] ${status}     - To which status the order needs to be moved
  - name: unified.us.functions.utils.astro.triggerOrderMovement
    flow:
      - log: -------[START-TRIGGER UTILITY] - Order [ ${orderNo}-${orderType} ] movement to [ ${status} ] status-------
      - loop:
          begin: 1
          end: 4
          storeIndex: retryTriggerCount
          mode: increment
          flow:
            - callAPI:
                url: http://astro.walmart.com/api/v3/teflon/order/${orderNo}
                header:
                  - key: segment
                    value: oaoh
                  - key: Content-Type
                    value: application/json
                readTimeout: 180000
                requestMethod: PUT
                verifyResponseCode: 200
                retriesOnFail: 3
                retryDelay: 180000
                requestBody: '{"fulfillmentGroups": [{"orderType":"$orderType","status": "$status"}]}'
                getValue:
                  - key: status
                    storeIn: responseTriggerStatus
                  - key: astroDescription
                    storeIn: failureReason
                  - key: astroDetails.description
                    storeIn: failureReasonDescription
            - if:
                condition: ${responseTriggerStatus} == 'SUCCESS'
                then:
                  - log: -------[END-TRIGGER UTILITY] - Order movement triggered successfully-------
                  - break: true
                else:
                  - if:
                      condition: ${altOrderType} != null
                      then:
                        - if:
                            condition: ${failureReason} == 'ORDER_FULFILLMENT_MISMATCH'
                            then:
                              - storeIn:
                                  key: orderType
                                  value: ${altOrderType}
                  #- log: ------------------------------------------------------------------------------------
                  - log: TRIGGER RETRY ${retryTriggerCount} - Triggering order movement again due to failure.
                  #- log: ------------------------------------------------------------------------------------
      - storeIn:
          key: altOrderType
          value: 'null'
      - if:
          condition: ${responseTriggerStatus} != 'SUCCESS'
          then:
            - failTest:
                message: "API_FAILURE - ASTRO - [ ${orderNo} ] Unable to trigger order movement ${failureReason} due to ${failureReasonDescription}"            

 # Function for Driver return initiated back to store order status change. 
     # [Utility to trigger order movement using Astro V2 API]
  # [mandatory] ${orderNo}    - Order number that has to be moved
  # [mandatory] ${orderType}  - Fulfillment type in the order to be moved
  # [mandatory] ${status}     - To which status the order needs to be moved
  - name: unified.us.functions.utils.astro.triggerDriverReturnInitiatedStatus
    flow:
      - log: -------[START-TRIGGER UTILITY] - Order [ ${orderNo}-${orderType} ] movement to [ ${status} ] status-------
      - loop:
          begin: 1
          end: 4
          storeIndex: retryTriggerCount
          mode: increment
          flow:
            - callAPI:
                url: http://astro.walmart.com/api/v2/teflon/order/${orderNo}/returnInitiated
                header:
                  - key: segment
                    value: oaoh
                  - key: Content-Type
                    value: application/json
                readTimeout: 180000
                requestMethod: POST
                verifyResponseCode: 200
                retriesOnFail: 3
                retryDelay: 180000
                requestBody: '{"fulfillmentGroups": [{"orderType":"$orderType","status": "$status"}]}'
                getValue:
                  - key: status
                    storeIn: responseTriggerStatus
            - if:
                condition: ${responseTriggerStatus} == 'SUCCESS'
                then:
                  - log: -------[END-TRIGGER UTILITY] - Order movement triggered successfully-------
                  - break: true
                else:
                  #- log: ------------------------------------------------------------------------------------
                  - log: TRIGGER RETRY ${retryTriggerCount} - Triggering order movement again due to failure.
                  #- log: ------------------------------------------------------------------------------------
      - if:
          condition: ${responseTriggerStatus} != 'SUCCESS'
          then:
            - failTest:
                message: "API_FAILURE - ASTRO - Unable to trigger order movement"

  # [Utility to validate order movement status using Astro V3 API]
  # [mandatory] ${orderNo}    - Order number that has to be moved
  # [mandatory] ${orderType}  - Fulfillment type in the order to be moved
  # [mandatory] ${status}     - To which status the order needs to be moved
  - name: unified.us.functions.utils.astro.validateOrderMovement
    flow:
      - log: -------[START-VERIFY UTILITY] - Order [ ${orderNo}-${orderType} ] movement to [ ${status} ] status-------
      - loop:
          begin: 1
          end: 4
          storeIndex: retryValidationCount
          mode: increment
          flow:
            - sleep:
                duration: 10000
            - callAPI:
                url: http://astro.walmart.com/api/v3/db/astro/teflon/order?orderType=${orderType}&status=${status}&orderNo=${orderNo}
                header:
                  - key: segment
                    value: oaoh
                  - key: Content-Type
                    value: application/json
                readTimeout: 180000
                requestMethod: GET
                verifyResponseCode: 200
                retriesOnFail: 3
                retryDelay: 180000
                getResponse:
                  storeIn: orderResponse
                getValue:
                  - key: astroDetails[0].result
                    storeIn: responseValidationStatus
                  - key: astroDescription
                    storeIn: responseDetails
                  - key: astroDetails[0].eventErrors[0].failAt
                    storeIn: responseDetailsDetailed
                  - key: astroDetails[0].eventErrors[0].description
                    storeIn: responseDetailsDescription
            - if:
                condition: ${responseValidationStatus} == true
                then:
                  - break: true
                else:
                  #- log: -------------------------------------------------------------
                  - log: VERIFY RETRY - ${retryValidationCount} - Rechecking after 10s
                  #- log: -------------------------------------------------------------
                  - if:
                      condition: ${orderType} == 'FC_DELIVERY' || ${orderType} == 'MP_DELIVERY'
                      then:
                        - try:
                            flow:
                              - log: ${orderResponse}
                              - verifyValue:
                                  identifier: ${orderResponse}
                                  contains: _HOLD
                              - storeIn:
                                  key: orderBatchingHold
                                  value: true
                    # Utility to help release order batching hold
                              - if:
                                  condition: ${orderBatchingHold}
                                  then:
                                    - executeFunction:
                                        name: us.functions.utils.astro.releaseOrderHold
                                    - storeIn:
                                        key: orderBatchingHold
                                        value: false
                                    - break: true
                            catch:
                              flow:
                                - log: No order hold present
                            
      - log: -------[END-VERIFY UTILITY] - Order [ ${orderNo}-${orderType} ] movement to [ ${status} ] status-------

  - name: unified.us.functions.utils.getFailureMessage
    flow:
      - if:
          condition: ${apiFetch}
          then:
            - if:
                condition: ${responseDetailsDetailed} == null
                then:
                  - storeIn:
                      key: responseDetailsDetailed
                      value: NA
                  - storeIn:
                      key: responseDetailsDescription
                      value: NA
            - if:
                condition: ${itemFilter} != null
                then:
                  - storeIn:
                      key: failureMessage
                      value: '[ Details : FailureType - OrderMovement, FulfillmentType - ${itemType}, FilterType - ${itemFilter} ]'
                else:
                  - storeIn:
                      key: failureMessage
                      value: '[ Details : FailureType - OrderMovement, FulfillmentType - ${itemType} ]'
          else:
            - storeIn:
                key: failureMessage
                value: '[ Details : FailureType - OrderMovement ]'      

  - name: unified.us.functions.utils.itemHealthCheck
    flow:
      - log: Checking item eligibility before proceeding
      - storeIn:
          key: itemEligiblity
          value: false
      - storeIn:
          key: ignoreItem
          value: false
      - loop:
          each: ${excludedItemLists}
          storeElement: itemId
          flow:
            - if:
                condition: ${itemId} == ${itemFetched}
                then:
                  - storeIn:
                      key: ignoreItem
                      value: true
                  - break: true
      - if:
          condition: ${ignoreItem}
          then:
            - log: Trying for other item as this is in excluded list of item ids
          else:
            - if:
                condition: ${itemType} == 'STORE_SCHEDULED_PICKUP' || ${itemType} == 'STORE_SCHEDULED_DELIVERY' || ${itemType} == 'STORE_UNSCHEDULED_PICKUP' || ${itemType} == 'FC_DELIVERY'
                then:
                  - try:
                      flow:
                          - executeFunction:
                              name: us.functions.utils.checkItemTransactabality
                              params:
                                - name: email
                                  string: checkItemTransactabality@walmart.com
                                - name:  itemGroup
                                  string: ${itemType}
                                - name: itemId
                                  string: ${itemFetched}
                      catch:
                        flow:
                          - log: Unable to get item Transactabality data
                  - if:
                      condition: ${itemEligible}
                      then:               
                        - storeIn:
                            key: itemEligiblity
                            value: true
                else:
                  - if:
                      condition: ${itemType} == 'MP_DELIVERY' && ${noSubSet}
                      then:
                        - executeFunction:
                            name: us.functions.utils.mpItemWFSCheck
                      else:
                        - log: Skipping item eligibility check
                        - storeIn:
                            key: itemEligiblity
                            value: true

  - name: unified.us.functions.utils.fetchFulcrumAvailableItem
    flow:
      - storeIn:
          key: executionStage
          value: FulcrumAPI
      - log: --Fulcrum begining--
      - if:
          condition: ${storeId} == null
          then:
            - storeIn:
                key: storeId
                value: 32144
      # First, check if the itemSubFilter is provided
      - if:
          condition: ${featureName} != null 
          then:  
            - if:
                condition: ${itemFilter} != null 
                then:            
                  - log: "SubFilter provided: ${itemFilter}, including in the URL"
                  - storeIn:
                      key: fetchURL
                      value: http://fulcrum.teflon.walmart.com/api/v2/db/fulcrum/goldenHealthyItemsUS?orderType=${itemType}&storeId=${storeId}&featureName=${featureName}&subFilters=${itemFilter}&itemStatus=true
                  - storeIn:
                      key: version
                      value: nextgen
                else:
                  - log: "No subFilter provided, constructing URL without subFilters"
                  - storeIn:
                      key: fetchURL
                      value: http://fulcrum.teflon.walmart.com/api/v2/db/fulcrum/goldenHealthyItemsUS?orderType=${itemType}&storeId=${storeId}&featureName=${featureName}&itemStatus=true  
          else:
            - if:
                condition: ${itemFilter} != null 
                then:            
                  - log: "SubFilter provided: ${itemFilter}, including in the URL"
                  - storeIn:
                      key: fetchURL
                      value: http://fulcrum.teflon.walmart.com/api/v2/db/fulcrum/goldenHealthyItemsUS?orderType=${itemType}&storeId=${storeId}&featureName=APP E2E Regression&subFilters=${itemFilter}&itemStatus=true
                  - storeIn:
                      key: version
                      value: nextgen
                else:
                  - log: "No subFilter provided, constructing URL without subFilters"
                  - storeIn:
                      key: fetchURL
                      value: http://fulcrum.teflon.walmart.com/api/v2/db/fulcrum/goldenHealthyItemsUS?orderType=${itemType}&storeId=${storeId}&featureName=APP E2E Regression&itemStatus=true  
      #Looping thru API Objects
      - loop:
          begin: 1
          end: 2
          storeIndex: retryValidationCount
          mode: increment
          flow:
            - sleep:
                duration: 10000
            - callAPI:
                url: ${fetchURL} #http://fulcrum.teflon.walmart.com/api/v1/db/fulcrum/instantItemHealthAnalysis?orderType=${itemType}&storeId=${storeId}&itemStatus=green
                readTimeout: 180000
                requestMethod: GET
                verifyResponseCode: 200
                retriesOnFail: 3
                retryDelay: 180000
                getResponse:
                  storeIn: orderResponse
                getValue:
                  - key: itemDetails
                    storeIn: responseItemdetails
                  - key: instantItemStatus
                    storeIn: orderResponse
                  - key: status
                    storeIn: fetchItemStatus
                  - key: itemDetails.instantItemStatus 
                    storeIn: firstItem
            - log: --Fulcrum response instant-- ${responseInstant}
            - log: --Fulcrum first item response-- ${firstItem}
            - log: --Fulcrum item detail-- ${responseItemdetails}
            - log: --Fulcrum fetch item status-- ${fetchItemStatus}
            - log: --Fulcrum response instant-- ${responseInstant}
            - log: --begining array
            - loop:
                each: "${firstItem}"
                storeIndex: i
                storeElement: x
                # Fetching first stock available item
                flow:
                  - log: store index is $x
                  - storeIn:
                      key: itemFetched
                      value: $x.itemId
                  - storeIn:
                      key: itemStatus
                      value: $x.healthCheckRes[0].isEligible
                  - log: ${itemFetched}
                  - log: ${itemStatus}
                  - if:
                      condition: ${itemStatus} == true
                      then:
                        - log: Fulcrum fetched item ${itemFetched}
                        - break: true
                      else:
                        - storeIn:
                            key: itemStatus
                            value: 'FAIL'

  - name: unified.us.functions.utils.astro.cancelPaidMembership
    flow:
      - log: Cancelling Paid Member
      - log: $customerEmail
      - callAPI:
          url: http://astro.walmart.com/api/v2/teflon/account/$customerEmail/wplus
          requestMethod: DELETE
          wait: 5000
          verifyResponseCode: 200
          header:
            - key: Content-Type
              value: application/json
            - key: version
              value: nextgen
          readTimeout: 30000 
          verifyResponseCode: 200
          verifyResponseBodyContains:
            - '"astroStatus":"SUCCESS"'
          getResponse:
            storeIn: response 
          getValue:
            - key: astroStatus
              storeIn: astroStatus
      - if:
          condition: ${astroStatus}!= 'SUCCESS'
          then:
            - failTest:
                message: "API_FAILURE - Astro - Unable to cancel the membership ${response}"


  # New Function to get stock available items using API (Fulcrum / Astro) with more error validation (create order / Validate order movement).
  # STORES item fetched details in ${itemFetched} [ItemId] and ${deeplinkURl} [deeplink]
  # Parameters:
  # [Mandatory] itemType - tag to identify kind of items to fetch [e.g. FC_DELIVERY / FC_OZARK / STORE_SCHEDULED_PICKUP ...]
  # [Mandatory] action  [FetchItem / FetchAndValidateOrderMovment] - FetchItem will only validate create order and FetchAndValidateOrderMovment will validate the order movement
  # [Optional] fulcrum [true/false] by default astro api
  # [Optional] storeId - If item fetched to be of a specific store by default 32144
  # [Mandatory] emailId - To check the validation in custom email by defualt test account is used 
  # [Optional] itemFilter - [Filter available in astro/fulcrum] Filter to fetch items with filters
  # [Mandatory if FetchAndValidateOrderMovment] orderStatus -
    # STORE_SCHEDULED_PICKUP/STORE_UNSCHEDULED_PICKUP - [PO Acknowledged/PO Pick Complete/PO Ready For Pickup/Customer Picked]
    # STORE_SCHEDULED_DELIVERY                        - [PO Acknowledged/PO Pick Complete/PO Out for Delivery/Delivered]
    # FC_DELIVERY/FC_DELIVERY_WPP                     - [Shipped/Delivered]
    # MP_DELIVERY/MP_WFS_DELIVERY                     - [PO Acknowledged/Shipped/Delivered]
  # [optional if FetchAndValidateOrderMovment] getOrderId - true/false [To get order id instead of item id for post txn flows] - as of now only single fulfilment is supported.
  - name: unified.us.functions.utils.fetchItemAndValidate
    flow:
      - storeIn:
          key: skipItemId
          value: us.data.skip.itemIds
      - log: "wait for 5 mins getting item with fulfillment ${itemType} with validation ${action}"
      - executeNode:
          file: us/e2e-tests/helpers/fetchAndValidateItem.js
          args:
            - value: ${action}
            - value: ${fulcrum}
            - value: ${itemType}
            - value: ${itemFilter}
            - value: ${storeId}
            - value: ${orderStatus}
            - value: ${emailId}
            - value: ${skipItemId}
            - value: ${getOrderId}
          getResponse:
            storeIn: itemFetched
      - try:
          flow:
            - verifyValue:
                identifier: ${itemFetched}
                contains: FAILURE
            - storeIn:
                key: itemAvailable
                value: false
          catch:
            flow:
              - storeIn:
                  key: itemAvailable
                  value: true
      - if:
          condition: ${itemAvailable}
          then:
            - if:
                condition: ${getOrderId}
                then:
                  - storeIn:
                      key: orderNo
                      value: $itemFetched
                  - log: ${orderNo}
                else:
                  # Generating deeplinkURL based on fetched item
                  - storeIn:
                      key: deeplinkURl
                      value: walmart://item/$itemFetched
                  - log: Item:$itemFetched
                  - log: deeplinkURL:$deeplinkURl
                  - storeIn:
                      key: fetchedItemDataDetails
                      value: ${itemFetched}
          else:
            - storeIn:
                key: testStarted
                value: true
            - failTest:
                message: ${itemFetched}
      - storeIn:
          key: itemFilter
          value: 'null'
      - storeIn:
          key: itemAvailable
          value: false
      - storeIn:
          key: getOrderId
          value: false

  # Function for Driver returned back to store order status change. 
     # [Utility to trigger order movement using Astro V3 API]
  # [mandatory] ${orderNo}    - Order number that has to be moved
  # [mandatory] ${orderType}  - Fulfillment type in the order to be moved
  # [mandatory] ${status}     - To which status the order needs to be moved
  - name: unified.us.functions.utils.astro.triggerDriverreturnedstatus
    flow:
      - log: -------[START-TRIGGER UTILITY] - Order [ ${orderNo}-${orderType} ] movement to [ ${status} ] status-------
      - loop:
          begin: 1
          end: 4
          storeIndex: retryTriggerCount
          mode: increment
          flow:
            - callAPI:
                url: http://astro.walmart.com/api/v2/teflon/order/${orderNo}/returned
                header:
                  - key: segment
                    value: oaoh
                  - key: Content-Type
                    value: application/json
                readTimeout: 180000
                requestMethod: POST
                verifyResponseCode: 200
                retriesOnFail: 3
                retryDelay: 180000
                requestBody: '{"fulfillmentGroups": [{"orderType":"$orderType","status": "$status"}]}'
                getValue:
                  - key: astroStatus
                    storeIn: responseTriggerStatus
            - if:
                condition: ${responseTriggerStatus} == 'SUCCESS'
                then:
                  - log: -------[END-TRIGGER UTILITY] - Order movement triggered successfully-------
                  - break: true
                else:
                  #- log: ------------------------------------------------------------------------------------
                  - log: TRIGGER RETRY ${retryTriggerCount} - Triggering order movement again due to failure.
                  #- log: ------------------------------------------------------------------------------------
      - if:
          condition: ${responseTriggerStatus} != 'SUCCESS'
          then:
            - failTest:
                message: "API_FAILURE - ASTRO - Unable to trigger order movement" 

## RXPD Util to create Prescriptions using Astro
  - name: unified.us.functions.utils.astro.rxpd.create.rx
    flow:
      - storeIn:
          key: executionStage
          value: Transactions
      - log: -------[START-Create prescriptions for the given customer] ] -------
      - loop:
          begin: 1
          end: 3
          storeIndex: retryCount
          mode: increment
          flow:
            - callAPI:
                url: http://astro.walmart.com/api/v2/teflon/rx/order
                header:
                  - key: segment
                    value: oaoh
                  - key: Content-Type
                    value: application/json
                readTimeout: 180000
                requestMethod: POST
                verifyResponseCode: 200
                retriesOnFail: 2
                retryDelay: 30000
                requestBody: '{"patientId": "$patientId","siteId": "$siteId","drug": {"ndc": "$ndc"}, "moveTo":"$moveTo"}'
                getValue:
                  - key: astroStatus
                    storeIn: responseStatus
            - if:
                condition: ${responseStatus} == 'SUCCESS'
                then:
                  - log: -------[END-Created prescriptions for the given customer successfully]-------
                  - break: true
                else:
                  - log: RETRY ${retryCount}
      - if:
          condition: ${responseStatus} != 'SUCCESS'
          then:
            - failTest:
                message: "API_FAILURE - ASTRO - [ ${$patientId} ] Unable to Create Prescriptions for the given customer ${failureReason}"
  - name: unified.us.functions.utils.astro.createTrialAccountConvertToPaid
    flow:
      - log: Create Account
      - log: ${payload}
      - callAPI:
          url: http://astro.walmart.com/api/v2/teflon/customer
          requestMethod: POST
          wait: 5000
          verifyResponseCode: 200
          header:
            - key: Content-Type
              value: application/json
            - key: segment
              value: oaoh
          readTimeout: 30000 
          requestBody: ${payload}
          verifyResponseCode: 200
          verifyResponseBodyContains:
            - '"astroStatus":"SUCCESS"'
          getResponse:
            storeIn: response
          getValue:
            - key: astroDetails.addPaymentPreferenceId
              storeIn: addPaymentPreferenceId
            - key: astroDetails.statusCode
              storeIn: statusCode
      - log: Account created successfully
      - if:
          condition: ${statusCode}!= 200
          then:
            - failTest:
                message: "API_FAILURE - Cannot create a trial member"
      - log: Converting Trial to Paid Member
      - executeFunction:
          name: unified.us.functions.utils.astro.convertTrialtoPaidMember

  - name: unified.us.functions.utils.astro.convertTrialtoPaidMember
    flow:
      - log: Convert Trial to Paid Member
      - log: $customerEmail
      - log: ${payload}
      - callAPI:
          url: http://astro.walmart.com/api/v2/teflon/account/$customerEmail/wplus
          requestMethod: PUT
          wait: 5000
          verifyResponseCode: 200
          header:
            - key: Content-Type
              value: application/json
            - key: version
              value: nextgen
          readTimeout: 30000 
          requestBody: '{"convertToPaid":true}'
          verifyResponseCode: 200
          verifyResponseBodyContains:
            - '"astroStatus":"SUCCESS"'
          getResponse:
            storeIn: response
          getValue: 
            - key: astroDetails.status
              storeIn: status
      - if:
          condition: ${status}!= 'OK'
          then:
            - failTest:
                message: "API_FAILURE - Astro - Cannot convert to paid member" 

  - name: unified.us.functions.utils.astro.createTrialAccount
    flow:
      - log: Create Account
      - log: ${payload}
      - callAPI:
          url: http://astro.walmart.com/api/v2/teflon/customer
          requestMethod: POST
          wait: 5000
          verifyResponseCode: 200
          header:
            - key: Content-Type
              value: application/json
            - key: segment
              value: oaoh
          readTimeout: 30000 
          requestBody: ${payload}
          verifyResponseCode: 200
          verifyResponseBodyContains:
            - '"astroStatus":"SUCCESS"'
          getResponse:
            storeIn: response
          getValue:
            - key: astroDetails.addPaymentPreferenceId
              storeIn: addPaymentPreferenceId
            - key: astroDetails.statusCode
              storeIn: statusCode
      - log: Account created successfully
      - if:
          condition: ${statusCode}!= 200
          then:
            - failTest:
                message: "API_FAILURE - Cannot create a trial member"         

  - name: unified.us.functions.utils.astro.addPaymentToExistingAccount
    flow:
      - log: Add Payment
      - log: ${payload}
      - storeIn:
          key: astroStatus
          value: 'null'
      - loop:
          begin: 1
          end: 4
          storeIndex: retryTriggerCount
          mode: increment
          flow:
            - callAPI:
                url: http://astro.walmart.com/api/v2/teflon/customer/paymentPreferences
                requestMethod: POST
                wait: 5000
                header:
                  - key: Content-Type
                    value: application/json
                  - key: segment
                    value: oaoh
                readTimeout: 30000 
                requestBody: ${payload}
                getValue:
                  - key: astroStatus
                    storeIn: astroStatus
                  - key: astroDescription
                    storeIn: errorMessage
                  - key: astroDetails.statusCode
                    storeIn: responseCode
                  - key: statusCode
                    storeIn: altResponseCode
            - if:
                condition: ${astroStatus} == 'SUCCESS'
                then:
                  - if:
                      condition: ${responseCode} == 200
                      then:
                        - log: Payment added successfully
                        - break: true
                else:
                  - log: TRIGGER RETRY ${retryTriggerCount} - Triggering Additional payment addition API again
                  - sleep:
                      duration: 20000

      - if:
          condition: ${astroStatus}!= 'SUCCESS'
          then:
            - if:
                condition: ${responseCode} == 400 || ${altResponseCode} == 400
                then:
                  - failTest:
                      message: "API_FAILURE - ASTRO - PAYLOAD ERROR. Payload used: ${payload}"
                else:
                  - failTest:
                      message: "API_FAILURE - ASTRO - Unable to add new payment details to an account. Error: ${errorMessage}"


  - name: unified.us.functions.utils.astro.fetchPreferenceId
    flow:
      - log: Fetches the preference Id using the customer email
      - log: $email
      - callAPI:
          url: http://astro.walmart.com/api/v2/teflon/customer/$email
          requestMethod: GET
          wait: 5000
          verifyResponseCode: 200
          header:
            - key: Content-Type
              value: application/json
            - key: segment
              value: oaoh
          readTimeout: 30000
          retriesOnFail: 5
          verifyResponseCode: 200
          verifyResponseBodyContains:
            - '"SUCCESS"'
          getValue:
            - key: astroStatus
              storeIn: customerIdStatus
            - key: astroDetails.customerDetails.deliveryPreferences[0].deliveryAddressId
              storeIn: preferenceId
      - log: "Fetched prefernece id: ${preferenceId}"

  - name: unified.us.functions.utils.astro.updateDeliveryAddressFlags
    flow:
      - loop:
          begin: 0
          end: 3
          storeIndex: retryCount
          mode: increment
          flow:
            - log: Update Delivery Address Flags for email
            - log: $email
            - log: "Used payload is: ${payload}"
            - storeIn:
                key: errorCode
                value: 'null'
            - storeIn:
                key: updateDeliveryAddressFlags
                value: 'null'
            - callAPI:
                url: http://astro.walmart.com/api/v2/teflon/customer/${email}/contactinformations
                requestMethod: PUT
                header:
                  - key: Content-Type
                    value: application/json
                readTimeout: 180000
                requestBody: ${payload}
                getValue:
                  - key: astroStatus
                    storeIn: updateDeliveryAddressFlags
                retryDelay: 5000
            - log: ${updateDeliveryAddressFlags}
            - if:
                condition: ${updateDeliveryAddressFlags} == 'SUCCESS'
                then:
                  - log: Updated Delivery Address Flags successfully
                  - break: true
                else:
                  - log: Failure in Updating Delivery Address Flags. Retrying after 30 Secs
                  - sleep:
                      duration: 30000
      - if:
          condition: ${updateDeliveryAddressFlags} == 'SUCCESS'
          then:
            - log: Updated Delivery Address Flags successfully
          else:
            - failTest:
                message: "API_FAILURE - ASTRO - Failure in Updating Delivery Address Flags. Error."


  - name: unified.us.functions.utils.astro.pauseMembershipWithPastOrFutureDate
    flow:
      - log: Pausing membership with a past or future date
      - log: $customerEmail
      - log: ${payload}
      - callAPI:
          url: http://astro.walmart.com/api/v2/teflon/account/$customerEmail/wplus
          requestMethod: PUT
          wait: 5000
          verifyResponseCode: 200
          header:
            - key: Content-Type
              value: application/json
            - key: version
              value: nextgen
          readTimeout: 30000 
          requestBody: ${payload}
          verifyResponseCode: 200
          verifyResponseBodyContains:
            - '"astroStatus":"SUCCESS"'
          getResponse:
            storeIn: response
          getValue:
            - key: astroDetails.status
              storeIn: status
      - if:
          condition: ${status}!='OK'
          then:
            - failTest:
                message: "API_FAILURE - Astro - Unable to pause the membership ${response}"

  - name: unified.us.functions.utils.restartapp
    flow:
      - if:
          condition: ${platform} == 'iOS'
          then:
            - launchStartPage: true
            - executeFunction:
                name: unified.us.functions.global.onboarding.navigateOnboardingToHome   

      - if:
          condition: ${platform} == 'Android'
          then:
            - startActivity:
                packageName: ${APP_PACKAGE:com.walmart.android.debug}
                activityName: com.walmart.glass.integration.splash.SplashActivity
                params:
                  - key: appWaitActivity
                    value: com.walmart.glass.onboarding.view.OnboardingActivity              

# Fetch customer id for prod emails
  - name: unified.us.functions.utils.prod.fetchCustomerId
    flow:
      - log: Fetches the Customer Id using the customer email
      - log: $email
      - callAPI: 
          url: http://ca.prod-n.walmart.com/ca-app/services/customers/emails/$email
          requestMethod: GET
          wait: 5000
          verifyResponseCode: 200
          header:
            - key: WM_CONSUMER.ID
              value: 2cd788f9-76e7-4d68-a466-628248d7bf24
            - key: Content-Type
              value: application/json
            - key: WM_CONSUMER.NAME
              value: aaa
            - key: WM_CONSUMER.TENANT_ID
              value: 0
            - key: WM_CONSUMER.VERTICAL_ID
              value: 0
            - key: WM_IFX.CLIENT_TYPE
              value: INTERNAL
            - key: WM_QOS.CORRELATION_ID
              value: TEST
            - key: WM_SEC.AUTH_TOKEN
              value: 1
            - key: WM_SVC.ENV
              value: prod
            - key: WM_SVC.NAME
              value: CustomerAccountService
            - key: WM_SVC.VERSION
              value: 1.0.0
          readTimeout: 30000
          retriesOnFail: 5
          verifyResponseCode: 200
          verifyResponseBodyContains:
            - '"OK"'
          getValue:
            - key: status
              storeIn: customerIdStatus
            - key: payload.persons[0].customerAccountId
              storeIn: customerAccountId
      - log: "Fetched customer id: ${customerAccountId}"                    

  - name: unified.us.functions.utils.fetchFromDataList
    flow:
      - if:
          condition: ${storeId} == null
          then:
            - storeIn:
                key: storeId
                value: 32144

      - if:
          condition: ${itemType} == 'MP_PRO_SELLER'
          then:
            - storeIn:
                key: itemGroup
                value: MP_DELIVERY
          else:
            - storeIn:
                key: itemGroup
                value: ${itemType}
      - loop:
          each: ${itemList}
          storeIndex: i
          storeElement: itemId
          flow:
                  - executeFunction:
                      name: unified.us.functions.utils.checkItemTransactabality
                  - if:
                      condition: ${itemEligible}
                      then:
                        - storeIn:
                            key: itemFetched
                            value: ${itemId}
                        - storeIn:
                            key: deeplinkURl
                            value: walmart://item/$itemFetched
                        - log: Item:$itemFetched
                        - log: deeplinkURL:$deeplinkURl
                        - break: true

      - if:
          condition: ${itemEligible}
          then:
            - log: Eligible item is ${itemFetched} for type ${itemType}
          else:
            - failTest:
                message: "DATA_FAILURE - Eligible item not found for type ${itemType}"

  - name: unified.us.functions.utils.checkItemTransactabality
    flow:
      - storeIn:
          key: itemEligible
          value: false
      - callAPI:
          url: http://astro.walmart.com/api/v2/teflon/item/transactability
          requestMethod: POST
          wait: 5000
          header:
            - key: Content-Type
              value: application/json
          readTimeout: 180000
          requestBody: '{"storeId":"${storeId}","fulfillmentGroups":[{"orderType":"${itemGroup}","items":[{"itemId":${itemId},"quantity":1}]}],"customerEmailAddress":"${email}"}'
          wait: 10000
          retriesOnFail: 3
          retryDelay: 2000
          getValue:
            - key: astroStatus
              storeIn: transactabilityStatus

      - if:
          condition: ${transactabilityStatus} == 'SUCCESS'
          then:
            - storeIn:
                key: itemEligible
                value: true

  - name: unified.us.functions.utils.astro.addRewardAmount
    flow:
      - log: Add Reward amount to existing Wplus user
      - log: ${payload}
      - callAPI:
          url: http://astro.walmart.com/api/v2/teflon/addBalanceRewards
          requestMethod: PUT
          wait: 5000
          verifyResponseCode: 200
          header:
            - key: Content-Type
              value: application/json
            - key: version
              value: nextgen
          readTimeout: 30000 
          requestBody: ${payload}
          verifyResponseBodyContains:
            - '"astroStatus":"SUCCESS"'
          getResponse:
            storeIn: response
          getValue: 
            - key: astroDetails.result
              storeIn: status
      - if:
          condition: ${status}!= 'SUCCESS'
          then:
            - failTest:
                message: "API_FAILURE - Astro - Cannot add reward amount to paid member"
 
  - name: unified.us.functions.utils.astro.validateDriverTip
    flow:
      - log: -------[START- UTILITY] - Validate driver Tip [ ${orderNo}-${orderType} ] for [ ${status} ] status-------

      - storeIn:
          key: mappingData
          value: 20000

      # Driver Tip Verification [Total re-attempt - 3 times incase of failure]
      - loop:
          begin: 1
          end: 4
          storeIndex: retryMovementCount
          mode: increment
          flow:
            - log: ------------------------------------------------------------------------------------
            - log: Driver Tip Verification attempt - ${retryMovementCount}
            - log: ------------------------------------------------------------------------------------

            - arithmetic:
                expression: ${mappingData} * 3
                storeIn: mappingData

            # Trigger Validate Driver Tip for the required orderType
            - executeFunction:
                name: unified.us.functions.utils.astro.triggerValidateDriverTip

            # Wait for 5(each attempt) secs before validating if order movement trigger is successful or not
            - sleep:
                duration: 5000

            # Break re-attempt loop if Driver Tip Verification is successful
            - if:
                condition: ${responseVerifyDriverTipStatus} == 'SUCCESS'
                then:
                  - log: Driver Tip Has been Successfully Validated for Order [ ${orderNo} ] with [ ${status} ] status for fulfillment type [ ${orderType} ]
                  - break: true
                else:
                  - log: Retry after some wait time

      # Fail with appropriate error if Driver tip verification fails, even after all re-attempts
      - if:
          condition: ${responseVerifyDriverTipStatus} == 'SUCCESS'
          then:
            - log: -------[END-DRIVER TIP VERIFICATION UTILITY] - for order [ ${orderNo}-${orderType} ] on [ ${status} ] status-------
          else:
            - executeFunction:
                name: unified.us.functions.utils.getFailureMessage
            - failTest:
                message: "API_FAILURE - ASTRO - Driver Tip Validation for [ ${orderNo} ] failed due to ${responseDetails} ${failureMessage}"

  - name: unified.us.functions.utils.astro.triggerValidateDriverTip
    flow:
      - log: -------[START-TRIGGER VALIDATE DRIVER TIP UTILITY] - for Order [ ${orderNo}-${orderType} ] on [ ${status} ] status-------
      - loop:
          begin: 1
          end: 4
          storeIndex: retryTriggerCount
          mode: increment
          flow:
            - callAPI:
                url: http://astro.walmart.com/api/v2/teflon/order/${orderNo}/validateDriverTip
                header:
                  - key: segment
                    value: oaoh
                  - key: Content-Type
                    value: application/json
                readTimeout: 180000
                requestMethod: POST
                verifyResponseCode: 200
                retriesOnFail: 3
                retryDelay: 180000
                requestBody: '{"submittedTipAmount":${driverTipAmt},"orderType":"${orderType}","orderStatus":"${status}","tipType":"${tipType}"}'
                getValue:
                  - key: astroStatus
                    storeIn: responseVerifyDriverTipStatus
                  - key: astroDescription
                    storeIn: reason
            - log: "The ValidateDriverTip status is: ${responseVerifyDriverTipStatus}"
            - log: "The ASTRO STATUS: '${responseVerifyDriverTipStatus}'"
            - log: "The ASTRO MESSAGE: '${reason}'"
            - if:
                condition: ${responseVerifyDriverTipStatus} == 'SUCCESS'
                then:
                  - log: -------[END-TRIGGER UTILITY] - Verify Driver Tip successfully-------
                  - break: true
                else:
                  - failTest:
                      message: "API_FAILURE - ASTRO - [ ${orderNo} ] Unable to Verify Driver Tip ${reason}"


  - name: unified.us.functions.utils.astro.updateCommitmentModelScore
    flow:
      - log: Updating commitment model score for the account
      - log: $customerEmail
      - callAPI:
          url:  http://astro.walmart.com/api/v2/teflon/account/$customerEmail/p13n/datastudio?p13nConfig=WPLUST-COMMITMENT-MODEL-SCORE-OVERRIDE
          requestMethod: POST
          requestBody: '{"score": "${commitmentModelscore}"}'
          wait: 5000
          verifyResponseCode: 200
          header:
            - key: Content-Type
              value: application/json
            - key: version
              value: nextgen
          readTimeout: 30000 
          verifyResponseCode: 200
          verifyResponseBodyContains:
            - '"astroStatus":"SUCCESS"'
          getResponse:
            storeIn: response 
          getValue:
            - key: astroStatus
              storeIn: astroStatus
      - if:
          condition: ${astroStatus}!= 'SUCCESS'
          then:
            - failTest:
                message: "API_FAILURE - Astro - Unable to update the commitment model score ${response}"

  # [Utility is used to move order status for multiple fulfillment items at once]
  # [mandatory] orderNo     - Order number for which items needs to be moved
  # [mandatory] orderType1  - Fulfillment type in the order to be moved (1st item)
  # [mandatory] status1     - To which status the order needs to be moved (1st item)
  # [optional]  orderType2  - Fulfillment type in the order to be moved (2nd item)
  # [optional]  status2     - To which status the order needs to be moved (2nd item)
  # [optional]  orderType3  - Fulfillment type in the order to be moved (3rd item)
  # [optional]  status3     - To which status the order needs to be moved (3rd item)
  # -----------------------------------------------------------------------------------------------------------------------
  # Valid orderType-status combinations :
  # STORE_SCHEDULED_PICKUP/STORE_UNSCHEDULED_PICKUP - [PO Acknowledged/PO Pick Complete/PO Ready For Pickup/Customer Picked]
  # STORE_SCHEDULED_DELIVERY                        - [PO Acknowledged/PO Pick Complete/PO Out for Delivery/Delivered]
  # FC_DELIVERY/FC_DELIVERY_WPP                     - [Shipped/Delivered]
  # MP_DELIVERY/MP_WFS_DELIVERY                     - [PO Acknowledged/Shipped/Delivered]
  # -----------------------------------------------------------------------------------------------------------------------
  - name: unified.us.functions.utils.astro.setMultilineOrderStatus
    flow:
      # Creating arrayList of orderTypes required for order movement based on params sent
      - storeIn:
          key: arrayList
          value: '[ "${orderType1}"'
      - if:
          condition: ${orderType2} != null
          then:
            - storeIn:
                key: arrayList
                value: ${arrayList}, "${orderType2}"
            - if:
                condition: ${orderType3} != null
                then:
                  - storeIn:
                      key: arrayList
                      value: ${arrayList}, "${orderType3}"
                  - if:
                      condition: ${orderType4} != null
                      then:
                        - storeIn:
                            key: arrayList
                            value: ${arrayList}, "${orderType4}"
      - storeIn:
          key: arrayList
          value: '${arrayList}]'

      # Variable to store orderTypes which are successful in order movement.
      # Used to skip already successful types during re-attempt
      - storeIn:
          key: completedOrderType
          value: ''

      # Fetch wait time constant set in mapping file
      - executeFunction:
          name: us.functions.utils.getMappingValue
          params:
            - name: mappingVariable
              string: us.data.sleep.time

      # Multifulfillment order movement loop [Total re-attempt - 3 times incase of failure of atleast one orderType movement]
      - loop:
          begin: 1
          end: 4
          storeIndex: retryMovementCount
          mode: increment
          flow:
            - log: ------------------------------------------------------------------------------------
            - log: MultiOrder movement attempt - ${retryMovementCount}
            - log: ------------------------------------------------------------------------------------
            - storeIn:
                key: allMoved
                value: true

            - arithmetic:
                expression: ${mappingData} * 3
                storeIn: mappingData

            # Wait for 60/180/540(attempt-wise) secs before triggering the order movement if not successful in earlier attempt
            - log: Waiting for ${mappingData} seconds before order movement trigger on attempt - ${retryMovementCount}
            - sleep:
                duration: ${mappingData}

            # Order movement triggering for each of the orderTypes required
            - loop:
                each: ${arrayList}
                storeIndex: i
                storeElement: type
                flow:
                  - try:
                      flow:
                        # Skip trigger if current orderType is already moved to required status
                        - verifyValue:
                            identifier: ${completedOrderType}
                            contains: ${type}
                        - log: Skipping retry trigger for ${type} as order movement is already successful
                      catch:
                        flow:
                          # Storing appropriate status for order movement
                          - if:
                              condition: $i == 0
                              then:
                                - storeIn:
                                    key: status
                                    value: ${status1}
                              else:
                                - if:
                                    condition: $i == 1
                                    then:
                                      - storeIn:
                                          key: status
                                          value: ${status2}
                                    else:
                                      - storeIn:
                                          key: status
                                          value: ${status3}
                          # Trigger order movement if it is yet to be completed
                          - executeFunction:
                              name: us.functions.utils.astro.triggerOrderMovement
                              params:
                                - name: orderType
                                  string: ${type}
                                - name: status
                                  string: ${status}
            # Wait for 30 secs before validating if order movement trigger is successful or not
            - sleep:
                duration: 30000

            # Validating order movement for each of the orderTypes triggered earlier
            - storeIn:
                key: errorDetails
                value: ''
            - loop:
                each: ${arrayList}
                storeIndex: i
                storeElement: type
                flow:
                  - try:
                      flow:
                        # Skip validation if current orderType is already moved to required status
                        - verifyValue:
                            identifier: ${completedOrderType}
                            contains: ${type}
                        - log: Skipping retry verification for ${type} as order movement is already successful
                      catch:
                        flow:
                          # Storing appropriate status for order movement validation
                          - if:
                              condition: $i == 0
                              then:
                                - storeIn:
                                    key: status
                                    value: ${status1}
                              else:
                                - if:
                                    condition: $i == 1
                                    then:
                                      - storeIn:
                                          key: status
                                          value: ${status2}
                                    else:
                                      - storeIn:
                                          key: status
                                          value: ${status3}
                          # Validating order movement if it is yet to be completed
                          - executeFunction:
                              name: us.functions.utils.astro.validateOrderMovement
                              params:
                                - name: orderType
                                  string: ${type}
                                - name: status
                                  string: ${status}

                          # If order movement is successful, storing orderType in a variable containing all successful ones
                          - if:
                              condition: ${responseValidationStatus} == true
                              then:
                                - log: Order [ ${orderNo} ] moved to [ ${status} ] status for type [ ${type} ]
                                - storeIn:
                                    key: completedOrderType
                                    value: ${completedOrderType}${type}
                              else:
                                # Variable set to false if even one orderType movement is un-successful. Used for loop break if all are moved successfully
                                - storeIn:
                                    key: allMoved
                                    value: false
                                - executeNode:
                                    file: us/e2e-tests/helpers/jsonParser.js
                                    args:
                                      - value: ${errorDetails}
                                      - value: ${type}
                                      - value: add
                                      - value: ${responseDetails}
                                    getResponse:
                                      storeIn: errorDetails
                                - log: Error Details - ${errorDetails}

            # Break loop instead of re-attempt as all orderTypes are moved to required status
            - if:
                condition: ${allMoved}
                then:
                  - log: All orderTypes in order [ ${orderNo} ] moved to required status
                  - break: true

      # Fail with appropriate error if all orderTypes are not moved to required status even after all re-attempts
      - if:
          condition: ${allMoved} != true
          then:
            - failTest:
                message: "API_FAILURE - ASTRO - Order [ ${orderNo} ] movement through Astro API failed for few/all fulfillment types. Details- ${errorDetails}"
      - storeIn:
          key: completedOrderType
          value: ''
      - storeIn:
          key: orderType1
          value: 'null'
      - storeIn:
          key: orderType2
          value: 'null'
      - storeIn:
          key: orderType3
          value: 'null'

  # Adding subs to the SC scheduled orders during PO pick complete
  - name: unified.us.functions.utils.astro.subs.setOrderStatus
    flow:
      - log: Set subs order status to PO pick Complete
      - loop:
           begin: 1
           end: 4      
           storeIndex: j
           mode: increment
           flow:
            - callAPI:
                url: http://astro.walmart.com/api/v3/teflon/order/${orderNo}
                header:
                  - key: segment
                    value: oaoh
                  - key: Content-Type
                    value: application/json     
                readTimeout: 180000
                requestMethod: PUT
                wait: 15000
                verifyResponseCode: 200
                verifyResponseBodyContains:
                  - '"status":"SUCCESS"'
                retriesOnFail: 3
                retryDelay: 180000
                requestBody: ${payload}
                getValue:
                  - key: astroStatus
                    storeIn: astroStatus
            - sleep:
                duration: 200000
            - executeFunction:
                name: us.functions.utils.astro.validateOrderMovement
            - if:
                condition: ${responseValidationStatus} == true
                then:
                  - break: true
      - if:
          condition: ${responseValidationStatus} == true
          then:
            - log: -------[END-MOVE UTILITY] - Move order [ ${orderNo}-${orderType} ] to [ ${status} ] status-------
          else:
            - failTest:
                message
  
  
  - name: unified.us.functions.utils.astro.createAccountWithoutPhoneNumber
    flow:
      - log: Create Account
      - loop:
          begin: 1
          end: 4
          storeIndex: retryTriggerCount
          mode: increment
          flow:
            - callAPI:
                url: http://astro.walmart.com/api/v2/teflon/customer
                requestMethod: POST
                wait: 5000
                header:
                  - key: Content-Type
                    value: application/json
                  - key: segment
                    value: oaoh
                readTimeout: 30000 
                requestBody: ${payload}
                getValue:
                  - key: astroDetails.addPaymentPreferenceId
                    storeIn: addPaymentPreferenceId
                  - key: astroStatus
                    storeIn: astroStatus
                  - key: astroDetails.statusCode
                    storeIn: responseCode
                  - key: statusCode
                    storeIn: altResponseCode
                  - key: astroDescription
                    storeIn: errorMessage
                  - key: astroDetails.customerDetails.emailAddress
                    storeIn: astroEmail
          #requestBody: '{"firstName": "Astro","lastName": "Mobile","emailAddress": "$email","paymentMethods": ["VISA"],"postalAddress": {"address": "1350 Bacchus Dr","city": "San Jose","country": "USA","postalCode": "95122","state": "CA"},"password": "$password"}'
            - if:
                condition: ${astroStatus} == 'SUCCESS'
                then: 
                  - if:
                      condition: ${responseCode} == 200
                      then:
                        - log: $addPaymentPreferenceId
                        - if:
                            condition: ${withoutPayment}
                            then:
                              - executeFunction:
                                  name: us.functions.utils.astro.deletePaymentData
                            else:
                              - log: Account created successfully
                        - log: ------- Account created Successfully -------
                        - break: true
                else:
                  - log: TRIGGER RETRY ${retryTriggerCount} - Triggering account creation API again
                  - sleep:
                      duration: 20000

      - if:
          condition: ${astroStatus}!= 'SUCCESS'
          then:
            - if:
                condition: ${responseCode} == 400 || ${altResponseCode} == 400
                then:
                  - failTest:
                      message: "API_FAILURE - ASTRO - PAYLOAD ERROR. Payload used: ${payload}"
                else:
                  - failTest:
                      message: "API_FAILURE - ASTRO - Unable to create account. Error: ${errorMessage}"  


#Function to get the current price of an item
  - name: unified.us.functions.utils.astro.getItemPrice
    flow:
      - log: Getting the item price
      - callAPI:
          url: http://astro.walmart.com/api/v2/teflon/item/${item}?storeId=${storeId}
          requestMethod: GET
          wait: 5000
          verifyResponseCode: 200
          header:
            - key: Content-Type
              value: application/json
          readTimeout: 180000
          requestBody: '{}'
          verifyResponseBodyContains:
            - '"SUCCESS"'
          getValue:
            - key: astroStatus
              storeIn: getItemPriceStatus
            - key: astroDescription
              storeIn: status
            - key: astroDetails.currencyAmount
              storeIn: itemPrice
          retriesOnFail: 3
          retryDelay: 1000
      - log: ${getItemPriceStatus}
      - log: "Current price of an Item: $${itemPrice}"
      - if:
          condition: ${getItemPriceStatus}!= 'SUCCESS'
          then:
            - failTest:
                message: "API_FAILURE - Astro - Unable to Check the item price"

  #Astro Check GiftCard Balance API can be used to check GC Balance for all the Gift Cards mentioned on Astro Glass Teflon Golden Data page
  # [mandatory] ${PID}    - PID of card as parameter while calling the function
  - name: unified.us.functions.utils.checkGiftCardBalance
    flow:
      - log: Checking the Gift card balance
      - callAPI:
          url: http://astro.walmart.com/api/v2/teflon/updateGcBalance/PIH.pang.FDCGC.GIFTCARD.${PID}
          requestMethod: POST
          wait: 5000
          verifyResponseCode: 200
          header:
            - key: Content-Type
              value: application/json
          readTimeout: 180000
          requestBody: '{}'
          verifyResponseBodyContains:
            - '"SUCCESS"'
          getValue:
            - key: astroStatus
              storeIn: checkBalanceStatus
            - key: astroDescription
              storeIn: status
            - key: astroDetails.balanceamount.currencyAmount
              storeIn: gcBalance
          retriesOnFail: 3
          retryDelay: 1000
      - log: ${checkBalanceStatus}
      - log: ${status}
      - if:
          condition: ${checkBalanceStatus}!= 'SUCCESS'
          then:
            - failTest:
                message: "API_FAILURE - Astro - Unable to Check the Gift Card balance"

  #Astro Update GiftCard Balance API can be used to update GC Balance for all the Gift Cards mentioned on Astro Glass Teflon Golden Data page
  # [mandatory] ${PID}    - PID of card as parameter while calling the function
  - name: unified.us.functions.utils.addAmountToGiftCard
    flow:
      - log: Adding Amount to Gift Card
      - callAPI:
          url: http://astro.walmart.com/api/v2/teflon/updateGcBalance/PIH.pang.FDCGC.GIFTCARD.${PID}
          requestMethod: POST
          wait: 5000
          verifyResponseCode: 200
          header:
            - key: Content-Type
              value: application/json
          readTimeout: 180000
          requestBody: '{"addamount":$balance}'
          verifyResponseBodyContains:
            - '"SUCCESS"'
          getValue:
            - key: astroStatus
              storeIn: addBalanceStatus
            - key: astroDescription
              storeIn: status
          retriesOnFail: 3
          retryDelay: 1000
      - log: ${addBalanceStatus}
      - log: ${status}
      - if:
          condition: ${addBalanceStatus}!= 'SUCCESS'
          then:
            - failTest:
                message: "API_FAILURE - Astro - Unable to add balance to Gift Card"

  # PetRX - increase quantity and move Order
  - name: unified.us.functions.utils.astro.petrxOrder.increaseQtyandMoveOrder
    flow:
       - log: "Increase Quantity and Move Order for Petrx Order and Payload is as below:::: ${payload}"
       - loop:
           begin: 1
           end: 4      
           storeIndex: j
           mode: increment
           flow:
             - callAPI:
                url: http://astro.walmart.com/api/v3/teflon/order/${orderNo}
                header:
                  - key: Content-Type
                    value: application/json
                  - key: segment
                    value: oaoh
                readTimeout: 180000
                requestMethod: PUT
                wait: 15000
                verifyResponseCode: 200
                retriesOnFail: 3
                retryDelay: 180000
                requestBody: ${payload}
                getValue:
                  - key: astroStatus
                    storeIn: astroStatus

             - sleep:
                duration: 200000
             - executeFunction:
                name: us.functions.utils.astro.validateOrderMovement
             - if:
                condition: ${responseValidationStatus} == true
                then:
                   - log: -------[END-MOVE UTILITY] - Move order [ ${orderNo}-${orderType} ] to [ ${status} ] status-------
                else:
                  - failTest:
                      message: "API_FAILURE - ASTRO - Unable to move PetRX Order ${orderNo}-${orderType} to ${status}"

  - name: unified.us.functions.utils.astro.createAccount.versionTwo
    flow:
      - log: Create Account
      - log: ${payload}
      - loop:
          begin: 1
          end: 4
          storeIndex: retryTriggerCount
          mode: increment
          flow:
            - callAPI:
                url: https://astro-release.walmart.com/api/v2/teflon/customer
                requestMethod: POST
                wait: 5000
                header:
                  - key: Content-Type
                    value: application/json
                  - key: segment
                    value: oaoh
                  - key: tenant-id
                    value: elh9ie
                readTimeout: 30000 
                requestBody: ${payload}
                disableCertificateChecks: true
                getValue:
                  - key: astroDetails.addPaymentPreferenceId
                    storeIn: addPaymentPreferenceId
                  - key: astroStatus
                    storeIn: astroStatus
                  - key: astroDetails.statusCode
                    storeIn: responseCode
                  - key: statusCode
                    storeIn: altResponseCode
                  - key: astroDescription
                    storeIn: errorMessage
                  - key: astroDetails.customerDetails.phoneNumber
                    storeIn: astroPhoneNum
                  - key: astroDetails.customerDetails.emailAddress
                    storeIn: astroEmail
            - storeIn: 
                key: astroPhoneNumber
                value: "1${astroPhoneNum}"
            - if:
                condition: ${astroStatus} == 'SUCCESS'
                then:
                  - if:
                      condition: ${responseCode} == 200
                      then:
                        - log: $addPaymentPreferenceId
                        - if:
                            condition: ${withoutPayment}
                            then:
                              - executeFunction:
                                  name: us.functions.utils.astro.deletePaymentData
                            else:
                              - log: Account created successfully
                        - log: ------- Account created Successfully -------
                        - break: true
                else:
                  - log: TRIGGER RETRY ${retryTriggerCount} - Triggering account creation API again
                  - sleep:
                      duration: 20000

      - if:
          condition: ${astroStatus}!= 'SUCCESS'
          then:
            - if:
                condition: ${responseCode} == 400 || ${altResponseCode} == 400
                then:
                  - failTest:
                      message: "API_FAILURE - ASTRO - PAYLOAD ERROR. Payload used: ${payload}"
                else:
                  - failTest:
                      message: "API_FAILURE - ASTRO - Unable to create account. Error: ${errorMessage}"      