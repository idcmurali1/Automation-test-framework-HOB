functions:
  # Function to validate POS subtotal and estimated total
  - name: us.functions.functional.checkout.reviewOrder.validatePosTotals
    flow:
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.scrollDownToPOS
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.validatePOSSubtotal
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.validatePOSEstimatedTotal

  # Function to scroll down till the POS section
  - name: us.functions.functional.checkout.reviewOrder.scrollDownToPOS
    flow:
      - executeFunction:
          name: us.functions.utils.scrollIfNotVisible
          params:
            - name: identifier
              string: us.mappings.functional.checkout.reviewOrder.pos
            - name: direction
              string: down
            - name: scrollPosition
              string: center

  - name: us.functions.functional.checkout.reviewOrder.validatePOSSubtotal
    flow:
      - if:
          condition: ${platform} == 'iOS'
          then:
            - getString:
                identifier: us.mappings.functional.checkout.reviewOrder.pos.subTotalValue
                attribute: value
                storeIn: subTotalValue
          else:
             - getString:
                identifier: us.mappings.functional.checkout.reviewOrder.pos.subTotalValue
                attribute: text
                storeIn: subTotalValue
      - log: Subtotal value ${subTotalValue}
      - if:
          condition: ${itemCount} > 1
          then:
            - storeIn:
                key: itemSubtotalText
                value: (${itemCount} items)
          else:
            - storeIn:
                key: itemSubtotalText
                value: (${itemCount} item)
      - executeFunction:
          name:  us.functions.functional.utils.validateElementValue
          params:
            - name: identifierToVerify
              string: us.mappings.functional.checkout.reviewOrder.pos.subTotalLabel
            - name: identifierValueToVerify
              string: Subtotal ${itemSubtotalText}
            - name: toVerifyContent
              string: "false"
      - executeNode:
          file: us/functional-tests-transactions/helpers/validatePrice.js
          args:
            - value: ${subTotalValue}
          getResponse:
            storeIn: isSubtotalValid
      - log: isSubtotalValid ${isSubtotalValid}
      - if:
          condition: ${isSubtotalValid} != true
          then:
            - failTest:
                message: "Subtotal value is not displayed"
          else:
            - log: Subtotal amount is displayed
  # Function to validate the Estimated total label and Estimated total value in POS
  - name: us.functions.functional.checkout.reviewOrder.validatePOSEstimatedTotal
    flow:
      - if:
          condition: ${platform} == 'iOS'
          then:
            - getString:
                identifier: us.mappings.functional.checkout.reviewOrder.pos.estimatedTotalValue
                attribute: value
                storeIn: estTotalValue
          else:
             - getString:
                identifier: us.mappings.functional.checkout.reviewOrder.pos.estimatedTotalValue
                attribute: text
                storeIn: estTotalValue
      - log: Estimated total value ${estTotalValue}
      - executeFunction:
          name: us.functions.functional.utils.validateElementValue
          params:
            - name: identifierToVerify
              string: us.mappings.functional.checkout.reviewOrder.pos.estimatedTotalLabel
            - name: identifierValueToVerify
              string: Estimated Total
            - name: toVerifyContent
              string: "false"     
      - executeNode:
          file: us/functional-tests-transactions/helpers/validatePrice.js
          args:
            - value: ${estTotalValue}
          getResponse:
            storeIn: isEstTotalValid
      - log: isEstTotalValid ${isEstTotalValid}
      - if:
          condition: ${isEstTotalValid} != true
          then:
            - failTest:
                message: "Estimated total value is not displayed"
          else:
            - log: Estimated total amount is displayed
  # Function to validate the Bag fee, delivery from store slot fee and below threshold order minimum fee in POS
  - name: us.functions.functional.checkout.reviewOrder.validateScheduledDeliveryPOS
    flow:
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.scrollDownToPOS
      - verifyIdentifier:
          present:
            - identifier: us.mappings.functional.checkout.reviewOrder.verifyCheckoutPosBagFeeLabel
            - identifier: us.mappings.functional.checkout.reviewOrder.verifyCheckoutPosBagFeePending
            - identifier: us.mappings.functional.checkout.reviewOrder.pos.deliveryFromStoreLabel
      - if:
          condition: ${isBelowThreshold} == true
          then:
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.functional.checkout.reviewOrder.POS.threshold
          else:
            - verifyIdentifier:
                notPresent:
                  - identifier: us.mappings.functional.checkout.reviewOrder.POS.threshold
  
  - name: us.functions.functional.checkout.reviewOrder.validatePOSForSCPickup
    flow:
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.validatePosTotals
      - if:
          condition: ${isBelowThreshold}
          then:
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.functional.checkout.reviewOrder.pos.belowOrderMinimumLineItemPickup
          else:
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.functional.checkout.reviewOrder.pos.freePickup
            - verifyIdentifier:
                notPresent:
                  - identifier: us.mappings.functional.checkout.reviewOrder.pos.belowOrderMinimumLineItemPickup
  # NOTE Moved below functions to this new file as part of refactoring, functionality to be updated with latest
  # during unified test automation. Update to support both platforms
  - name: us.functions.functional.checkout.reviewOrder.pos.validateNoBelowOrderMinimumFeeForDigitalDelivery
    flow:
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.scrollDownToPOS
      - verifyIdentifier:
          notPresent:
            - identifier: us.mappings.functional.checkout.reviewOrder.pos.belowOrderMinimumFee

  - name: us.functions.functional.checkout.reviewOrder.pos.validateSubtotal.multipleItems
    flow:
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.scrollDownToPOS
      - verifyIdentifier:
          present:
            - identifier: us.mappings.functional.checkout.reviewOrder.pos.multipleItems.subtotal

  - name: us.functions.functional.checkout.reviewOrder.pos.validate3pSellerShippingFee
    flow:
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.scrollDownToPOS
      - verifyIdentifier:
          present:
            - identifier: us.mappings.functional.checkout.reviewOrder.pos.3pSellerShippingFeeLineItem
          label:
            - identifier: us.mappings.functional.checkout.reviewOrder.pos.3pSellerShippingFeeLineItem
              contains: $${shippingFee}

  - name: us.functions.functional.checkout.reviewOrder.pos.validateLocalMarketplaceDeliveryFee
    flow:
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.scrollDownToPOS
      - verifyIdentifier:
          present:
            - identifier: us.mappings.functional.checkout.reviewOrder.pos.localMarketplaceDeliveryLineItem
          label:
            - identifier: us.mappings.functional.checkout.reviewOrder.pos.localMarketplaceDeliveryLineItem
              contains: $9.95

  - name: us.functions.functional.checkout.reviewOrder.validatePOSRegulatoryFees
    flow:
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.scrollDownToPOS
      - verifyIdentifier:
          present:
            - identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&TaxesLabel
      - click:
          identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&TaxesLabel
      - verifyIdentifier:
          present:
            - identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&TaxesLabelTitle
      - storeIn:
          key: totalFees
          value: 0
      - if:
          condition: ${crv} == true
          then:
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&Taxes.crvFee
            - getString:
                identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&Taxes.crvFeeAmount
                attribute: value
                extractNumbers: true
                storeIn: fee
            - log: "totalFees: ${totalFees}, fee: ${fee}"
            - arithmetic:
                expression: ${totalFees} + ${fee}
                storeIn: totalFees
      - if:
          condition: ${battery} == true
          then:
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&Taxes.batteryFee
            - getString:
                identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&Taxes.batteryFeeAmount
                attribute: value
                extractNumbers: true
                storeIn: fee
            - log: "totalFees: ${totalFees}, fee: ${fee}"
            - arithmetic:
                expression: ${totalFees} + ${fee}
                storeIn: totalFees
      - if:
          condition: ${tire} == true
          then:
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&Taxes.tireRecyclingFee
            - getString:
                identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&Taxes.tireRecyclingFeeAmount
                attribute: value
                extractNumbers: true
                storeIn: fee
            - log: "totalFees: ${totalFees}, fee: ${fee}"
            - arithmetic:
                expression: ${totalFees} + ${fee}
                storeIn: totalFees
      - if:
          condition: ${coreCharge} == true
          then:
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&Taxes.coreChargeFee
            - getString:
                identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&Taxes.coreChargeFeeAmount
                attribute: value
                extractNumbers: true
                storeIn: fee
            - log: "totalFees: ${totalFees}, fee: ${fee}"
            - arithmetic:
                expression: ${totalFees} + ${fee}
                storeIn: totalFees
      - if:
          condition: ${ewaste} == true
          then:
            - verifyIdentifier:
                present:
                  - identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&Taxes.ewasteRecyclingFee
            - getString:
                identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&Taxes.ewasteRecyclingFeeAmount
                attribute: value
                extractNumbers: true
                storeIn: fee
            - log: "totalFees: ${totalFees}, fee: ${fee}"
            - arithmetic:
                expression: ${totalFees} + ${fee}
                storeIn: totalFees
      - click:
          identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&Taxes.gotItButton
      - verifyIdentifier:
          value:
            - identifier: us.mappings.functional.checkout.reviewOrder.pos.regulatoryFees&TaxesLabel
              contains: ${totalFees}

  - name: us.functions.functional.checkout.reviewOrder.pos.validateShippingAndPickup
    flow:
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.scrollDownToPOS
      - verifyIdentifier:
          present:
            - identifier: us.mappings.functional.checkout.reviewOrder.pos.pickupLabel
            - identifier: us.mappings.functional.checkout.reviewOrder.pos.shippingLabel
