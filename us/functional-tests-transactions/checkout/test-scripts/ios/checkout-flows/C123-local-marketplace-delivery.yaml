# Validate marketplace (3p) seller shipping for multiple items checkout flow
general:
  platform: ios
  tags: C123, unified-prod-functional-checkout-mp
  inherit:
    filesRunAll:
      - us-errors-helpers.yaml
  testCaseId: C123

scenarios:
  - name: Before
    before: true
    endTestOnFailure: true
    flow:
      # Set environment
      - executeFunction:
          name: us.function.utils.getEnvironmentValue
      # Set platform
      - executeFunction:
          name: functions.utils.setPlatformInfo
      - log: End Before test

      # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: "R2_SUBFLOW_PRE_TRANSACTION"
  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: Validate local marketplace items checkout flow
    endTestOnFailure: true
    flow:
      - log: Starting test "Validate local marketplace items checkout flow"

      # Navigate onboarding to home
      - executeFunction:
          name: us.functions.global.onboarding.navigateOnboardingToHome

      # Navigate to sign in page
      - executeFunction:
          name: us.functions.home.navigateHomeToSignIn

      # Sign in with LMP account
      - executeFunction:
          name: us.functions.global.authentication.signInAccount
          params:
            - name: email
              string: us.data.prod.checkout.lmp.ios.email
            - name: password
              string: us.data.prod.checkout.lmp.ios.password

      # Go back to Home
      - executeFunction:
          name: us.functions.global.navigation.accountToHome

      # Enable dummy payment through debug panel
      # - executeFunction:
      #     name: us.functions.functional.utils.placeOrder.enablePaymentByPass

      # XGo to cart and remove items in cart
#      - click:
#          identifier: us.mappings.navBar.cartIcon
#      - executeFunction:
#          name: us.functions.cart.removeAllCartItems
#      - executeFunction:
#          name: us.functions.cart.removeUnavailableItemsFromCart
#      - executeFunction:
#          name: us.functions.global.navigation.backNavigation
      
      # - executeFunction:
      #     name: us.functions.gic.module.selectAdress.fromSelector
      #     params:
      #       - name: deliveryAddress
      #         string: ${STREET_ADDR:5947 Katy St, Houston, TX, 77007}
      #       - name: deliveryAddressCard
      #         string: ${STREET_ADDR:5947 Katy St, Houston, TX, 77007}

      # Search item and add to cart
      # - executeFunction:
      #     name: unified.us.functions.search.searchItem
      #     params:
      #       - name: searchTerm
      #         string: us.data.prod.localMarketplace.item

#      - executeFunction:
#          name: unified.us.functions.functional.global.navigation.goToDeepLink
#          params:
#            - name: deepLinkUrl
#              string: us.data.checkout.localMarketplace.item
#
#      - executeFunction:
#          name: unified.us.functions.item.addItemToCart
        

      # - executeFunction:
      #     name: unified.us.functions.search.clickOnFirstItem
      #     params:
      #       - name: noAds
      #         string: "true"

      # - executeFunction:
      #     name: unified.us.functions.item.addItemToCart

      # - executeFunction:
      #     name: us.functions.functional.utils.addItemToCart
      #     params:
      #       - name: searchTerm
      #         string: us.data.prod.localMarketplace.item
      #       - name: expectedItemCount
      #         string: 1

      # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: "R2_SUBFLOW_TRANSACTION"
      # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

      # Go to cart
      - executeFunction:
          name: us.functions.global.navigation.toCartFromNavBar

      - executeFunction:
          name: us.functions.functional.cart.selectFulfillmentTab
          params:
            - name: fulfillmentTab
              string: delivery
      
      - executeFunction:
          name: us.functions.cart.continueToCheckout
      
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.validateDeliveryFromLocalStoreFulfillmentCard
          params:
            - name: fulfillmentText
              string: MPDelivery
            - name: fulfillmentItemCount
              string: 1
            - name: fulfillmentType
              string: MP_DELIVERY
      
      # Validate shipping fee in pos
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.pos.validateLocalMarketplaceDeliveryFee
      
      # Update and validate delivery instructions
      - scroll:
          direction: up
          untilIdentifier: us.mappings.reviewOrder.deliveryInstructions.title
          position: center
      
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.addDeliveryInstructions
          params:
            - name: houseType
              string: House
            - name: gateCode
              string: '560'
            - name: deliveryNotes
              string: Leave at front door
            - name: doorStepType
              string: Front door
      
      - executeFunction:
          name: us.functions.functional.checkout.reviewOrder.deliveryModule.validateDeliveryInstructionsModule
          params:
            - name: fulfillmentDeliveryInstructions
              string: House, 123456, Back door, Some delivery instructions.
      


      # # Selecting the shipping fulfillment option
      # - executeFunction:
      #     name: us.functions.cart.switchBetweenPickUpAndShipping
      #     params:
      #       - name: fulfillmentType
      #         string: shipping

      # # Continue to checkout or create new order
      # - executeFunction:
      #     name: us.functions.cart.continueToCheckout

      # # Validate shipping module
      # - executeFunction:
      #     name: us.functions.functional.checkout.reviewOrder.fulfillment.validateCardImageAndTitle
      #     params:
      #       - name: fulfillmentText
      #         string: Shipping
      #       - name: isMultipleItems
      #         string: true

      # # Validate seller shipping price for each 3p item
      # - executeFunction:
      #     name: us.functions.functional.checkout.reviewOrder.itemDetails.validate3pShippingMulitpleItemsWithShippingFees
      #     params:
      #       - name: numDifferentItems
      #         string: 2
      # # shippingFee stored from previous method
      # - log: "shippingFee: ${shippingFee}"

      

      # # Opt out of text message updates
      # - scroll:
      #     direction: up
      #     untilIdentifier: us.mappings.reviewOrder.mobileContactText
      #     position: center

      # - executeFunction:
      #     name: us.functions.functional.utils.optOutTextMessage

      # # Place order
      # - scroll:
      #     direction: up
      #     untilIdentifier: us.mappings.reviewOrder.paymentMethod.label

      # - executeFunction:
      #     name: us.functions.checkout.placeOrder
      #     params:
      #       - name: ebtExists
      #         string: false

      # # Validate order confirmation page
      # - executeFunction:
      #     name: us.functions.orderConfirmation.orderCreationValidation
      # - executeFunction:
      #     name: us.functions.orderConfirmation.getOrderNumber

      # - log: Order number ${orderNo}

      # # Validate shipping module in TY page
      # - scroll:
      #     direction: down
      #     untilIdentifier: us.mappings.functional.checkout.reviewOrder.fulfillmentCardTitle

      # - executeFunction:
      #     name:us.functions.checkout.thankyou.validateThankYouFulfillmentModule
      #     params:
      #       - name: fulfillmentText
      #         string: Shipping
      #       - name: fulfillmentType
      #         string: FC_DELIVERY
      #       - name: isMultipleItems
      #         string: true
      #       - name: fulfillmentItemCount
      #         string: 2

      # - storeIn:
      #      key: testStatus
      #      value: passed

  - name: After
    after: true
    useTestConfigErrors: false
    flow:
      - executeFunction:
          name: us.functions.utils.afterSteps
