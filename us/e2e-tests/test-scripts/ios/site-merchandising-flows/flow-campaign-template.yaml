general:
  platform: ios
  tags: ${tag}
  inherit:
    filesRunAll:
      - us-errors-helpers.yaml

scenarios:

  - name: Before
    before: true
    endTestOnFailure: true
    flow:

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_PRE_TRANSACTION'
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
    #Started Main Flow
  - name: Main
    flow:

      - log: Start Main

      - storeIn:
          key: statusPass
          value: ''

      - storeIn:
          key: statusFail
          value: ''

      - storeIn:
          key: homePagePass
          value: 'null'

      - storeIn:
          key: storyPagePass
          value: ''

      - storeIn:
          key: storyStatus
          value: 'FAIL'

      - storeIn:
          key: ssCount
          value: 0

      - storeIn:
          key: id
          value: ${id}

      - storeIn:
          key: campaignName
          value: ${name}

      - storeIn:
          key: campaignDeepLink
          value: ${deepLink}

      - storeIn:
          key: items
          value: ${itemList}

      - storeIn:
          key: allItems
          value: ${items}

      - storeIn:
          key: zone
          value: ${contentZone}

      - storeIn:
          key: productType
          value: ${productType}

      - storeIn:
          key: tempoModuleType
          value: ${tempo}

      - storeIn:
          key: category
          value: ${category}

      - storeIn:
          key: buildKey
          value: ${keyData}

      - storeIn:
          key: altCampaignLinks
          value: ${addCampaignLinks}

      - storeIn:
          key: onlyItemValidation
          value: ${onlyItemValidation}

      - storeIn:
          key: variantItemsDetails 
          value: ${variantItemsDetails}

      - storeIn:
          key: variantItemsIds
          value: ${variantItemsIds}

      # Navigate on-boarding to home
      - executeFunction:
          name: us.functions.global.onboarding.navigateOnboardingToHome
       
     # Open preview environment
      - if:
          condition: ${TEMPO_ENV} == 'preview'
          then:
            - openLink: walmart-debug://tempo?wm_preview=true&pageType=MobileHomescreen
            - executeFunction:
                name: us.functions.global.navigation.openDeepLink

      - executeNode:
            file: us/e2e-tests/helpers/validateDeepLinkFormat.js
            args:
            - value: ${campaignDeepLink}
            - value: skipCheck
            getResponse:
             storeIn: skipCase

      - if:
          condition: ${items} != 'NA' && ${item} != ' ' && ${skipCase} != 'skip'
          then:
            - executeFunction:
                name: us.functions.utils.getR2Array
                params:
                  - name: data
                    string: ${items}

            - executeFunction:
                name: us.functions.itemPage.fetchItemNamesOfList
                params:
                  - name: listOfItems
                    string: ${r2Array}

            # - executeFunction:
            #     name: us.functions.item.closeItemPage

      # Navigate to home page
      - executeFunction:
          name: us.functions.global.navigation.toTab
          params:
            - name: tabName
              string: Shop
      - if:
          condition:  ${onlyItemValidation} != true
          then:
            - executeFunction:
                name: us.functions.homePage.validateStoryLink

      - if:
          condition: ${campaignDeepLink} != 'not available'
          then:
            - executeFunction:
                name: us.functions.browsePage.openStoryPage

      - if:
          condition: ${items} != 'NA' && ${item} != ' ' && ${campaignDeepLink} != 'not available' && ${deepLinkStatus} != 'FAIL' && ${skipCase} != 'skip'
          then:
            - executeFunction:
                name: us.functions.browsePage.getItemNameInitialisation
            - if:
                condition: ${itemDisplayType} == 'grid'
                then:
                  - executeFunction:
                      name: us.functions.browsePage.fetchGridDisplayedItemNames
                else:
                  - if:
                      condition: ${itemDisplayType} == 'carousel'
                      then:
                        - executeFunction:
                            name: us.functions.browsePage.fetchCarouselDisplayedItemNames
                      else:
                        - if:
                            condition: ${itemDisplayType} == 'list'
                            then:
                              - executeFunction:
                                  name: us.functions.browsePage.fetchListDisplayedItemNames
                            else:
                                - if:
                                    condition: ${itemDisplayType} == 'mosaicGrid'
                                    then:
                                    - executeFunction:
                                        name: us.functions.browsePage.fetchMosaicGridDisplayedItemNames
            - executeFunction:
                name: us.mappings.utils.validateItemPresence
          else:
            - if:
                condition: ${skipCase} == 'skip'
                then:
                  - executeNode:
                      file: us/e2e-tests/helpers/validateDetailsForSM.js
                      args:
                        - value: skip
                        - value: blank
                        - value: ${allItems}
                      getResponse:
                        storeIn: itemStatus
                  - storeIn:
                     key: itemValidated
                     value: true

      # # performing After steps
      - if:
          condition: ${testStatus} != 'failed'
          then:
            - storeIn:
                key: testStatus
                value: passed

  - name: After
    after: true
    useTestConfigErrors: false
    flow:
      - executeFunction:
          name: us.functions.utils.sm.afterSteps
