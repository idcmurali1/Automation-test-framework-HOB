# TC-6: CFS Incremental Auth "scheduled pikcup" gift card order - add credit card at amends  

general:
  platform: ios
  tags: #us-golden-flows, C2719946, p2-ecomm-teflon-e2e
  inherit:
    filesRunAll:
      - us-errors-helpers.yaml
  testCaseId: C2719946

scenarios:

  - name: Before
    before: true
    endTestOnFailure: true
    flow:

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_PRE_TRANSACTION'
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      
      # Fetch 'lower-priced' substitutable item from items list
      - executeFunction:
          name: us.functions.utils.fetchFromDataList
          params:
            - name: email
              string: us.data.flow.cfs.android.gc.email 
            - name: itemType
              string: STORE_SCHEDULED_PICKUP
            - name: itemList
              string: us.data.flow.incrementalAuth.cfs.lowPrice.itemList
            - name: storeId
              string: 32144

      - storeIn:
          key: item1
          value: $itemFetched

      # Fetch 'medium-priced' substitutable item from items list
      - executeFunction:
          name: us.functions.utils.fetchFromDataList
          params:
            - name: email
              string: us.data.flow.cfs.android.gc.email    
            - name: itemType
              string: STORE_SCHEDULED_PICKUP
            - name: itemList
              string: us.data.flow.incrementalAuth.cfs.mediumPrice.itemList
            - name: storeId
              string: 32144

      - storeIn:
          key: item2
          value: $itemFetched


      # Fetch 'higher-priced' substitutable item from items list - CC+GC Amends
      - executeFunction:
          name: us.functions.utils.fetchFromDataList
          params:
            - name: email
              string: us.data.flow.cfs.android.gc.email   
            - name: itemType
              string: STORE_SCHEDULED_PICKUP
            - name: itemList
              string: us.data.flow.incrementalAuth.cfs.higherPrice.itemList
            - name: storeId
              string: 32144

      - storeIn:
          key: item3
          value: $itemFetched          

      # Astro clear cart
      - executeFunction:
          name: us.functions.utils.astro.clearCart
          params:
            - name: custEmail
              string: us.data.flow.cfs.android.gc.email

      # Check Gift Card balance and add if 
      - executeFunction:
          name: us.functions.checkGiftCardBalanceAndLoadIfZero
          params:
            - name: balance
              string: 100
            - name: PID
              string: eb6f1344-42c7-4a73-aa72-826a51e246d6.9083

  - name: Main
    endTestOnFailure: true
    flow:

      - log: Start Main

      #Navigate onboarding to home
      - executeFunction:
          name: us.functions.global.onboarding.navigateOnboardingToHome

      # Will take the user to the account menu from where the user can sign in to the app
      - executeFunction:
          name: us.functions.home.navigateHomeToSignIn

      # User signs in to the account
      - executeFunction:
          name: us.functions.global.authentication.signInAccount
          params:
            - name: email
              string: us.data.flow.cfs.android.gc.email
            - name: password
              string: us.data.flow.cfs.android.gc.password

      - executeFunction:
          name: us.functions.global.navigation.accountToHome
  
      - executeFunction:
          name: us.functions.home.rateDriverPopup

      - executeFunction:
          name: us.functions.gic.module.selectAdress.fromSelector
          params:
            - name: deliveryAddress
              string: ${STREET_ADDR:2476 Barlow Ave, San Jose, CA 95122}
            - name: deliveryAddressCard
              string: ${STREET_ADDR:2476 Barlow Ave, San Jose, CA, 95122}

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: Add substitutable lower and medium priced items - gift card tender
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *                        

      # Select Delivery intent from GIC
      - executeFunction:
          name: us.functions.gic.expandIfCollapsed
      - executeFunction:
          name: us.functions.gic.setFulfillment
          params:
            - name: option
              string: Pickup

      # Add item1 to the cart
      - executeFunction:
          name: us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://item/$item1
      - executeFunction:
           name: us.functions.item.addItemToCart
      - sleep:
          duration: 3000                         

      # Add item2 to the cart
      - executeFunction:
          name: us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://item/$item2
      - executeFunction:
           name: us.functions.item.addItemToCart
      - sleep:
          duration: 3000

      # Go to cart
      - executeFunction:
           name: us.functions.global.navigation.toCartFromNavBar

      - executeFunction:
          name: us.functions.cart.checkoutWithSlotBooking
          params:
            - name: tab
              string: pickup
            - name: page
              string: cart
            - name: slotDay
              string: dayAfter
            - name: slotIndex
              string: 4

      # Language updates under 'Adjustment Charge' for "gift-card + credit-card" order
      - executeFunction:
          name: us.functions.reviewOrder.incrementalAuth.adjustmentCharge

      - executeFunction:
          name: us.functions.checkout.placeOrder

      - executeFunction:
          name: us.functions.orderConfirmation.getOrderNumber

      # Go to home
      - executeFunction:
          name: us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://home
      - sleep:
          duration: 3000

      # Add item3 to the cart for existing amendable order
      - executeFunction:
          name: us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://item/$item3
      - executeFunction:
           name: us.functions.item.addItemToCart
      - sleep:
          duration: 3000

      - executeFunction:
          name: us.functions.global.navigation.toCartFromNavBar

      # Amends 'What is a temporary hold?' language and bottom-sheet verification
      - executeFunction:
          name: us.functions.cart.amendsPage.verifyTemporaryHold

      - executeFunction:
          name: us.functions.cart.addToExistingOrder

      - executeFunction:
          name: us.functions.amend.creditCard.InCart
          params:
            - name: cvv
              string: "111"

      - executeFunction:
          name: us.functions.amend.verify.itemAddedToOrder

      - executeFunction:
          name: us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://orders/$orderNo

      # ODP 'Temporary Hold' language and bottom-sheet verification
      - executeFunction:
          name: us.functions.orderDetails.incrementalAuth.verifyTemporaryHold

      - storeIn:
          key: testStatus
          value: passed
          
  - name: After
    after: true
    flow:
      - executeFunction:
          name: us.functions.utils.afterSteps
