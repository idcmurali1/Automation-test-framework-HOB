# TC-5: CFS Incremental Auth - scheduled delivery credit card only  

general:
  platform: ios
  tags: #us-golden-flows, C2719945, p2-ecomm-teflon-e2e
  inherit:
    filesRunAll:
      - us-errors-helpers.yaml
  testCaseId: C2719945

scenarios:

  - name: Before
    before: true
    endTestOnFailure: true
    flow:

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_PRE_TRANSACTION'
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

      
      # Fetch 'lower-priced' substitutable item from items list
      - executeFunction:
          name: us.functions.utils.fetchFromDataList
          params:
            - name: email
              string: us.data.flow.cfs.android.email 
            - name: itemType
              string: STORE_SCHEDULED_DELIVERY
            - name: itemList
              string: us.data.flow.incrementalAuth.cfs.lowPrice.itemList
            - name: storeId
              string: 32144

      - storeIn:
          key: item1
          value: $itemFetched

      
      # Fetch 'medium-priced' substitutable item from items list
      - executeFunction:
          name: us.functions.utils.fetchFromDataList
          params:
            - name: email
              string: us.data.flow.cfs.android.email    
            - name: itemType
              string: STORE_SCHEDULED_DELIVERY
            - name: itemList
              string: us.data.flow.incrementalAuth.cfs.mediumPrice.weighted.itemList
            - name: storeId
              string: 32144

      - storeIn:
          key: item2
          value: $itemFetched


      # Fetch 'medium-priced and weighted' substitutable item from items list
      - executeFunction:
          name: us.functions.utils.fetchFromDataList
          params:
            - name: email
              string: us.data.flow.cfs.android.email    
            - name: itemType
              string: STORE_SCHEDULED_DELIVERY
            - name: itemList
              string: us.data.flow.incrementalAuth.cfs.mediumPrice.itemList
            - name: storeId
              string: 32144

      - storeIn:
          key: item3
          value: $itemFetched          

      # Astro clear cart
      - executeFunction:
          name: us.functions.utils.astro.clearCart
          params:
            - name: custEmail
              string: us.data.flow.cfs.android.email

  - name: Main
    endTestOnFailure: true
    flow:

      - log: Start Main

      #Navigate onboarding to home
      - executeFunction:
          name: us.functions.global.onboarding.navigateOnboardingToHome

      # Will take the user to the account menu from where the user can sign in to the app
      - executeFunction:
          name: us.functions.home.navigateHomeToSignIn

      # User signs in to the account
      - executeFunction:
          name: us.functions.global.authentication.signInAccount
          params:
            - name: email
              string: us.data.flow.cfs.android.email
            - name: password
              string: us.data.flow.cfs.android.password

      - executeFunction:
          name: us.functions.global.navigation.accountToHome
  
      - executeFunction:
          name: us.functions.home.rateDriverPopup

      - executeFunction:
          name: us.functions.gic.module.selectAdress.fromSelector
          params:
            - name: deliveryAddress
              string: ${STREET_ADDR:2476 Barlow Ave, San Jose, CA 95122}
            - name: deliveryAddressCard
              string: ${STREET_ADDR:2476 Barlow Ave, San Jose, CA, 95122}

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'Add substitutable lower and medium priced items'
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *                        

      # Select Delivery intent from GIC
      - executeFunction:
          name: us.functions.gic.expandIfCollapsed
      - executeFunction:
          name: us.functions.gic.setFulfillment
          params:
            - name: option
              string: Delivery                             

      # Add item1 to the cart
      - executeFunction:
          name: us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://item/$item1
      - executeFunction:
           name: us.functions.item.addItemToCart
      - sleep:
          duration: 3000                         

      # Add item2 to the cart
      - executeFunction:
          name: us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://item/$item2
      - executeFunction:
           name: us.functions.item.addItemToCart
      - sleep:
          duration: 3000         

      # Go to cart
      - executeFunction:
           name: us.functions.global.navigation.toCartFromNavBar

      # Verify cart
      - executeFunction:
          name: us.functions.cart.verifyCardDetails
          params:
            - name: fulfillmentText
              string: Delivery

      - executeFunction:
          name: us.functions.cart.checkoutWithSlotBooking
          params:
            - name: tab
              string: delivery
            - name: page
              string: cart
            - name: slotDay
              string: today
            - name: slotIndex
              string: 4

      - executeFunction:
          name: us.functions.checkout.reviewOrder.verifyCardDetails
          params:
            - name: fulfillmentText
              string: Delivery

      # POS & Wallet 'Temporary Hold' language and bottom-sheet verification
      - executeFunction:
          name: us.functions.reviewOrder.incrementalAuth.verifyTemporaryHold

      - executeFunction:
          name: us.functions.checkout.placeOrder

      - executeFunction:
          name: us.functions.orderConfirmation.getOrderNumber

      # Go to home
      - executeFunction:
          name: us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://home
      - sleep:
          duration: 3000

      # Add item3 to the cart for existing amendable order
      - executeFunction:
          name: us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://item/$item3
      - executeFunction:
           name: us.functions.item.addItemToCart
      - sleep:
          duration: 3000

      - executeFunction:
          name: us.functions.global.navigation.toCartFromNavBar

      # Amends cart page 'Temporary Hold' language and bottom-sheet verification
      - executeFunction:
          name: us.functions.cart.amendsPage.verifyTemporaryHold

      - executeFunction:
          name: us.functions.cart.addToExistingOrder

      - executeFunction:
          name: us.functions.amend.creditCard.InCart
          params:
            - name: cvv
              string: "111"

      - executeFunction:
          name: us.functions.amend.verify.itemAddedToOrder

      - executeFunction:
          name: us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://orders/$orderNo

      # ODP 'Temporary Hold' language and bottom-sheet verification
      - executeFunction:
          name: us.functions.orderDetails.incrementalAuth.verifyTemporaryHold

      - storeIn:
          key: testStatus
          value: passed
          
  - name: After
    after: true
    flow:
      - executeFunction:
          name: us.functions.utils.afterSteps                                                                    