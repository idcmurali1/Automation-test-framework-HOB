# TC1 and TC11 Post Transaction Drone Delivery - Order Details Page, Purchase History Page, and Live Order Tracking Page verification

general:
  platform: ios
  tags: #us-golden-flows, C2715041, p2-ecomm-teflon-e2e
  inherit:
    filesRunAll:
      - us-errors-helpers.yaml
  testCaseId: C2715041
  metadata:
    - name: scenarioId
      string: 

scenarios:

  - name: Before
    before: true
    endTestOnFailure: true
    flow:

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_POST_TRANSACTION'
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

 #***************************************************************************************************************

  # Astro - Create order 

 #***************************************************************************************************************
      
      # Fetch stock available items using fetch API
      # Drone item list needs to be updated
      - executeFunction:
           name: us.functions.utils.fetchFromDataList 
           params:
             - name: email
               string: us.data.flow.drone.ios.email      
             - name: itemType
               string: DRONE_DELIVERY
             - name: itemList
               string: us.data.drone.delivery.itemList
      - storeIn:
          key: item1
          value: $itemFetched

      # This will be updated based on payload requirements - order creation via Astro is WIP
      - executeFunction:
          name: us.functions.utils.astro.createOrder
          params:
            - name: payload
              string: us.data.droneDelivery.ios.createOrderPayload                          

  - name: Main
    flow:
      - log: Start Main

      # Navigate onboarding to home
      - executeFunction:
          name: us.functions.global.onboarding.navigateOnboardingToHome
  
      # Navigate to sign in page
      - executeFunction:
          name: us.functions.home.navigateHomeToSignIn

      - executeFunction:
          name: us.functions.global.authentication.signInAccount
          params:
              - name: email
                string: us.data.flow.drone.ios.email
              - name: password
                string: us.data.flow.drone.ios.password
  
      # Deeplink into order details page
      - executeFunction:
          name: us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://orders/$orderNo

      # Move order to SHIPPED via Astro API
      - executeFunction:
          name: us.functions.utils.astro.getOrderStatus
          params:
            - name: orderNo
              string: ${orderNo}
      - executeFunction:
           name: us.functions.utils.astro.setOrderStatus
           params:
            - name: orderNo
              string: ${orderNo}
            - name: orderType
              string: DRONE_DELIVERY
            - name: status
              string: Shipped

      # Deeplink into order details page
      - executeFunction:
          name: us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://orders/$orderNo              

      # Verify Drone order - shipped state
      - executeFunction:
          name: us.functions.orderDetails.verifyDroneCardDetails

      # Move order to DELIVERED via Astro API
      - executeFunction:
          name: us.functions.utils.astro.getOrderStatus
          params:
            - name: orderNo
              string: ${orderNo}
      - executeFunction:
           name: us.functions.utils.astro.setOrderStatus
           params:
            - name: orderNo
              string: ${orderNo}
            - name: orderType
              string: DRONE_DELIVERY
            - name: status
              string: Delivered

      # Deeplink into order details page
      - executeFunction:
          name: us.functions.global.navigation.goToDeepLink
          params:
            - name: deepLinkUrl
              string: walmart://orders/$orderNo

      # Verify Drone order - delivered state
      - executeFunction:
          name: us.functions.orderDetails.deliveredStatus.verifyDroneOrder
          
      - storeIn:
          key: testStatus
          value: passed

  - name: After
    after: true
    flow:
      - executeFunction:
          name: us.functions.utils.afterSteps