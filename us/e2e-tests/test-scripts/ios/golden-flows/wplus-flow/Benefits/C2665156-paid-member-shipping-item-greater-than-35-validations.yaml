#====================================================Author: Amar Kumar (a0k05n4)======================================================

general:
  platform: ios
  tags:  C2665156, us-golden-flows-wplus, p0-wplus-teflon-e2e
  testCaseId: C2665156
  inherit:
    filesRunAll:
      - us-errors-helpers.yaml
  metadata:
    - name: scenarioId
      string: 186, WP012

scenarios:

  - name: Before
    before: true
    endTestOnFailure: true
    flow:
      #- executeFunction:
      #    name: us.functions.utils.astro.clearCart
      #    params:
      #      - name: custEmail
      #        string: us.data.fsnm.email

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_PRE_TRANSACTION'
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: Main
    flow:

     - log: Start Main
     - try:
        flow:
         - getTimestamp:
            asDate: false
            storeIn: timestamp

         - storeIn:
            key: customerEmail
            value: wplususer${timestamp}@walmart.com

        # Create Wplus Trial Account and convert to Paid using astro api
         - executeFunction:
             name: us.functions.utils.astro.createTrialAccountConvertToPaid
             params:
                - name: email
                  string: $customerEmail
                - name: payload
                  string: us.data.createWplusAccountPayload.annual
            

      # Navigate onboarding to home
         - executeFunction:
            name: us.functions.global.onboarding.navigateOnboardingToHome

     # Navigate to sign in page
         - executeFunction:
            name: us.functions.home.navigateHomeToSignIn #us.functions.wplus.navigateHomeToSignIn

      #create new account
         - executeFunction:
             name: us.functions.global.authentication.signInAccount
             params:
               - name: email
                 string: ${customerEmail} #us.data.fsnm.email
               - name: password
                 string: E2epassword$ #us.data.fsnm.password

         - executeFunction:
            name: us.functions.global.navigation.accountToHome

        #Close W+ bottomsheet on home page
         - executeFunction:
             name: us.test.functions.utils.closeWplusPrompt.homeScreen
      


         - executeFunction:
              name: us.functions.home.location.updateStore
              params:
                 - name: address
                   string: ${STREET_ADDR:777 Story Rd}
                 - name: ZIP_CODE
                   string: ${ZIP_CODE:95122} 

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
         - log: 'R2_SUBFLOW_TRANSACTION'
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

         - executeFunction:
            name: us.functions.gic.changeFulfillment
            params:
             - name: option
               string: Shipping

        #  - executeFunction:
        #     name: us.functions.utils.getSearchableItem 
        #     params:
        #       - name: source
        #         string: astro  
        #       - name: itemType
        #         string: FC_DELIVERY
        #       - name: storeId
        #         string: 32144
        #       - name: itemFilter #itemList
        #         string: greaterThan35 #us.data.greaterThan35shipping.itemLists

        #     # Add item to cart from deeplink
        #  - executeFunction:
        #     name: us.functions.global.navigation.goToDeepLink
        #     params:
        #       - name: deepLinkUrl
        #         string: ${deeplinkURl} 
                  
         - executeFunction:
            name: us.functions.item.deepLink.checkItemAvailable
            params:
              - name: itemArray
                string: us.data.greaterThan35shipping.itemLists

         - executeFunction:
             name: us.functions.item.addItemToCart

      # Navigating to cart
         - executeFunction:
            name: us.functions.global.navigation.toCartFromNavBar

      # Scrolling to top of cart
         - executeFunction:
             name: us.functions.cart.scrollToTopOfCart

         - executeFunction:
              name: us.functions.cart.switchBetweenPickUpAndShipping
              params:
                - name: fulfillmentType
                  string: shipping

         - executeFunction:
             name: us.functions.cart.verifyCardDetails
             params:
               - name: fulfillmentText
                 string: Shipping          
               - name: altFulfillmentText
                 string: Free shipping

      # Validaing that the minimum order fee is waived off for the 3+ shipping item
         - executeFunction:
             name: us.functions.wplus.cart.chargeWaiveOffValidation
             params:
               - name: cartType
                 string: fcOnly
               - name: storeOrderType
                 string: none

      # Navigating to the Review Order page
         - executeFunction:
            name: us.functions.cart.continueToCheckout

        # - executeFunction:
        #     name: us.functions.cart.handleItemUpdatesBottomTray

      # Verifying that the minimum order charge is waived off for the W+ Customer in Review Order page
         - executeFunction:
            name: us.functions.checkout.reviewOrder.verifyCardDetails
            params:
              - name: fulfillmentText
                string: Shipping
              - name: altFulfillmentText
                string: Free shipping

         - executeFunction:
            name: us.functions.wplus.reviewOrder.chargeWaiveOffValidation
            params:
             - name: basketType
               string: fcOnly
             - name: storeOrderType
               string: none

         - executeFunction:
            name: us.functions.checkout.confirmCvvBeforePlaceOrder
            params:               
              - name: cvv
                string: 111

         - executeFunction:
            name:  us.functions.checkout.confirmCvvAndPlaceOrder

         - executeFunction:
            name:  us.functions.checkout.placeOrderAgainIfError 

         - executeFunction:
                name: us.functions.orderConfirmation.ratings

         - executeFunction:
            name: us.functions.wplus.orderConfirmation.chargeWaiveOffValidation 
            params:
              - name: basketType
                string: fcOnly
              - name: storeOrderType
                string: none  

    # performing After steps
         - storeIn:
            key: testStatus
            value: passed

  - name: After
    after: true
    useTestConfigErrors: false
    flow:
      - executeFunction:
          name: us.functions.utils.afterSteps              