inherit: 'job:///glass-mobile-app-automation/looper-base:.looper.yml'

gitShallowDepth: 10 

parameters:
  - TEST_TAGS: { type: string }
  - SAUCE_APP: { type: string }
  - DEPENDENCY_PROFILE: { type: string }
  - POST_TO_SPLUNK: { type: string }
  - APP_BUILD_BRANCH: { type: string }
   
envs:
  global:
    variables:
      MARKET: us
      APP_PLATFORM: android
      SLACK_CHANNEL: r2-glass-test-result
      POST_TO_ES: true
      TEST_TAGS: us-order-creation
      R2_VERIFIER_PATH: "./us/e2e-tests"


  # Environment profiles can be specified here with specific environment variable values.
  env_android_teflon:
    variables:
      TEST_SESSION_ID: '%{(Math.abs(new(java.util.Random).nextInt()) % 100000000 + 1)}'
      DEPENDENCY_FILE_NAME: us/e2e-tests/dependencies/android/android-default.yaml
      GLASS_ENV: teflon
      MAPPING_LABELS: teflon

flows:
  run_tests:
    - call: build(env_android_teflon)

  run_create_items:
      - declare(APP_VERSION)
      - call: setup
      - shell: node ./us/e2e-tests/helpers/create-item-anytimedata.js

  setup:
    - hygieia.publishBuild()
    - shell (name Remove node_modules): |
        rm -frv node_modules
    - shell (name npm cache clear): |
        npm cache clear --force
    - shell (name sleep 10): |
        sleep 10
    - shell (name npm install): |
        npm install
    - if: |
        %{USE_CUSTOM_R2_JAR == 'false'}
      then:
        - shell (name download r2 binary): |
            npm run download-r2
      else:
        - shell: echo Using custom R2 jar

  get_app_version:
    - if: |
        %{APP_PLATFORM == 'android'}
      then:
        - var(APP_VERSION):
            - shell  (name Get App Version): head ${MARKET}/app-versions/${APP_BUILD_BRANCH}/android.txt
      else:
        - var(APP_VERSION):
            - shell  (name Get App Version): head ${MARKET}/app-versions/${APP_BUILD_BRANCH}/ios.txt
