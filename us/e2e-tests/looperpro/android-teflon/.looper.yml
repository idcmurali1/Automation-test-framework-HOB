inherit: 'job:///glass-mobile-app-automation/looper-base:.looper.yml'

gitShallowDepth: 10

parameters:
  - TEST_TAGS: { type: string }
  - SAUCE_APP: { type: string }
  - DEPENDENCY_PROFILE: { type: string }
  - POST_TO_SPLUNK: { type: string }
  - APP_BUILD_BRANCH: { type: string }

envs:
  global:
    variables:
      MARKET: us
      APP_PLATFORM: android
      SLACK_CHANNEL: r2-glass-test-result
      POST_TO_ES: true
      POST_TO_ANIVIA: true
      TESTRAIL_PLAN_ID: 796378
      APPLITOOLS_API_KEY: ENC[Rt+/oXg4fNf9b2Pq2MQ47frfGB42KVDp7l7/tQ/1na985VV7Ia42QMgDDOppIoaDTWfXJmsQW0Imo7rpXjXaQQ==]
      R2_VERIFIER_PATH: "./us/e2e-tests"

  # Environment profiles can be specified here with specific environment variable values.
  env_android_teflon:
    variables:
      TEST_SESSION_ID: '%{(Math.abs(new(java.util.Random).nextInt()) % 100000000 + 1)}'
      DEPENDENCY_FILE_NAME: us/e2e-tests/dependencies/android/android-default.yaml
    #   DEPENDENCY_PROFILE: looper
      GLASS_ENV: teflon
      MAPPING_LABELS: teflon

  env_android_spanish_teflon:
    variables:
      TEST_SESSION_ID: '%{(Math.abs(new(java.util.Random).nextInt()) % 100000000 + 1)}'
      DEPENDENCY_FILE_NAME: us/e2e-tests/dependencies/android/android-default.yaml
    #   DEPENDENCY_PROFILE: looper
      GLASS_ENV: teflon
      MAPPING_LABELS: spanish_teflon_e2e

flows:
  run_tests:
    - call: build(env_android_teflon)

  run_spanish_tests:
    - call: build(env_android_spanish_teflon)

  run_pii_tests:
    - call: build_pii_check(env_android_teflon)

  run_tests_quantum:
      - call: build_quantum(env_android_teflon)

  build_quantum:
    - node(label = linux, isolation = except_project, ws = exclusive, group = '${APP_PLATFORM} - ${TEST_TAGS}'):
        try:
          - declare(APP_VERSION)
          - call: setup
          - call: get_app_version
          - call: get_repository_build
          - call: return_sauce_app_location
          - call: get_build_app_version
          - call: execute_test
          - shell: node ./us/e2e-tests/helpers/generateQuantumReport.js
          - if: |
              %{GLASS_ENV == 'teflon'}
            then:
              - call: check_pii_data
          - call: generate_sauce_labs_build_url
          - call: publish_report
          # - shell: node ./us/e2e-tests/helpers/calculateAvgTestTime.js
          - call: get_test_failures
          - var(TEST_RUN_STATUS = $TEST_RUN_PASSED)
        catch:
          - var(TEST_RUN_STATUS = $TEST_RUN_FAILED)
          - shell: exit 1
        finally:
          - call: slack_test_run_helper
          - call: post_test_results_json_to_es
          - call: post_test_results_json_to_splunk
          - call: update_test_results_to_xray
          - if: |
              %{GLASS_ENV == 'teflon'}
            then:
              - call: check_pii_failure

  get_app_version:
    - if: |
        %{APP_PLATFORM == 'android'}
      then:
        - var(APP_VERSION):
            - shell  (name Get App Version): head ${MARKET}/app-versions/${APP_BUILD_BRANCH}/android.txt
      else:
        - var(APP_VERSION):
            - shell  (name Get App Version): head ${MARKET}/app-versions/${APP_BUILD_BRANCH}/ios.txt
