# ================================================================================================================================
# TC: 004
# Flow: TC-004: Items:  Associate account + 2P item + CC
# ================================================================================================================================

general:
  testCaseId: C2720548
  tags: C2720548 #, p1-mx-ea-teflon, p1-bodega-ea-teflon, p1-mx-ea-prod, p1-bodega-ea-prod

scenarios:
  - name: Before
    before: true
    endTestOnFailure: true
    flow:

      - executeFunction:
          name: functions.utils.setMarketInfo

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_PRE_TRANSACTION'
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
  - name: Main
    flow:


      - if: 
          condition: ${platform} == 'Android' 
          then:
            - storeIn:
                key: emailId
                value: data.wcp027.android.email
      - if: 
          condition: ${platform} == 'iOS'
          then:
            - storeIn:
                key: emailId
                value: data.wcp027.ios.email
      - storeIn:
          key: password
          value: data.wcp027.loginPassword

      # Onboard to aplication and select EA options.
      - executeFunction:
          name: functions.onboardingToHomePage.usingPostalCode
          params:
            - name: PostalCode
              string: data.onboarding.userPostalCode
            - name: ShoppingExperience
              string: data.onboarding.onlineExclusiveStore

      # Navigate and validate homepage.
      - executeFunction:
          name: functions.homePage.assertPageLoaded

      # Click on login and select sign in.
      - executeFunction:
          name: functions.global.tapAccountBtn

      - executeFunction:
          name: functions.accountPage.tapSignInBtn

      # Login with existing user.
      - executeFunction:
          name: functions.loginPage.userAuthentication
          params:
            - name: userEmail
              string: ${emailId}
            - name: userPassword
              string: data.wcp027.loginPassword

      # Search for item and validate if search results are displayed.
      - executeFunction:
          name: functions.global.tapShopBtn

      - executeFunction:
          name: functions.global.gic.selectDeliveryIntent
          params:
            - name: page
              string: home
      #Search for item and validate if search results are displayed.

      - executeFunction:
          name: functions.cartPage.clearCart

      - executeFunction:
          name: functions.searchPage.addToCartUsingItemArray
          params:
            - name: productArray
              string: data.globalShared_2PRegularItems

      # Go to Cart
      - executeFunction:
          name: functions.global.tapCartIcon

      # Go to checkout and handle address pop up
      - executeFunction:
          name: functions.cartPage.tapContinueToCheckoutBtn

      - executeFunction:
          name: functions.addAddressBottomSheet.handleSelectAddressPopUp
          params:
            - name: coloniaName
              string: data.defaultAddress.coloniaName

      - executeFunction:
          name: functions.checkoutPage.applyPromoCode
          params:
            - name: accountType
              string: data.global.accountType

      - if:
          condition: ${environment} == 'Teflon'
          then:
            - executeFunction:
                name: functions.checkoutPage.addCVV
                params:
                  - name: CVV
                    string: data.global.card.cvv.123
      
      - executeFunction:
          name: functions.checkoutPage.validateMoneyBoxField
          params:
            - name: moneyBoxFieldName
              string: ${promoCodeText}

      # Click Place Order
      - if:
          condition: ${environment} == 'Teflon'
          then:
            - executeFunction:
                name: functions.checkoutPage.tapPlaceOrderButton

# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_POST_TRANSACTION'
# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - if:
          condition: ${environment} == 'Teflon'
          then:
            - executeFunction:
                name: functions.thankYouPage.verifyThankYouPageDisplayed