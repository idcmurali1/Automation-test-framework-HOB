#######################################################################################################################
#
# TEST CASE DETAILS: 
#
#   TC - INEP-464
#       Flow : Place an order with multiple 3P items and complete fulfilment
#    
#   CONFLUENCE TRACKING DASHBOARD:
#     https://confluence.walmart.com/display/COMM/WCP+Merging+Hallways+-+Weekly+Summary#25049188467b442a39856942ffbf14209cc3ea19a5
#
#   JIRA OPIF TC:
#     https://jira.walmart.com/browse/OPIF-190415
#
#   Test Ticket
#     https://jira.walmart.com/browse/INEP-412
#
#   INEP Ticket
#     https://jira.walmart.com/browse/INEP-464
#
#######################################################################################################################

general:
  testCaseId: INEP-464
  tags: INEP-464, OPIF-190415, p1-mh-opif-teflon-d-feb, p1-mh-opif-teflon
  combineScenarios: true

scenarios:

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
#   B E F O R E   S C E N A R I O
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
  - name: Before
    before: true
    endTestOnFailure: true
    flow:

      - log: "BEFORE SCENARIO"

      - executeFunction:
          name: functions.utils.setMarketInfo

      - log: "BEFORE SCENARIO END"
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
#   M A I N   S C E N A R I O
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: "Place an order with multiple 3P items and complete fulfilment"
    flow:

      # Create account using astro api.
      - log:
          message: PREREQUISITE — Creating user account using Astro API...
          color: PURPLE_BOLD_BRIGHT 
      - executeFunction:
          name: functions.astroApi.createNewAccountWithCreatePayload

      # Create order using astro api.
      - log:
          message: PREREQUISITE — Creating order using Astro API...
          color: PURPLE_BOLD_BRIGHT 
      - executeFunction:
          name: functions.astroApi.createOrder
          params:
            - name: payload
              string: data.mh.createOrderPayload.multiple3Pitem # Param -> ${userEmail}

      # Onboard to application..
      - log:
          message: "Onboard to the application.."
          color: PURPLE_BOLD_BRIGHT        
      - executeFunction:
          name: functions.onboardingToHomePage.usingPostalCode
          params:
            - name: PostalCode
              string: data.onboarding.userPostalCode
            - name: ShoppingExperience
              string: data.onboarding.onlineExclusiveStore

      # Click on login and select sign in..
      - log:
          message: "Click on Login and Select Sign in.."
          color: PURPLE_BOLD_BRIGHT 
      - executeFunction:
          name: functions.global.tapAccountBtn
      - executeFunction:
          name: functions.accountPage.tapSignInBtn

      # Login with existing user user.
      - log:
          message: "Login with existing user using password as authentication method and ensure user is logged in"
          color: PURPLE_BOLD_BRIGHT       
      - executeFunction:
          name: functions.loginPage.userAuthentication
          params:
            - name: userEmail
              string: ${userEmail}
            - name: userPassword
              string: data.global.password.Password2
 # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_POST_TRANSACTION'
 # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

     # Navigate to ODP and verify page displayed..
      - log:
          message: "Navigate to ODP and verify page displayed.."
          color: PURPLE_BOLD_BRIGHT
      - executeFunction:
          name: functions.global.navigateToODPUseDeeplink    
          params:
            - name: returnedOrderNumber
              string: ${returnedOrderNumber}                

    # Validate ordered items are shown in order details and qty is correct..
      - log:
          message: "Validate ordered items are shown in order details and qty is correct.."
          color: PURPLE_BOLD_BRIGHT
      - executeFunction:
          name: functions.orderDetailPage.verifySectionDisplayed
      - executeFunction:
          name: functions.orderDetailPage.verifyDeliveryType
          params:
            - name: expectedDeliveryType
              string: data.global.deliveryText.delivery

      - executeFunction:
          name: functions.orderDetailPage.verifyItemDetails
          params:
            - name: 3P_item
              string: true

      # Validate Money Box
      - executeFunction:
          name: functions.orderDetailPage.validateMoneybox
          
      - executeFunction:
          name: functions.orderDetailPage.verifyQuantityPerLine 
          params:
            - name: lineItem
              string: "1"
            - name: quantity
              string: data.mh.inep464.totalCountItemsInOrder

      - executeFunction:
          name: functions.orderDetailPage.verifyQuantityPerLine 
          params:
            - name: lineItem
              string: "2"
            - name: quantity
              string: data.mh.inep464.totalCountItemsInOrder

      # Verify order status (Preparing/Preparando)..
      - log:
          message: "Verify order status (Preparing/Preparando).."
          color: PURPLE_BOLD_BRIGHT
      - executeFunction:
           name: functions.orderDetailPage.scrollUpToSection
           params:
             - name: section
               string: orderDetailPage.statusTracker # <- Tracker view
      - executeFunction:
          name: functions.orderDetailPage.verifyOrderStatusInOrderTracker
          params:
            - name: orderStatus
              string: data.orderTracker.status.preparing

      # Verify request cancellation button is displayed when order is in "preparing.."
      - log:
          message: "Verify request cancellation button is displayed when order is in preparing.."
          color: PURPLE_BOLD_BRIGHT
      - executeFunction:
          name: functions.orderDetailPage.assertRequestCancelButtonDisplayed

      # Move the order to Shipped status
      - log:
          message: MOVE ORDER TO SHIPPED..
          color: PURPLE_BOLD_BRIGHT
      - executeFunction:
          name: functions.astroApi.moveOrder
          params:
            - name: orderId
              string: ${returnedOrderNumber}
            - name: payload
              string: data.moveOrder.mpDelivery.shippedStatus

      # Reload Order Details Page displayed.
      - executeFunction:
          name: functions.orderDetailPage.reloadOrderDetailPage 

      - executeFunction:
           name: functions.orderDetailPage.scrollDownToSection
           params:
             - name: section
               string: orderDetailPage.statusTracker # <-- scroll up until status tracker is visible.
      - executeFunction:
          name: functions.orderDetailPage.verifyOrderStatusInOrderTracker
          params:
            - name: orderStatus
              string: data.orderTracker.status.onTheWay

      # Move the order to Delivered status
      - log:
          message: MOVE ORDER TO DELIVERED..
          color: PURPLE_BOLD_BRIGHT

      - executeFunction:
          name: functions.astroApi.moveOrder
          params:
            - name: orderId
              string: ${returnedOrderNumber}
            - name: payload
              string: data.moveOrder.mpDelivery.delivered   

      - log:
          message: "After delivery, status in LOT is correct ( Delivered/Entregado ).."
          color: PURPLE_BOLD_BRIGHT
      - executeFunction:
           name: functions.orderDetailPage.scrollUpToSection
           params:
             - name: section
               string: orderDetailPage.statusTracker
      - executeFunction:
          name: functions.orderDetailPage.verifyOrderStatusInOrderTracker
          params:
            - name: orderStatus
              string: data.orderTracker.status.delivered

      # Verify that once item is delivered Write opinion/Escribir opinion is shown..
      - log:
          message: "Verify that once item is delivered Write opinion/Escribir opinion is shown.."
          color: PURPLE_BOLD_BRIGHT
      - executeFunction:
          name: functions.orderDetailPage.assertWriteAReviewIsDisplayed 

      # Verify Contact Seller link is present in ODP..
      - log:
          message: "Verify Contact Seller link is present in ODP.."
          color: PURPLE_BOLD_BRIGHT
      - executeFunction:
          name: functions.orderDetailPage.validateContactSelller
      
      # Verify Contact seller page..
      - log:
          message: "Verify Contact seller page.."
          color: PURPLE_BOLD_BRIGHT   
      - executeFunction:
          name: functions.orderDetailPage.tapOnContactSelller
      - executeFunction:
          name: functions.orderDetailPage.validateContactSelllerDetails
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * #
#   A F T E R   S C E N A R I O                                                                                       #
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * #              
      - storeIn:
          key: testStatus
          value: passed

  - name: After
    after: true
    executeOnFailure: false
    flow:
      - executeFunction:
          name: functions.utils.after