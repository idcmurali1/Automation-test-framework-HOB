# ================================================================================================================================
# TC: 011
# Flow: TC-011 :Test Accounts: Existing user + Payment Information: MCI +  MCI Item
# ================================================================================================================================

general:
  testCaseId: C2720134
  tags: C2720134,  p1-mx-ea-teflon, p1-bodega-ea-teflon, p1-mx-mh-e2e-teflon, p1-mx-mh-e2e-prod
  combineScenarios: true

scenarios:
  - name: Before
    before: true
    endTestOnFailure: true
    flow:

      - executeFunction:
          name: functions.utils.setMarketInfo

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_PRE_TRANSACTION'
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
  - name: Main
    flow:

      - if: 
          condition: ${platform} == 'Android' 
          then:
            - storeIn:
                key: emailId
                value: data.wcp011.android.email
      - if: 
          condition: ${platform} == 'iOS'
          then:
            - storeIn:
                key: emailId
                value: data.wcp011.ios.email

      # Onboard to aplication and select EA options.
      - executeFunction:
          name: functions.onboardingToHomePage.usingPostalCode
          params:
            - name: PostalCode
              string: data.onboarding.userPostalCode
            - name: ShoppingExperience
              string: data.onboarding.onlineExclusiveStore

      # Navigate and validate homepage.
      - executeFunction:
          name: functions.homePage.assertPageLoaded

      # Click on login and select sign in.
      - executeFunction:
          name: functions.global.tapAccountBtn

      - executeFunction:
          name: functions.accountPage.tapSignInBtn

      # Login with existing user.
      - executeFunction:
          name: functions.loginPage.userAuthentication
          params:
            - name: userEmail
              string: ${emailId}
            - name: userPassword
              string: data.global.password.Password1

      - executeFunction:
          name: functions.accountPage.deleteIfAnyInvoicePresent

      # Search for item and validate if search results are displayed.
      - executeFunction:
          name: functions.global.tapShopBtn

      - executeFunction:
          name: functions.cartPage.clearCart

      - if:
          condition: ${environment} == 'Production'
          then:
            - executeFunction:
                name: functions.searchPage.getTheFirstAvailableItemAndNavigateToPDP
                params:
                  - name: productArray
                    string: data.searchPage.tc11.mciItem
            - executeFunction:
                name: functions.productDetailsPage.validateMCIlabel
            - executeFunction:
                name: functions.productDetailsPage.validateShareLink
            - executeFunction:
                name: function.globalPages.selectAndVerifyDeliveryAddress
                params:
                  - name: page
                    string: data.pageName.productPage
                  - name: streetAddress
                    string: data.defaultAddress.streetAddress
            - executeFunction:
                name: functions.productDetailsPage.tapAddToCart
            - executeFunction:
                name: functions.productDetailsPage.tapClose

      - if:
          condition: ${environment} == 'Teflon'
          then:
            - executeFunction:
                name: functions.utils.getTheFirstAvailableItemAndNavigateToPDPWithDeepLink
                params:
                  - name: productArray
                    string: data.searchPage.tc11.mciItem
            - executeFunction:
                name: functions.productDetailsPage.tapClose

      - executeFunction:
          name: functions.global.tapCartIcon

      - if:
          condition: ${environment} == 'Production'
          then:
            - executeFunction:
                name: function.globalPages.selectAndVerifyDeliveryAddress
                params:
                  - name: page
                    string: data.pageName.cartPage
                  - name: streetAddress
                    string: data.global.deliveryAddress.streetName_testerazo
            - executeFunction:
                name: functions.cartPage.tapContinueToCheckoutBtn
            - executeFunction:
                name: functions.checkoutPage.selectInvoice
            - executeFunction:
                name: functions.invoicePage.addNewInvoice
                params:
                  - name: invoiceFirstName
                    string: data.global.name.ACCEPT
                  - name: invoiceLastName
                    string: data.global.name.ACCEPT
                  - name: invoiceMiddleName
                    string: data.global.name.ACCEPT
                  - name: invoiceRfc
                    string: data.invoice.RFC
                  - name: invoiceTaxRegime
                    string: data.invoice.TaxRegime
                  - name: invoiceCFDI
                    string: data.invoice.CFDI
                  - name: invoiceEmail
                    string: testInvoice@test.com
                  - name: invoicePostalCode 
                    string: data.defaultAddress.zipCode
                  - name: invoiceSteetAddress
                    string: data.defaultAddress.streetAddress
                  - name: invoiceAppartment
                    string: data.defaultAddress.exteriorNumber
                  - name: invoiceColoniaName
                    string: data.defaultAddress.coloniaName
                  - name: invoicePhoneCountryCode
                    string: data.global.phoneCountryCode1
                  - name: invoicePhoneNumber
                    string: data.defaultAddress.phoneNumber

      - if:
          condition: ${environment} == 'Teflon'
          then:
            - executeFunction:
                name: functions.cartPage.tapContinueToCheckoutBtn
            - executeFunction:
                name: functions.addAddressBottomSheet.handleSelectAddressPopUp
                params:
                  - name: invoiceColoniaName
                    string: data.defaultAddress.coloniaName
            # - if:
            #     condition: ${platform} == 'Android'
            #     then:
            #       - executeFunction:
            #           name: functions.checkoutPage.tapPlaceOrderButton
            #     else:            
            #       - executeFunction:
            #           name: functions.checkoutPage.scrollToCVVTextfield
            - executeFunction:
                name: functions.checkoutPage.validateMciOptionsDisplayed
            - executeFunction:
                name: functions.checkoutPage.selectMCIoption
            - executeFunction:
                name: functions.checkoutPage.selectInvoice
            - executeFunction:
                name: functions.checkoutPage.selectExistingInvoiceFromSheet
            - executeFunction:
                name: functions.checkoutPage.addCVV
                params:
                  - name: CVV
                    string: data.global.card.cvv.1234
            - executeFunction:
                name: functions.checkoutPage.tapPlaceOrderButton

    # # # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
    #         - log: 'R2_SUBFLOW_POST_TRANSACTION'
    # # # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
          
            - executeFunction:
                name: functions.thankYouPage.verifyThankYouPageDisplayed

      - executeFunction:
                name: functions.global.navigateToODPUseDeeplink
            
      - executeFunction:
          name: functions.orderDetailPage.verifySectionDisplayed

      - executeFunction:
          name: functions.orderDetailPage.verifyPaymentType
          params:
            - name: paymentType
              string:  data.global.creditCard.visa.4242.endingLabelText

      # - executeFunction:
      #     name: functions.orderDetailPage.verifyFinanceOptionsDisplayed

      - storeIn:
          key: testStatus
          value: passed

  #After Scenarios
  - name: After
    after: true
    flow:
      - executeFunction:
          name: functions.utils.after
