inherit: 'job:///glass-mobile-app-automation/looper-base:.looper.yml'

gitShallowDepth: 10

branches:
  - spec: development
    scheduling: concurrent

    triggers:
      - pr:
          scheduling: cancelRunning
          requiredLabels:
            - "ca-e2e"
      - push:
          manualOnly: true

      - manual:
          name: Run Android e2e English App Test - Staging
          call: run_build(TEST_TAGS = 'E2E-Android-English', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS = 'staging', REPORT_ID = "3")
      
      - cron:
          spec: 30 8 * * *
          call: run_build(TEST_TAGS = 'E2E-Android-English', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS= 'staging', REPORT_ID = "3")

      - manual:
          name: Run Android e2e French App Test - Staging
          call: run_build(TEST_TAGS = 'E2E-Android-French', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "4")

      - cron:
          spec: 30 8 * * *
          call: run_build(TEST_TAGS = 'E2E-Android-French', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "4")

      - manual:
          name: Run Android e2e English GO EXP Test - Staging
          call: run_build(TEST_TAGS = 'GO/MX-Express-Slot-English-Android-Flow', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS= 'staging', REPORT_ID = "5")

      - cron:
          spec: 0 10 * * *
          call: run_build(TEST_TAGS = 'GO/MX-Express-Slot-English-Android-Flow', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS= 'staging', REPORT_ID = "5")

      - manual:
          name: Run Android e2e French GO EXP Test - Staging
          call: run_build(TEST_TAGS = 'GO/MX-Express-Slot-French-Android-Flow', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "6")

      - cron:
          spec: 0 10 * * *
          call: run_build(TEST_TAGS = 'GO/MX-Express-Slot-French-Android-Flow', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "6")

      - manual:
          name: Run Android e2e English POJ Test - Staging
          call: run_build(TEST_TAGS = 'Post-Transction-English-Android-Flow', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS= 'staging', REPORT_ID = "7")

      - cron:
          spec: 0 10 * * *
          call: run_build(TEST_TAGS = 'Post-Transction-English-Android-Flow', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS= 'staging', REPORT_ID = "7")

      - manual:
          name: Run Android e2e French POJ Test - Staging
          call: run_build(TEST_TAGS = 'Post-Transction-French-Android-Flow', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "8")

      - cron:
          spec: 0 10 * * *
          call: run_build(TEST_TAGS = 'Post-Transction-French-Android-Flow', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "8")


  - spec: ca/*
    scheduling: concurrent

    triggers:
      - pr:
          scheduling: cancelRunning
          requiredLabels:
            - "ca-e2e"
      - push:
          manualOnly: true

      - manual:
          name: Run Android e2e English App Test - Staging
          call: run_release_build(TEST_TAGS = 'E2E-Android-English', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS= 'staging', REPORT_ID = "3")
      
      - cron:
          spec: 30 19 * * *
          call: run_release_build(TEST_TAGS = 'E2E-Android-English', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS= 'staging', REPORT_ID = "3")

      - manual:
          name: Run Android e2e French App Test - Staging
          call: run_release_build(TEST_TAGS = 'E2E-Android-French', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "4")

      - cron:
          spec: 30 19 * * *
          call: run_release_build(TEST_TAGS = 'E2E-Android-French', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "4")

      - manual:
          name: Run Android e2e English GO EXP Test - Staging
          call: run_release_build(TEST_TAGS = 'GO/MX-Express-Slot-English-Android-Flow', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS= 'staging', REPORT_ID = "5")

      - cron:
          spec: 0 13 * * *
          call: run_release_build(TEST_TAGS = 'GO/MX-Express-Slot-English-Android-Flow', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS= 'staging', REPORT_ID = "5")

      - manual:
          name: Run Android e2e French GO EXP Test - Staging
          call: run_release_build(TEST_TAGS = 'GO/MX-Express-Slot-French-Android-Flow', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "6")

      - cron:
          spec: 0 13 * * *
          call: run_release_build(TEST_TAGS = 'GO/MX-Express-Slot-French-Android-Flow', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "6")

      - manual:
          name: Run Android e2e English POJ Test - Staging
          call: run_release_build(TEST_TAGS = 'Post-Transction-English-Android-Flow', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS= 'staging', REPORT_ID = "7")

      - cron:
          spec: 30 19 * * *
          call: run_release_build(TEST_TAGS = 'Post-Transction-English-Android-Flow', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS= 'staging', REPORT_ID = "7")

      - manual:
          name: Run Android e2e French POJ Test - Staging
          call: run_release_build(TEST_TAGS = 'Post-Transction-French-Android-Flow', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "8")

      - cron:
          spec: 30 19 * * *
          call: run_release_build(TEST_TAGS = 'Post-Transction-French-Android-Flow', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "8")

envs:
  global:
    variables:
      MARKET: ca
      SAUCE_USERNAME: CanadaMobile
      SAUCE_ACCESS_KEY: be7b5ef5-86d1-450d-94ba-f3234f736ab8
      POST_TO_SPLUNK: true
      POST_TO_XRAY: false
      POST_TO_ES: true

  run_android_development_branch:
    variables:
      SLACK_CHANNEL: r2-ca-glass-test-result
      APP_PLATFORM: android
      TEST_SESSION_ID: '%{(Math.abs(new(java.util.Random).nextInt()) % 100000000 + 1)}'
      DEPENDENCY_FILE_NAME: ${MARKET}/test/dependencies/android/android-default.yaml
      GLASS_ENV: Staging Android -v${BUILD_APP_VERSION}
      SLACK_TEST_RUN_MESSAGE: "${TEST_PLAN_STATUS}\n>>> *Branch*: ${TRIGGER_BRANCH}\n
        *Tag*: ${TEST_TAGS}\n
        *App Build*: ${SAUCE_APP}\n
        *Build Link*: ${BUILD_URL}\n
        *Test Environment*: ${GLASS_ENV}\n
        *Test Report*: ${SLACK_TEST_REPORT_MESSAGE}\n
        *Report Link*: ${REPORT_URL}"

  run_android_release_branch:
    variables:
      SLACK_CHANNEL: r2-ca-release-branch-report
      APP_PLATFORM: android
      TEST_SESSION_ID: '%{(Math.abs(new(java.util.Random).nextInt()) % 100000000 + 1)}'
      DEPENDENCY_FILE_NAME: ${MARKET}/test/dependencies/android/android-default.yaml
      GLASS_ENV: Staging Android -v${BUILD_APP_VERSION}
      SAUCE_APP: 'storage:filename=ca-walmart-release-latest.apk'
      USE_TEST_REPORT: true
      SLACK_TEST_RUN_MESSAGE: "${TEST_PLAN_STATUS}\n>>> *Branch*: ${TRIGGER_BRANCH}\n
        *Tag*: ${TEST_TAGS}\n
        *App Build*: ${SAUCE_APP}\n
        *Build Link*: ${BUILD_URL}\n
        *Test Environment*: ${GLASS_ENV}\n
        *Test Report*: ${SLACK_TEST_REPORT_MESSAGE}\n
        *Report Link*: ${REPORT_URL}"


flows:

  # For publishing report
  publish_report:
    try:
      - publishReport:
          context: ${REPORT_ID}${TEST_SESSION_ID}
          dir: report
          index: index.html
          verbose: true
      - var(REPORT_URL):
        - shell (name Report URL): |
            REPORT_VALUE=PUBLISH_REPORT_${REPORT_ID}${TEST_SESSION_ID}
            echo ${!REPORT_VALUE}
    catch:
      - echo "Publish Report step failed. Please check Start R2 Test step. $flowErrorMessage"

  # Generating saucelabs url
  generate_sauce_labs_build_url:
    - shell (name Sauce Labs Build URL): |
        echo "https://app.saucelabs.com/archives/vdc?q=build:(r2-${TEST_SESSION_ID})"

  # Getting app version from saucelabs using api
  get_build_app_version:
    try:
      - var(VERSION_NAME = 'version')
      - var(STORAGE_NAME):
          - shell (name STORAGE_NAME): echo ${SAUCE_APP} | cut -f2 -d'='
      - var(BUILD_APP_VERSION):
          - shell (name BUILD_APP_VERSION): |
              curl -s -u "$SAUCE_USERNAME:$SAUCE_ACCESS_KEY" "https://api.us-west-1.saucelabs.com/v1/storage/files?per_page=1&name=${STORAGE_NAME}" | grep -o "\"${VERSION_NAME}\": \"[^\"]*\"" | cut -f4 -d'"' | cut -f1 -d"-"
      - echo "${BUILD_APP_VERSION}"
    catch:
      - echo "Unable to get build appVersion - $flowErrorMessage"

  # Assigning to variable and printing on report
  get_app_version:
    - call: get_build_app_version
    - var(APP_VERSION):
        - shell  (name Get App Version): echo ${BUILD_APP_VERSION}

  # generate test report in slack format
  get_test_report_slack_format:
    try:
      - shell (name Generate test report in slack format): |
          node ./ca/slack-output/generate-slack-output.js
      - var(SLACK_TEST_REPORT_MESSAGE):
        - shell (name Generate test report in slack format): |
            cat slackOutPut.txt
    catch:
      - echo "Unable to generate report - $flowErrorMessage"
      - exit 1

  pr:
    - parallel(failsafe):
      - call: run_build(TEST_TAGS = 'E2E-Android-English', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS = 'staging', REPORT_ID = "3")
      - call: run_build(TEST_TAGS = 'E2E-Android-French', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "4")
      - call: run_build(TEST_TAGS = 'GO/MX-Express-Slot-English-Android-Flow', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS= 'staging', REPORT_ID = "5")
      - call: run_build(TEST_TAGS = 'GO/MX-Express-Slot-French-Android-Flow', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "6")
      - call: run_build(TEST_TAGS = 'Post-Transction-English-Android-Flow', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper', MAPPING_LABELS= 'staging', REPORT_ID = "7")
      - call: run_build(TEST_TAGS = 'Post-Transction-French-Android-Flow', SAUCE_APP = 'storage:filename=ca-walmart-development-latest.apk', DEPENDENCY_PROFILE = 'looper_french', MAPPING_LABELS= 'fr_staging', REPORT_ID = "8")

  run_build:
    - call: build(run_android_development_branch)

  run_release_build:
    - call: build(run_android_release_branch)