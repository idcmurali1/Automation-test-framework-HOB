#---------steps-------------
# Guest user - validate fav page -  add a GM product to cart
# Sign in as reg user,  cart merge
# search a GO item 
# add the item to fav through PDP
# naviagte to fav page, through to items
# click Add to cart
# go to cart, select delivery from store for GO and select shipping for GM
# place order

#pending - add item to fav using scanner
#---------------------------
general:
  platform: ios
  tags: flow-074, ca_authpoc, fr_ca, E2E-iOS-English, E2E-iOS-French
  inherit:
    filesRunAll:
      - ca-errors-helpers.yaml

scenarios:
  - name: Before
    before: true
    endTestOnFailure: true
    flow:
      - log: Execute before steps

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * #
      - log: 'R2_SUBFLOW_PRE_TRANSACTION'
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * #

  - name: Main
    flow:
      - log: Start Main

      # Get TimeStamp
      - getTimestamp:
          asDate: true
          storeIn: timestamp

      #temporary#
      - executeFunction:
          name: ca.test.functions.utils.avoidTestPopup

      # Navigate onboarding to home
      - executeFunction:
          name: ca.test.functions.global.onboarding.navigateiosOnboardingToHome
          params:
            - name: ZIP_CODE
              string: ca.test.data.flow074.onboardingZipcode

      #Verifying home screen
      - executeFunction:
          name: ca.test.functions.home.headerElements.validateIosHomePage

      - executeFunction:    
          name: ca.test.functions.home.livingDesign.validateIosBottomNavigation

      # Astro - Clear Cart
      - executeFunction:
          name: ca.functions.utils.astro.clearCart
          params:
            - name: custEmail
              string: ca.test.data.ios.flow074.email
            - name: password
              string: ca.test.data.ios.flow074.password

      # Home to Sign In
      - executeFunction:
          name: ca.test.functions.home.signIn

      # Sign In to the account
      - executeFunction:
          name: ca.test.functions.loginPage.userLogin
          params:
            - name: email
              string: ca.test.data.ios.flow074.email
            - name: password
              string: ca.test.data.ios.flow074.password

      - executeFunction:
          name: ca.test.functions.utils.terminateApp

      - executeFunction:
          name: ca.test.functions.utils.relaunchApp

      # Checking and selecting Store
      - executeFunction:
          name: ca.test.functions.home.storeSelect
          params:
            - name: Zip_Code
              string: ca.test.data.flow074.onboardingZipcode
            - name: storeName
              string: ca.test.data.flow074.storeName

      # Product Search
      - executeFunction:
          name: ca.test.functions.productSearch.searchAProduct
          params:           
            - name: product
              string: ca.test.data.flow074.product_1_sku

      # Navigating to PDP from SRP
      - executeFunction:
          name: ca.test.functions.productSearch.srpToPdpPage
          params:
            - name: productName
              string: ca.test.data.flow074.product_1_name

      - executeFunction:
          name: ca.test.functions.pdp.addToFavourites
          params:
            - name: productName
              string: ca.test.data.flow074.product_1_name

      # close PDP page
      - executeFunction:
          name: ca.test.functions.PDPpage.closePDPpage

      #clear search box
      - executeFunction:
          name: ca.test.functions.productSearch.clearSearch

      # Product Search
      - executeFunction:
          name: ca.test.functions.productSearch.searchAProduct
          params:           
            - name: product
              string: ca.test.data.flow074.product_2_sku

      # Navigating to PDP from SRP
      - executeFunction:
          name: ca.test.functions.productSearch.srpToPdpPage
          params:
            - name: productName
              string: ca.test.data.flow074.product_2_name

      - executeFunction:
          name: ca.test.functions.pdp.addToFavourites
          params:
            - name: productName
              string: ca.test.data.flow074.product_2_name

      # close PDP page
      - executeFunction:
          name: ca.test.functions.PDPpage.closePDPpage

      #clear search box
      - executeFunction:
          name: ca.test.functions.productSearch.clearSearch

      # Product Search
      - executeFunction:
          name: ca.test.functions.productSearch.searchAProduct
          params:           
            - name: product
              string: ca.test.data.flow074.product_GO_sku

      # Add to cart
      - executeFunction:
          name: ca.test.functions.productSearch.addToCart
          params:
            - name: productName
              string: ca.test.data.flow074.product_GO_Name
            - name: quantity
              string: ca.test.data.flow074.product_GO_Qty

      # Navigating to My Items page
      - executeFunction:
          name: ca.test.functions.srpPage.navigateToMyItems
          params:
            - name: myItemsTab
              string: ca.test.data.myItems.favourites

      - executeFunction:
          name: ca.test.functions.myItems.validatingFavouritesPage
          params:
            - name: estimateTotalFav
              string: ca.test.data.flow074.myItems.estItemTotal
            - name: productCount
              string: ca.test.data.flow074.myItems.itemsCount

      # Adding 1st product based on product name to cart from Favourite page
      - executeFunction:
          name: ca.test.functions.myItems.favouriteAddToCart
          params:
            - name: productName
              string: ca.test.data.flow074.product_1_name
            - name: need
              string: ca.test.data.flow074.product_1_Qty

      # Adding 2nd product based on product name to cart from Favourite page
      - executeFunction:
          name: ca.test.functions.myItems.favouriteAddToCart
          params:
            - name: productName
              string: ca.test.data.flow074.product_2_name
            - name: need
              string: ca.test.data.flow074.product_2_Qty

       # Validate cart quantity
      - executeFunction:
           name: ca.test.functions.cart.assertCartQuantity
           params:
            - name: cartQuantity
              string: ca.test.data.flow074.cartQty

      # Asserting cart total
      - executeFunction:
          name: ca.test.functions.cart.assertCartTotal
          params:
            - name: subTotal
              string: ca.test.data.flow074.myItems.estTotal

# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_TRANSACTION'
# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

      # Navigate to cart
      - executeFunction:
          name: ca.test.functions.global.navigation.goToCartIos

      - if:
          identifier:
            present:
              - identifier: ca.test.mappings.cart.amendOrder.existingOrder.amendTime
          then:
            - executeFunction:
                name: ca.test.functions.cart.amendOrder.existingOrder.addItems
          else:
            # navigate to reserve time page
            - executeFunction:
                name: ca.test.functions.cart.reserveTimePage
            
            # Reserve time page validation
            - executeFunction:
                name: ca.test.functions.reserveTimePageValidation
      
            # navigating and changing store
            - executeFunction:
                name: ca.test.functions.reserveTime.changeStore
                params:
                  - name: Zip_Code
                    string: ca.test.data.flow074.onboardingZipcode
                  - name: storeName
                    string: ca.test.data.flow074.storeName
                  - name: storeDisplayed
                    string: ca.test.data.flow031.storeNameDisplay

            - executeFunction: 
                name: ca.test.functions.bookASlot.reserveTimePage.standardSlotSelection

            # Clicking book a slot button
            - executeFunction:
                name: ca.test.functions.bookASlot.reserveTimePage.bookASlotButton

            # Cart fulfillment verification
            - executeFunction:
                name: ca.test.functions.cart.pickup.verifyCardIos

            - executeFunction:
                name: ca.test.functions.cart.verifyProductDetails
                params:
                  - name: productName
                    string: ca.test.data.flow074.product_2_name
                  - name: productPrice
                    string: ca.test.data.flow074.product_2_price
                  - name: productQty
                    string: ca.test.data.flow074.product_2_Qty

            - executeFunction:
                name: ca.test.functions.cart.verifyProductDetails
                params:
                  - name: productName
                    string: ca.test.data.flow074.product_GO_Name
                  - name: productPrice
                    string: ca.test.data.flow074.product_GO_price 
                  - name: productQty
                    string: ca.test.data.flow074.product_GO_Qty

            # Cart fulfillment verification
            - executeFunction:
                name: ca.test.functions.cart.deliveryS2H.verifyCard 

            # Selecting pickup or shipping
            - executeFunction:
                name: ca.test.functions.cart.selectShippingOptionsIos 

            - executeFunction:
                name: ca.test.functions.cart.verifyProductDetails
                params:
                  - name: productName
                    string: ca.test.data.flow074.product_1_name
                  - name: productPrice
                    string: ca.test.data.flow074.product_1_price
                  - name: productQty
                    string: ca.test.data.flow002.product_p1_qty

            # # Verify cart subTotal
            # - executeFunction:
            #     name: ca.test.functions.cart.cartSubTotal
            #     params: 
            #       - name: subTotal
            #         string: ca.test.data.flow074.myItems.estTotal
            
            # - executeFunction:
            #     name: ca.test.functions.cart.groceryPickUp
            #     params:
            #       - name: slotPrice
            #         string: FREE

            # # Verify cart Taxes
            # - executeFunction:
            #     name: ca.test.functions.cart.cartTaxes
            #     params: 
            #       - name: taxes
            #         string: $5.94

            # # Asserting hst tax
            # - executeFunction:
            #     name: ca.test.functions.cart.hstTaxAssertion
            #     params:
            #       - name: hst_percentage
            #         string: ca.test.data.flow031.hstPercentage
            #       - name: hst_tax_value
            #         string: $5.94

            # # Verify cart estimated total
            # - executeFunction:
            #     name: ca.test.functions.cart.cartEstimatedTotal
            #     params: 
            #       - name: estimate_total
            #         string: $51.65
              
            # Proceed to Checkout
            - executeFunction:
                name: ca.test.functions.cart.checkout.proceedToCheckOutIos

            # CheckOut page order review validation
            - executeFunction:
                name: ca.test.functions.checkOut.validateCheckOutOrderCard
                params:
                  - name: fulfillmentType
                    string: ca.test.data.flow031.fulfillmentType
            
            - executeFunction:
                name: ca.test.functions.checkOut.fulfillmentCard.storeDetailsAssertion
                params:
                  - name: fulfillmentType
                    string: ca.test.data.flow031.fulfillmentType
                  - name: storeName
                    string: ca.test.data.flow031.storeName
                  - name: storeAddress
                    string: ca.test.data.flow031.storeNameDisplay

            # CheckOut page order review validation
            - executeFunction:
                name: ca.test.functions.checkOut.validateCheckOutOrderCard
                params:
                  - name: fulfillmentType
                    string: ca.test.data.flow074.fulfillmentTypeShipping

            # # Asserting delivery address
            # - executeFunction:
            #     name: ca.test.functions.checkOut.assertingDeliveryAddress
            #     params:
            #       - name: fulfillmentType
            #         string: Shipping
            #       - name: addressFirstLine
            #         string: 

            # Check out payment method validation
            - executeFunction:
                name: ca.test.functions.checkoutPage.validatePaymentDetails

            # Add Card Cvv
            - executeFunction:
                name: ca.test.functions.checkOut.payment.addCvvIos
                params:
                  - name: CVV
                    string: ca.test.data.flow074.cvvNumber

            # Adding mobile number
            - executeFunction:
                name: ca.test.functions.checkout.phoneNumber.enterContactNumber        

            # # Checkout page sub total assertion
            # - executeFunction:
            #     name: ca.test.functions.checkOut.subTotalValidation
            #     params:
            #       - name: subTotal
            #         string: $45.71

            # # Verify checkout grocery pickup fee -- $1 shows FREE
            # - executeFunction:
            #     name: ca.test.functions.checkOut.subTotal.scheduleOrderFee
            #     params: 
            #       - name: scheduledOrderFeeText
            #         string: Grocery pickup fee
            #       - name: scheduledOrderFeeValue
            #         string: FREE

            # # Checkout page tax assertion
            # - executeFunction:
            #     name: ca.test.functions.checkOut.taxesAssertion
            #     params:
            #       - name: total_tax
            #         string: $5.94
                    
            # # Checkout page hst assertion
            # - executeFunction:
            #     name: ca.test.functions.checkOut.hstAssertion
            #     params:
            #       - name: hst_percentage
            #         string: 13%
            #       - name: hst_tax_value
            #         string: $5.94
      
            # # Checkout page estimate total assertion
            # - executeFunction:  
            #     name: ca.test.functions.checkOut.estimateTotalAssertion
            #     params:
            #       - name: estimate_total
            #         string: $51.65
                  
            # Checkout
            - executeFunction:
                name: ca.test.functions.checkOut.PlacingOrder

# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
            - log: 'R2_SUBFLOW_POST_TRANSACTION'
# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *          

            # Order Confirmation screen validation
            - executeFunction:
                name: ca.test.functions.checkOut.orderConfirmationValidationIos  

            # # Order ID Assertion From Order Confirmation
            # - executeFunction:
            #     name: ca.test.functions.checkOut.orderConformation.orderIdExtraction

      - storeIn:
          key: testStatus
          value: passed
  
  - name: After
    after: true
    flow:
      - executeFunction:
          name: ca.test.functions.oms.orderCancellation
          params:
            - name: orderNo
              string: ${orderId}
      - executeFunction:
          name: ca.test.functions.utils.afterSteps     

           
          
                    