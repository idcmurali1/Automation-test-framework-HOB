#-------------------------------------------------------------------------------------------------------------------
# Flow: 030
# User : Registered User 
# Order Type: GM order
# Fulfillment: S2H
# Payment Type : CC
# Experience: A2C Search
# Validation: Try to apply a GO evoucher on a GM order
#-------------------------------------------------------------------------------------------------------------------
general:
  platform: ios
  tags: flow-030, ca_authpoc, E2E-iOS-English
  inherit:
    filesRunAll:
      - ca-errors-helpers.yaml

scenarios:
  - name: Before
    before: true
    endTestOnFailure: true
    flow:
      - log: Execute before steps

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * #
      - log: 'R2_SUBFLOW_PRE_TRANSACTION'
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * #

  - name: Main
    flow:

      - log: Start Main

      # Get TimeStamp
      - getTimestamp:
          asDate: false
          storeIn: timestamp
          
      #temporary#
      - executeFunction:
          name: ca.test.functions.utils.avoidTestPopup

      # Navigate onboarding to home
      - executeFunction:
          name: ca.test.functions.global.onboarding.navigateiosOnboardingToHome
      
      # Creating account using astro
      - executeFunction:
          name: ca.test.functions.astro.createAccount
          params:
            - name: payLoad
              string: ca.test.data.flow030.astroRequestBody    

       # Navigate to sign in page
      - executeFunction:
          name: ca.test.functions.home.navigateHomeToSignInIos
 
      # Sign In to the account
      - executeFunction:
          name: ca.test.functions.loginPage.userLogin
          params:
            - name: email
              string: ca.test.data.flow030.email
            - name: password
              string: ca.test.data.flow030.password

      - executeFunction:
          name: ca.test.functions.home.verifyUserNameInTopleft 

      - executeFunction:
          name: ca.test.functions.utils.terminateApp

      - executeFunction:
          name: ca.test.functions.utils.relaunchApp

      # Checking and selecting Store
      - executeFunction:
          name: ca.test.functions.home.storeSelect
          params:
            - name: Zip_Code
              string: ca.test.data.onboarding.zipcode
            - name: storeName
              string: ca.test.data.onboarding.storeName 

      # Product Search
      - executeFunction:
          name: ca.test.functions.productSearch.searchAProductIos
          params:           
            - name: product
              string: ca.test.data.search.gmStaging001       

      # # SRP Page Validation
      # - executeFunction:
      #     name: ca.test.functions.productSearch.srpPageValidaion            

      # Add to cart
      - executeFunction:
          name: ca.test.functions.srp.addToCartIos                  

      #clear search box
      - executeFunction:
          name: ca.test.functions.productSearch.clearSearch
    
      # Product Search
      - executeFunction:
          name: ca.test.functions.productSearch.searchAProductIos
          params:           
            - name: product
              string: ca.test.data.search.gmStaging002    

      # # SRP Page Validation
      # - executeFunction:
      #     name: ca.test.functions.productSearch.srpPageValidaion            

      # Add to cart
      - executeFunction:
          name: ca.test.functions.srp.addToCartIos

      # Asserting cart quantity
      - executeFunction:
          name: ca.test.functions.cart.assertCartQuantityIos
          params:
            - name: cartQuantity
              string: ca.test.ios.data.flow030.cartQuantity     

# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_TRANSACTION'
# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *                         

      # navigate to cart
      - executeFunction:
          name: ca.test.functions.global.navigation.goToCartIos
          
      # Selecting pickup or shipping
      - executeFunction:
          name: ca.test.functions.cart.selectShippingOptionsIos            
      
      # Cart fulfillment verification
      - executeFunction:
          name: ca.test.functions.cart.deliveryS2H.verifyCard       

      # Cart product details validation
      - executeFunction:
          name: ca.test.functions.cart.verifyProductTitle
          params:
            - name: productName
              string: ca.test.data.flow030.gmItem1
      
      - executeFunction:
          name: ca.test.functions.cart.verifyProductTitle
          params:
            - name: productName
              string: ca.test.data.flow030.gmItem2        

      # Verify cart subTotal
      - executeFunction:
          name: ca.test.functions.cart.cartSubTotal
          params: 
            - name: subTotal
              string: ca.test.data.flow030.subtotal

      # Verify cart walmart shipping
      - executeFunction:
          name: ca.test.functions.cart.cartWalmartShipping
          params: 
            - name: walmartShipping
              string: ca.test.data.flow030.shippingfee

      # Veriy ON Env Fee
      - executeFunction:
          name: ca.test.functions.cart.ONEnvHandlingFee
          params: 
            - name: ON_Env
              string: ca.test.data.flow030.ONEnv          

      # Verify cart taxes
      - executeFunction:
          name: ca.test.functions.cart.cartTaxes
          params: 
            - name: taxes
              string: ca.test.data.flow030.Taxes

      # Verify cart HST
      - executeFunction:
          name: ca.test.functions.cart.hstTaxAssertion
          params: 
            - name: hst_percentage
              string: ca.test.data.flow030.hstPercentage
            - name: hst_tax_value
              string: ca.test.data.flow030.hst

      # Verify cart estimated total
      - executeFunction:
          name: ca.test.functions.cart.cartEstimatedTotal
          params: 
            - name: estimate_total
              string: ca.test.data.flow030ios.estimatedTotal       
        
      # Proceed to Checkout
      - executeFunction:
          name: ca.test.functions.cart.proceedToCheckOutIos

      # Applying promo code to exisiting customer
      - executeFunction: 
          name: ca.test.functions.astro.promoCode
          params:
            - name: email
              string: ca.test.data.flow030.email
            - name: password
              string: ca.test.data.flow030.password
            - name: promoCode
              string: ca.test.data.flow030.promoCode

      # # CheckOut page order review validation
      # - executeFunction:
      #     name: ca.test.functions.checkOut.validateCheckOutOrderCartIos
      #     params:
      #       - name: fulfillment
      #         string: ca.test.data.flowios.fullfillmentType
      
      # # Check out payment method validation 
      # - executeFunction:
      #     name: ca.test.functions.checkOut.paymentOptionsIos 

      # Add Card Cvv
      - executeFunction:
          name: ca.test.functions.checkOut.payment.addCvvIos
          params:
            - name: CVV
              string: ca.test.data.checkout.Cvv_1 
      
      # Adding mobile number
      - executeFunction:
          name: ca.test.functions.checkout.phoneNumber.enterContactNumber

      # Promo Code Check
      - executeFunction:
          name: ca.test.functions.checkOut.promoCodeAvailabilityCheck

      # Promo Code Redeem
      - executeFunction:
          name: ca.test.functions.checkOut.promoCodeRedeem
          params:
            - name: PromoCode
              string: CA_GR_10_OFF

      # Promo Code do not qualify validation
      - executeFunction:
          name: ca.test.functions.checkOut.promoCodeDontQualify

      - storeIn:
          key: testStatus
          value: passed
  
  - name: After
    after: true
    flow:
      - executeFunction:
          name: ca.test.functions.utils.afterSteps