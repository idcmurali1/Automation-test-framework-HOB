# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * #
# scenario covered:
# Navigate onboarding to home, Astro - Clear Cart
# Sign In from account, Checking and selecting Store
# search a prpduct and add through srp, dearch a product via deeplink and add from PDP
# navigate to cart,  Book a delivery slot
# Cart fulfillment verification, Cart product details validation
# Proceed to Checkout, GC_CC
# place orders, cancel order
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * #

general:
  platform: ios
  tags: flow-046, ca_authpoc, testrun1, fr_ca, E2E-iOS-English, E2E-iOS-French
  inherit:
    filesRunAll:
      - ca-errors-helpers.yaml

scenarios:
  - name: Before
    before: true
    endTestOnFailure: true
    flow:
      - log: Execute before steps

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * #
      - log: 'R2_SUBFLOW_PRE_TRANSACTION'
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * #

  - name: Main
    flow:
      - log: Start Main

      # Get TimeStamp
      - getTimestamp:
          asDate: false
          storeIn: timestamp
          
      #temporary#
      - executeFunction:
          name: ca.test.functions.utils.avoidTestPopup

      # Navigate onboarding to home
      - executeFunction:
          name: ca.test.functions.global.onboarding.navigateiosOnboardingToHomeparamZip
          params:
            - name: ZIP_CODE
              string: ca.test.data.flow046.zipCode      
      
      # Astro - Clear Cart
      - executeFunction:
          name: ca.functions.utils.astro.clearCart
          params:
            - name: custEmail
              string: ca.test.data.ios.flow046.email
            - name: password
              string: ca.test.data.ios.flow046.password

      # Navigate to sign in page
      - executeFunction:
          name: ca.test.functions.home.signIn
      
      # Sign In to the account
      - executeFunction:
          name: ca.test.functions.loginPage.userLogin
          params:
            - name: email
              string: ca.test.data.ios.flow046.email
            - name: password
              string: ca.test.data.ios.flow046.password      

      - executeFunction:
          name: ca.test.functions.utils.terminateApp

      - executeFunction:
          name: ca.test.functions.utils.relaunchApp

      # Checking and selecting Store
      - executeFunction:
          name: ca.test.functions.home.storeSelect
          params:
            - name: Zip_Code
              string: ca.test.data.flow046.zipCode
            - name: storeName
              string: ca.test.data.flow046.storeName

      # Selecting address at home page
      - executeFunction:
          name: ca.test.functions.home.changeLocationLink
          params:
            - name: address
              string: ca.test.data.flow046.storeZipCode

      # Product Search
      - executeFunction:
          name: ca.test.functions.productSearch.searchAProduct
          params:           
            - name: product
              string: ca.test.data.flow046.product_P1_sku        

      # Add to cart
      - executeFunction:
          name: ca.test.functions.productSearch.addToCart
          params:
            - name: productName
              string: ca.test.data.flow046.product_P1_Name
            - name: quantity
              string: ca.test.data.flow046.product_P1_Quantity

      #clear search box
      - executeFunction:
          name: ca.test.functions.productSearch.clearSearch

      # Product Search
      - executeFunction:
          name: ca.test.functions.productSearch.searchAProduct
          params:           
            - name: product
              string: ca.test.data.flow046.product_P2_sku

      # Add to cart
      - executeFunction:
          name: ca.test.functions.productSearch.addToCart
          params:
            - name: productName
              string: ca.test.data.flow046.product_P2_Name
            - name: quantity
              string: ca.test.data.flow046.product_P2_Quantity

      # Asserting cart quantity
      - executeFunction:
           name: ca.test.functions.cart.assertCartQuantity
           params:
            - name: cartQuantity
              string: ca.test.data.flow046.cartQuantity
      
      # Asserting cart total
      - executeFunction:
          name: ca.test.functions.cart.assertCartTotal
          params:
            - name: subTotal
              string: ca.test.data.flow046.cartSubTotal

# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_TRANSACTION'
# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *                       

      # navigate to cart
      - executeFunction:
          name: ca.test.functions.global.navigation.goToCartIos

      - if:
          identifier:
            present:
              - identifier: ca.test.mappings.cart.amendOrder.existingOrder.amendTime
          then:
            - executeFunction:
                name: ca.test.functions.cart.amendOrder.existingOrder.addItems
          else:

            # Book a delivery slot
            - executeFunction:
                name: ca.test.functions.cart.deliverySlotIos
            
            # Cart fulfillment verification
            - executeFunction:
                name: ca.test.functions.cart.deliveryFromStore.verifyCard

            - executeFunction:
                name: ca.test.functions.cart.verifyProductDetails
                params:
                  - name: productName
                    string: ca.test.data.flow046.product_P1_Name
                  - name: productPrice
                    string: ca.test.data.flow046.product_P1_Price
                  - name: productQty
                    string: ca.test.data.flow046.product_P1_Quantity

            # Cart fulfillment verification
            - executeFunction:
                name: ca.test.functions.cart.deliveryS2H.verifyCard

            - executeFunction:
                name: ca.test.functions.cart.verifyProductDetails
                params:
                  - name: productName
                    string: ca.test.data.flow046.product_P2_Name
                  - name: productPrice
                    string: ca.test.data.flow046.product_P2_Price
                  - name: productQty
                    string: ca.test.data.flow046.product_P2_Quantity
            
            # Verify cart subTotal
            - executeFunction:
                name: ca.test.functions.cart.cartSubTotal
                params: 
                  - name: subTotal
                    string: ca.test.data.flow046.cartSubTotal

      # Temporary commenting associate discount validation
            # Verify associate discount   
            # - executeFunction:   
            #     name: ca.test.functions.cart.associateDiscount
            #     params:
            #       - name: associate_discount        
            #         string: ca.test.data.flow046.associatediscount

      # Temporary Commenting due to tax variation
            # Removing $ from slot price
            # - executeNode:
            #     file: ca/test/helpers/sanitizePriceIos.js
            #     args:
            #       - value: ${slotPrice}
            #     getResponse:
            #       storeIn: clearPrice
            # - log: ${clearPrice}

      # Temporary Commenting due to tax variation
            # Verify cart Grocery Delivery Fees
            # - executeFunction:
            #     name: ca.test.functions.cart.validateGroceryDeliveryFees
            #     params: 
            #       - name: grocery_delivery
            #         string: ${clearPrice}

      # Temporary Commenting due to tax variation
            # - executeFunction:
            #     name: ca.test.functions.cart.taxCalculation
            #     params:
            #       - name: subTotal
            #         string: ca.test.data.flow046.taxableItemValue
            #       - name: slotPrice
            #         string: ${clearPrice}
            #       - name: tax
            #         string: ca.test.data.flow046.cart.hstPercentage

      # Temporary Commenting due to tax variation
            # Verify cart Taxes
            # - executeFunction:
            #     name: ca.test.functions.cart.cartTaxes
            #     params: 
            #       - name: taxes
            #         string: ${tax_values}

      # Temporary Commenting due to tax variation
            # Verify cart HST
            # - executeFunction:
            #     name: ca.test.functions.cart.hstTaxAssertion
            #     params: 
            #       - name: hst_percentage
            #         string: ca.test.data.flow046.cart.hstPercentage
            #       - name: hst_tax_value
            #         string: ${tax_values}

      # Temporary commenting due to tax variation
            # Verify cart walmart shipping
            # - executeFunction:
            #     name: ca.test.functions.cart.cartWalmartShipping
            #     params: 
            #       - name: walmartShipping
            #         string: ca.test.data.flow046ios.shippingfee

      # Temporary Commenting due to tax variation
            # - executeFunction:
            #     name: ca.test.functions.cart.estimatedTotalCalculation
            #     params:
            #       - name: tax
            #         string: ${tax_values}
            #       - name: subTotal
            #         string: ca.test.data.flow046.cartSubTotalAfterAssociateDiscount
            #       - name: slotPrice
            #         string: ${clearPrice}

            # # Verify cart estimated total
            # - executeFunction:
            #     name: ca.test.functions.cart.cartEstimatedTotal
            #     params: 
            #       - name: estimate_total
            #         string: ${estimate_total}

            # Proceed to Checkout
            - executeFunction:
                name: ca.test.functions.cart.proceedToCheckOutIos
            
            # Asserting Driver Tip
            - executeFunction:
                name: ca.test.functions.checkout.DriverTip.zeroTip

            # Check out payment method validation 
            - executeFunction:
                name: ca.test.functions.checkOut.paymentOptionsIos

            - executeFunction:
                name:  ca.test.functions.astroUrl.createGiftCard
                params:
                  - name: giftCardAmount
                    string: ca.test.data.flow046.checkout.giftCardAmount

            # Navigating edit payment page
            - executeFunction:
                name: ca.test.functions.checkOut.paymentOptions.clickOnEditPayment
            
            - executeFunction:
                name: ca.test.functions.checkOut.paymentOptions.editPayments.removeGiftCard

            - executeFunction:
                name: ca.test.functions.checkOut.editPayment.chooseGiftCard
                params:
                  - name: cardNumber
                    string: ${giftCardNumber}
                  - name: cardPin
                    string: ${giftCardPin}
                  - name: cvvNumber
                    string: ca.test.data.flow009.cvvNumber

             # Checkout page sub total assertion
            - executeFunction:
                name: ca.test.functions.checkOut.subTotalValidation
                params:
                  - name: subTotal
                    string: ca.test.data.flow046.subtotal

            - executeNode:
                    file: ca/test/helpers/CheckOut/extractingTipDetailsAndPercentage.js
                    args:
                      - value: ${driverTip}
                      - value: ${estimate_total}
                    getValue:
                      - key: tipPercentage
                        storeIn: driverTipPercentage
                      - key: tipAmount
                        storeIn: driverTipAmount
                      - key: updatedEstimateTotal
                        storeIn: estimateTotalWithDriverTip

                # Validating driver tip amount in checkout
            - executeFunction:
                    name: ca.test.functions.checkOut.driverTipValidation
                    params:
                      - name: tipPercentage
                        string: ${driverTipPercentage}
                      - name: driverTip
                        string: ${driverTipAmount}        

            # Verify checkout Grocery Delivery Fees
            - executeFunction:
                name: ca.test.functions.checkOut.validateGroceryDeliveryFees
                params: 
                  - name: grocery_delivery
                    string: ${clearPrice}

            # Checkout page tax assertion
            - executeFunction:
                name: ca.test.functions.checkOut.taxesAssertion
                params:
                  - name: total_tax
                    string: ${tax_values}
                    
            # Checkout page hst assertion
            - executeFunction:
                name: ca.test.functions.checkOut.hstAssertion
                params:
                  - name: hst_percentage
                    string: ca.test.data.flow046.hstPercentage
                  - name: hst_tax_value
                    string: ${tax_values}

       # Temporary commenting associate discount validation
            # Verify associate discount
            # - executeFunction:
            #     name: ca.test.functions.checkout.associateDiscount
            #     params:
            #       - name: associate_discount        
            #         string: ca.test.data.flow046.associatediscount
      
            # Checkout page estimate total assertion
            - executeFunction:  
                name: ca.test.functions.checkOut.estimateTotalAssertion
                params:
                  - name: estimate_total
                    string: ${estimateTotalWithDriverTip}

      # Checkout
      - executeFunction:
          name: ca.test.functions.checkOut.PlacingOrder

# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_POST_TRANSACTION'
# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *          

      # Order Confirmation screen validation
      - executeFunction:
          name: ca.test.functions.checkOut.orderConfirmationValidationIos   

      # Continue Shopping
      - executeFunction:
          name: ca.test.functions.checkOut.continueShopping     

      # Navigate to account page
      - executeFunction:
          name: ca.test.functions.home.navigateHomeToAccountPage
    
      # Go to purchase page
      - executeFunction:
          name: ca.test.functions.accountPage.purchaseHistoryButtonIos

      # Purchase history page to view Details
      - executeFunction:
          name: ca.test.functions.purchaseHistory.viewDetailsButtonIos

      # Order cancellation
      - executeFunction:
          name: ca.test.functions.purchaseHistory.orderCancellation  

      # Order cancellation from home
      - executeFunction:
          name: ca.test.functions.purchaseHistory.orderCancellationHome                

      - storeIn:
          key: testStatus
          value: passed          
  
  - name: After
    after: true
    flow:
      - executeFunction:
          name: ca.test.functions.utils.afterSteps               