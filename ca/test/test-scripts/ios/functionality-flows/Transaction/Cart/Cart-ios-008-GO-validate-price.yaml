#------------------------------------------------------------------------------
##Validating the price summary of the cart for GO.
# Scenarios covered: 
# Add a GO product to cart as reg user
# Go to cart, validate price(subtotal, savings, total items, pickUp slot price, taxes and estimated total
#------------------------------------------------------------------------------
general:
  platform: ios
  tags: cart-008-ios, ca-function-run, cart_ios
  testCaseId: cart-008-ios
  inherit:
    filesRunAll:
      - ca-errors-helpers.yaml

scenarios:
  - name: Before
    before: true
    endTestOnFailure: true
    flow:
      - log: Execute before steps

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * #
      - log: 'R2_SUBFLOW_PRE_TRANSACTION'
# #* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * #  

  - name: Validating the price summary of the cart for GO.
    flow:
            - log:
                message: Validating the price summary of the cart for GO.
                color: CYAN_BOLD_BRIGHT

            # Navigate onboarding to home
            - executeFunction:
                name: ca.test.functions.global.onboarding.navigateiosOnboardingToHomeparamZip
                params:
                  - name: ZIP_CODE
                    string: ca.test.data.orleansZipCode
            - log:
                message: navigated from onboarding to home
                color: YELLOW 

          #Navigate to sign in page
            - executeFunction:
                name: ca.test.functions.home.navigateHomeToSignInIos
            - log:
                message: navigated to sign in page
                color: YELLOW     

            # Login us registered user
            - executeFunction:
                name: ca.test.functions.global.authentication.signInAccountIos
                params:
                  - name: email
                    string: ca.test.data.cart008.emailios
                  - name: password
                    string: ca.test.data.cart008.passwordios 
            - executeFunction:
                name: ca.test.functions.home.verifyUserNameInTopleft
            - log:
                message: signed in
                color: YELLOW  

            # Selecting store in home page
            - executeFunction:
                name: ca.test.functions.global.authentication.storeSelect
                params:
                  - name: Zip_Code
                    string: ca.test.data.orleansZipCode
                  - name: storeName
                    string: ca.test.data.orleansStoreName
            - log:
                message: Updated the store to K1C1T1!
                color: YELLOW 

            #Clear Cart
            - executeFunction:
                name:  ca.test.functions.cart.removeCartItems
            - log:
                message: cart cleared
                color: YELLOW    

            - executeFunction:
                name: ca.functions.searchPage.searchItemArray
                params:
                  - name: items
                    string: ca.test.data.cart008.goItemArray1
                  - name: quantity
                    string: ca.test.data.product_1_qty
                  - name: checkNonPromotionBadges
                    string: true      
            - log:
               message: searched a GO product!
               color: YELLOW 

            - storeIn:
                key: go_item
                value: ${productTitle}

            - storeIn:
                key: go_item_price
                value: ${productCost}

          #Searching for another GO Product
          # Product Search
            - executeFunction:
                  name: ca.functions.searchPage.searchItemArray
                  params:
                    - name: items
                      string: ca.test.data.cart008.goItemArray2
                    - name: quantity
                      string: ca.test.data.product_1_qty
                    - name: checkNonPromotionBadges
                      string: true 
            - log:
               message: searched a GO product!
               color: YELLOW 

            - storeIn:
                key: go_item_2
                value: ${productTitle}
            - storeIn:
                key: go_item_price_2
                value: ${productCost}

          #Searching for another GO Product
          # Product Search
            - executeFunction:
                name: ca.functions.searchPage.searchItemArray
                params:
                  - name: items
                    string: ca.test.data.cart008.mxItemArray
                  - name: quantity
                    string: ca.test.data.product_1_qty
                  - name: checkNonPromotionBadges
                    string: true

            - log:
               message: searched a GO product!
               color: YELLOW 

            - storeIn:
                key: go_item_3
                value: ${productTitle}

            - storeIn:
                key: go_item_price_3
                value: ${productCost}

            # Asserting cart total
            - executeFunction:
                name: ca.test.functions.cart.assertCartTotal
                params:
                  - name: subTotal
                    string: ${totalPrice}
            - log:
               message: cart subtotal verified!
               color: YELLOW 

# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
            - log: 'R2_SUBFLOW_TRANSACTION'
# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

          # navigate to cart
            - executeFunction:
                name: ca.test.functions.global.navigation.goToCartIos
            - log:
                message: Navigated to cart
                color: YELLOW 

            #Add product to cart - GO - dynamic product addition                    
            - executeFunction:
                name: ca.test.functions.dynamicProduct    

          # Book a delivery slot
            - executeFunction:
                name: ca.test.functions.cart.deliverySlotIos  
            - executeNode:
                  file: ca/test/helpers/sanitizePriceIos.js
                  args:
                    - value: ${slotPrice}      
                  getResponse:
                    storeIn: clearPrice
            - log: ${clearPrice}     
            - log:
                message: Booked delivery slot
                color: YELLOW

            # Verify cart grocery delivery fee 
            - executeFunction:
                name: ca.test.functions.cart.validateGroceryDeliveryFees
                params: 
                  - name: grocery_delivery
                    string: ${clearPrice}                
            - log:
               message: cart grocerry delivery fee verified!
               color: YELLOW 
            
            # - executeFunction:
            #     name: ca.test.functions.utils.taxCalculation
            #     params:
            #       - name: taxableTotal
            #         string: ${totalPrice}
            #       - name: slotPrice
            #         string: ${clearPrice}
            #       - name: taxPercentage
            #         string: ca.test.data.cart008.hstPercentage 
            # - executeFunction:
            #       name: ca.test.functions.cartPage.validateMoneyBox
            #       params:
            #         - name: checkForHstTax
            #           string: true
            # - log:
            #    message: cart tax verified!
            #    color: YELLOW 
#------------------------------------------------------------------------------
            - storeIn:
                key: testStatus
                value: passed
  #After Scenarios
  - name: After
    after: true
    flow:
      - log:
          message: cart-008-ios
          color: GREEN_BOLD
      - executeFunction:
          name: ca.test.functions.utils.afterSteps  
