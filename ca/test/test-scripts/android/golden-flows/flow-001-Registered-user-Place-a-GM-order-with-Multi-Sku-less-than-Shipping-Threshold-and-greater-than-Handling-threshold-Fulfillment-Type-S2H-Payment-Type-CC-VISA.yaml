#-------------------------------------------------------------------------------------------------------------------
# Flow: 001
# User: Registered user
# Order Type: GM order with Multi Sku, Handling threshold < cartSubTotal < Shipping Threshold
# Fulfillment: S2H
# Payment Type: CC VISA
# Experience: A2C Search
# Validation: Cart- Qty, SubTotal, tax, estimate total
# Remark:  
#-------------------------------------------------------------------------------------------------------------------
general:
#   platform: android
  tags: flow-001v, E2E-Android-English, E2E-Android-French, Android-Development-Build-Sanity
  inherit:
    filesRunAll:
      - ca-errors-helpers.yaml
scenarios:
  - name: Before
    before: true
    endTestOnFailure: true
    flow:
      - executeFunction:
          name: ca.test.functions.utils.setExecutionPlatform

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_PRE_TRANSACTION'
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
  - name: Main
    flow:
      - log: Start Main
      # Get timestamp
      - getTimestamp:
          asDate: false
          storeIn: timestamp

      - log:
          message: "Step 1: Validate Welcome to Walmart Page."
          color: GREEN_BOLD
      - executeFunction:
          name: ca.functions.onboarding.isOnboardingDisplayed
      - if:
          condition: ${returnedIsDisplayed} == true
          then:
            - log:
                message: "Onboarding displayed, flow will navigate through."
                color: CYAN
            - executeFunction:
                name: ca.functions.onboarding.tapContinueBtn
          else:
            - failTest:
                message: "Onboarding not displayed."

      - log:
          message: "Step 2: Check & Validate Notification Page."
          color: GREEN_BOLD
      - executeFunction:
          name: ca.test.functions.onboarding.isNotificationDisplayed
      - if:
          condition: ${returnedIsDisplayed} == true
          then:
            - log:
                message: "Notification displayed"
                color: CYAN
            - executeFunction:
                name: ca.test.functions.onboarding.validateNotificationPage
            - executeFunction:
                name: ca.test.functions.onboarding.allowNotification
          else:
            - log:
                message: "Notification not displayed"
                color: CYAN

      - log:
          message: "Step 3: Validating Share Your Location Page"
          color: GREEN_BOLD
      - executeFunction:
          name: ca.functions.onboarding.validateShareLocation$LearnMoreLink
      - executeFunction:
          name: ca.test.functions.onboarding.shareLocation.tapEnterPostalCodeLink

      - log:
          message: "Step 4: Validating Share Your Location Page"
          color: GREEN_BOLD
      - executeFunction:
          name: ca.test.functions.onboarding.validateShareYourPostalCodePage
      - executeFunction:
          name: ca.test.functions.onboarding.sharePostalCode.tapUseCurrentLocation

      - log:
          message: "Step 5: Onboard though Share Precise Location."
          color: GREEN_BOLD
      - executeFunction:
          name: ca.test.functions.onboarding.shareLocation.sharePreciseLocation

      - log:
          message: "Step 6: Validate Personalised Experience Page."
          color: GREEN_BOLD
      - executeFunction:
          name: ca.test.functions.onboarding.validatePersonalisedExperienceScreen
      - executeFunction:
          name: ca.test.functions.onboarding.personalisedExperience.tapAllow

      - log:
          message: "End of onboarding validation."
          color: GREEN_BOLD

      # Checking if GIC CCM refreshed else relaunching the app to update the CCM.
      - log:
          message: "Checking for GIC header CCM refresh."
          color: GREEN_BOLD
      - executeFunction:
          name: ca.test.functions.globalIntent.isGlobalIntentHeaderDisplayed
      - if:
          condition: ${returnedIsDisplayed} == false
          then:
            - executeFunction:
                name: ca.test.functions.utils.relaunchApp

      - log:
          message: "Creating user account"
          color: GREEN_BOLD
      - executeFunction:
          name: ca.test.functions.apis.createAccount

      - log:
          message: "Add products below shipping threshold to cart."
          color: GREEN_BOLD

      - log:
          message: "Step 7: Validate Global Intent Onboarding Screen."
          color: GREEN_BOLD
      - executeFunction:
          name: ca.test.functions.globalIntent.validateOnboardingScreen
      - executeFunction:
          name: ca.test.functions.globalIntent.onboardingScreen.tapGotIt

      - log: 
          message: "Step 8: Validate Global Pickup Intent."
          color: GREEN_BOLD
      - executeFunction:
          name: ca.test.functions.globalIntent.selectPickupIntent
      - executeFunction:
          name: ca.test.functions.globalIntent.valdiatePickupIntentHotCard
          params:
            - name: storeName
              string: ca.test.data.gic.defaultStoreName
            - name: storeAddress
              string: ca.test.data.gic.defaultStoreAddress

      - log:
          message: "Step 9: Validate Global Delivery Intent for Guest User."
          color: GREEN_BOLD
      - executeFunction:
          name: ca.test.functions.globalIntent.selectDeliveryIntent
      - executeFunction:
          name: ca.test.functions.globalIntent.guestUser.validateDeliveryHotCard
          params:
            - name: defaultAddress
              string: ca.test.data.gic.defaultAddress

      - log: 
          message: "Step 10: Guest User login from Delivery Address Page."
          color: GREEN_BOLD
      - executeFunction:
          name: ca.test.functions.gobalIntent.deliveryIntent.guestUserAddAddress

      - log:
          message: "Step 11: Validate Sign In page and login"
          color: GREEN_BOLD
      - executeFunction:
          name: ca.test.functions.loginPage.userLogin
          params:
            - name: email
              string: ${email}
            - name: password
              string: ${password}


      - log:
          message: "Step 12: Validate and select the delivery address."
          color: GREEN_BOLD
      - executeFunction:
          name: ca.test.functions.addressSelectorPopup.isAddressPageDisplayed
      - if:
          condition: ${returnedIsDisplayed} == true
          then:
            - log:
                message: "Address selector popup displayed."
                color: CYAN
            - executeFunction:
                name:  ca.test.functions.addressSelectorPopup.selectUserAddress
                params:
                    - name: userNameInAddress
                      string: Walmart Glass-App
            - executeFunction:
                name: ca.test.functions.addressSelectorPopup.tapSaveButton
          else:
            - failTest:
                message: "Address selector popup not displayed."
      
      - log:
          message: "Step 13: Validate Global Delivery Intent for Registered User."
          color: GREEN_BOLD

# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - log: 'R2_SUBFLOW_POST_TRANSACTION'
# # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      - storeIn:
          key: testStatus
          value: passed
  #After Scenarios
  - name: After
    after: true
    flow:
      - log:
          message: flow-001
          color: GREEN_BOLD
      - executeFunction:
          name: ca.test.functions.utils.afterSteps