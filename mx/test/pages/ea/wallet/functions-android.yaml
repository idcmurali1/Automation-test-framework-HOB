#======================================================================================================================
#  AUTHOR: Isis Tolentino (vn53dge)
#  CREATED: Dec/21/2023
#  REVISION: ---
#
#  Copyright © 2023 Walmart. All rights reserved.
#======================================================================================================================

functions:

  # AUTHOR: Isis Tolentino (vn53dge)
  - name: mx.functions.ea.wallet.assertPageDisplayed
    platform: android
    flow: 
      - verifyIdentifier:
          present:
            - identifier: mx.mappings.ea.wallet.backButton
            - identifier: mx.mappings.ea.wallet.pageTitle
            - identifier: mx.mappings.ea.wallet.genericPageContainer
      - log:  
          message: "End function: wallet.assertPageDisplayed"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION:  This method asserts that a specific card is present in card's carousel.
  #               Note: use this function when user have only 1  or 2 cards in wallet. For other cases use function searchAndAssertCardAdded.
  # PARAM         ${cardLastDigits} [Mandatory] Must be the las FOUR digits from card added.
  # AUTHOR: Isis Tolentino (vn53dge)
  # EDITOR: Osmar Juárez (vn56dce), Rodrigo Pacheco (vn53p0i)
  - name: mx.functions.ea.wallet.assertCardDisplayed
    platform: android
    flow:
      - log:
          message: "Expected to find card with last digits: '${cardLastDigits}'"
          color: CYAN
      - if:
          identifier:
            present:
              - identifier: mx.mappings.ea.wallet.cardContainer
              - identifier: mx.mappings.ea.wallet.cardLastDigits #<--PARAM--${cardLastDigits}
          then:
            - log:
                message: "Assertion Succeeded: Correct Card is Displayed."
                color: GREEN_BOLD
          else:
            - failTest:
                message: "Failed: Expected Card's last digits did not display."
      - log:
          message: "End function: wallet.assertCardDisplayed"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # AUTHOR: Isis Tolentino (vn53dge)
  - name: mx.functions.ea.wallet.tapBack
    platform: android
    flow:
      - click:
          identifier: mx.mappings.ea.wallet.backButton
      - log:
          message: "End function: wallet.tapBack"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # AUTHOR: Isis Tolentino (vn53dge)
  - name: mx.functions.ea.wallet.tapEditCard
    platform: android
    flow:
      - click:
          identifier: mx.mappings.ea.wallet.editCardButton
      - log:
          message: "End function: wallet.tapEditCard"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION: Tap on edit card finding the edit button of a specific card added using the last digits. 
  #              Useful when there are more than 1 card added in the user's wallet.
  # PARAM: ${cardLastDigits} [Mandatory] Must be the las FOUR digits from card added.
  # AUTHOR: Osmar Juárez (vn56dce)
  # EDITOR: Rodrigo Pacheco (vn53p0i)
  - name: mx.functions.ea.wallet.tapEditCardByLastDigits
    platform: android
    flow:
      - log:
          message: "Card's last 4 digits to edit: '${cardLastDigits}'"
          color: CYAN
      - click:
          identifier: mx.mappings.ea.wallet.editCardButtonByLastDigits #--PARAM--${cardLastDigits}--
      - log:
          message: "End function: wallet.tapEditCardByLastDigits"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION:  This method asserts the added card is NOT displayed.
  # PARAM         ${cardLastDigits} [Mandatory] Must be the las FOUR digits from card added.
  # AUTHOR: Isis Tolentino (vn53dge)
  # EDITOR: Rodrigo Pacheco (vn53p0i)
  - name: mx.functions.ea.wallet.assertCardNotDisplayed
    platform: android
    flow:
      - log:
          message: "Card's last 4 digits to verify: '${cardLastDigits}'"
          color: CYAN
      - if:
          identifier:
            notPresent:
              - identifier: mx.mappings.ea.wallet.cardLastDigits #<--PARAM--${cardLastDigits}
          then:
            - log:
                message: "Assertion Succeeded: Expected Card is not Displayed."
                color: GREEN_BOLD
          else:
            - failTest:
                message: "Failed: Expected Card is still present."
      - log:
          message: "End function: wallet.assertCardNotDisplayed"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION:  This method asserts that a card added is NO longer displayed after deleted. This assertion supports when 
  #               user has more than 1 card saved in wallet.
  # PARAMS:       ${cardLastDigits}              [Mandatory] Must be the last FOUR digits from card added.
  #               ${expectedTotalNumberOfCards}  [Mandatory] Must be the expected number of cards to be saved in wallet.
  # AUTHOR: Osmar Juárez (vn56dce)
  # EDITOR: ------
  - name: mx.functions.ea.wallet.assertCardNotDisplayedInCollapsedView
    platform: android
    flow:
      - log:
          message: "Expected Not Found Card with last digits: '${cardLastDigits}'"
          color: CYAN
      - log:
          message: "Expected Total Number Of Cards: '${expectedTotalNumberOfCards}'"
          color: CYAN
      - executeFunction:
          name: mx.functions.ea.wallet.getNumberOfCardsInWallet
      - storeIn:
          key: numberOfCards
          value: ${returnedNumberOfCards}
      - click:
          identifier: mx.mappings.ea.wallet.arrowExpandOrCollapseCardsCarousel      
      - executeFunction:
          name: mx.functions.ea.wallet.assertCardNotDisplayed
          params:
            - name: cardsLastDigits
              string: ${cardLastDigits}
      - if:
          condition: ${numberOfCards} == ${expectedTotalNumberOfCards}
          then:
            - log:
                message: "Assertion Succeeded: Expected Number of Cards is correct;"
                color: GREEN_BOLD
          else:
            - failTest:
                message: "Failed: Expected Number of Cards is not the expected value."
      - log:
          message: "End function: ea.wallet.assertCardNotDisplayedInCollapsedView"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION:  This method validate that the current card container view for a specific card is fully Displayed with
  #               all the elements like: bank icon, card last digits, expiration date and edit button
  # PARAM         ${cardLastDigits}            [Mandatory] Must be the last FOUR digits from card added.
  # RETURN        ${isCardViewFullyDisplayed}  Boolean flag to indicate if the card view displayed it is the card searched
  # AUTHOR: Osmar Juárez (vn56dce)
  - name: mx.functions.ea.wallet.validateCardViewIsFullyDisplayed
    platform: android
    flow:
      - if:
          identifier:
            displayed:
              - identifier: mx.mappings.ea.wallet.cardViewByIcon #--PARAM--${cardLastDigits}-- 
                value: "true"
              - identifier: mx.mappings.ea.wallet.cardViewByCardNumber #--PARAM--${cardLastDigits}-- 
                value: "true"
              - identifier: mx.mappings.ea.wallet.cardViewByEditButton #--PARAM--${cardLastDigits}-- 
                value: "true"
              - identifier: mx.mappings.ea.wallet.cardViewByExpirationDate #--PARAM--${cardLastDigits}-- 
                value: "true"
          then:
            - log:
                message: "[OK] Card is currently displayed on selected view in carousel"
                color: GREEN_BOLD
            - storeIn:
                key: isCardViewFullyDisplayed
                value: true
          else:
            - log:
                message: "[WARNING] Card is not displayed on current selected view in carousel"
                color: YELLOW
            - storeIn:
                key: isCardViewFullyDisplayed
                value: false
      - log:
          message: "End function: ea.wallet.validateCardViewIsFullyDisplayed"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------
  #
  # DESCRIPTION: This function search and returns the number of cards saved in wallet
  # RETURNS:     ${returnedNumberOfCards} Total Number of credit/debit cards that user has saved in wallet.
  # AUTHOR: Osmar Juárez (vn56dce)
  # EDITOR: -----
  - name: mx.functions.ea.wallet.getNumberOfCardsInWallet
    platform: android
    flow:
      # Get the total number of cards saved in wallet for the current user
      - getString:
          identifier: mx.mappings.ea.wallet.cardsCarouselTitle # contains a string text like "Tarjetas de credito y debito (N0)"
          attribute: text
          extractNumbers: true
          storeIn: returnedNumberOfCards # saved only the numeric value from the string "N0"
      - log:
          message: "Total cards saved by the user: '${returnedNumberOfCards}'" 
          color: GREEN_BOLD
      - log:
          message: 'End function: mx.functions.ea.wallet.getNumberOfCardsInWallet'
          color: BLUE
  
  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION:  This function calculate the actual position of the indicator bar for the actual card view displayed in the carousel.
  #               Based on the actual position on the view and the total number of cards the function returns different
  #               flags to indicate if it is the first position, the last one or near to the last or firts positions.
  #               Note: If the card view position indicator it is at the middle point this is consider as "CLOSER to the FIRST" card
  #
  # PARAM:        ${totalNumberOfCards}  Numeric value to indicate the total number of cards that user has saved.
  # RETURNS:         
  #               ${cardViewPosition}    String with the value of the initial indicator position element ["Tarjeda # de #"]
  #               ${isFirstCard}         Boolean flag [true | false] to indicate if the card view indicator position is the first card
  #               ${isLastCard}          Boolean flag [true | false] to indicate if the card view indicator position is the last card
  #               ${isCloserToTheFirst}  Boolean flag [true | false] to indicate if the card view indicator position is closer to the first card
  #               ${isCloserToTheLast}   Boolean flag [true | false] to indicate if the card view indicator position is closer to the last card
  # AUTHOR: Osmar Juárez (vn56dce)
  - name: mx.functions.ea.wallet.getInitialIndicatorPositionCardView
    platform: android
    flow:
      # Calculate the middle position based on the total number of cards (Note: Odd numbers are rounded to next number, I.E: 3/2 = 1.5 rounded to 2)
      - arithmetic:
          expression: ${totalNumberOfCards} / 2
          storeIn: middlePosition
          numberOfDecimalPlaces: 0
      - log:
          message: "Middle position for cards view: '${middlePosition}'" 
          color: GREEN_BOLD
      # Get and saved the actual position from the text property of the indicator baner
      - getString:
          identifier: mx.mappings.ea.wallet.indicatorPositionCardView
          attribute: content-desc
          extractNumbers: false
          storeIn: cardViewPosition # store the string: "Tarjeta N1 de N2"
      - log:
          message: "Current Card View Indicator Position: '${cardViewPosition}'" 
          color: GREEN_BOLD
      - getString:   
          identifier: mx.mappings.ea.wallet.indicatorPositionCardView # get only the numeric values from string "Tarjeta N1 de N2" 
          attribute: content-desc
          extractNumbers: true
          storeIn: currentConcatCardViewPosition # saved only the numeric values like "N1N2"
      - storeIn:
          key: concatFirtsPosition
          value: 1${totalNumberOfCards}
      - storeIn:
          key: concatMiddleWihtLastPosition
          value: ${middlePosition}${totalNumberOfCards}
      - storeIn:
          key: concatLastPosition
          value: ${totalNumberOfCards}${totalNumberOfCards}
      # initializing position flags
      - storeIn:
          key: isFirstCard
          value: false
      - storeIn:
          key: isLastCard
          value: false
      - storeIn:
          key: isCloserToTheFirst
          value: false
      - storeIn:
          key: isCloserToTheLast
          value: false
      # Based on the actual position of the card view we set the flags to indicate if is more on the left or right (first or last card)
      - if:
          condition: ${currentConcatCardViewPosition} <= ${concatMiddleWihtLastPosition}
          then:
            - if:
                condition: ${currentConcatCardViewPosition} == ${concatFirtsPosition}
                then:
                  - log:
                      message: "Card View Indicator Position: 'First Card'" 
                      color: GREEN_BOLD
                  - storeIn:
                      key: isFirstCard
                      value: true
                else: 
                  - storeIn:
                      key: isCloserToTheFirst
                      value: true
                  - log:
                      message: "Card View Indicator Position: CLOSER to the FIRST card" 
                      color: GREEN_BOLD  
          else:
            - if:
                condition: ${currentConcatCardViewPosition} == ${concatLastPosition}
                then:
                  - log:
                      message: "Card View Indicator Position: 'Last Card'" 
                      color: GREEN_BOLD
                  - storeIn:
                      key: isLastCard
                      value: true
                else:
                  - storeIn:
                        key: isCloserToTheLast
                        value: true
                  - log:
                      message: "Card View Indicator Position: CLOSER to the LAST card" 
                      color: GREEN_BOLD
      - log:
          message: "End function: ea.wallet.getInitialIndicatorPositionCardView"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION:  Funtion to update flags considering if there are more cards to continue scrolling to the left or right
  # RETURN        ${isEdgeFirstCardCarousel} Boolean flag [true|false] to indicate that there are no more cards to the left to scroll in carousel
  # RETURN        ${isEdgeLastCardCarousel}  Boolean flag [true|false] to indicate that there are no more cards to the right to scroll in carousel 
  # AUTHOR: Osmar Juárez (vn56dce)
  - name: mx.functions.ea.wallet.checkIfIsEdgeCardCarousel
    platform: android
    flow:
      - if:
          identifier:
            notPresent:
              - identifier: mx.mappings.ea.wallet.nextCardView 
          then:
            - storeIn:
                key: isEdgeLastCardCarousel
                value: true
      - if:
          identifier:
            notPresent:
              - identifier: mx.mappings.ea.wallet.previousCardView 
          then:
            - storeIn:
                key: isEdgeFirstCardCarousel
                value: true
      - log:
          message: "End function: ea.wallet.checkIfIsEdgeCardCarousel" 
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION:  Scroll in Card Caroulel based on the first position of the displayed card view in cards carousel 
  #               to start scrolling until all the cards in wallet are veryfied 
  # PARAM         ${cardsLastDigits}           [Mandatory] Must be the last FOUR digits from card added.
  #               ${totalNumberOfCards}        [Mandatory] Total number of cards seaved in wallet for the current user
  # RETURN        ${isCardViewFullyDisplayed}  Boolean flag to indicate if the card view displayed it is the card searched
  # AUTHOR: Osmar Juárez (vn56dce)
  - name: mx.functions.ea.wallet.scrollUntilFoundCard
    platform: android
    flow:
      - executeFunction: 
          name: mx.functions.ea.wallet.getInitialIndicatorPositionCardView 
          params:
            - name: totalNumberOfCards
              string: ${totalNumberOfCards}
          #RETURN: ${cardViewPosition}--${isFirstCard}--${isLastCard}--${isCloserToTheFirst}--${isCloserToTheLast}
      # initializing flags to set directions when initial position is not the first or last card 
      - storeIn:
          key: isEdgeFirstCardCarousel
          value: false
      - storeIn:
          key: isEdgeLastCardCarousel
          value: false
      - storeIn:
          key: isReturnPerformed
          value: false
      # For loop from 0 to Total number of cards to search and assert each card until find the searched one
      - loop:
          begin: 0
          end: ${totalNumberOfCards}
          storeIndex: i
          mode: increment
          flow:
            - log: -- Loop iteration ${i} --
            - executeFunction:
                name:  mx.functions.ea.wallet.validateCardViewIsFullyDisplayed  # RETURN: ${isCardViewFullyDisplayed}
                params:
                  - name: cardLastDigits
                    string: ${cardLastDigits}
            - if:
                condition: ${isCardViewFullyDisplayed} == "true"
                then:
                  - log:
                      message: "[OK] Card was found in carousel."
                      color: GREEN_BOLD
                  - break: true
                else:
                  - if:
                      condition: ${isLastCard} == "true" 
                      then:
                        - scroll:
                            direction: right
                            withinIdentifier: mx.mappings.ea.wallet.cardsCarousel
                  - if:
                      condition: ${isFirstCard} == "true" 
                      then:
                        - scroll:
                            direction: left
                            withinIdentifier: mx.mappings.ea.wallet.cardsCarousel
                  - if:
                      condition: ${isCloserToTheFirst} == "true" 
                      then:
                        - executeFunction:
                            name: mx.functions.ea.wallet.checkIfIsEdgeCardCarousel
                            # RETURN: ${isEdgeFirstCardCarousel} 
                        - if:
                            condition: ${isEdgeFirstCardCarousel} == "true" 
                            then:
                              - if:
                                  condition: ${isReturnPerformed} == "false"
                                  then:
                                    - scroll:
                                        direction: left
                                        untilIdentifier: mx.mappings.ea.wallet.otherPositionCardView #--PARAM--${cardViewPosition}
                                        withinIdentifier: mx.mappings.ea.wallet.cardsCarousel
                                    - storeIn:
                                        key: isReturnPerformed
                                        value: true
                                    - scroll:
                                        direction: left
                                        withinIdentifier: mx.mappings.ea.wallet.cardsCarousel
                                  else:
                                    - if:
                                        condition: ${isEdgeLastCardCarousel} != "true"
                                        then: 
                                          - scroll:
                                              direction: left
                                              withinIdentifier: mx.mappings.ea.wallet.cardsCarousel
                            else:
                              - scroll:
                                  direction: right
                                  withinIdentifier: mx.mappings.ea.wallet.cardsCarousel
                  - if:
                      condition: ${isCloserToTheLast} == "true" 
                      then:
                        - executeFunction:
                            name: mx.functions.ea.wallet.checkIfIsEdgeCardCarousel
                            # RETURN: ${isEdgeLastCardCarousel}
                        - if:
                            condition: ${isEdgeLastCardCarousel} == "true" 
                            then:
                               - if:
                                  condition: ${isReturnPerformed} == "false"
                                  then:
                                    - scroll:
                                        direction: right
                                        untilIdentifier: mx.mappings.ea.wallet.otherPositionCardView #--PARAM--${cardViewPosition}
                                        withinIdentifier: mx.mappings.ea.wallet.cardsCarousel
                                    - storeIn:
                                        key: isReturnPerformed
                                        value: true
                                    - scroll:
                                        direction: right
                                        withinIdentifier: mx.mappings.ea.wallet.cardsCarousel
                                  else:
                                    - if:
                                        condition: ${isEdgeFirstCardCarousel} != "true"
                                        then: 
                                          - scroll:
                                              direction: right
                                              withinIdentifier: mx.mappings.ea.wallet.cardsCarousel
                            else:
                              - scroll:
                                  direction: left
                                  withinIdentifier: mx.mappings.ea.wallet.cardsCarousel

      - log:
          message: "End function: ea.wallet.scrollUntilFoundCard" 
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION:  This function search for the specified card and position the current view for the card searched. 
  #               The function start scroll from left to right or from right to left based on the initial position
  # PARAM         ${cardLastDigits}     [Mandatory] Must be the last FOUR digits from card added.
  # PARAM         ${totalNumberOfCards} [Mandatory] Must be the number of cards saved in wallet. 
  # AUTHOR: Osmar Juárez (vn56dce)
  - name: mx.functions.ea.wallet.assertCardWithSearchAndPosition
    platform: android
    flow:
      - log:
          message: "Looking for card with last digits: '${cardLastDigits}'"
          color: CYAN
      - if:
          condition: ${totalNumberOfCards} == "1"
          then:
            - executeFunction:
                name:  mx.functions.ea.wallet.validateCardViewIsFullyDisplayed # RETURN: ${isCardViewFullyDisplayed}
                params:
                  - name: cardLastDigits
                    string: ${cardLastDigits}
          else: 
            - executeFunction: 
                name: mx.functions.ea.wallet.scrollUntilFoundCard # based on actual position scroll to right or left until next card to validate
                params:
                  - name: cardLastDigits
                    string: ${cardLastDigits}
                  - name: totalNumberOfCards
                    string: ${totalNumberOfCards}    
      - if: 
          condition: ${isCardViewFullyDisplayed} == "false"
          then:
            - failTest: 
                message: "[X] Assertion fail: Card was not found or is fully displayed in carousel."
          else:
            - log:
                message: "[OK] Assertion succeed: Card was found and was position to view fully displayed."
                color: CYAN
      - log:
          message: "End function: ea.wallet.assertCardWithSearchAndPosition"
          color: BLUE
