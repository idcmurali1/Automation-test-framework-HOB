#======================================================================================================================
#  AUTHOR: Rodrigo Pacheco Cámara (vn53p0i)
#  CREATED: Feb/19/2024
#  REVISION: ---
#
#  Copyright © 2024 Walmart. All rights reserved.
#======================================================================================================================

functions:

  # Description: This function asserts if the PDP view is displayed.
  # AUTHOR: Rodrigo Pacheco  (vn53p0i)
  - name: mx.functions.ea.pdp.assertPageDisplayed
    platform: ios
    flow:
      - scroll:
          direction: down
          scrollLimit: 1
          wait: 1000
      - if:
          identifier:
            present:
              - identifier: mx.mappings.ea.pdp.productNameLabel
              - identifier: mx.mappings.ea.pdp.topProductPriceLabel
              - identifier: mx.mappings.ea.pdp.productPicture
              - identifier: mx.mappings.ea.pdp.zoomIcon
          then:
            - log:
                message: "Success: PDP is displayed."
                color: CYAN
          else:
            - failTest:
                message: "Failed: PDP did not display."
      - log:
          message: "End function: pdp.assertPageDisplayed"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Param: ${productName}  [Mandatory]  Full expected product name to be displayed.
  # AUTHOR: Rodrigo Pacheco  (vn53p0i)
  - name: mx.functions.ea.pdp.assertCorrectProductDisplayed
    platform: ios
    flow:
      - log:
          message: "Product Name: '${productName}'"
          color: CYAN
      - if:
          identifier:
            present:
              - identifier: mx.mappings.ea.pdp.productNameLabel #<--[PARAM]--${productName}
          then:
            - log:
                message: "Success: PDP is displayed."
                color: GREEN_BOLD
          else:
            - failTest:
                message: "Failed: PDP is not displayed."
      - log:
          message: "End function: pdp.assertCorrectProductDisplayed"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # AUTHOR: Rodrigo Pacheco  (vn53p0i)
  - name: mx.functions.ea.pdp.addToCart
    platform: ios
    flow:
      - click:
          identifier: mx.mappings.ea.pdp.addToCartButton
      - log:
          message: "End function: pdp.addToCart"
          color: BLUE

  # -------------------------------------------------------------------------------------------------------------------              

  # AUTHOR: Rodrigo Pacheco  (vn53p0i)
  - name: mx.functions.ea.pdp.assertAddedToCart
    platform: ios
    flow:
      - if:
          identifier:
            present:
              - identifier: mx.mappings.ea.pdp.addToCartButton
          then:
            - failTest:
                message: "The product has not been added to cart."
          else:
            - log:
                message: "Success: Product has been added to cart."
                color: GREEN_BOLD
      - log:
          message: "End function: pdp.assertAddedToCart"
          color: BLUE 

  # -------------------------------------------------------------------------------------------------------------------              

  # AUTHOR: Rodrigo Pacheco  (vn53p0i)
  - name: mx.functions.ea.pdp.tapClose
    platform: ios
    flow:
      - click:
          identifier: mx.mappings.ea.pdp.closeButton
      - log:
          message: "End function: pdp.tapClose"
          color: BLUE

  # -------------------------------------------------------------------------------------------------------------------              

  # DESCRIPTION: This function returns product's final price from the pdp displayed.
  # RETURNS:
  #   ${returnedPrice}
  #   ${returnedOriginalPrice} If available, if not, the same value as '${returnedPrice}' will be returned.
  #   ${returnedDiscountAmount} This is the amount that the user will save by purchasing the product. Only if product has discount.
  # AUTHOR: Osmar Juárez  (vn56dce)
  # EDITOR: Rodrigo Pacheco (vn53p0i)
  - name: mx.functions.ea.pdp.getProductPrice
    platform: ios
    flow:
      - getString:
          identifier: mx.mappings.ea.pdp.topProductPriceLabel
          storeIn: productPrice
      - executeNode:
          file: mx/test/helpers/utils/getNumberFromPriceString.js
          args:
            - value: ${productPrice}
          getResponse:
            storeIn: returnedPrice

      # Verifying if product has a discount...
      - if:
          identifier:
            present:
              - identifier: mx.mappings.ea.pdp.topProductOriginalPriceLabel
          then:
            # Extraction of the Original Price...
            - log:
                message: "Discount found, extracting Original Price value..."
                color: GREEN_BOLD
            - getString:
                identifier: mx.mappings.ea.pdp.topProductOriginalPriceLabel
                storeIn: originalPrice
            - executeNode:
                file: mx/test/helpers/utils/getNumberFromPriceString.js
                args:
                  - value: ${originalPrice}
                getResponse:
                  storeIn: returnedOriginalPrice

            # Calculate the Discount Amount...
            - arithmetic:
                expression: ${returnedOriginalPrice} - ${returnedPrice}
                numberOfDecimalPlaces: 2
                storeIn: returnedDiscountAmount
          else:
            - log:
                message: "Discount not found, returning Current Price..."
                color: GREEN_BOLD
            - storeIn:
                key: returnedOriginalPrice
                value: ${returnedPrice}
            - storeIn:
                key: returnedDiscountAmount
                value: '0.00'

      # Logging Results...
      - log:
          message: "Price Got: '${returnedPrice}'"
          color: GREEN_BOLD
      - log:
          message: "Original Price Got: '${returnedOriginalPrice}'"
          color: GREEN_BOLD
      - log:
          message: "Discount Amount Got: '${returnedDiscountAmount}'"
          color: GREEN_BOLD
      - log:
          message: "End function: mx.functions.ea.pdp.getProductPrice"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION: Increases the actual quantity of a product by the desired amount of increments. i.e. for a product which
  #     its current quantity is 12, if the desired amount of increments is 5, the final quantity will be 17 (assuming
  #     there was enough stock to supply the demand, otherwise, the app will cap the quantity to the max available stock).
  #
  # PARAMS:
  #     ${quantity}  [Mandatory]
  #         Amount of increments to to the actual quantity.
  #
  #     ${ignoreClickException}  [Optional]
  #         Flag to tell the clicking action (to perform the quantity increments) to ignore the exception in case the click
  #         cannot be done. This scenario mostly happens when the product reaches the Max Quantity Limit; the increase
  #         button becomes not clickable and so and exception (and a failure) will be thrown. Use this flag only when
  #         necessary.
  #         Options: [ true | false | null ]
  #
  # AUTHOR: Rodrigo Pacheco (vn53p0i)
  - name: mx.functions.ea.pdp.increaseProductQuantityBy
    platform: ios
    flow:
      - log:
          message: "Increments: '${quantity}'"
          color: CYAN
      - log:
          message: "Ignore Click Exception: '${ignoreClickException}'"
          color: CYAN
      - try:
          flow:
            - click:
                identifier: mx.mappings.ea.pdp.increaseQuantityButton
                numberOfClicks: ${quantity}
                waitBetweenClicks: 8000
          catch:
            flow:
              - if:
                  condition: ${ignoreClickException} == true
                  then:
                    - log:
                        message: "Increment Quantity Button not clickable, process will continue..."
                        color: GREEN_BOLD
                    # Close the 'Not enough pieces' popup if displayed...
                    - sleep:
                        duration: 3000
                    - executeFunction:
                        name: mx.functions.ea.pdp.not-enough-pieces-popup.closePopupIfDisplayed
                  else:
                    - failTest:
                        message: "Increment Quantity Button not clickable, quantity cannot be incremented"
      - sleep:
          duration: 8000
      - log:
          message: "End function: pdp.increaseProductQuantityBy"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION: Decreases the actual quantity of a product by the desired amount of decrements. i.e. for a product which
  #     its current quantity is 12, if the desired amount of decrements is 5, the final quantity will be 7.
  #
  # PARAMS:
  #     ${quantity}  [Mandatory]
  #         Amount of increments to to the actual quantity.
  #
  # AUTHOR: Rodrigo Pacheco (vn53p0i)
  - name: mx.functions.ea.pdp.decreaseProductQuantityBy
    platform: ios
    flow:
      - log:
          message: "Decrements: '${quantity}'"
          color: CYAN
      - click:
          identifier: mx.mappings.ea.pdp.decreaseQuantityButton
          numberOfClicks: ${quantity}
          waitBetweenClicks: 8000
      - sleep:
          duration: 8000
      - log:
          message: "End function: pdp.decreaseProductQuantityBy"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION:  Closes the specified popup in case it displays, sometimes multiple popups can display at once, so function
  #                 will close all of them in case this happens.
  # AUTHOR: Rodrigo Pacheco (vn53p0i)
  - name: mx.functions.ea.pdp.not-enough-pieces-popup.closePopupIfDisplayed
    platform: ios
    flow:
      - loop:
          begin: 0
          end: 12
          mode: increment
          flow:
            - if:
                identifier:
                  present:
                    - identifier: mx.mappings.ea.pdp.not-enough-pieces-popup.understoodButton
                then:
                  - log:
                      message: "Closing 'Not enough pieces' popup..."
                      color: GREEN_BOLD
                  - click:
                      identifier: mx.mappings.ea.pdp.not-enough-pieces-popup.understoodButton
                else:
                  - log:
                      message: "The 'Not enough pieces' popup did not display."
                      color: GREEN_BOLD
                  - break: true
      - log:
          message: "End function: pdp.not-enough-pieces-popup.closePopupIfDisplayed"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # RETURNS:  ${returnedProductQuantity}
  # AUTHOR: Rodrigo Pacheco C. (vn53p0i)
  - name: mx.functions.ea.pdp.getProductQuantity
    platform: ios
    flow:
      - getString:
          identifier: mx.mappings.ea.pdp.productQuantity
          extractNumbers: true
          storeIn: returnedProductQuantity
      - executeNode:
          file: mx/test/helpers/utils/sanitizeQuantity.js
          args:
            - value: ${returnedProductQuantity}
          getResponse:
            storeIn: returnedProductQuantity
      - log:
          message: "Quantity Got: '${returnedProductQuantity}'"
          color: GREEN_BOLD
      - log:
          message: "End function: pdp.getProductQuantity"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION: Verifies if the product has discount or not and returns the result in a boolean value.
  # RETURNS:  ${returnedHasDiscount}
  # AUTHOR: Rodrigo Pacheco C. (vn53p0i)
  - name: mx.functions.ea.pdp.checkIfProductHasDiscount
    platform: ios
    flow:
      - if:
          identifier:
            present:
              - identifier: mx.mappings.ea.pdp.topProductOriginalPriceLabel
          then:
            - storeIn:
                key: returnedHasDiscount
                value: true
          else:
            - storeIn:
                key: returnedHasDiscount
                value: false
      - log:
          message: "Returned Result: 'returnedHasDiscount' = '${returnedHasDiscount}'"
          color: GREEN_BOLD
      - log:
          message: "End function: pdp.checkIfProductHasDiscount"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # AUTHOR: Rodrigo Pacheco  (vn53p0i)
  - name: mx.functions.ea.pdp.refurbished-product-popup.tapContinueIfDisplayed
    platform: ios
    flow:
      - if:
          identifier:
            present:
              - identifier: mx.mappings.ea.pdp.refurbished-product-popup.popupTitle
          then:
            - log:
                message: "Closing Refurbished Product Popup..."
                color: GREEN_BOLD
            - click:
                identifier: mx.mappings.ea.pdp.refurbished-product-popup.continueButton
          else:
            - log:
                message: "Refurbished Product Popup did not display."
                color: GREEN_BOLD
      - log:
          message: "End function: pdp.refurbished-product-popup.tapContinueIfDisplayed"
          color: BLUE
  
  #--------------------------------------------------------------------------------------------------------------------

  - name: mx.functions.ea.pdp.clickBuyNow
    platform: ios
    flow:
      - click:
          identifier: mx.mappings.ea.pdp.buyNowButton
      - log:
          message: "End Function: ea.pdp.buyNowButton"
          color: BLUE