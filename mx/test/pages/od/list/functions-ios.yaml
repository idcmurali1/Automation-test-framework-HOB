#======================================================================================================================
#  AUTHOR: Gustavo Antonio Lopez Cambambia (vn53g21)
#  CREATED: Jan/09/2023
#  REVISION: ---
#
#  Copyright © 2022 Walmart. All rights reserved.
#======================================================================================================================

functions:

  # Description: This function scrolls down to specific product
  # Param: ${productName}  [Mandatory]  specific product name.
  - name: mx.functions.list.scrollDownToProduct
    platform: ios
    flow: 
      - scroll: 
          direction: down
          untilIdentifier: mx.mappings.list.productByName
          position: center
          scrollLimit: 8
          wait: 1000

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This function scrolls up to specific product
  # Param: ${productName}  [Mandatory]  specific product name.
  - name: mx.functions.list.scrollUpToProduct
    platform: ios
    flow: 
      - scroll: 
          direction: up
          untilIdentifier: mx.mappings.list.productByName
          position: center
          scrollLimit: 8
          wait: 1000

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This function change the needed quantity of specific product
  # Param2: ${productName}  [Mandatory]  specific product name.
  #         ${productPiecesNeeded} [Mandatory] quantity to increase
  - name: mx.functions.list.changeNeededQuantity
    platform: ios
    flow: 
      - click:
          identifier: mx.mappings.list.neededQuantityButton
      - enterText:
          identifier: mx.mappings.list.pickerWheelNeeded
          string: ${productPiecesNeeded}
          clickFirst: false
          clearField: false
      - log: 
          message: "${productPiecesNeeded} was selected as needed quantity"
          color: CYAN
      - executeFunction:
          name: mx.functions.utils.tapCloseKeyboardButton

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This function increases the product quantity by clicking the increase button.
  # Params: ${productName}  [Mandatory]  Specific product name.
  #         ${quantity}     [Mandatory]  Quantity to increase on clicks.
  # AUTHOR: Rodrigo Pacheco C. (vn53p0i)
  - name: mx.functions.list.increaseProductQuantityBy
    platform: ios
    flow:
      - log:
          message: "Product Name: '${productName}'"
          color: CYAN
      - log:
          message: "Quantity to increase: '${quantity}'"
          color: CYAN
      - executeFunction:
          name: mx.functions.utils.extractElementCoordinates # --RETURNS--${x}--${y}--Coordinates-->
          params:
            - name: element
              string: mx.mappings.list.mainButtonByProductName # <--PARAMS--${productName}
      # Adjusting element coordinates to click the increment button relative to the collapsed main button.
      - arithmetic:
          expression: ${x} + 105
          storeIn: x1
      - arithmetic:
          expression: ${y} + 15
          storeIn: y1
      # The first click expands the button so we can show and reach the increase button and the second performs the increments.
      - click:
          coordinates: ${x}, ${y}
      - click:
          coordinates: ${x1}, ${y1}
          numberOfClicks: ${quantity}
          waitBetweenClicks: 10
      # This waits for the button to collapse, so function can be used exactly before its decrease variation.
      - sleep:
          duration: 3000
      - log:
          message: "End function: list.increaseProductQuantityBy"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This function decreases the product quantity by clicking the decrease button.
  # Params: ${productName}  [Mandatory]  Specific product name.
  #         ${quantity}     [Mandatory]  Quantity to decrease on clicks.
  # AUTHOR: Rodrigo Pacheco C.
  - name: mx.functions.list.decreaseProductQuantityBy
    platform: ios
    flow:
      - log:
          message: "Product Name: '${productName}'"
          color: CYAN
      - log:
          message: "Quantity to decrease: '${quantity}'"
          color: CYAN
      - executeFunction:
          name: mx.functions.utils.extractElementCoordinates # --RETURNS--${x}--${y}--Coordinates-->
          params:
            - name: element
              string: mx.mappings.list.mainButtonByProductName # <--PARAMS--${productName}
      # Adjusting element coordinates to click the decrement button relative to the collapsed main button.
      - arithmetic:
          expression: ${x} + 10
          storeIn: x1
      - arithmetic:
          expression: ${y} + 15
          storeIn: y1
      # The first click expands the button so we can show and reach the increase button and the second performs the decrements.
      - click:
          coordinates: ${x}, ${y}
      - click:
          coordinates: ${x1}, ${y1}
          numberOfClicks: ${quantity}
          waitBetweenClicks: 10
      # This waits for the button to collapse, so function can be used exactly before its increase variation.
      - sleep:
          duration: 3000
      - log:
          message: "End function: list.decreaseProductQuantityBy"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------
  
  # Description: This clicks on pieces button of a specific product.
  # Param: ${productName}  [Mandatory]  Name of the product to be added to cart.

  - name: mx.functions.list.switchProductToPieces
    platform: ios
    flow:
      - click: 
          identifier: mx.mappings.list.piecesButtonByProductName
      - log: 
          message: "product switched to pieces"
          color: CYAN

#--------------------------------------------------------------------------------------------------------------------

  # Description: This function clicks the weight button of specific product
  # Param: ${productName}  [Mandatory]  specific product name.
  - name: mx.functions.list.switchProductToWeight
    platform: ios
    flow: 
      - click:
          identifier: mx.mappings.list.weightButtonByProductName
      - log: 
          message: "Product switched to weight"
          color: CYAN

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This function gets the product subtotal of a specific product and stores it in the global variable ${returnedProductSubTotalPrice}
  # Param: ${productName}  [Mandatory]  specific product name.
  - name: mx.functions.list.getProductSubtotal
    platform: ios
    flow: 
      - getString:
          identifier: mx.mappings.list.productSubTotalPriceByProductName
          storeIn: productSubTotalPrice
      - executeNode:
          file: mx/test/helpers/list/getAndSanitizeSubtotalPriceiOS.js
          args:
            - value: ${productSubTotalPrice}
          getResponse:
            storeIn: returnedProductSubTotalPrice
      - log: 
          message: "the product: ${productName}, has a subtotal of: $${returnedProductSubTotalPrice}"
          color: CYAN

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This function gets the product quantity of specific weight product
  # Param: ${productName}  [Mandatory]  specific product name.
  - name: mx.functions.list.getProductQuantityAsWeight
    platform: ios
    flow: 
      - if:
          identifier:
            present:
              - identifier: mx.mappings.list.addToCartButtonByProductName
          then:
              - failTest:
                  message: "Cannot obtain the ${productName} product pieces, the product is not added to cart"
          else:
            - if:
                identifier:
                  present:
                    - identifier: mx.mappings.list.piecesProductTypeByName
                then:
                    - failTest:
                        message: "Cannot obtain weight, the ${productName} product is a pieces product"
                else:
                  - if:
                      identifier:
                        present:
                          - identifier: mx.mappings.list.weightProductTypeByName
                      then:
                        - getString:
                            identifier: mx.mappings.list.weightProductTypeByName
                            attribute: label
                            storeIn: productQuantityAsWeight
                        - executeNode:
                            file: mx/test/helpers/slp/sanitizePrice.js
                            args:
                              - value: ${productQuantityAsWeight}
                            getResponse:
                              storeIn: returnedProductQuantityAsWeight
                        - log:
                            message: "Quantity got for the product ${productName}: ${returnedProductQuantityAsWeight} grams."
                            color: CYAN

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This function gets the product name by his position number on page
  # Param: ${positionNumber}  [Mandatory]  specific product position.
  - name: mx.functions.list.getProductNameByPosition
    platform: ios
    flow: 
      - getString:
           identifier: mx.mappings.list.productNameByPosition
           storeIn: returnedProductNameByPosition
      - executeNode:
          file: mx/test/helpers/list/getAndSanitizeProductNameiOS.js
          args:
            - value: ${returnedProductNameByPosition}
          getResponse:
            storeIn: returnedProductNameByPosition
      - log:
          message: "Product name got for the position number ${positionNumber} is: ${returnedProductNameByPosition}"
          color: CYAN

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This function assert the estimated total displayed in page
  # Param: ${expectedEstimatedTotal}  [Mandatory]  specific estimated total to assert.
  - name: mx.functions.list.assertEstimatedTotal
    platform: ios
    flow:
      - log:
          message: "Expected Estimated Total: '${expectedEstimatedTotal}'"
          color: CYAN
      - getString:
          identifier: mx.mappings.list.estimatedTotalText
          storeIn: returnedEstimatedTotal
      - executeNode:
          file: mx/test/helpers/utils/cleanPriceStringIncludingCommas.js
          args:
            - value: ${returnedEstimatedTotal}
          getResponse:
            storeIn: returnedEstimatedTotal
      - log:
          message: "Extracted Estimated Total: '${returnedEstimatedTotal}'"
          color: GREEN_BOLD
      - if:
          condition: ${returnedEstimatedTotal} == ${expectedEstimatedTotal}
          then:
            - log:
                message: Estimated Total is correct.
                color: GREEN_BOLD
          else:
            - failTest:
                message: "Failed: Estimated Total is not correct."
      - log:
          message: "End function: list.assertEstimatedTotal"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This function assert the total products count displayed in page
  # Param: ${expectedTotalProductsCount}  [Mandatory]  specific number to assert.
  - name: mx.functions.list.assertTotalProductsCount
    platform: ios
    flow:
      - if:
          identifier:
            value:
              - identifier: mx.mappings.list.itemsCounter
                contains: "${expectedTotalProductsCount} artículo"
          then:
            - log:
                message: The expected total products count equals the displayed total product count.
                color: CYAN
          else:
            - failTest:
                message: The expected total products count does not equal the displayed total products count.

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method asserts the items count displayed
  # Param: ${expectedProductsCount} [Mandatory] Expected products count
  - name: mx.functions.list.assertTotalProductsDisplayed
    platform: ios
    flow: 
      - log:
          message: Validating that items count equals than the expected...
          color: CYAN
      - numberOfChildElements:
          identifier: mx.mappings.list.itemsContainer
          storeIn: returnedProductsCount
          filterBy: mx.mappings.list.categoryCount
      - log:
          message: The returned products count is ${returnedProductsCount}, now validating with the expected count...
          color: CYAN
      - verifyValue: 
          identifier: ${returnedProductsCount}
          equals: ${expectedProductsCount} 
      - log:
          message: The products count matched!
          color: CYAN   

  #--------------------------------------------------------------------------------------------------------------------

  # AUTHOR: Rodrigo Pacheco C. (vn53p0i)
  - name: mx.functions.list.assertListIsEmpty
    platform: ios
    flow:
      - if:
          identifier:
            present:
              - identifier: mx.mappings.list.emptyTitle
              - identifier: mx.mappings.list.emptySubtitle
          then:
            - log:
                message: "List is Empty."
                color: CYAN
          else:
            - failTest:
                message: "Failed: List is not empty."
      - log:
          message: "End function: list.assertListIsEmpty"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # AUTHOR: Rodrigo Pacheco C. (vn53p0i)
  - name: mx.functions.list.isListEmpty
    platform: ios
    flow:
      - if:
          identifier:
            present:
              - identifier: mx.mappings.list.emptyTitle
              - identifier: mx.mappings.list.emptySubtitle
          then:
            - storeIn:
                key: returnedIsListEmpty
                value: true
          else:
            - storeIn:
                key: returnedIsListEmpty
                value: false
      - log:
          message: "End function: list.isListEmpty (${returnedIsListEmpty})"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # AUTHOR: Rodrigo Pacheco C. (vn53p0i)
  - name: mx.functions.list.emptyList
    platform: ios
    flow:
      - executeFunction:
          name: mx.functions.list.isListEmpty
      - if:
          condition: ${returnedIsListEmpty} == true
          then:
            - log:
                message: "List is empty already."
                color: CYAN
          else:
            - log:
                message: "List is not empty. Emptying list..."
                color: CYAN
            - loop:
                begin: 1
                end: 50
                flow:
                  - if:
                      identifier:
                        present:
                          - identifier: mx.mappings.list.deleteButtonGeneral
                      then:
                        - click:
                            identifier: mx.mappings.list.deleteButtonGeneral
                        - click:
                            identifier: mx.mappings.list.delete-product-popup.deleteButton
                        - sleep:
                            duration: 3000
                      else:
                        - log:
                            message: "List is now empty."
                            color: CYAN
                        - break: true
      - log:
          message: "End function: list.emptyList"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION: This function asserts a specific product is not listed.
  # PARAM: ${productName}  [Mandatory]  Product name to validate.
  # AUTHOR: ???
  # EDITOR: Rodrigo Pacheco (vn53p0i)
  - name: mx.functions.list.assertProductNotListed
    platform: ios
    flow:
      - log:
          message: "Product name: ${productName}"
          color: CYAN
      - executeFunction:
          name: mx.functions.utils.scrollToTop
      - scroll:
          direction: down
          scrollLimit: 3
          untilIdentifier: mx.mappings.list.productByName # <--PARAMS--${productName}
          wait: 1000
      - verifyIdentifier:
          notPresent:
            - identifier: mx.mappings.list.productByName # <--PARAMS--${productName}
      - log:
          message: "End function: list.assertProductNotListed"
          color: BLUE



