#======================================================================================================================
#  AUTHOR: Francisco Javier Ramírez Hernández (vn53vq4)
#  CREATED: Feb/09/2023
#  REVISION: ---
#
#  Copyright © 2023 Walmart. All rights reserved.
#======================================================================================================================

functions:

  # Description: This method taps the edit option for substitutes
  - name: mx.functions.review-order.tapEditSubstitutePreferences
    flow:
      - click:
          identifier: mx.mappings.review-order.editSusbstitutesButton
      - log:
          message: "End function: review-order.tapEditSubstitutePreferences"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method scrolls down to the specified Section on param.
  # NOTE:        The values specified in the 'wait' attributes of the scrolls must not be changed.
  # Param        ${sectionName}        [Mandatory]  Name of section to scroll into (as displayed on page)
  # Param        ${expectedPromoCode}  [Optional]   Name of promotional code to scroll into (if promo code has been applied).
  #              (i.e. [ Envío a domicilio | Pickup | Pago | Total | ODSHIPFREE ] ) etc.
  - name: mx.functions.review-order.scrollDownToSection
    flow:
      - if:
          condition: ${APP_PLATFORM} == 'ios' && ${sectionName} == 'Pago'
          then:
            - storeIn:
                key: sectionName
                value: pago
      - if:
          condition: ${expectedPromoCode} == null
          then:
            - storeIn:
                key: expectedPromoCode
                value: ''
      - log:
          message: "Section Name: ${sectionName}"
          color: CYAN
      - if:
          condition: ${APP_PLATFORM} == 'ios'
          then:
            - if:
                identifier:
                  visible:
                    - identifier: mx.mappings.review-order.sectionContainerByName
                      value: 'false'
                then:
                  - scroll:
                      direction: down
                      scrollLimit: 12
                      wait: 2000
                      position: center
                      untilIdentifier: mx.mappings.review-order.sectionContainerByName
                else:
                  - scroll:
                      direction: down
                      scrollLimit: 5
                      wait: 2000
                      position: center
                      untilIdentifier: mx.mappings.review-order.sectionContainerByName
                  - if:
                      identifier:
                        visible:
                          - identifier: mx.mappings.review-order.sectionContainerByName
                            value: 'false'
                      then:
                        - failTest:
                            message: "Fail: Section not found ('${sectionName}')."
          else:
            - if:
                identifier:
                  notPresent:
                    - identifier: mx.mappings.review-order.sectionContainerByName
                then:
                  - scroll:
                      direction: down
                      scrollLimit: 12
                      wait: 2000
                      position: center
                      untilIdentifier: mx.mappings.review-order.sectionContainerByName
                else:
                  - scroll:
                      direction: up
                      scrollLimit: 2
                      wait: 2000
                  - scroll:
                      direction: down
                      scrollLimit: 12
                      position: center
                      wait: 2000
                      untilIdentifier: mx.mappings.review-order.sectionContainerByName
            - if:
                identifier:
                  notPresent:
                    - identifier: mx.mappings.review-order.sectionContainerByName
                then:
                  - failTest:
                      message: "Fail: Section not found ('${sectionName}')."
      - log:
          message: "End function: review-order.scrollDownToSection"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: Asserts the displayed Order's Delivery Slot is correct.
  # Params: ${deliverySlot}  [Mandatory]  Expected delivery slot to be displayed. The value passed in this
  #             param must be the string value returned by the 'delivery-slot-extraction/parseDeliverySlotForAssertion.js'
  #             helper (see helper's documentation).
  #
  #   Flags used:
  #     ${ASSERT_DELIVERY_SLOT_IN_REVIEW_ORDER}
  #         If set to 'true', the flow will perform assertion for the Delivery Slot in review-order page.
  #         If set to 'false' or not set at all, it will perform the Delivery Slot assertion as expected.
  #
  - name: mx.functions.review-order.assertDeliverySlot
    flow:
      - if:
          condition: ${ASSERT_DELIVERY_SLOT_IN_REVIEW_ORDER} == true
          then:
            - log:
                message: "Expected delivery slot: '${deliverySlot}'"
                color: CYAN
            - getString:
                identifier: mx.mappings.review-order.deliverySlot
                storeIn: returnedDeliverySlot
            - executeNode:
                file: mx/test/helpers/delivery-slot/stringCleanerForDeliverySlotAssertion.js
                args:
                  - value: ${returnedDeliverySlot}
                getResponse:
                  storeIn: parsedDeliverySlot
            - log: 
                message: "Parsed displayed Delivery Slot: '${parsedDeliverySlot}'"
                color: CYAN
            - if:
                condition: ${deliverySlot} == ${parsedDeliverySlot}
                then:
                  - log:
                      message: Correct Delivery Slot.
                      color: CYAN
                else:
                  - failTest:
                      message: "'${deliverySlot}', did not match '${parsedDeliverySlot}'"
          else:
            - log:
                message: "Delivery Slot Assertion has been turned off by flag:'ASSERT_DELIVERY_SLOT_IN_REVIEW_ORDER'"
                color: YELLOW
      - log:
          message: "End function: review-order.assertDeliverySlot"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # AUTHOR: Octavio Cabrales (vn53g23)
  # EDITORS: Sergio Fernandez (vn0t1qt)
  - name: mx.functions.review-order.scrollDownToWallet
    flow:
      - scroll:
          direction: down
          untilIdentifier: mx.mappings.review-order.payment-section.paymentLabel
      - log:
          message: "End function: review-order.scrollDownToWallet"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # AUTHOR: Gustavo Lopez (vn53g21)
  # EDITORS: 
  - name: mx.functions.review-order.scrollUpToWallet
    flow:
      - scroll:
          direction: up
          untilIdentifier: mx.mappings.review-order.payment-section.paymentLabel
          position: center
      - log:
          message: "End function: review-order.scrollUpToWallet"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method enters the CVV
  # Param ${cvv} [Mandatory] CVV for the credit card.
  - name: mx.functions.review-order.payment-section.enterCVV
    flow:
    - if:
        condition: ${APP_PLATFORM} == 'ios'
        then:
          - if:
              identifier:
                present:
                  - identifier: mx.mappings.review-order.payment-section.cvvInputField
              then:
                - enterText:
                    identifier: mx.mappings.review-order.payment-section.cvvInputField
                    clearField: true
                    pressEnter: true
                    string: ${cvv}
        else:
          - scroll:
              direction: down
              wait: 5000
              position: center
              untilIdentifier: mx.mappings.review-order.payment-section.cvvInputField
          - enterText:
              identifier: mx.mappings.review-order.payment-section.cvvInputField
              clearField: true
              pressEnter: true
              string: ${cvv}
    - if:
        condition: ${APP_PLATFORM} == 'android'
        then:
          - hideKeyboard: true
        else:
          - if:
              identifier:
                present:
                  - identifier: mx.mappings.utils.closeKeyboardButton
              then:
                - executeFunction:
                    name: mx.functions.utils.tapCloseKeyboardButton
    - log:
        message: "End function: review-order.payment-section.enterCVV"
        color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method scrolls down to phone number section and inputs the user's phone number.
  # Param ${userPhoneNumber} [Mandatory] User phone number to input.
  # EDITOR: Rodrigo PC - vn53p0i
  - name: mx.functions.review-order.enterCellphoneNumber
    flow:
    - log:
        message: "Phone number: ${userPhoneNumber}"
        color: CYAN
    - enterText:
        identifier: mx.mappings.review-order.phoneNumberInputField
        string: ${userPhoneNumber}
        clickFirst: true
        clearField: true
    - if:
        condition: ${APP_PLATFORM} == 'android'
        then:
          - executeFunction:
              name: mx.functions.utils.performActionDone
          - executeFunction:
              name: mx.functions.utils.performActionNext
        else:
          - click:
              identifier: mx.mappings.review-order.payment-section.listoButton
    - log:
        message: "End function: review-order.enterCellphoneNumber"
        color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method asserts the cellphone number error message is not displayed.
  - name: mx.functions.review-order.assertIncompleteCellphoneNumberErrorMessageNotDisplayed
    flow:
      - verifyIdentifier:
          notPresent:
            - identifier: mx.mappings.review-order.phoneNumberErrorMessage
      - log:
          message: "End function: review-order.assertIncompleteCellphoneNumberErrorMessageNotDisplayed"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This function asserts the deliveryFee at the bottom of the review-order page.
  # Param ${deliveryFee} [Mandatory] Delivery fee value to assert.
  - name: mx.functions.review-order.assertDeliveryFee
    flow:
      - log:
          message: "Expected delivery Fee: ${deliveryFee}"
          color: CYAN
      - if:
          condition: ${APP_PLATFORM} == 'android'
          then:
            - verifyIdentifier:
                text:
                  - identifier: mx.mappings.review-order.deliveryFeeValue
                    equals: $${deliveryFee}
          else:
            - verifyIdentifier:
                label:
                  - identifier: mx.mappings.review-order.deliveryFeeValue
                    equals: $${deliveryFee}
      - log: 
          message: Delivery Fee is correct.
          color: CYAN
      - log:
          message: "End function: review-order.assertDeliveryFee"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # RETURNS:
  #   ${returnedOrderedDate}  The ordered date of the order if needed in a future assertion.
  # EDITORS: Rodrigo Pacheco (vn53p0i) 
  - name: mx.functions.review-order.tapPlaceOrder
    flow:
    - click: 
        identifier: mx.mappings.review-order.placeOrderButton
    - executeNode:
        file: mx/test/helpers/utils/getTodaysDateAsStringForAssertion.js
        getResponse:
          storeIn: returnedOrderedDate
    - log:
        message: "Ordered Date '${returnedOrderedDate}' saved in 'returnedOrderedDate'."
        color: CYAN
    - log:
        message: "End function: review-order.tapPlaceOrder"
        color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method taps on back button
  - name: mx.functions.review-order.tapBack
    flow:
    - click:
        identifier: mx.mappings.review-order.backButton
    - log: 
        message: "End function: review-order.tapBack"
        color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method taps on exit payment button
  - name: mx.functions.review-order.almost-done-popup.tapExitPayment
    flow:
    - click:
        identifier: mx.mappings.review-order.almost-done-popup.exitPaymentButton
    - log: 
        message: "End function: review-order.almost-done-popup.tapExitPayment"
        color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method expands the promotional code section if it is not.
  - name: mx.functions.review-order.expandCouponsOption
    flow:
      - if:
          identifier:
            present:
              - identifier: mx.mappings.review-order.expandedPromotionalCodeSection
          then:
            - log:
                message: "Promotional Code Section already expanded."
                color: CYAN
          else:
            - log:
                message: "Expanding Promotional Code Section..."
                color: CYAN
            - click:
                identifier: mx.mappings.review-order.expandCollapsePromoCodeSectionButton
      - log:
          message: "End function: review-order.expandCouponsOption"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method contracts the promotional code section if it is not.
  - name: mx.functions.review-order.contractCouponsOption
    flow:
      - if:
          identifier:
            present:
              - identifier: mx.mappings.review-order.contractedPromotionalCodeSection
          then:
            - log:
                message: "Promotional Code Section already contracted."
                color: CYAN
          else:
            - log:
                message: "Contracting Promotional Code Section..."
                color: CYAN
            - click:
                identifier: mx.mappings.review-order.expandCollapsePromoCodeSectionButton
      - log:
          message: "End function: review-order.contractCouponsOption"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method asserts no errors are displayed in promotional code section.
  - name: mx.functions.review-order.assertCouponNotValidErrorMessageNotDisplayed
    flow:
      - if:
          identifier:
            present:
              - identifier: mx.mappings.review-order.invalidCouponErrorMessage
          then:
            - failTest:
                message: "Error message in Promotional Code section is displayed."
          else:
            - log:
                message: "Success: Error message not displayed."
                color: CYAN
      - log:
          message: "End function: review-order.assertCouponNotValidErrorMessageNotDisplayed"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method enters a promotional code.
  # Param  ${promoCode}  [Mandatory]  Promotional Code.
  - name: mx.functions.review-order.applyCoupon
    flow:
      - log:
          message: "Promotional Code: ${promoCode}"
          color: CYAN
      - scroll:
          direction: down
          untilIdentifier: mx.mappings.review-order.promotionalCodeField
      - click:
          identifier: mx.mappings.review-order.promotionalCodeField
      - enterText:
          identifier: mx.mappings.review-order.promotionalCodeField
          string: ${promoCode}          
      - executeFunction:
          name: mx.functions.utils.tapCloseKeyboardButton
      - click:
          identifier: mx.mappings.review-order.applyPromotionalCodeButton
      - log:
          message: "End function: review-order.applyCoupon"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method asserts the promotional code was applied correctly.
  # Param  ${expectedPromoCode}  [Mandatory]  Promotional Code.
  - name: mx.functions.review-order.assertCouponApplied
    flow:
      - log:
          message: "Expected Applied Promotional Code: ${expectedPromoCode}"
          color: CYAN
      - if:
          identifier:
            notPresent:
              - identifier: mx.mappings.review-order.appliedPromotionalCode
          then:
            - failTest:
                message: "Applied Promotional Code label not found."
          else:
            - log:
                message: "Success: Promotional Code Applied."
                color: CYAN
      - log:
          message: "End function: review-order.assertCouponApplied"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method removes a promotional code.
  - name: mx.functions.review-order.removeCoupon
    flow:
      - if:
          identifier:
            present:
              - identifier: mx.mappings.review-order.deleteAppliedPromotionalCodeButton
          then:
            - click:
                identifier: mx.mappings.review-order.deleteAppliedPromotionalCodeButton
          else:
            - failTest:
                message: "Delete coupon button not found."
      - log:
          message: "End function: review-order.removeCoupon"
          color: BLUE
  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method asserts a promotional code has been removed.
  # Param  ${expectedPromoCode}  [Mandatory]  Promotional Code.
  - name: mx.functions.review-order.assertCouponRemoved
    flow:
      - getString:
          identifier: mx.mappings.review-order.promotionalCodeField
          storeIn: returnedCoupon
      - if:
          identifier:
            notPresent:
              - identifier: mx.mappings.review-order.appliedPromotionalCode
          then:
            - log:
                message: "Success: Promotional Code is removed."
          else:
            - failTest:
                message: "Promotional Code field is not empty."
      - log:
          message: "End function: review-order.assertCouponRemoved"
          color: BLUE
  #--------------------------------------------------------------------------------------------------------------------

  # AUTHOR: Rodrigo Pacheco (vn53p0i)
  # EDITOR: Sergio Fernandez (vn0t1qt)
  - name: mx.functions.review-order.assertPageDisplayed
    flow:
      - if:
          identifier:
            notPresent:
              - identifier: mx.mappings.review-order.deliveryHeaderContainer
          then:
            - scroll:
                direction: up
                scrollLimit: 2
                wait: 1000
      - verifyIdentifier:
          present:
            - identifier: mx.mappings.review-order.pageTitle
            - identifier: mx.mappings.review-order.deliveryDetailsSection
            - identifier: mx.mappings.review-order.placeOrderButton
          timeout: 30000
      - log:
          message: "End function: review-order.assertPageDisplayed (Page Displayed)"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION: This method asserts the selected delivery method, either home delivery or pickup. Other values given
  #   will fail the test.
  #
  # PARAM: ${expectedDeliveryMethod} [Mandatory] Delivery method to assert, either 'HomeDelivery' or 'PickupDelivery'.
  #
  # AUTHOR: Rodrigo Pacheco (vn53p0i)
  # EDITOR: Sergio Fernandez (vn0t1qt)
  - name: mx.functions.review-order.assertDeliveryMethod
    flow:
      - log:
          message: "Assert For: ${expectedDeliveryMethod}"
          color: CYAN
      - getString:
          identifier: mx.mappings.review-order.selectedDeliveryMethod
          storeIn: displayedDeliveryMethod
      - executeNode:
          file: mx/test/helpers/utils/trimString.js
          args:
            - value: ${displayedDeliveryMethod}
          getResponse:
            storeIn: parsedDisplayedDeliveryMethod
      - log:
          message: "Displayed Delivery Method: ${parsedDisplayedDeliveryMethod}"
          color: CYAN
      - if:
          condition: ${expectedDeliveryMethod} == 'HomeDelivery'
          then:
            - if:
                condition: ${parsedDisplayedDeliveryMethod} != 'Envío a domicilio'
                then:
                  - failTest:
                      message: "Fail: Displayed delivery method '${parsedDisplayedDeliveryMethod}' is incorrect (Expected 'Envío a domicilio')."
          else:
            - if:
                condition: ${expectedDeliveryMethod} == 'PickupDelivery'
                then:
                  - if:
                      condition: ${parsedDisplayedDeliveryMethod} != 'Pickup'
                      then:
                        - failTest:
                            message: "Fail: Displayed delivery method '${parsedDisplayedDeliveryMethod}' is incorrect (Expected 'Pickup')."
                else:
                  - failTest:
                      message: "Fail: provided delivery method '${expectedDeliveryMethod}' not valid"
      - log:
          message: "End function: review-order.assertDeliveryMethod (Success: Displayed Delivery method is '${parsedDisplayedDeliveryMethod}')"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method asserts the displayed home delivery address name.
  # Param ${expectedAddressName}  [Mandatory]  Expected address name.
  - name: mx.functions.review-order.assertHomeDeliveryAddressName
    flow:
      - if:
          condition: ${APP_PLATFORM} == 'android'
          then:
            - verifyIdentifier:
                text:
                  - identifier: mx.mappings.review-order.addressName
                    equals: ${expectedAddressName}
          else:
            - verifyIdentifier:
                label:
                  - identifier: mx.mappings.review-order.addressName
                    contains: ${expectedAddressName}
      - log:
          message: "End function review-order.assertHomeDeliveryAddressName"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION: This method asserts the displayed Home Delivery Address.
  # PARAMS:  ${expectedUserAddress}  [Mandatory]  Expected Home Address.
  # AUTHOR: Rodrigo Pacheco (vn53p0i)
  # EDITOR: Sergio Fernandez (vn0t1qt)
  - name: mx.functions.review-order.assertHomeDeliveryAddress
    flow:
      - log:
          message: "Expected Address: '${expectedUserAddress}'"
          color: CYAN
      - getString:
          identifier: mx.mappings.review-order.deliveryAddress
          storeIn: displayedDeliveryAddress
      - log:
          message: "Displayed Address: '${displayedDeliveryAddress}'"
          color: CYAN
      - if: 
          condition: ${displayedDeliveryAddress} == ${expectedUserAddress}
          then:
            - log:
                message: "Assertion Successful: Displayed Address is correct."
                color: CYAN
          else:
            - failTest:
                message: "Assertion Failed: Displayed Address is not correct."
      - log:
          message: "End function: review-order.assertHomeDeliveryAddress"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method verifies the selected delivery address.
  # NOTE: this assertion must be performed with the returned value of mx.functions.reserve-slot.getSelectedAddress
  # Params  ${streetName}     [Mandatory]   Name of the street to be validated.
  #         ${exteriorNumber} [Mandatory]   Exterior number to be validated.
  #         ${city}           [Mandatory]   City to be validated.
  #         ${state}          [Mandatory]   State to be validated.
  #         ${zipCode}        [Mandatory]   ZIP Code to be validated.
  - name: mx.functions.review-order.assertHomeDeliveryAddressByIndividualValues
    flow:
      # Using '\e[36m' to print in CYAN and '\e[0m' to reset color, to simplify logs.
      - log: "\e[36mExpected StreetName: '${streetName}'\e[0m"
      - log: "\e[36mExpected ExteriorNumber: '${exteriorNumber}'\e[0m"
      - log: "\e[36mExpected City: '${city}'\e[0m"
      - log: "\e[36mExpected State: '${state}'\e[0m"
      - log: "\e[36mExpected ZipCode: '${zipCode}'\e[0m"
      - getString:
          identifier: mx.mappings.review-order.deliveryAddress
          storeIn: displayedAddress
      - executeNode:
          file: mx/test/helpers/utils/stringContainsAll.js
          args:
            - value: ${displayedAddress}
            - value: ${streetName}, ${exteriorNumber}, ${city}, ${state}, ${zipCode}
          getResponse:
            storeIn: isAddressCorrect
      - if:
          condition: ${isAddressCorrect} == true
          then:
            - log:
                message: "Address is correct."
                color: CYAN
          else:
            - failTest:
                message: "Expected address not contained in: '${displayedAddress'}"
      - log:
          message: "End function: review-order.assertHomeDeliveryAddressByIndividualValues (Address is correct)"
          color: BLUE
 
   #--------------------------------------------------------------------------------------------------------------------

  # Description: This method asserts the blue manage payment methods message displayed successfully.
  - name: mx.functions.review-order.payment-section.assertBlueManagePaymentMethodsMessageDisplayed
    flow:
    - verifyIdentifier:
        present:
          - identifier: mx.mappings.review-order.payment-section.blueMessage
    - log:
        message: "End function: review-order.payment-section.assertBlueManagePaymentMethodsMessageDisplayed"
        color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method taps on "editar pago" or "agregar pago" button.
  - name: mx.functions.review-order.payment-section.tapChangePaymentMethod
    flow:
      - click:
          identifier: mx.mappings.review-order.payment-section.editOrAddPaymentMethod
      - log:
          message: "End function: review-order.payment-section.tapChangePaymentMethod"
          color: BLUE
  
   #--------------------------------------------------------------------------------------------------------------------

  # Description: This method asserts the selected payment method.
  # Param  ${paymentMethod}  [Mandatory]  (Input: [ PayAtDelivery | Card | NewCard | PayPal ] )
  # AUTHOR: ?????
  # EDITOR: Sergio Fernandez (vn0t1qt) | Teresa Partida (vn55epy)
  - name: mx.functions.review-order.payment-section.assertSelectedPaymentMethod
    flow:
    - log:
        message: "Expected payment method: ${paymentMethod}"
        color: CYAN
    - if:
        condition: ${paymentMethod} != 'PayAtDelivery' && ${paymentMethod} != 'Card' && ${paymentMethod} != 'NewCard' && ${paymentMethod} != 'PayPal'
        then:
          - failTest:
              message: "Invalid Payment Method received: '${paymentMethod}'"
    - if:
        condition: ${paymentMethod} == 'PayAtDelivery'
        then:
          - verifyIdentifier:
              present:
                - identifier: mx.mappings.review-order.payment-section.payAtDeliveryMethodIsSelected
    - if:
        condition: ${paymentMethod} == 'Card'
        then:
          - verifyIdentifier:
              present:
                - identifier: mx.mappings.review-order.payment-section.payWithCardMethodIsSelected
                - identifier: mx.mappings.review-order.payment-section.cvvInputField
    - if:
        condition: ${paymentMethod} == 'NewCard'
        then:
          - verifyIdentifier:
              present:
                - identifier: mx.mappings.review-order.payment-section.payWithCardMethodIsSelected
    - if:
        condition: ${paymentMethod} == 'PayPal'
        then:
          - verifyIdentifier:
              present:
                - identifier: mx.mappings.review-order.payment-section.paypalMethodIsSelected
                - identifier: mx.mappings.review-order.payment-section.paypalIcon
    - log:
        message: "End function: review-order.payment-section.assertSelectedPaymentMethod (Correct payment method: ${paymentMethod}, is displayed.)"
        color: BLUE
  
  #--------------------------------------------------------------------------------------------------------------------

  # PARAMS:  ${expectedOption}  [Mandatory]  Expected option to be selected. Values: [ cash | card ]
  # AUTHOR: Sergio Fernandez (vn0t1qt)
  - name: mx.functions.review-order.payment-section.assertSelectedPayAtDeliveryOption
    flow:
    - log:
        message: "Expected Option: ${expectedOption}"
        color: CYAN
    - storeIn:
        key: successFlag
        value: false
    - if:
        condition: ${expectedOption} == 'cash'
        then:
          - verifyIdentifier:
              present:
                - identifier: mx.mappings.review-order.payment-section.payAtDeliveryCashOptionLabel
          - storeIn:
              key: successFlag
              value: true
    - if:
        condition: ${expectedOption} == 'card'
        then:
          - verifyIdentifier:
              present:
                - identifier: mx.mappings.review-order.payment-section.payAtDeliveryCardOptionLabel
          - storeIn:
              key: successFlag
              value: true
    - if:
        condition: ${successFlag} == false
        then:
          - failTest:
              message: "Invalid Pay at Delivery Option provided (${expectedOption})"
    - log:
        message: "Successful Assertion: Pay at Delivery option displayed is '${expectedOption}'"
        color: CYAN
    - log:
        message: "End function: review-order.payment-section.assertSelectedPayAtDeliveryOption"
        color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method asserts the selected user paypal account by email.
  # Param        ${expectedUserPaypalEmail}  [Mandatory]  Expected PayPal account email.
  - name: mx.functions.review-order.payment-section.assertPaypalEmail
    flow:
      - log:
          message: "Expected email: ${expectedUserPaypalEmail}"
          color: CYAN
      - if:
          identifier:
            present:
              - identifier: mx.mappings.review-order.payment-section.selectedPaypalAccountByEmail
          then:
            - log:
                message: "Email is correct."
                color: CYAN
          else:
            - failTest:
                message: "Fail: Expected email is not correct."
      - log:
          message: "End function: review-order.payment-section.assertPaypalEmail"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # PARAMS: ${last4Digits}  [Mandatory]  Last 4 digits of the card to assert
  # AUTHOR: Teresa Partida (vn55epy)
  - name: mx.functions.review-order.payment-section.assertSelectedCardByLast4Digits
    flow:
      - log:
          message: "Expected last 4 digits: ${last4Digits}"
          color: CYAN
      - verifyIdentifier:
          present:
            - identifier: mx.mappings.review-order.payment-section.payWithCardLast4DigitsIsSelected
      - log:
          message: "End function: review-order.payment-section.assertSelectedCardByLast4Digits"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method asserts the expected total displayed in the payment section.
  # Param        ${expectedTotal}  [Mandatory]  Expected total to assert.
  - name: mx.functions.review-order.payment-section.assertTotal
    flow:
      - log:
          message: "Expected total: ${expectedTotal}"
          color: CYAN
      - if:
          identifier:
            present:
              - identifier: mx.mappings.review-order.payment-section.totalValueForAssertion
          then:
            - log:
                message: "Total is correct."
                color: CYAN
          else:
            - failTest:
                message: "Fail: Expected total is not correct."
      - log:
          message: "End function: review-order.payment-section.assertTotal"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method asserts the total products count next to the subtotal label.
  # Param        ${expectedProductsCount}  [Mandatory]  Expected number of products.
  - name: mx.functions.review-order.assertSubtotalProductsCount
    flow:
      - log:
          message: "Expected Subtotal Products Count: ${expectedProductsCount}"
          color: CYAN
      - executeFunction:
          name: mx.functions.utils.searchItemInPage
          params:
            - name: elementToFind
              string: mx.mappings.review-order.subtotalTitle
      - verifyIdentifier:
          present:
            - identifier: mx.mappings.review-order.productsCountInSubtotalTitleForAssertion # <--PARAM--${expectedProductsCount}
      - log:
          message: "Successful Assertion: Subtotal Products Count is correct!"
          color: CYAN
      - log:
          message: "End function: review-order.assertSubtotalProductsCount (Success: displayed products count == ${expectedProductsCount})"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  - name: mx.functions.review-order.getDeliveryFee
    flow:
      - if:
          identifier:
            present:
            - identifier: mx.mappings.review-order.deliveryFeeValue
          then:
            - getString:
                identifier: mx.mappings.review-order.deliveryFeeValue
                storeIn: returnedDeliveryFee
            - executeNode:
                file: mx/test/helpers/utils/cleanPriceString.js
                args:
                  - value: ${returnedDeliveryFee}
                getResponse:
                  storeIn: returnedDeliveryFee
            - log:
                message: "Delivery Fee Got: ${returnedDeliveryFee}"
                color: CYAN
          else:
            - storeIn:
                key: returnedDeliveryFee
                value: '0.00'
            - log:
                message: "Delivery Fee value not found, returning '0.00'"
                color: CYAN

      - log: 
          message: "End function: review-order.getDeliveryFee"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------
  # Description: This method retrieves the order's promotional discount.
  - name: mx.functions.review-order.getPromoDiscount
    flow:
      - getString:
          identifier: mx.mappings.review-order.promoDiscountValue
          storeIn: returnedPromoDiscount
      - executeNode:
          file: mx/test/helpers/utils/cleanPriceString.js
          args:
            - value: ${returnedPromoDiscount}
          getResponse:
            storeIn: returnedPromoDiscount
      - log:
          message: "Discount Got: ${returnedPromoDiscount}"
          color: CYAN
      - log:
          message: "End function: review-order.getPromoDiscount"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------
  # Description: This method asserts the order's promotional discount is not displayed.
  - name: mx.functions.review-order.assertPromoDiscountIsNotDisplayed
    flow:
      - if:
          identifier:
            notPresent:
              - identifier: mx.mappings.review-order.promoDiscountValue
          then:
            - log:
                message: "No promotional discount is displayed"
          else:
            - failTest:
                message: "Promotional discount is displayed"
      - log:
          message: "End function: review-order.assertPromoDiscountIsNotDisplayed"
          color: BLUE
  
  #--------------------------------------------------------------------------------------------------------------------

  # Description: This function asserts estimated total from the place order button.
  # Param ${estimatedTotalFromButton} [Mandatory] Estimated Total to assert.
  - name: mx.functions.review-order.assertEstimatedTotalFromButton
    flow:
      - log:
          message: "Expected Estimated Total: '${estimatedTotalFromButton}'"
          color: CYAN
      - getString:
          identifier: mx.mappings.review-order.estimatedTotalPriceFromPlaceOrderButtonValue
          storeIn: returnedEstimatedTotal
      - executeNode:
          file: mx/test/helpers/utils/cleanPriceStringIncludingCommas.js
          args:
            - value: ${returnedEstimatedTotal}
          getResponse:
            storeIn: returnedEstimatedTotal
      - if:
          condition: ${returnedEstimatedTotal} == ${estimatedTotalFromButton}
          then:
            - log:
                message: "Successful Assertion: Estimated Total from button is correct!"
                color: CYAN
          else:
            - failTest:
                message: "Failed Assertion: expected $${estimatedTotalFromButton} and got $${returnedEstimatedTotal}"
      - log: 
          message: "End function: review-order.assertEstimatedTotalFromButton"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------
  
  # Description: This function clicks on add delivery instructions
  - name: mx.functions.review-order.tapAddDeliveryInstructions
    flow:
      - click:
          identifier: mx.mappings.review-order.addDeliveryInstructions
      - log: 
          message: "End function: review-order.tapAddDeliveryInstructions"
          color: BLUE
  
  #--------------------------------------------------------------------------------------------------------------------
  
  # Description: This function enters delivery instructions comment.
  # Param ${deliveryInstructions} [Mandatory] Delivery Instructions.
  - name: mx.functions.review-order.enterDeliveryInstructions
    flow:
      - enterText:
          identifier: mx.mappings.review-order.deliveryInstructionsMessage
          string: ${deliveryInstructions}
          clickFirst: true
      - click:
          identifier: mx.mappings.general-comments-pop-up.saveButton
      - log: 
          message: "End function: review-order.enterDeliveryInstructions"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------
  
  # Description: This function asserts if discount is as expected
  # Param ${expectedDiscount} [Mandatory] 
  # AUTHOR: Octavio Cabrales Zárate (vn53g23)
  - name: mx.functions.review-order.assertDiscount
    flow:
      - executeNode:
          file: mx/test/helpers/review-order/add$.js
          args:
            - value: ${expectedDiscount}
          getResponse:
            storeIn: expectedDiscount
      - log:
          message: Expected discount ${expectedDiscount}
          color: CYAN
      - if:
          identifier:
            present:
              - identifier: mx.mappings.review-order.discountText
          then:
            - log:
                message: Correct discount
                color: CYAN
          else:
            - failTest:
                message: Discount mismatches.
      - log:
          message: "End function: review-order.assertDiscount"
          color: BLUE
      
  #--------------------------------------------------------------------------------------------------------------------
 
  # DESCRIPTION:
  #   Asserts whether the displayed subtotal after discounts equals the given expected subtotal.
  # PARAM:
  #   ${expectedSubtotalAfterDiscount}  [Mandatory]   Expected subtotal after discount to assert. 
  #                                                     This is the value of the sum of all product subtotals after discounts.
  # AUTHOR: Rodrigo Pacheco (vn53p0i)
  - name: mx.functions.review-order.assertSubtotalAfterDiscount
    flow:
      - log:
          message: "Expected Subtotal After Discounts: '${expectedSubtotalAfterDiscount}'"
          color: CYAN
      # Get displayed Subtotal after discount.
      - getString:
          # This mapping gets the Subtotal value AFTER discount (if there are NO discounts function fails).
          identifier: mx.mappings.review-order.subtotalValueAfterDiscount
          storeIn: displayedSubtotalAfterDiscount
      # Clean the subtotal obtained and log it...
      - executeNode:
           file: mx/test/helpers/review-order/cleanSubtotalPrice.js
           args:
             - value: ${displayedSubtotalAfterDiscount}
           getResponse:
               storeIn: displayedSubtotalAfterDiscount
      - log:
          message: "Displayed Subtotal: '${displayedSubtotalAfterDiscount}'"
          color: CYAN
      # Assert expected vs displayed...
      - if:
          condition: ${expectedSubtotalAfterDiscount} == ${displayedSubtotalAfterDiscount}
          then:
            - log:
                message: "Successful Assertion: Displayed Subtotal after discounts is correct"
                color: CYAN
          else:
            - failTest:
                message: "Failed Assertion: Displayed Subtotal after discounts is incorrect"
      - log:  
          message: "End function: review-order.assertSubtotalAfterDiscount"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION: Scroll until add payment button
  # AUTHOR: Guillermo Canales (g0c08aj)
  - name: mx.functions.review-order.scrollToAddPaymentButton
    flow:
      - if:
          condition: ${ANDROID_DRAG_PAYMENT_WORKAROUND} == true
          then:
            - drag:
                from:
                  x: 300
                  y: 1000
                to:
                  x: 300
                  y: 500
                wait: 0
          else:
            - scroll:
                direction: down
                untilIdentifier: mx.mappings.review-order.payment-section.editOrAddPaymentMethod
                position: center
                scrollLimit: 3
                wait: 3000
      - log:
          message: "End function: review-order.scrollToAddPaymentButton"
          color: CYAN

  #--------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION: Scroll until phone number
  # AUTHOR: Guillermo Canales (g0c08aj)
  - name: mx.functions.review-order.scrollToPhoneNumber
    flow:
      - if:
          condition: ${ANDROID_DRAG_PAYMENT_WORKAROUND} == true
          then:
            - drag:
                from:
                  x: 300
                  y: 1000
                to:
                  x: 300
                  y: 300
                wait: 0
          else:
            - executeFunction:
                name: mx.functions.review-order.scrollDownToSection
                params:
                  - name: sectionName
                    string: "Número telefónico"
      - log:
          message: "End function: review-order.scrollToPhoneNumber"
          color: CYAN

  #--------------------------------------------------------------------------------------------------------------------
  # Review if restriction message is present 
  # AUTHOR: Brenda Robles (vn557kg)
  # EDITOR: Teresa Partida (vn55epy)
  - name: mx.functions.review-order.assertRestrictionMessage
    flow:
      - scroll:
          direction: down
          scrollLimit: 12
          wait: 2000
          position: center
          untilIdentifier: mx.mappings.review-order.restrictionMessage
      - verifyIdentifier:
          present:
            - identifier: mx.mappings.review-order.restrictionMessage
      - log:
          message: "Assertion Succeeded: Restriction Message is displayed"
          color: CYAN
      - log:
          message: "End function review-order.assertRestrictionMessage"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------
  # Description: Open Products details modal
  # AUTHOR: Teresa Partida (vn55epy)
  - name: mx.functions.review-order.productDetails.tapView
    flow:
      - click:
          identifier: mx.mappings.review-order.viewButton
      - log:
          message: "End function review-order.productDetails.tapView"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------
  # Description: Assert product is displayed in the Products details modal
  # Param ${productName} [Mandatory]
  # AUTHOR: Teresa Partida (vn55epy)
  - name: mx.functions.review-order.productDetails.assertProductIsDisplayed
    flow:
      - verifyIdentifier:
          present:
            - identifier: mx.mappings.review-order.productByName
      - log:
          message: "End function review-order.productDetails.assertProductIsDisplayed"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------
  # Description: Assert product price displayed in the Products details modal
  # Param ${productName} [Mandatory]
  #       ${expectedProductPrice} [Mandatory]
  # AUTHOR: Teresa Partida (vn55epy)
  - name: mx.functions.review-order.productDetails.assertProductPriceByName
    flow:
      - if:
          condition: ${platform} == 'Android'
          then:
            - getString:
                identifier: mx.mappings.review-order.productPriceByName
                storeIn: returnedPrice
            - executeNode:
                file: mx/test/helpers/utils/cleanPriceString.js
                args:
                  - value: ${returnedPrice}
                getResponse:
                  storeIn: returnedPrice
          else:
            - getString:
                identifier: mx.mappings.review-order.productByName
                storeIn: returnedString
            - executeNode:
                file: mx/test/helpers/cart/getPriceFromNameLabel.js
                args:
                  - value: ${returnedString}
                getResponse:
                  storeIn: productPrice
            - executeNode:
                file: mx/test/helpers/cart/getPriceFromLabel.js
                args:
                  - value: ${productPrice}
                getResponse:
                  storeIn: returnedPrice

      # Comparing displayed vs expected...
      - if:
          condition: ${returnedPrice} == ${expectedProductPrice}
          then:
            - log:
                message: "Assertion Succeeded: Price is Correct."
                color: GREEN_BOLD
          else:
            - failTest:
                message: "Failed: Price is not Correct. Expected: ${expectedProductPrice}, Got: ${returnedPrice}"
      - log:
          message: "End function review-order.productDetails.assertProductPriceByName"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------
  # Description: Assert product quantity displayed in the Products detail modal
  # Param ${productName} [Mandatory]
  #       ${expectedProductQuantity} [Mandatory]
  # AUTHOR: Teresa Partida (vn55epy)
  - name: mx.functions.review-order.productDetails.assertProductQuantityByName
    flow:
      - verifyIdentifier:
          present:
            - identifier: mx.mappings.review-order.productQuantityByName # <--PARAM--${expectedProductQuantity}
      - log:
          message: "End function review-order.productDetails.assertProductQuantityByName"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------
  # Description: Close the Product details modal
  # AUTHOR: Teresa Partida (vn55epy)
  - name: mx.functions.review-order.productDetails.close
    flow:
      - click:
          identifier: mx.mappings.review-order.products-details-popup.doneButton
      - log:
          message: "End function review-order.productDetails.close"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method asserts the cellphone number error message displayed.
  # AUTHOR: Brenda Robles (vn557kg)
  # EDITOR: Teresa Partida (vn55epy)
  - name: mx.functions.review-order.assertIncompleteCellphoneNumberErrorMessageDisplayed
    flow:
      - log:
          message: "Validating cellphone number error message is on screen..."
          color: CYAN
      - verifyIdentifier:
          present:
            - identifier: mx.mappings.review-order.phoneNumberErrorMessage
      - log:
          message: "End function review-order.assertIncompleteCellphoneNumberErrorMessageDisplayed"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method asserts the cellphone number error message displayed.
  # AUTHOR: Teresa Partida (vn55epy)
  - name: mx.functions.review-order.assertReviewFieldErrorMessageIsDisplayed
    flow:
      - log:
          message: "Validating review field error message is on screen..."
          color: CYAN
      - verifyIdentifier:
          present:
            - identifier: mx.mappings.review-order.reviewFieldsErrorMessage
      - log:
          message: "End function review-order.assertReviewFieldErrorMessageIsDisplayed"
          color: BLUE

  #--------------------------------------------------------------------------------------------------------------------

  # Description: This method asserts the invalid coupon error message displayed.
  # AUTHOR: Brenda Robles (vn577kg)
  # EDITOR: Teresa Partida (vn55epy)
  - name: mx.functions.review-order.assertInvalidCouponErrorMessageIsDisplayed
    flow:
      - verifyIdentifier:
          present:
            - identifier: mx.mappings.review-order.invalidCouponErrorMessage
      - log:
          message: "End function: review-order.assertInvalidCouponErrorMessageIsDisplayed"
          color: BLUE
