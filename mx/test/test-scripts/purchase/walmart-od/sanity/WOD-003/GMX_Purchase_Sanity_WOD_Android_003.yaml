#======================================================================================================================
#  AUTHOR: Guillermo Canales Justo (g0c08aj)
#  CREATED: Apr/15/2024
#  REVISION: ---
#
#  Copyright Â© 2024 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: qaa-purchase-sanity-walmart-od-production-android-003, qaa-purchase-sanity-walmart-od-production-android

scenarios:
  - name: Before
    before: true
    flow:

      - log: "BEFORE SCENARIO START: Initial Config..."
      - storeIn:
          key: PURCHASE_TEST_CASE_NAME
          value: "GMX_PURCHASE_SANITY_WOD_ANDROID_003"
      - executeFunction:
          name: mx.functions.utils.relaunchApp
      - storeIn:
          key: WOD_003_SUCCESSFUL_EXECUTION
          value: false
      - log: "BEFORE SCENARIO END"

  #--------------------------------------------------------------------------------------------------------------------

  - name: Main
    platform: android
    flow:

      - log: "TEST START: ${PURCHASE_TEST_CASE_NAME}"

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 1: LOGIN IN ONBOARDING SCREEN AND GO TO BANNER OD.

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 1: LAUNCH AND LOGIN IN ONBOARDING SCREEN AND SELECT OD BANNER."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.flows.global.onboarding.navigateOnboardingToHomeAsRegisteredUser
          params:
            - name: userEmail
              string: mx.data.qaa.purchase.sanity.wod-003.userEmail
            - name: userPassword
              string: mx.data.qaa.purchase.sanity.wod-003.userPassword
            - name: zipCode
              string: mx.data.qaa.purchase.sanity.wod-003.zipCode
            - name: banner
              string: 'OD'

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 2: GO TO MY ITEMS - ORDER AGAIN AND LISTS SHOULD SHOW.

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 2: GO TO MY ITEMS."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.bottom-menu.tapProductsAndLists
      - executeFunction:
          name: mx.functions.utils.closeBlackPopupIfDisplayed
      - executeFunction:
          name: mx.functions.products-and-lists.assertPageDisplayed

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 3: GO TO LISTS - VERIFY FAVORITE LIST.

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 3: GO TO LISTS."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.products-and-lists.tapLists
      - executeFunction:
          name: mx.functions.lists.assertListDisplayed
          params:
            - name: listName
              string: mx.data.qaa.purchase.sanity.wod-003.myFavoritesListName

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 4: OPEN A CUSTOM LIST

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 4: OPEN A CUSTOM LIST."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.lists.openFavoritesList
      - executeFunction:
          name: mx.functions.list.assertPageDisplayed
      - executeFunction:
          name: mx.functions.list.assertCorrectListOpened
          params:
            - name: expectedListName
              string: mx.data.qaa.purchase.sanity.wod-003.myFavoritesListName

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 5: ADD PRODUCTS ITEMS TO CART FROM CUSTOM LIST

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 5: ADD PRODUCTS ITEMS TO CART FROM CUSTOM LIST."
            - name: squadNames
              string: PURCHASE | QAA
      - log: "Verifying all products were added to the favorites list..."
      - executeFunction:
          name: mx.functions.list.assertProductListed
          params:
            - name: productName
              string: mx.data.qaa.purchase.sanity.wod-003.productName1
      - executeFunction:
          name: mx.functions.list.assertProductListed
          params:
            - name: productName
              string: mx.data.qaa.purchase.sanity.wod-003.productName2

      - log: "Add products to cart"
      - executeFunction:
          name: mx.functions.list.getProductNameByPosition
          params:
            - name: positionNumber
              string: "1"
      - executeFunction:
          name: mx.flows.od.list.addProductToCartByName
          params:
            - name: productName
              string: ${returnedProductNameByPosition}
      # [VARIABLE] Name of product 1 saved in ${purchase_od003_product_1_name}
      - storeIn:
          key: purchase_od003_product_1_name
          value: ${returnedProductNameByPosition}
      # [VARIABLE] Price of product 1 saved in ${purchase_od003_product_1_price}
      - storeIn:
          key: purchase_od003_product_1_price
          value: ${returnedProductPrice}
      # [VARIABLE] Pieces of product 1 saved in ${purchase_od003_product_1_quantity}
      - storeIn:
          key: purchase_od003_product_1_quantity
          value: ${returnedProductQuantity}
      # [VARIABLE] Subtotal of product 1 saved in ${purchase_od001_product_1_price}
      - storeIn:
          key: purchase_od003_product_1_subtotal
          value: ${returnedProductSubTotalPrice}

      - executeFunction:
          name: mx.functions.list.getProductNameByPosition
          params:
            - name: positionNumber
              string: "2"
      - executeFunction:
          name: mx.flows.od.list.addProductToCartByName
          params:
            - name: productName
              string: ${returnedProductNameByPosition}
      # [VARIABLE] Name of product 2 saved in ${purchase_od003_product_2_name}
      - storeIn:
          key: purchase_od003_product_2_name
          value: ${returnedProductNameByPosition}
      # [VARIABLE] Price of product 2 saved in ${purchase_od003_product_2_price}
      - storeIn:
          key: purchase_od003_product_2_price
          value: ${returnedProductPrice}
      # [VARIABLE] Weight of product 2 saved in ${purchase_od003_product_2_quantity}
      - storeIn:
          key: purchase_od003_product_2_quantity
          value: ${returnedProductQuantity}
      # [VARIABLE] Subtotal of product 1 saved in ${purchase_od001_product_1_price}
      - storeIn:
          key: purchase_od003_product_2_subtotal
          value: ${returnedProductSubTotalPrice}

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 6: INCREASE PRODUCT QUANTITY

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 6: INCREASE PRODUCT QUANTITY ON FAVORITE LIST.'
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.list.tapPlusProduct
          params:
            - name: productName
              string: mx.data.qaa.purchase.sanity.wod-003.productName1
      # [VARIABLE] plus quantity to saved product ${purchase_od003_product_1_quantity}
      - arithmetic:
          expression: ${purchase_od003_product_1_quantity} + 1
          storeIn: purchase_od003_product_1_quantity

      - executeFunction:
          name: mx.functions.list.tapPlusProduct
          params:
            - name: productName
              string: mx.data.qaa.purchase.sanity.wod-003.productName2
      # [VARIABLE] plus quantity to saved product ${purchase_od003_product_2_quantity}
      - arithmetic:
          expression: ${purchase_od003_product_2_quantity} + 1
          storeIn: purchase_od003_product_2_quantity

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 6.5 In GIC select Home Delivery for an address with coverage.

      - log:
          message: "STEP 6.5: In GIC select Home Delivery for an address with coverage."
          color: ORANGE
      - executeFunction:
          name: mx.flows.od.delivery-method-selector.selectRandomHomeDeliveryAddress
      # [VARIABLE] Selected Home Delivery Address Street Name saved in purchase_od_003_street_name
      - storeIn:
          key: purchase_od_003_street_name
          value: ${returnedStreetName}
      # [VARIABLE] Selected Home Delivery Address Exterior Number value saved in purchase_od_003_exterior_number
      - storeIn:
          key: purchase_od_003_exterior_number
          value: ${returnedExteriorNumber}

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 7: Open cart and assert products Added

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 7: OPEN CART AND PERFORM PRODUCT ASSERTIONS.'
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon
      - executeFunction:
          name: mx.functions.cart.assertPageDisplayed
      - executeFunction:
          name: mx.functions.cart.assertCartNotEmpty
      - storeIn:
          key: purchase_od003_order_subtotal
          value: ${returnedSummarySubtotal}

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 8: Add first product to Save For Later

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 8: ADD FIRST PRODUCT TO SAVE FOR LATER.'
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.utils.closeBlackPopupIfDisplayed
      - executeFunction:
          name: mx.functions.cart.tapSaveForLaterByProductName
          params:
            - name: productName
              string: mx.data.qaa.purchase.sanity.wod-003.productName1

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 9: Return product back to cart

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 9: RETURN PRODUCT BACK TO CART.'
            - name: squadNames
              string: PURCHASE | QAA
      - scroll:
          direction: down
          untilIdentifier: mx.mappings.cart.sfl.moveToCart
      - executeFunction:
          name: mx.functions.cart.sfl.tapMoveToCartByProductName
          params:
            - name: productName
              string: mx.data.qaa.purchase.sanity.wod-003.productName1

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 10 Tap on reserve slot

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 10: Tap on reserve slot."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.cart.scrollUpToReserveSlotButton
      - executeFunction:
          name: mx.functions.cart.tapReserveSlot

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 11: Reserve a Home Delivery Slot and continue to checkout

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 11: Reserve a Home Delivery Slot."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.reserve-slot.selectDateAndRandomNormalTimeSlot
          params:
            - name: dateAfterTomorrow
              string: "true"
      # [VARIABLE] Selected Day Slot value saved in purchase_od_003_selected_day_slot
      - storeIn:
          key: purchase_od_003_selected_day_slot
          value: ${returnedSelectedDaySlot}
      # [VARIABLE] Selected Time Slot value saved in purchase_od_003_selected_time_slot
      - storeIn:
          key: purchase_od_003_selected_time_slot
          value: ${returnedSelectedTimeSlot}
      # [VARIABLE] Delivery Fee value saved in purchase_od_003_delivery_fee
      - storeIn:
          key: purchase_od_003_delivery_fee
          value: ${returnedDeliveryFee}

      - executeFunction:
          name: mx.functions.utils.getDeliverySlot
          params:
            - name: forPage
              string: 'Cart'
            - name: selectedDaySlot
              string: ${purchase_od_003_selected_day_slot}
            - name: selectedTimeSlot
              string: ${purchase_od_003_selected_time_slot}
      # [VARIABLE] Delivery Slot value saved in purchase_od_003_delivery_slot
      - storeIn:
          key: purchase_od_003_delivery_slot
          value: ${returnedDeliverySlot}

      - executeFunction:
          name: mx.flows.od.cart.assertHomeSlotSelected
          params:
            - name: deliverySlot
              string: ${purchase_od_003_delivery_slot}
            - name: expectedUserStreet
              string: ${purchase_od_003_street_name}
            - name: expectedUserExteriorNumber
              string: ${purchase_od_003_exterior_number}
            - name: expectedDeliveryFee
              string: ${purchase_od_003_delivery_fee}

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 12: Continue to checkout

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 12: Continue to checkout"
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.cart.tapContinue

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 13: Go to search Products

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 13: Go to Search products."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.cart.backToListsSearch

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 14: Search product, open PDP and Add product to cart

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 14: Search product, open PDP and Add product to cart."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.search.addItemToCartFromSearch
          params:
            - name: searchTerm
              string: mx.data.qaa.purchase.sanity.wod-003.searchTerm1
            - name: productName
              string: mx.data.qaa.purchase.sanity.wod-003.productName3
      # [VARIABLE] Name of product 3 saved in ${purchase_od003_product_3_name}
      - storeIn:
          key: purchase_od003_product_3_name
          value: mx.data.qaa.purchase.sanity.wod-003.productName3
      # [VARIABLE] Price of product 3 saved in ${purchase_od003_product_3_price}
      - storeIn:
          key: purchase_od003_product_3_price
          value: ${returnedProductPrice}
      # [VARIABLE] Quantity of product 3 saved in ${purchase_od003_product_3_quantity}
      - storeIn:
          key: purchase_od003_product_3_quantity
          value: ${returnedProductQuantity}
      # [VARIABLE] Subtotal of product 1 saved in ${purchase_od001_product_1_price}
      - storeIn:
          key: purchase_od003_product_3_subtotal
          value: ${returnedProductSubTotalPrice}

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 15: Increase product quantity to exceed delivery threshold.

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 15: Increase product quantity to exceed delivery threshold."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon
      - executeFunction:
          name: mx.flows.cart.increaseQuantityToExceedHomeDeliveryThresholdOnCart
          params:
            - name: productName
              string: mx.data.qaa.purchase.sanity.wod-003.productName1
      - executeFunction:
          name: mx.functions.cart.getProductQuantity # <--[PARAM]--${productName}
      - executeFunction:
          name: mx.functions.cart.getProductPrice # <--[PARAM]--${productName}
      # [VARIABLE] Quantity of product 1 saved in ${purchase_od003_product_1_quantity}
      - storeIn:
          key: purchase_od003_product_1_quantity
          value: ${returnedProductQuantity}

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 16: Product quantity is updated.

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 16: Product quantity is updated."
            - name: squadNames
              string: PURCHASE | QAA
      - log: "Product 1 - ${purchase_od003_product_1_name} - assertions"
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions
          params:
            - name: productName
              string: ${purchase_od003_product_1_name}
            - name: expectedQuantity
              string: ${purchase_od003_product_1_quantity}
            - name: expectedUnitPrice
              string: ${purchase_od003_product_1_price}
            - name: expectedOriginalPrice
              string: "null"

      - log: "Product 2 - ${purchase_od003_product_2_name} - assertions"
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions
          params:
            - name: productName
              string: ${purchase_od003_product_2_name}
            - name: expectedQuantity
              string: ${purchase_od003_product_2_quantity}
            - name: expectedUnitPrice
              string: ${purchase_od003_product_2_price}
            - name: expectedOriginalPrice
              string: "null"

      - log: "Product 3 - ${purchase_od003_product_3_name} - assertions"
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions
          params:
            - name: productName
              string: ${purchase_od003_product_3_name}
            - name: expectedQuantity
              string: ${purchase_od003_product_3_quantity}
            - name: expectedUnitPrice
              string: ${purchase_od003_product_3_price}
            - name: expectedOriginalPrice
              string: "null"

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 17: Change shipping details.

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 17: Change shipping details."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.cart.tapReserveSlot

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 18: Select "Pickup" and select time slot.

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 18: Select Pickup and select time slot."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.reserve-slot.tapPickupDeliveryMethod
      - executeFunction:
          name: mx.flows.od.reserve-slot.selectDateAndRandomNormalTimeSlot
          params:
            - name: dateAfterTomorrow
              string: "true"
      # [VARIABLE] Selected Day Slot value saved in purchase_od_003_selected_day_slot
      - storeIn:
          key: purchase_od_003_selected_day_slot
          value: ${returnedSelectedDaySlot}
      # [VARIABLE] Selected Time Slot value saved in purchase_od_003_selected_time_slot
      - storeIn:
          key: purchase_od_003_selected_time_slot
          value: ${returnedSelectedTimeSlot}
      - executeFunction:
          name: mx.functions.utils.getDeliverySlot
          params:
            - name: forPage
              string: 'Cart'
            - name: selectedDaySlot
              string: ${purchase_od_003_selected_day_slot}
            - name: selectedTimeSlot
              string: ${purchase_od_003_selected_time_slot}
      # [VARIABLE] Delivery Slot value saved in purchase_od_003_delivery_slot
      - storeIn:
          key: purchase_od_003_delivery_slot
          value: ${returnedDeliverySlot}
      - executeFunction:
          name: mx.functions.reserve-slot.getSelectedStore
          # --RETURNS--${returnedStoreName}-->
      - executeFunction:
          name: mx.functions.cart.assertPickupSlotSelected
          params:
            - name: deliverySlot
              string: ${returnedDeliverySlot}
            - name: storeName
              string: ${returnedStoreName}

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 19: Continue to checkout.

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 19: Continue to checkout."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.cart.closeSnackbarIfDisplayed
      - executeFunction:
          name: mx.functions.cart.tapContinue
      - executeFunction:
          name: mx.functions.utils.waitUntilMappingDisappear
          params:
            - name: mapping
              string: mx.mappings.cart.cartBackgroundSpinner
      - executeFunction:
          name: mx.functions.utils.waitUntilMappingDisappear
          params:
            - name: mapping
              string: mx.mappings.add-payment-method.paymentLoadingSpinner

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 20: Go to Wallet in CXO, validate pay at delivery not available.

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 20: Continue to checkout."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.review-order.scrollToAddPaymentButton
      - executeFunction:
          name: mx.functions.review-order.payment-section.tapChangePaymentMethod
      - executeFunction:
          name: mx.functions.utils.waitUntilMappingDisappear
          params:
            - name: mapping
              string: mx.mappings.wallet.spinnerWallet
      - executeFunction:
          name: mx.functions.wallet.assertPaymentMethodCashIsUnavailable

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 21: Get back to Cart screen

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 21 Get back to Cart screen"
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.cart.backToCart

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 23: Open PDP screen and decrease product quantity

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 23 Open PDP screen and decrease product quantity"
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.cart.openPDP
          params:
            - name: productName
              string: mx.data.qaa.purchase.sanity.wod-003.productName1
      - arithmetic:
          expression: ${purchase_od003_product_1_quantity} - 1
          storeIn: quantity
      - executeFunction:
          name: mx.functions.pdp.decreaseQuantityBy
          params:
            - name: quantity
              string: ${quantity}
      - arithmetic:
          expression: ${purchase_od003_product_1_quantity} - ${quantity}
          storeIn: newQuantity
          asInt: true
      # [VARIABLE] Quantity of product 1 saved in ${purchase_od003_product_1_quantity}
      - storeIn:
          key: purchase_od003_product_1_quantity
          value: ${newQuantity}
      - executeFunction:
          name: mx.functions.pdp.assertQuantityAsPieces
          params:
            - name: expectedQuantityAsPieces
              string: "1"

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 24: Open Cart

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 24 Get back to Cart screen"
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.cart.backToCart
      - executeFunction:
          name: mx.flows.od.cart.assertDeliveryMethodSlot
          params:
            - name: deliveryMethod
              string: "PickupDelivery"
            - name: deliverySlot
              string: ${returnedDeliverySlot}
            - name: userShortAddress
              string: "null"
            - name: expectedDeliveryFee
              string: "null"
      # [VARIABLE] Subtotal saved in ${subtotal_product_1}
      - arithmetic:
          expression: ${purchase_od003_product_1_price} * ${purchase_od003_product_1_quantity}
          numberOfDecimalPlaces: 2
          storeIn: subtotal_product_1
      # [VARIABLE] Subtotal saved in ${subtotal_product_2}
      - arithmetic:
          expression: ${purchase_od003_product_2_price} * ${purchase_od003_product_2_quantity}
          numberOfDecimalPlaces: 2
          storeIn: subtotal_product_2
      # [VARIABLE] Subtotal saved in ${subtotal_product_3}
      - arithmetic:
          expression: ${purchase_od003_product_3_price} * ${purchase_od003_product_3_quantity}
          numberOfDecimalPlaces: 2
          storeIn: subtotal_product_3
      # [VARIABLE] Cart total saved in ${purchase_od001_total}
      - arithmetic:
          expression: ${subtotal_product_1} + ${subtotal_product_2} + ${subtotal_product_3}
          numberOfDecimalPlaces: 2
          storeIn: purchase_od003_total
      - executeFunction:
          name: mx.flows.od.cart.assertTotals # --RETURNS--${returnedEstimatedTotal}-->
          params:
            - name: expectedDeliveryFee
              string: "null"
            - name: expectedSubtotal
              string: ${purchase_od003_total}

      #------------------------------------------------------------------------------------------------------------------

      ## STEP 25: Continue to Checkout

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 25 Continue to Checkout"
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.cart.tapContinue
      - executeFunction:
          name: mx.functions.utils.waitUntilMappingDisappear
          params:
            - name: mapping
              string: mx.mappings.cart.cartBackgroundSpinner
      - executeFunction:
          name: mx.functions.utils.waitUntilMappingDisappear
          params:
            - name: mapping
              string: mx.mappings.add-payment-method.paymentLoadingSpinner
      - executeFunction:
          name: mx.functions.review-order.assertDeliveryMethod
          params:
            - name: expectedDeliveryMethod
              string: "PickupDelivery"

      #------------------------------------------------------------------------------------------------------------------

      ## STEP: 26 Go to payment methods

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 26 Go to payment methods"
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.review-order.scrollToAddPaymentButton
      - executeFunction:
          name: mx.functions.review-order.payment-section.tapChangePaymentMethod
      - executeFunction:
          name: mx.functions.utils.waitUntilMappingDisappear
          params:
            - name: mapping
              string: mx.mappings.wallet.spinnerWallet

      #------------------------------------------------------------------------------------------------------------------

      ## STEP: 27 Select pay at delivery

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 27 Select pay at delivery."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.payment.selectPayAtDeliveryOption
          params:
            - name: payAtDeliveryFormat
              string: mx.data.qaa.purchase.sanity.wod-003.paymentMethod
      - executeFunction:
          name: mx.functions.wallet.tapContinue
      - executeFunction:
          name: mx.functions.review-order.payment-section.assertSelectedPaymentMethod
          params:
            - name: paymentMethod
              string: mx.data.qaa.purchase.sanity.wod-003.paymentMethod
      - executeFunction:
          name: mx.functions.review-order.payment-section.assertSelectedPayAtDeliveryOption
          params:
            - name: expectedOption
              string: mx.data.qaa.purchase.sanity.wod-003.payAtDeliveryMethod
      - scroll:
          direction: down
          untilIdentifier: mx.mappings.review-order.estimatedTotalPriceFromBottomLabel
      - executeFunction:
          name: mx.functions.review-order.payment-section.assertTotal
          params:
            - name: expectedTotal
              string: ${purchase_od003_total}

      #------------------------------------------------------------------------------------------------------------------

      ## STEP: 28 Place order

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 28 Place order."
            - name: squadNames
              string: PURCHASE | QAA

      - scroll:
          direction: up
      - executeFunction:
          name: mx.functions.review-order.scrollToPhoneNumber
      - executeFunction:
          name: mx.functions.review-order.enterCellphoneNumber
          params:
            - name: userPhoneNumber
              string: mx.data.qaa.purchase.sanity.wod-003.userPhoneNumber
      - executeFunction:
          name: mx.functions.review-order.tapPlaceOrder
      - executeFunction:
          name: mx.functions.order-confirmation.getOrderNumber
      # [VARIABLE] Cart total saved in ${purchase_od001_total}
      - arithmetic:
          expression: ${purchase_od003_product_1_quantity} + ${purchase_od003_product_2_quantity} + ${purchase_od003_product_3_quantity}
          storeIn: totalProductsCount
      - executeFunction:
          name: mx.flows.od.order-confirmation.assertConfirmation
          params:
            - name: expectedTotal
              string: ${purchase_od003_total}
            - name: expectedDeliveryMethod
              string: mx.data.qaa.purchase.sanity.wod-003.deliveryMethod
            - name: expectedDaySlot
              string: ${purchase_od_003_selected_day_slot}
            - name: expectedTimeSlot
              string: ${purchase_od_003_selected_time_slot}
            - name: expectedDeliverySlot
              string: ${purchase_od_003_delivery_slot}
            - name: expectedHomeAddressName
              string: "null"
            - name: expectedHomeAddress
              string: "null"
            - name: expectedProductsCount
              string: ${totalProductsCount}

      #------------------------------------------------------------------------------------------------------------------

      ## STEP: 29 Cancel Order (extra steps)

      - log:
          message: "STEP 29: Cancel order (extra steps)"
          color: ORANGE

      - executeFunction:
          name: mx.functions.order-confirmation.tapFindMoreProducts

      - executeFunction:
          name: mx.functions.bottom-menu.tapAccount

      - executeFunction:
          name: mx.functions.account.assertPageDisplayed

      - executeFunction:
          name: mx.functions.account.openOrdersHistory

      - executeFunction:
          name: mx.functions.orders-history.assertPageDisplayed

      - executeFunction:
          name: mx.functions.orders-history.tapOrderDetailsByPosition
          params:
            - name: position
              string: '1'

      - executeFunction:
          name: mx.flows.od.order-details.cancelOrderWithSetOption

      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon

      - executeFunction:
          name: mx.functions.cart.assertCartIsEmpty

      - executeFunction:
          name: mx.functions.cart.tapBack

      #------------------------------------------------------------------------------------------------------------------

      - storeIn:
          key: WOD_003_SUCCESSFUL_EXECUTION
          value: true

      - log: "TEST END: ${PURCHASE_TEST_CASE_NAME}"

  #--------------------------------------------------------------------------------------------------------------------

  - name: After
    after: true
    flow:
      - log: "AFTER SCENARIO START: After Configs..."

      - if:
          condition: ${WOD_003_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "Main Failed. No need to reset data."
                color: RED
            - executeFunction:
                name: mx.flows.od.after-scenario-exclusive.relaunchAndNavigateToHomePage
            - executeFunction:
                name: mx.flows.od.after-scenario-exclusive.emptyCart
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: GREEN_BOLD
      - log: "AFTER SCENARIO END"