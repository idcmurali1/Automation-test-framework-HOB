#======================================================================================================================
#    AUTHOR: Teresa Partida (vn55epy)
#   CREATED: May/07/2024
#  REVISION: ---
#
#  Copyright Â© 2024 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: qaa-purchase-sanity-walmart-od-production-ios-001, qaa-purchase-sanity-walmart-od-production-ios

scenarios:
  #####################################################################################################################
  #
  #  JIRA MANUAL TC:
  #    https://jira.walmart.com/browse/MMP-1003
  #
  # Flags Used:
  #       ${ASSERT_DELIVERY_SLOT_IN_CART}  -  Values: [true | false]
  #       ${ASSERT_DELIVERY_SLOT_IN_REVIEW_ORDER}  -  Values: [true | false]
  #       ${IOS_CART_PRODUCT_ASSERTIONS_WORKAROUND}  -  Values: [true | false]
  #
  #######################################################################################################################

  - name: Before
    before: true
    flow:
      - log: "BEFORE SCENARIO START: Initial Config..."

      - storeIn:
          key: PURCHASE_TEST_CASE_NAME
          value: "GMX_PURCHASE_SANITY_WOD_IOS_001"
      - executeFunction:
          name: mx.functions.utils.relaunchApp
      - storeIn:
          key: WOD_001_SUCCESSFUL_EXECUTION
          value: false
      - log: "BEFORE SCENARIO END"

  #--------------------------------------------------------------------------------------------------------------------

  - name: Main
    platform: ios
    flow:
      - log: "TEST START: ${PURCHASE_TEST_CASE_NAME}"

     # STEP 1: Navigate through onboarding and select OD Banner -------------------------------
      - log:
          message: "STEP 1: Navigate through onboarding and select OD Banner"
          color: ORANGE

      - executeFunction:
          name: mx.flows.global.onboarding.navigateToHomeAsGuestUser
          params:
            - name: zipCode
              string: mx.data.qaa.purchase.sanity.wod-001.zipCode
            - name: banner
              string: "OD"

      # STEP 2: Login from Profile screen ------------------------------------------------------
      - log:
          message: "STEP 2: Login from Profile screen."
          color: ORANGE

      - executeFunction:
          name: mx.flows.od.login.navigateToAccountAndLogin
          params:
            - name: userEmail
              string: mx.data.qaa.purchase.sanity.wod-001.userEmail
            - name: userPassword
              string: mx.data.qaa.purchase.sanity.wod-001.userPassword
            - name: userName
              string: mx.data.qaa.purchase.sanity.wod-001.userName

      # STEP 3: Open favorites list and add products to cart ------------------------------
      - log:
          message: "STEP 3: Open favorites list and add products to cart."
          color: ORANGE

      - executeFunction:
          name: mx.functions.bottom-menu.tapProductsAndLists
      - executeFunction:
          name: mx.functions.products-and-lists.assertPageDisplayed
      - executeFunction:
          name: mx.functions.products-and-lists.tapLists
      - executeFunction:
          name: mx.functions.lists.assertPageDisplayed
      - executeFunction:
          name: mx.functions.lists.assertListDisplayed
          params:
            - name: listName
              string: mx.data.qaa.purchase.sanity.wod-001.listName
      - executeFunction:
          name: mx.functions.lists.openList
      - executeFunction:
          name: mx.functions.list.assertCorrectListOpened
          params:
            - name: expectedListName
              string: mx.data.qaa.purchase.sanity.wod-001.listName

      - executeFunction:
          name: mx.functions.list.getProductNameByPosition
          params:
            - name: positionNumber
              string: 1
      - executeFunction:
          name: mx.flows.od.list.addProductToCartByName
          params:
            - name: productName
              string: ${returnedProductNameByPosition}
      # [VARIABLE] Name of product 1 saved in ${purchase_od001_product_1_name}
      - storeIn:
          key: purchase_od001_product_1_name
          value: ${returnedProductNameByPosition}
      # [VARIABLE] Price of product 1 saved in ${purchase_od001_product_1_price}
      - storeIn:
          key: purchase_od001_product_1_price
          value: ${returnedProductPrice}
      # [VARIABLE] Subtotal of product 1 saved in ${purchase_od001_product_1_price}
      - storeIn:
          key: purchase_od001_product_1_subtotal
          value: ${returnedProductSubTotalPrice}
      # [VARIABLE] Type of product 1 saved in ${purchase_od001_product_1_price}
      - storeIn:
          key: purchase_od001_product_1_type
          value: ${returnedProductType}
      # [VARIABLE] Pieces of product 1 saved in ${purchase_od001_product_1_quantity}
      - storeIn:
          key: purchase_od001_product_1_quantity
          value: ${returnedProductQuantity}

      - executeFunction:
          name: mx.functions.list.getProductNameByPosition
          params:
            - name: positionNumber
              string: 2
      - executeFunction:
          name: mx.flows.od.list.addProductToCartByName
          params:
            - name: productName
              string: ${returnedProductNameByPosition}
      # [VARIABLE] Name of product 2 saved in ${purchase_od001_product_2_name}
      - storeIn:
          key: purchase_od001_product_2_name
          value: ${returnedProductNameByPosition}
      # [VARIABLE] Price of product 2 saved in ${purchase_od001_product_2_price}
      - storeIn:
          key: purchase_od001_product_2_price
          value: ${returnedProductPrice}
      # [VARIABLE] Subtotal of product 2 saved in ${purchase_od001_product_1_price}
      - storeIn:
          key: purchase_od001_product_2_subtotal
          value: ${returnedProductSubTotalPrice}
      # [VARIABLE] Type of product 2 saved in ${purchase_od001_product_1_price}
      - storeIn:
          key: purchase_od001_product_2_type
          value: ${returnedProductType}
      # [VARIABLE] Weight of product 2 saved in ${purchase_od001_product_2_quantity}
      - storeIn:
          key: purchase_od001_product_2_quantity
          value: ${returnedProductQuantity}

      # STEP 4: In GIC select Home Delivery for an address with coverage ---------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 4: In GIC select Home Delivery for an address with coverage."
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.flows.od.delivery-method-selector.selectRandomHomeDeliveryAddress
      # [VARIABLE] Selected home delivery address saved in ${purchase_od001_delivery_address}
      - storeIn:
          key: purchase_od001_delivery_address
          value: ${returnedDeliveryAddress}
      # [VARIABLE] Selected home delivery address street saved in ${purchase_od001_delivery_address_street}
      - storeIn:
          key: purchase_od001_delivery_address_street
          value: ${returnedStreetName}
      # [VARIABLE] Selected home delivery address street exterior number saved in ${purchase_od001_delivery_address_exterior_number}
      - storeIn:
          key: purchase_od001_delivery_address_exterior_number
          value: ${returnedExteriorNumber}
      # [VARIABLE] Selected home delivery address city saved in ${purchase_od001_delivery_address_city}
      - storeIn:
          key: purchase_od001_delivery_address_city
          value: ${returnedCity}
      # [VARIABLE] Selected home delivery address state saved in ${purchase_od001_delivery_address_state}
      - storeIn:
          key: purchase_od001_delivery_address_state
          value: ${returnedState}
      # [VARIABLE] Selected home delivery address zip code saved in ${purchase_od001_delivery_address_zip_code}
      - storeIn:
          key: purchase_od001_delivery_address_zip_code
          value: ${returnedZipCode}

      # STEP 5: Go to cart -------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 5: Go to cart"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon

      # STEP 6: Validate cart ----------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 6: Validate cart"
            - name: squadNames
              string: PURCHASE | QAA

      - log: "Product 1 - ${purchase_od001_product_1_name} - assertions"
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions
          params:
            - name: productName
              string: ${purchase_od001_product_1_name}
            - name: productType
              string: ${purchase_od001_product_1_type}
            - name: expectedQuantity
              string: ${purchase_od001_product_1_quantity}
            - name: expectedWeightQuantity
              string: "null"
            - name: expectedUnitPrice
              string: ${purchase_od001_product_1_price}
            - name: expectedOriginalPrice
              string: "null"
            - name: expectedSubtotal
              string: ${purchase_od001_product_1_subtotal}

      - log: "Product 2 - ${purchase_od001_product_2_name} - assertions"
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions
          params:
            - name: productName
              string: ${purchase_od001_product_2_name}
            - name: productType
              string: ${purchase_od001_product_2_type}
            - name: expectedQuantity
              string: "null"
            - name: expectedWeightQuantity
              string: ${purchase_od001_product_2_quantity}
            - name: expectedUnitPrice
              string: ${purchase_od001_product_2_price}
            - name: expectedOriginalPrice
              string: "null"
            - name: expectedSubtotal
              string: ${purchase_od001_product_2_subtotal}

      # STEP 7: Select a slot for home delivery method ---------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 7: Select a slot for home delivery method"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.cart.tapReserveSlot

      - executeFunction:
          name: mx.functions.reserve-slot.assertHomeDeliveryIsSelected

      - executeFunction:
          name: mx.functions.reserve-slot.assertSelectedAddress
          params:
            - name: expectedUserAddress
              string: ${returnedDeliveryAddress}

      # STEP 8: Select any available slot and continue to checkout ---------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 8: Select any available slot and continue to checkout"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.flows.od.reserve-slot.selectDateAndRandomNormalTimeSlot
          params:
            - name: dateAfterTomorrow
              string: true
      # [VARIABLE] Returned day slot saved in ${purchase_od001_reserved_slot_day}
      - storeIn:
          key: purchase_od001_reserved_slot_day
          value: ${returnedSelectedDaySlot}
      # [VARIABLE] Returned time slot saved in ${purchase_od001_reserved_slot_time}
      - storeIn:
          key: purchase_od001_reserved_slot_time
          value: ${returnedSelectedTimeSlot}
      # [VARIABLE] Home delivery fee saved in ${purchase_od001_reserved_slot_fee}
      - storeIn:
          key: purchase_od001_reserved_slot_fee
          value: mx.data.qaa.purchase.sanity.wod-001.deliveryFee

      - executeFunction:
          name: mx.functions.utils.getDeliverySlot # ---> RETURNS ${returnedDeliverySlot}
          params:
            - name: forPage
              string: 'Cart'
            - name: selectedDaySlot
              string: ${purchase_od001_reserved_slot_day}
            - name: selectedTimeSlot
              string: ${purchase_od001_reserved_slot_time}

      - executeFunction:
          name: mx.flows.od.cart.assertHomeSlotSelected
          params:
            - name: deliverySlot
              string: ${returnedDeliverySlot}
            - name: expectedUserStreet
              string: ${purchase_od001_delivery_address_street}
            - name: expectedUserExteriorNumber
              string: ${purchase_od001_delivery_address_exterior_number}
            - name: expectedDeliveryFee
              string: ${purchase_od001_reserved_slot_fee}

      # [VARIABLE] Cart subtotal saved in ${purchase_od001_order_subtotal}
      - arithmetic:
          expression: ${purchase_od001_product_1_subtotal} + ${purchase_od001_product_2_subtotal}
          numberOfDecimalPlaces: 2
          storeIn: purchase_od001_order_subtotal
      # [VARIABLE] Cart total saved in ${purchase_od001_total}
      - arithmetic:
          expression: ${purchase_od001_order_subtotal} + ${purchase_od001_reserved_slot_fee}
          numberOfDecimalPlaces: 2
          storeIn: purchase_od001_order_total

      - executeFunction:
          name: mx.flows.od.cart.assertTotals # --RETURNS--${returnedEstimatedTotal}-->
          params:
            - name: expectedDeliveryFee
              string: ${purchase_od001_reserved_slot_fee}
            - name: expectedSubtotal
              string: ${purchase_od001_order_subtotal}

      - executeFunction:
          name: mx.functions.cart.tapContinue

      # STEP 9: Review order -----------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 9: Review order"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.flows.od.review-order.assertDeliveryInformation
          params:
            - name: deliveryMethod
              string: mx.data.qaa.purchase.sanity.wod-001.deliveryMethod
            - name: expectedDaySlot
              string: ${purchase_od001_reserved_slot_day}
            - name: expectedTimeSlot
              string: ${purchase_od001_reserved_slot_time}
            - name: expectedStoreOrHomeName
              string: mx.data.qaa.purchase.sanity.wod-001.userAddressName
            - name: expectedStoreOrHomeAddress
              string: 'null'
            - name: expectedUserStreet
              string: ${purchase_od001_delivery_address_street}
            - name: expectedUserExteriorNumber
              string: ${purchase_od001_delivery_address_exterior_number}
            - name: expectedUserCity
              string: ${purchase_od001_delivery_address_city}
            - name: expectedUserState
              string: ${purchase_od001_delivery_address_state}
            - name: expectedUserZipCode
              string: ${purchase_od001_delivery_address_zip_code}

      - executeFunction:
          name: mx.flows.od.review-order.assertTotalsInformation
          params:
            - name: expectedSubtotalProductsCount
              string: mx.data.qaa.purchase.sanity.wod-001.productsCount
            - name: expectedSubtotal
              string: ${purchase_od001_order_subtotal}
            - name: assertDeliveryFee
              string: 'true'
            - name: expectedDeliveryFee
              string: ${purchase_od001_reserved_slot_fee}

      # STEP 10: Select pay at delivery ------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 10: Select pay at delivery"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.review-order.scrollUpToWallet

      - executeFunction:
          name: mx.flows.od.review-order.selectPayAtDeliveryMethodIfNotSelected
          params:
            - name: payAtDeliveryOption
              string: mx.data.qaa.purchase.sanity.wod-001.payAtDeliveryMethod

      # STEP 11: Confirm pay at delivery was selected in ROP ---------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 11: Confirm pay at delivery was selected in ROP"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.review-order.payment-section.assertSelectedPaymentMethod
          params:
            - name: paymentMethod
              string: mx.data.qaa.purchase.sanity.wod-001.paymentMethod

      - executeFunction:
          name: mx.functions.review-order.payment-section.assertSelectedPayAtDeliveryOption
          params:
            - name: expectedOption
              string: mx.data.qaa.purchase.sanity.wod-001.payAtDeliveryMethod

      - executeFunction:
          name: mx.functions.review-order.payment-section.assertTotal
          params:
            - name: expectedTotal
              string: ${purchase_od001_order_total}

      # STEP 12: Place order -----------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 12: Place order"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.review-order.tapPlaceOrder

      # STEP 13: Review Order Confirmation Screen --------------------------------------------------
      - log:
          message: "STEP 13: Review Order Confirmation Screen"
          color: ORANGE

      - executeFunction:
          name: mx.functions.utils.closeRateWalmartPopupIfDisplayed

      - executeFunction:
          name: mx.functions.order-confirmation.assertPageDisplayed

      - executeFunction:
          name: mx.functions.order-confirmation.getOrderNumber

      - executeFunction:
          name: mx.flows.od.order-confirmation.assertConfirmation
          params:
            - name: expectedTotal
              string: ${purchase_od001_order_total}
            - name: expectedDeliveryMethod
              string: mx.data.qaa.purchase.sanity.wod-001.deliveryMethod
            - name: expectedDaySlot
              string: ${purchase_od001_reserved_slot_day}
            - name: expectedTimeSlot
              string: ${purchase_od001_reserved_slot_time}
            - name: expectedHomeAddressName
              string: mx.data.qaa.purchase.sanity.wod-001.userAddressName
            - name: expectedUserStreet
              string: ${purchase_od001_delivery_address_street}
            - name: expectedUserExteriorNumber
              string: ${purchase_od001_delivery_address_exterior_number}
            - name: expectedUserCity
              string: ${purchase_od001_delivery_address_city}
            - name: expectedUserState
              string: ${purchase_od001_delivery_address_state}
            - name: expectedUserZipCode
              string: ${purchase_od001_delivery_address_zip_code}
            - name: expectedProductsCount
              string: mx.data.qaa.purchase.sanity.wod-001.productsCount

      # STEP 14: Cancel order (extra steps) --------------------------------------------------------
      - log:
          message: "STEP 14: Cancel order (extra steps)"
          color: ORANGE

      - executeFunction:
          name: mx.functions.utils.closeRateWalmartPopupIfDisplayed

      - executeFunction:
          name: mx.functions.order-confirmation.tapFindMoreProducts

      - executeFunction:
          name: mx.functions.bottom-menu.tapAccount

      - executeFunction:
          name: mx.functions.account.assertPageDisplayed

      - executeFunction:
          name: mx.functions.account.openOrdersHistory

      - executeFunction:
          name: mx.functions.orders-history.assertPageDisplayed

      - executeFunction:
          name: mx.functions.orders-history.tapOrderDetailsByPosition
          params:
            - name: position
              string: '1'

      - executeFunction:
          name: mx.flows.od.order-details.cancelOrderWithSetOption

      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon

      - executeFunction:
          name: mx.functions.cart.assertCartIsEmpty

      - executeFunction:
          name: mx.functions.cart.tapBack

      #------------------------------

      - storeIn:
          key: WOD_001_SUCCESSFUL_EXECUTION
          value: true

      - log: "TEST END: ${PURCHASE_TEST_CASE_NAME}"

  #----------------------------------------------------------------------------------------------

  - name: After
    after: true
    flow:
      - log: "AFTER SCENARIO START: After Configs..."

      - if:
          condition: ${WOD_001_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "Main Failed. Resetting data for the next execution if necessary..."
                color: RED
            - executeFunction:
                name: mx.flows.od.after-scenario-exclusive.relaunchAndNavigateToHomePage
            - executeFunction:
                name: mx.flows.od.after-scenario-exclusive.emptyCart
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: GREEN_BOLD
      - log: "AFTER SCENARIO END"
