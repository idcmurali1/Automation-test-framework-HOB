#======================================================================================================================
#  AUTHOR: Teresa Partida (vn55epy)
#  CREATED: Dec/11/2024
#  REVISION: ---
#
#  Copyright 춸 2024 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: purchase-walmart-ea-sanity-production-ios-013, purchase-bodega-ea-sanity-production-ios-013, purchase-walmart-ea-sanity-production-ios, purchase-bodega-ea-sanity-production-ios
  testCaseId: MMP-5097

#######################################################################################################################
#
#  TEST CASE TITLE:
#    TC0013 Guest cart, modify items, SfL
#
#  CONFLUENCE TRACKING DASHBOARD:
#    TO-DO
#
#  JIRA AUTOMATION TC:
#    https://jira.walmart.com/browse/MMP-5097
#
#  JIRA MANUAL TC:
#    https://jira.walmart.com/browse/MMP-5058
#
#######################################################################################################################

scenarios:

  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
  #   B E F O R E   S C E N A R I O
  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: Before
    before: true
    flow:

      - log: R2_SUBFLOW_BEFORE ### [[ 游릭 Flow Identifier: BEFORE 游릭 ]] ###

      - storeIn:
          key: MMP_5097_SUCCESSFUL_EXECUTION
          value: false

      - executeFunction:
          name: functions.utils.setMarketInfo

  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
  #   M A I N   S C E N A R I O
  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: Main
    platform: ios
    flow:

      - log: R2_SUBFLOW_MAIN ### [[ 游릭 Flow Identifier: MAIN 游릭 ]] ###

      #---------------------------------------------------------------------------------------------
      # STEP 1: ADD MULTIPLE PRODUCTS TO CART ------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 1: ADD MULTIPLE PRODUCTS TO CART"
          color: ORANGE

      - executeFunction:
          name: functions.onboardingToHomePage.usingPostalCode
          params:
            - name: PostalCode
              string: data.onboarding.userPostalCode
            - name: ShoppingExperience
              string: data.onboarding.onlineExclusiveStore

      # FIRST PRODUCT -------------------------------------
      - executeFunction:
          name: functions.searchPage.addToCartUsingItemArray
          params:
            - name: productArray
              string: mx.data.purchase-products.games.array

      - executeFunction:
          name: mx.functions.slp.getFirstProductListedName # ---> ${returnedProductName}

      - executeFunction:
          name: mx.functions.slp.getUnitProductPrice # ---> ${returnedPrice}
          params:
            - name: productName
              string: ${returnedProductName}

      - storeIn:
          key: purchase_5058_first_product_price
          value: ${returnedPrice}
      - storeIn:
          key: purchase_5058_first_product_type
          value: "Pieces"
      - storeIn:
          key: purchase_5058_first_product_subtotal
          value: ${returnedPrice}
      - storeIn:
          key: purchase_5058_first_product_name
          value: ${returnedProductName}

      # SECOND PRODUCT -------------------------------------
      - executeFunction:
          name: functions.searchPage.addToCartUsingItemArray
          params:
            - name: productArray
              string: mx.data.purchase-products.babies.array

      - executeFunction:
          name: mx.functions.slp.getFirstProductListedName # ---> ${returnedProductName}

      - executeFunction:
          name: mx.functions.slp.getUnitProductPrice # ---> ${returnedPrice}
          params:
            - name: productName
              string: ${returnedProductName}

      - storeIn:
          key: purchase_5058_second_product_price
          value: ${returnedPrice}
      - storeIn:
          key: purchase_5058_second_product_type
          value: "Pieces"
      - storeIn:
          key: purchase_5058_second_product_subtotal
          value: ${returnedPrice}
      - storeIn:
          key: purchase_5058_second_product_name
          value: ${returnedProductName}

      # THIRD PRODUCT -------------------------------------
      - executeFunction:
          name: functions.searchPage.addToCartUsingItemArray
          params:
            - name: productArray
              string: mx.data.purchase-products.appliances.array

      - executeFunction:
          name: mx.functions.slp.getFirstProductListedName # ---> ${returnedProductName}

      - executeFunction:
          name: mx.functions.slp.getUnitProductPrice # ---> ${returnedPrice}
          params:
            - name: productName
              string: ${returnedProductName}

      - storeIn:
          key: purchase_5058_third_product_price
          value: ${returnedPrice}
      - storeIn:
          key: purchase_5058_third_product_type
          value: "Pieces"
      - storeIn:
          key: purchase_5058_third_product_subtotal
          value: ${returnedPrice}
      - storeIn:
          key: purchase_5058_third_product_name
          value: ${returnedProductName}

      # [VARIABLE] Update product total
      - arithmetic:
          expression: ${purchase_5058_first_product_subtotal} + ${purchase_5058_second_product_subtotal} + ${purchase_5058_third_product_subtotal}
          numberOfDecimalPlaces: 2
          storeIn: purchase_5058_cart_total


      #---------------------------------------------------------------------------------------------
      # STEP 2: GO TO CART -------------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 2: GO TO CART"
          color: ORANGE

      - executeFunction:
          name: functions.global.tapCartIcon
      - executeFunction:
          name: mx.functions.cart.assertCartNotEmpty
      - executeFunction:
          name: functions.cartPage.validateItemDetails

      - log: "Product - ${purchase_5058_first_product_name} - assertions"
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions
          params:
            - name: productName
              string: ${purchase_5058_first_product_name}
            - name: productType
              string: ${purchase_5058_first_product_type}
            - name: expectedQuantity
              string: "null"
            - name: expectedUnitPrice
              string: ${purchase_5058_first_product_price}
            - name: expectedOriginalPrice
              string: "null"
            - name: expectedSubtotal
              string: ${purchase_5058_first_product_price}

      - log: "Product - ${purchase_5058_second_product_name} - assertions"
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions
          params:
            - name: productName
              string: ${purchase_5058_second_product_name}
            - name: productType
              string: ${purchase_5058_second_product_type}
            - name: expectedQuantity
              string: "null"
            - name: expectedUnitPrice
              string: ${purchase_5058_second_product_price}
            - name: expectedOriginalPrice
              string: "null"
            - name: expectedSubtotal
              string: ${purchase_5058_second_product_price}

      - log: "Product - ${purchase_5058_third_product_name} - assertions"
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions
          params:
            - name: productName
              string: ${purchase_5058_third_product_name}
            - name: productType
              string: ${purchase_5058_third_product_type}
            - name: expectedQuantity
              string: "null"
            - name: expectedUnitPrice
              string: ${purchase_5058_third_product_price}
            - name: expectedOriginalPrice
              string: "null"
            - name: expectedSubtotal
              string: ${purchase_5058_third_product_price}

      - executeFunction:
          name: functions.cartPage.validateMoneybox

      - executeFunction:
          name: functions.cartPage.assertCartQuantity
          params:
            - name: expectedQuantity
              string: mx.data.qaa.purchase.sanity.tc013.expectedProductsQuantity

      - executeFunction:
          name: functions.cartPage.assertCartTotals
          params:
            - name: expectedSubTotal
              string: ${purchase_5058_cart_total} # <-- ${totalPrice} / GLOBAL VAR
            - name: assertEstimatedTotal
              string: 'true'

      #---------------------------------------------------------------------------------------------
      # STEP 3: MODIFY PRODUCT QUANTITY ------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 3: MODIFY PRODUCT QUANTITY"
          color: ORANGE

      - executeFunction:
          name: mx.functions.cart.increaseProductQuantityBy
          params:
            - name: productName
              string: ${purchase_5058_first_product_name}
            - name: increments
              string: mx.data.qaa.purchase.sanity.tc013.productIncrement

      # [VARIABLE] Update product total
      - arithmetic:
          expression: ${purchase_5058_first_product_subtotal} + ( ${purchase_5058_first_product_price} * mx.data.qaa.purchase.sanity.tc013.productIncrement)
          numberOfDecimalPlaces: 2
          storeIn: purchase_5058_first_product_subtotal

      # [VARIABLE] Update product total
      - arithmetic:
          expression: ${purchase_5058_cart_total} + ( ${purchase_5058_first_product_price} * mx.data.qaa.purchase.sanity.tc013.productIncrement)
          numberOfDecimalPlaces: 2
          storeIn: purchase_5058_cart_total

      - executeFunction:
          name: functions.cartPage.assertCartTotals
          params:
            - name: expectedSubTotal
              string: ${purchase_5058_cart_total}
            - name: assertEstimatedTotal
              string: 'true'

      #---------------------------------------------------------------------------------------------
      # STEP 4: Increase item quantity until max limit ------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 4: INCREASE PRODUCT MAX QUANTITY"
          color: ORANGE

      - executeFunction:
          name: mx.functions.cart.increaseProductMaxQuantity # --> ${returnedMaxQuantity}
          params:
            - name: productName
              string: ${purchase_5058_second_product_name}

      # [VARIABLE] Update product total
      - arithmetic:
          expression: ${purchase_5058_second_product_subtotal} + ( ${purchase_5058_second_product_price} * ${returnedMaxQuantity})
          numberOfDecimalPlaces: 2
          storeIn: purchase_5058_second_product_subtotal

      # [VARIABLE] Update product total
      - arithmetic:
          expression: ${purchase_5058_cart_total} + ( ${purchase_5058_second_product_price} * ${returnedMaxQuantity})
          numberOfDecimalPlaces: 2
          storeIn: purchase_5058_cart_total

      - executeFunction:
          name: functions.cartPage.assertCartTotals
          params:
            - name: expectedSubTotal
              string: ${purchase_5058_cart_total}
            - name: assertEstimatedTotal
              string: 'true'

      #---------------------------------------------------------------------------------------------
      # STEP 5: MOVE PRODUCTS TO SAVE FOR LATER -----------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 5: MOVE PRODUCTS TO SAVE FOR LATER"
          color: ORANGE

      ##TODO move all products to SfL

      - executeFunction:
          name: mx.functions.cart.tapSaveForLaterByProductName
          params:
            - name: productName
              string: ${purchase_5058_third_product_name}

        # [VARIABLE] Update product total
      - arithmetic:
          expression: ${purchase_5058_cart_total} - ${purchase_5058_third_product_subtotal}
          numberOfDecimalPlaces: 2
          storeIn: purchase_5058_cart_total

      - executeFunction:
          name: functions.cartPage.assertCartTotals
          params:
            - name: expectedSubTotal
              string: ${purchase_5058_cart_total}
            - name: assertEstimatedTotal
              string: 'true'

      - executeFunction:
          name: mx.functions.cart.tapSaveForLaterByProductName
          params:
            - name: productName
              string: ${purchase_5058_first_product_name}

      - executeFunction:
          name: mx.functions.cart.tapSaveForLaterByProductName
          params:
            - name: productName
              string: ${purchase_5058_second_product_name}

      # [VARIABLE] Update product total
      - arithmetic:
          expression: ${purchase_5058_cart_total} - ${purchase_5058_first_product_subtotal} - ${purchase_5058_second_product_subtotal}
          numberOfDecimalPlaces: 2
          storeIn: purchase_5058_cart_total

      - executeFunction:
          name: functions.cartPage.assertCartIsEmpty

      #---------------------------------------------------------------------------------------------
      # STEP 6: MOVE FROM SAVE FOR LATER TO CART----------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 6: MOVE FROM SAVE FOR LATER TO CART"
          color: ORANGE

      - executeFunction:
          name: mx.functions.cart.sfl.tapMoveToCartByProductName
          params:
            - name: productName
              string: ${purchase_5058_third_product_name}

      # [VARIABLE] Update product total
      - arithmetic:
          expression: ${purchase_5058_cart_total} + ${purchase_5058_third_product_price}
          numberOfDecimalPlaces: 2
          storeIn: purchase_5058_cart_total

      - executeFunction:
          name: functions.cartPage.assertCartTotals
          params:
            - name: expectedSubTotal
              string: ${purchase_5058_cart_total}
            - name: assertEstimatedTotal
              string: 'true'

      #---------------------------------------------------------------------------------------------
      # STEP 7: DELETE PRODUCTS IN SAVE FOR LATER --------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 7: DELETE PRODUCTS IN SAVE FOR LATER"
          color: ORANGE

      - executeFunction:
          name: mx.functions.cart.deleteProductSaveForLaterByProductName
          params:
            - name: productName
              string: ${purchase_5058_first_product_name}

      - executeFunction:
          name: mx.functions.cart.deleteProductSaveForLaterByProductName
          params:
            - name: productName
              string: ${purchase_5058_second_product_name}

      - executeFunction:
          name: mx.functions.cart.assertSaveForLaterNotDisplayed

      #---------------------------------------------------------------------------------------------
      # STEP 8: DELETE PRODUCTS FROM THE CART ------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 8: DELETE PRODUCTS FROM THE CART"
          color: ORANGE

      - executeFunction:
          name: functions.global.tapBackBtn
      - executeFunction:
          name: functions.cartPage.clearCart

      #---------------------------------------------------------------------------------------------
      # END ----------------------------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - storeIn:
          key: MMP_5097_SUCCESSFUL_EXECUTION
          value: true

  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
  #   A F T E R   S C E N A R I O
  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: After
    after: true
    flow:
      - log: R2_SUBFLOW_AFTER ### [[ 游릭 Flow Identifier: AFTER 游릭 ]] ###

      - if:
          condition: ${MMP_5097_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "Main Failed."
                color: RED
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: GREEN_BOLD
      - log: "AFTER SCENARIO ENDED"
