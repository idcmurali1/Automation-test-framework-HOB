#======================================================================================================================
#  AUTHOR: Brenda Robles (vn557kg)
#  CREATED: Oct/30/2024
#  REVISION: ---
#
#  Copyright 춸 2024 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: purchase-walmart-ea-sanity-production-android-001, purchase-bodega-ea-sanity-production-android-001, purchase-walmart-ea-sanity-production-android, purchase-bodega-ea-sanity-production-android
  testCaseId: MMP-5099

#######################################################################################################################
#
#  TEST CASE TITLE:
#    TC Goal: Merge cart (new user), pick up, pay at store * TBD
#
#  CONFLUENCE TRACKING DASHBOARD:
#    TO-DO
#
#  JIRA AUTOMATION TC:
#    https://jira.walmart.com/browse/MMP-5099
#
#  JIRA MANUAL TC:
#    https://jira.walmart.com/browse/MMP-5054
#
#######################################################################################################################

scenarios:

  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
  #   B E F O R E   S C E N A R I O
  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: Before
    before: true
    flow:

      - log: R2_SUBFLOW_BEFORE ### [[ 游릭 Flow Identifier: BEFORE 游릭 ]] ###

      - executeFunction:
          name: functions.utils.setMarketInfo

      - storeIn:
          key: MMP_5099_SUCCESSFUL_EXECUTION
          value: false

      - log: "BEFORE SCENARIO END"

  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
  #   M A I N   S C E N A R I O
  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: Main
    platform: android
    flow:

      - log: R2_SUBFLOW_MAIN ### [[ 游릭 Flow Identifier: MAIN 游릭 ]] ###

      #---------------------------------------------------------------------------------------------
      # STEP 0: RESET ACCOUNT DATA -----------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 0: RESET ACCOUNT DATA"
          color: ORANGE

      - executeFunction:
          name: functions.onboardingToHomePage.usingPostalCode
          params:
            - name: PostalCode
              string: data.onboarding.userPostalCode
            - name: ShoppingExperience
              string: data.onboarding.onlineExclusiveStore

      - executeFunction:
          name: functions.global.tapAccountBtn
      - executeFunction:
          name: functions.accountPage.tapSignInBtn

      - executeFunction:
          name: functions.loginPage.userAuthentication
          params:
            - name: userEmail
              string: mx.data.purchase-001.userEmail
            - name: userPassword
              string: mx.data.purchase-user-data.userPassword

      - executeFunction:
          name: functions.global.tapShopBtn
      - executeFunction:
          name: mx.flows.od.after-scenario-exclusive.openCartAndDeleteAllProducts
      - executeFunction:
          name: functions.global.tapBackBtn
      - executeFunction:
          name: functions.global.tapAccountBtn
      - executeFunction:
          name: mx.functions.account.tapLogout
      - executeFunction:
          name: functions.global.tapShopBtn

      #---------------------------------------------------------------------------------------------
      # STEP 1: OPEN PDP ---------------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 1: OPEN PDP"
          color: ORANGE

      - executeFunction:
          name: functions.searchPage.getTheFirstAvailableItemAndNavigateToPDP
          params:
            - name: productArray
              string: mx.data.purchase-products.pickup.array

      #---------------------------------------------------------------------------------------------
      # STEP 2: ADD PRODUCT TO CART ----------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 2: ADD PRODUCT TO CART"
          color: ORANGE

      - executeFunction:
          name: mx.functions.pdp.addToCart # ---> ${returnedProductName}
      - executeFunction:
          name: mx.functions.pdp.getPrice # ---> ${returnedProductPrice}
      - executeFunction:
          name: mx.functions.pdp.getType # ---> ${returnedProductType}
      - executeFunction:
          name: mx.functions.pdp.getProductQuantityAsPieces # ---> ${returnedProductQuantity}

      # [VARIABLE] Product's name saved in ${purchase_5054_product_name}
      - storeIn:
          key: purchase_5054_product_name
          value: ${returnedProductName}
      # [VARIABLE] Product's price saved in ${purchase_5054_product_price}
      - storeIn:
          key: purchase_5054_product_price
          value: ${returnedProductPrice}
      # [VARIABLE] Product's type saved in ${purchase_5054_product_type}
      - storeIn:
          key: purchase_5054_product_type
          value: ${returnedProductType}
      # [VARIABLE] Product's quantity saved in ${purchase_5054_product_quantity}
      - storeIn:
          key: purchase_5054_product_quantity
          value: ${returnedProductQuantity}
      # [VARIABLE] Product's subtotal saved in ${purchase_5054_product_subtotal}
      - storeIn:
          key: purchase_5054_product_subtotal
          value: ${returnedProductPrice}

      - executeFunction:
          name: functions.productDetailsPage.tapClose

      #---------------------------------------------------------------------------------------------
      # STEP 3: GO TO CART -------------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 3: GO TO CART"
          color: ORANGE

      - executeFunction:
          name: functions.global.tapCartIcon
      - executeFunction:
          name: functions.cartPage.validateItemDetails
      - executeFunction:
          name: functions.cartPage.validateMoneybox

      - log: "Product - ${purchase_5054_product_name} - assertions"
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions
          params:
            - name: productName
              string: ${purchase_5054_product_name}
            - name: productType
              string: "null"
            - name: expectedQuantity
              string: ${purchase_5054_product_quantity}
            - name: expectedWeightQuantity
              string: "null"
            - name: expectedUnitPrice
              string: "null"
            - name: expectedOriginalPrice
              string: "null"
            - name: expectedSubtotal
              string: ${purchase_5054_product_subtotal}

      #---------------------------------------------------------------------------------------------
      # STEP 4: MODIFY PRODUCT QUANTITY -------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 4: MODIFY PRODUCT QUANTITY"
          color: ORANGE

      - executeFunction:
          name: mx.functions.cart.increaseProductQuantityBy
          params:
            - name: productName
              string: ${purchase_5054_product_name}
            - name: increments
              string: mx.data.purchase-001.productIncrement

      # [VARIABLE] Update product quantity, saved in ${purchase_5054_product_quantity}
      - arithmetic:
          expression: ${purchase_5054_product_quantity} + mx.data.purchase-001.productIncrement
          numberOfDecimalPlaces: 0
          storeIn: purchase_5054_product_quantity

      # [VARIABLE] Update product subtotal, saved in ${purchase_od014_pieces_product_subtotal}
      - arithmetic:
          expression: ${purchase_5054_product_quantity} * ${purchase_5054_product_subtotal}
          numberOfDecimalPlaces: 2
          storeIn: purchase_5054_product_subtotal_update

      - log: "Product - ${purchase_5054_product_name} - assertions"
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions
          params:
            - name: productName
              string: ${purchase_5054_product_name}
            - name: productType
              string: "null"
            - name: expectedQuantity
              string: ${purchase_5054_product_quantity}
            - name: expectedWeightQuantity
              string: "null"
            - name: expectedUnitPrice
              string: "null"
            - name: expectedOriginalPrice
              string: "null"
            - name: expectedSubtotal
              string: ${purchase_5054_product_subtotal_update}

      #---------------------------------------------------------------------------------------------
      # STEPS 5, 6 & 7: CHANGE DELIVERY METHOD TO PICK UP (5), ADD ZIP CODE (6) AND SELECT STORE (7)
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEPS 5, 6 & 7: CHANGE DELIVERY METHOD TO PICK UP (5), ADD ZIP CODE (6) AND SELECT STORE (7)"
          color: ORANGE

      - executeFunction:
          name: functions.cartPage.getFulfillmentType

      - executeFunction:
          name: functions.cartPage.switchDeliveryToPickup

      #---------------------------------------------------------------------------------------------
      # STEP 8: CONTINUE TO CHECKOUT ---------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 8: CONTINUE TO CHECKOUT"
          color: ORANGE

      - executeFunction:
          name: functions.cartPage.tapContinueToCheckoutBtn

      #---------------------------------------------------------------------------------------------
      # STEP 9: CREATE NEW ACCOUNT ---------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 9: CREATE NEW ACCOUNT"
          color: ORANGE

      - if:
          condition: ${GLASS_ENV} == 'production'
          then:
            - log:
                message: "Using existing account in production"

            - executeFunction:
                name: functions.loginPage.userAuthentication
                params:
                  - name: userEmail
                    string: mx.data.purchase-001.userEmail
                  - name: userPassword
                    string: mx.data.purchase-user-data.userPassword

            - executeFunction:
                name: functions.addAddressPage.isPageDisplayed

            - if:
                condition: ${returnedIsDisplayed} == true
                then:
                  - executeFunction:
                      name: functions.cartPage.getFulfillmentType
                  - executeFunction:
                      name: functions.cartPage.switchDeliveryToPickup
                  - executeFunction:
                      name: functions.cartPage.tapContinueToCheckoutBtn

      #---------------------------------------------------------------------------------------------
      # STEP 10: VALIDATE PRODUCT DETAILS ----------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 10: VALIDATE PRODUCT DETAILS"
          color: ORANGE

      - executeFunction:
          name: functions.checkoutPage.validateItemDetails

      #---------------------------------------------------------------------------------------------
      # STEP 11 & 12: OPEN WALLET (11) AND SELECT PAY AT STORE (12) --------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 11 & 12: OPEN WALLET (11) AND SELECT PAY AT STORE (12)"
          color: ORANGE

      - executeFunction:
          name: functions.checkoutPage.selectPaymentMethod
          params:
            - name: payment
              string: data.paymentMethod.payAtStore

      - executeFunction:
          name: functions.checkoutPage.validatePayAtStore

      - executeFunction:
          name: mx.flows.od.review-order.assertTotalsInformation
          params:
            - name: expectedSubtotalProductsCount
              string: ${purchase_5054_product_quantity}
            - name: expectedSubtotal
              string: ${purchase_5054_product_subtotal_update}
            - name: assertDeliveryFee
              string: "false"

      #---------------------------------------------------------------------------------------------
      # STEP 13: MODIFY PHONE NUMBER ---------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 13: MODIFY PHONE NUMBER"
          color: ORANGE

      - executeFunction:
          name: mx.functions.review-order.enterCellphoneNumber
          params:
            - name: userPhoneNumber
              string: mx.data.purchase-user-data.userPhoneNumber

      #---------------------------------------------------------------------------------------------
      # STEP 14: PLACE ORDER -----------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - if:
          condition: ${GLASS_ENV} == 'teflon'
          then:
            - log:
                message: "STEP 14: PLACE ORDER"
                color: ORANGE

            - executeFunction:
                name: functions.checkoutPage.tapPlaceOrderButton

            - executeFunction:
                name: functions.thankYouPage.verifyThankYouPageDisplayed

      # End main -----------------------------------------------------------------------------------
      - storeIn:
          key: MMP_5099_SUCCESSFUL_EXECUTION
          value: true

  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
  #   A F T E R   S C E N A R I O
  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: After
    after: true
    flow:
      - log: R2_SUBFLOW_AFTER ### [[ 游릭 Flow Identifier: AFTER 游릭 ]] ###

      - if:
          condition: ${MMP_5099_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "Main Failed."
                color: RED
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: GREEN_BOLD
      - log: "AFTER SCENARIO ENDED"
