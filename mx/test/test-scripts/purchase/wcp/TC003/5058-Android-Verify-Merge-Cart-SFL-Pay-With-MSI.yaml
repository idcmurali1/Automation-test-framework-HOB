#======================================================================================================================
#  AUTHOR: Belen Garcia (vn532ri)
#  CREATED: Nov/11/2024
#  REVISION: ---
#
#  Copyright 춸 2024 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: purchase-walmart-ea-sanity-production-android-003, purchase-bodega-ea-sanity-production-android-003, maintenance-purchase-walmart-ea-sanity-production-android, maintenance-purchase-bodega-ea-sanity-production-android
  testCaseId: MMP-5058

#######################################################################################################################
#
#  TEST CASE TITLE:
#    TC Goal: Merge cart (new user), pick up, pay at store * TBD
#
#  CONFLUENCE TRACKING DASHBOARD:
#    TO-DO
#
#  JIRA AUTOMATION TC:
#    https://jira.walmart.com/browse/MMP-5101
#
#  JIRA MANUAL TC:
#    https://jira.walmart.com/browse/MMP-5058
#
#######################################################################################################################

scenarios:

  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
  #   B E F O R E   S C E N A R I O
  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: Before
    before: true
    flow:

      - log: R2_SUBFLOW_BEFORE ### [[ 游릭 Flow Identifier: BEFORE 游릭 ]] ###

      - executeFunction:
          name: functions.utils.setMarketInfo

      - storeIn:
          key: MMP_5058_SUCCESSFUL_EXECUTION
          value: false

      - log: "BEFORE SCENARIO END"

  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
  #   M A I N   S C E N A R I O
  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: Main
    platform: android
    flow:

      - log: R2_SUBFLOW_MAIN ### [[ 游릭 Flow Identifier: MAIN 游릭 ]] ###

      #---------------------------------------------------------------------------------------------
      # STEP 0: RESET ACCOUNT DATA -----------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 0: RESET ACCOUNT DATA"
          color: ORANGE

      - executeFunction:
          name: functions.onboardingToHomePage.usingPostalCode
          params:
            - name: PostalCode
              string: data.onboarding.userPostalCode
            - name: ShoppingExperience
              string: data.onboarding.onlineExclusiveStore

      - executeFunction:
          name: functions.global.tapAccountBtn
      - executeFunction:
          name: functions.accountPage.tapSignInBtn

      - executeFunction:
          name: functions.loginPage.userAuthentication
          params:
            - name: userEmail
              string: mx.data.purchase-003.userEmail
            - name: userPassword
              string: mx.data.purchase-user-data.userPassword

      - executeFunction:
          name: functions.global.tapShopBtn
      - executeFunction:
          name: mx.flows.od.after-scenario-exclusive.openCartAndDeleteAllProducts
      - executeFunction:
          name: functions.global.tapBackBtn
      - executeFunction:
          name: functions.global.tapAccountBtn
      - executeFunction:
          name: mx.functions.account.openAddresses
      - executeFunction:
          name: mx.flows.od.addresses.deleteAllAddresses
      - executeFunction:
          name: functions.global.tapBackBtn
      - executeFunction:
          name: functions.accountPage.openWallet
      - executeFunction:
          name: mx.flows.od.wallet.deleteAllCards
      - executeFunction:
          name: functions.global.tapBackBtn
      - executeFunction:
          name: mx.functions.account.tapLogout
      - executeFunction:
          name: mx.functions.bottom-menu.showBottomMenu
      - executeFunction:
          name: functions.global.tapShopBtn

      #---------------------------------------------------------------------------------------------
      # STEP 1: OPEN PDP ---------------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 1: ADD ITEMS FROM SLP"
          color: ORANGE

      - executeFunction:
          name: functions.searchPage.addToCartUsingItemArrayList-GetProductDetails
          params:
            - name: productArray
              string: mx.data.qaa.purchase-001.firstProduct

      # [VARIABLE] Product's name saved in ${purchase_5058_first_product_name}
      - storeIn:
          key: purchase_5058_first_product_name
          value: ${productName}

      - executeFunction:
          name: functions.searchResultPage.getProductPrice   #returns -> productPrice, params <- productName
          params:
            - name: productName
              string: ${purchase_5058_first_product_name}

      - executeFunction:
          name: functions.utils.javascript.cleanProductPrice  #returns -> cleanProductPrice, params <- productPrice
          params:
            - name: productPrice
              string: ${productPrice}

      # [VARIABLE] Product's price saved in ${purchase_5058_first_product_price}
      - storeIn:
          key: purchase_5058_first_product_price
          value: ${cleanProductPrice}

      - executeFunction:
          name: mx.functions.pdp.getType # ---> ${returnedProductType}

      # [VARIABLE] Product's type saved in ${purchase_5058_first_product_type}
      - storeIn:
          key: purchase_5058_first_product_type
          value: ${returnedProductType}
      - executeFunction:
          name: mx.functions.bottom-menu.tapHome
      - executeFunction:
          name: functions.searchPage.addToCartUsingItemArrayList-GetProductDetails
          params:
            - name: productArray
              string: mx.data.qaa.purchase-001.secondProduct

      # [VARIABLE] Product's name saved in ${purchase_5058_second_product_name}
      - storeIn:
          key: purchase_5058_second_product_name
          value: ${productName}

      - executeFunction:
          name: functions.searchResultPage.getProductPrice   #returns -> productPrice, params <- productName
          params:
            - name: productName
              string: ${purchase_5058_second_product_name}

      - executeFunction:
          name: functions.utils.javascript.cleanProductPrice  #returns -> cleanProductPrice, params <- productPrice
          params:
            - name: productPrice
              string: ${productPrice}

      # [VARIABLE] Product's name saved in ${purchase_5058_second_product_price}
      - storeIn:
          key: purchase_5058_second_product_price
          value: ${cleanProductPrice}

      - executeFunction:
          name: mx.functions.pdp.getType # ---> ${returnedProductType}

      # [VARIABLE] Product's name saved in ${purchase_5058_second_product_type}
      - storeIn:
          key: purchase_5057_second_product_type
          value: ${returnedProductType}

      #---------------------------------------------------------------------------------------------
      # STEP 2: GO TO CART -------------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 2: GO TO CART"
          color: ORANGE

      - executeFunction:
          name: functions.global.tapCartIcon
      - executeFunction:
          name: functions.cartPage.scrollToTopOfCart
      - executeFunction:
          name: functions.cartPage.validateMoneybox

      - log: "Product - ${purchase_5058_second_product_name} - assertions"
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions
          params:
            - name: productName
              string: ${purchase_5058_second_product_name}
            - name: productType
              string: ${purchase_5058_second_product_type}
            - name: mx.data.qaa.purchase-003.productQty
              string: ${purchase_5058_second_product_quantity}
            - name: expectedWeightQuantity
              string: "null"
            - name: expectedUnitPrice
              string: ${purchase_5058_second_product_price}
            - name: expectedOriginalPrice
              string: "null"
            - name: expectedSubtotal
              string: ${purchase_5058_second_product_subtotal}

      - scroll:
          direction: up
          scrollLimit: 3

      - log: "Product - ${purchase_5058_first_product_name} - assertions"
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions
          params:
            - name: productName
              string: ${purchase_5058_first_product_name}
            - name: productType
              string: ${purchase_5058_first_product_type}
            - name: mx.data.qaa.purchase-003.productQty
              string: ${purchase_5058_first_product_quantity}
            - name: expectedWeightQuantity
              string: "null"
            - name: expectedUnitPrice
              string: ${purchase_5058_first_product_price}
            - name: expectedOriginalPrice
              string: "null"
            - name: expectedSubtotal
              string: ${purchase_5058_first_product_subtotal}
      
      - scroll:
          direction: down
          scrollLimit: 2             

      #---------------------------------------------------------------------------------------------
      # STEP 3: MOVE ITEM TO SAVE FOR LATER---------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 3: MOVE ITEM TO SAVE FOR LATER"
          color: ORANGE

      - executeFunction:
          name: mx.functions.utils.searchItemInPage
          params:
            - name: productName
              string: ${purchase_5058_second_product_name}
            - name: elementToFind
              string: cartPage.productMoveToSaveForLater

      - executeFunction:
          name: functions.cartPage.moveAndVerifyProductMoveToSFL
          params:
            - name: productName
              string: ${purchase_5058_second_product_name}

      #---------------------------------------------------------------------------------------------
      # STEP 4: MOVE ITEM TO CART FROM SAVE FOR LATER---------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 4: MOVE ITEM TO CART FROM SAVE FOR LATER"
          color: ORANGE

      - executeFunction:
          name: mx.functions.utils.searchItemInPage
          params:
            - name: productName
              string: ${purchase_5058_second_product_name}
            - name: elementToFind
              string: cartPage.productMoveToCartBtn

      - executeFunction:
          name: mx.functions.cart.moveAndValidateProductToCartFromSFL
          params:
            - name: productName
              string: ${purchase_5058_second_product_name}

      #---------------------------------------------------------------------------------------------
      # STEP 5: MOVE ITEM TO SAVE FOR LATER---------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 5: MOVE ITEM TO SAVE FOR LATER"
          color: ORANGE

      - executeFunction:
          name: mx.functions.utils.searchItemInPage
          params:
            - name: productName
              string: ${purchase_5058_first_product_name}
            - name: elementToFind
              string: cartPage.productMoveToSaveForLater

      - executeFunction:
          name: functions.cartPage.moveAndVerifyProductMoveToSFL
          params:
            - name: productName
              string: ${purchase_5058_first_product_name}

      #---------------------------------------------------------------------------------------------
      # STEP 6: DELETE ITEM IN SAVE FOR LATER---------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 6: DELETE ITEM IN SAVE FOR LATER"
          color: ORANGE

      - executeFunction:
          name: mx.functions.cart.deleteProductSaveForLaterByProductName
          params:
            - name: productName
              string: ${purchase_5058_first_product_name}

      #---------------------------------------------------------------------------------------------
      # STEP 7: CONTINUE TO CHECKOUT ---------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 7: CONTINUE TO CHECKOUT"
          color: ORANGE

      - executeFunction:
          name: functions.cartPage.tapContinueToCheckoutBtn

      #---------------------------------------------------------------------------------------------
      # STEP 8: LOGIN AS EXISTING USER ---------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 8: LOGIN AS EXISTING USER"
          color: ORANGE

      - executeFunction:
          name: functions.loginPage.userAuthentication
          params:
            - name: userEmail
              string: mx.data.purchase-003.userEmail
            - name: userPassword
              string: mx.data.purchase-user-data.userPassword

      #---------------------------------------------------------------------------------------------
      # STEP 9: ADD NEW ADDRESS --------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 9: ADD NEW ADDRESS"
          color: ORANGE

      - executeFunction:
          name: functions.cartPage.tapOnAddressLink

      - executeFunction:
          name: functions.cartPage.tapDeliveryOption

      - executeFunction:
          name: functions.addAddressPage.addAddress
          params:
            - name: firstName
              string: mx.data.purchase-003.firstName
            - name: lastName
              string: mx.data.purchase-003.lastName
            - name: streetAddress
              string: mx.data.purchase-003.streetAddress
            - name: exteriorNumber
              string: mx.data.purchase-003.exteriorNumber
            - name: interiorNumber
              string: mx.data.purchase-003.interiorNumber
            - name: zipCode
              string: mx.data.purchase-003.zipCode
            - name: coloniaName
              string: mx.data.purchase-003.coloniaNameAndroid
            - name: crossingStreets
              string: mx.data.purchase-003.crossingStreets
            - name: references
              string: mx.data.purchase-003.references
            - name: phoneNumber
              string: mx.data.purchase-user-data.userPhoneNumber

      #---------------------------------------------------------------------------------------------
      # STEP 10: CONTINUE TO CHECKOUT -----------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 10: CONTINUE TO CHECKOUT"
          color: ORANGE

      - executeFunction:
          name: functions.cartPage.tapContinueToCheckoutBtn

      #---------------------------------------------------------------------------------------------
      # STEP 11: VALIDATE PRODUCT DETAILS -----------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 11: VALIDATE PRODUCT DETAILS"
          color: ORANGE

      - click:
          identifier: mx.mappings.review-order.viewButton

      - executeFunction:
          name: functions.checkoutPage.validateItemDetails

      - click:
          identifier: mx.mappings.review-order.products-details-popup.doneButton

      #---------------------------------------------------------------------------------------------
      # STEP 12: OPEN WALLET------------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 12: OPEN WALLET"
          color: ORANGE

      - executeFunction:
          name: mx.functions.utils.searchItemInPage
          params:
            - name: elementToFind
              string: checkoutPage.updatePaymentMethodBtn

      - executeFunction:
          name: functions.checkoutPage.tapAddPaymentMethodBtn

      #---------------------------------------------------------------------------------------------
      # STEP 13: ADD CARD------------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 13: ADD CARD"
          color: ORANGE

      - executeFunction:
          name: functions.checkoutPage.walletPopup.tapAddCardBtn

      - executeFunction:
          name: mx.flows.od.wallet.addNewDebitOrCreditCardShort
          params:
            - name: cardNumber
              string: mx.data.purchase-003.cardNumber
            - name: expirationDate
              string: mx.data.purchase-003.cardExpirationDate
            - name: cardCVV
              string: mx.data.purchase-003.cardCVV
            - name: cardHolderName
              string: mx.data.purchase-003.cardHolderName
            - name: last4Digits
              string: mx.data.purchase-003.cardLastFourDigits

      - executeFunction:
          name: mx.functions.pdp.tapClose

      #---------------------------------------------------------------------------------------------
      # STEP 14: SELECT MSI------------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 14: SELECT MSI"
          color: ORANGE

      - executeFunction:
          name: mx.functions.review-order.payment-section.selectMSIPromotionEA
          params:
            - name: msiPromotionOption
              string: mx.data.purchase-003.reserve-slot-payment.msiPromotionOption

      #---------------------------------------------------------------------------------------------
      # STEP 15: SUBMIT ORDER------------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 15: SUBMIT ORDER"
          color: ORANGE

      - if:
          condition: ${GLASS_ENV} == 'teflon'
          then:
            - log:
                message: "STEP 14: PLACE ORDER"
                color: ORANGE

            - executeFunction:
                name: functions.checkoutPage.tapPlaceOrderButton

            - executeFunction:
                name: functions.thankYouPage.verifyThankYouPageDisplayed



      # End main -----------------------------------------------------------------------------------
      - storeIn:
          key: MMP_5058_SUCCESSFUL_EXECUTION
          value: true

  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
  #   A F T E R   S C E N A R I O
  # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: After
    after: true
    flow:
      - log: R2_SUBFLOW_AFTER ### [[ 游릭 Flow Identifier: AFTER 游릭 ]] ###

      - if:
          condition: ${MMP_5058_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "Main Failed."
                color: RED
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: GREEN_BOLD
      - log: "AFTER SCENARIO ENDED"
