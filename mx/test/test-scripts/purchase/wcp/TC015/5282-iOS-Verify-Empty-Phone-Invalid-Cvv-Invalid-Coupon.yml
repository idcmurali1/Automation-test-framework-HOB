#======================================================================================================================
#  AUTHOR: Teresa Partida (vn55epy)
#  CREATED: Jan/13/2025
#  REVISION: ---
#
#  Copyright 춸 2025 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: purchase-walmart-ea-sanity-production-ios-015, purchase-bodega-ea-sanity-production-ios-015, purchase-walmart-ea-sanity-production-ios, purchase-bodega-ea-sanity-production-ios
  testCaseId: MMP-5313

#######################################################################################################################
#
#  TEST CASE TITLE: 
#    Empty phone field, invalid cvv, invalid coupon
#
#  CONFLUENCE TRACKING DASHBOARD:
#    TO-DO 
#
#  JIRA AUTOMATION TC:
#    https://jira.walmart.com/browse/MMP-5313
#
#  JIRA MANUAL TC:
#    https://jira.walmart.com/browse/MMP-5282
#
#######################################################################################################################

scenarios:

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
#   B E F O R E   S C E N A R I O
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: Before
    before: true
    flow:

      - log: R2_SUBFLOW_BEFORE ### [[ 游릭 Flow Identifier: BEFORE 游릭 ]] ###

      - storeIn:
         key: MMP_5282_SUCCESSFUL_EXECUTION
         value: false

      ## TODO Remove when issue is solved
      - storeIn:
          key: WALLET_ISSUE_WORKAROUND
          value: true

      - executeFunction:
          name: functions.utils.setMarketInfo

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
#   M A I N   S C E N A R I O
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: Main
    platform: ios
    flow:

      - log: R2_SUBFLOW_MAIN ### [[ 游릭 Flow Identifier: MAIN 游릭 ]] ###
      
      #---------------------------------------------------------------------------------------------
      # STEP 1: LOGIN ------------------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 1: LOGIN"
          color: ORANGE

      - executeFunction:
          name: functions.onboardingToHomePage.usingPostalCode
          params:
            - name: PostalCode
              string: data.onboarding.userPostalCode
            - name: ShoppingExperience
              string: data.onboarding.onlineExclusiveStore

      - executeFunction:
          name: functions.global.tapAccountBtn
      - executeFunction:
          name: functions.accountPage.tapSignInBtn

      - executeFunction:
          name: functions.loginPage.userAuthentication
          params:
            - name: userEmail
              string: mx.data.purchase-015.userEmail
            - name: userPassword
              string: mx.data.purchase-user-data.userPassword

      - executeFunction:
          name: functions.global.tapShopBtn
      - executeFunction:
          name: mx.flows.od.after-scenario-exclusive.openCartAndDeleteAllProducts
      - executeFunction:
          name: functions.global.tapBackBtn

      #---------------------------------------------------------------------------------------------
      # STEPS 2 & 3: SEARCH ITEM (2) AND OPEN PDP (3) ----------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEPS 2 & 3: SEARCH ITEM (2) AND OPEN PDP (3)"
          color: ORANGE

      - executeFunction:
          name: functions.searchPage.getTheFirstAvailableItemAndNavigateToPDP
          params:
            - name: productArray
              string: mx.data.purchase-products.appliances.array

      #---------------------------------------------------------------------------------------------
      # STEP 4: ADD PRODUCT TO CART  ---------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 4: ADD PRODUCT TO CART"
          color: ORANGE

      - executeFunction:
          name: mx.functions.pdp.addToCart # ---> ${returnedProductName}
      - sleep:
          duration: 3000
      - executeFunction:
          name: mx.functions.pdp.getPrice # ---> ${returnedProductPrice}
      - executeFunction:
          name: mx.functions.pdp.getType # ---> ${returnedProductType}
      - executeFunction:
          name: mx.functions.pdp.getProductQuantityAsPieces # ---> ${returnedProductQuantity}

      - storeIn:
          key: purchase_5282_product_price
          value: ${returnedProductPrice}
      - storeIn:
          key: purchase_5282_product_type
          value: ${returnedProductType}
      - storeIn:
          key: purchase_5282_product_subtotal
          value: ${returnedProductPrice}
      - storeIn:
          key: purchase_5282_product_name
          value: ${returnedProductName}
      - storeIn:
          key: purchase_5282_product_quantity
          value: ${returnedProductQuantity}

      - executeFunction:
          name: functions.productDetailsPage.tapClose
  

      #---------------------------------------------------------------------------------------------
      # STEP 5: GO TO CART -------------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------

      - log:
          message: "STEP 5: GO TO CART"
          color: ORANGE

      - executeFunction:
          name: functions.global.tapCartIcon 
      - executeFunction:
          name: mx.functions.cart.assertCartNotEmpty
      - executeFunction:
          name: functions.cartPage.validateItemDetails
      - executeFunction:
          name: functions.cartPage.validateMoneybox

      - log: "Product - ${purchase_5282_product_name} - assertions"
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions
          params:
            - name: productName
              string: ${purchase_5282_product_name}
            - name: productType
              string: ${purchase_5282_product_type}
            - name: expectedQuantity
              string: ${purchase_5282_product_quantity}
            - name: expectedWeightQuantity
              string: "null"
            - name: expectedUnitPrice
              string: ${purchase_5282_product_price}
            - name: expectedOriginalPrice
              string: "null"
            - name: expectedSubtotal
              string: ${purchase_5282_product_subtotal}

      - executeFunction:
          name: functions.cartPage.assertCartQuantity
          params:
            - name: expectedQuantity
              string: ${purchase_5282_product_quantity}

      - executeFunction:
          name: functions.cartPage.assertCartTotals
          params:
            - name: expectedSubTotal
              string: ${purchase_5282_product_subtotal} # <-- ${totalPrice} / GLOBAL VAR
            - name: assertEstimatedTotal
              string: 'true'

      #---------------------------------------------------------------------------------------------
      # STEP 6 & 7: SELECT DELIVERY ADDRESS (6) & EDIT ADDRESS (7) ---------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 6 & 7: SELECT DELIVERY ADDRESS (6) & EDIT ADDRESS (7)"
          color: ORANGE

      - executeFunction:
          name: functions.cartPage.tapDeliveryOption
      - executeFunction:
          name: functions.cartPage.tapOnAddressLink
      - executeFunction:
          name: mx.functions.address-selector-popup.tapEditAddress

      - executeNode:
          file: mx/test/helpers/utils/getRandomInt.js
          args:
            - value: 1
            - value: 99
          getResponse:
            storeIn: purchase_5282_address_exterior_number

      - storeIn:
          key: purchase_5282_address_street
          value: mx.data.purchase-015.userStreet

      - storeIn:
          key: purchase_5282_address_street
          value: "${purchase_5282_address_exterior_number} ${purchase_5282_address_street}"

      - executeFunction:
          name: mx.flows.od.addresses.editHomeDeliveryAddressFromPopup
          params:
            - name: userStreet
              string: ${purchase_5282_address_street}
            - name: userExteriorNumber
              string: ${purchase_5282_address_exterior_number}

      - executeFunction:
          name: mx.functions.address-selector-popup.tapSave

      - sleep:
          duration: 2000

      - executeFunction:
          name: mx.functions.cart.assertHomeSlotAddressByIndividualValues
          params:
            - name: streetName
              string: ${purchase_5282_address_street}
            - name: exteriorNumber
              string: ${purchase_5282_address_exterior_number}

      #---------------------------------------------------------------------------------------------
      # STEP 8: CONTINUE TO CHECKOUT ---------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 8: CONTINUE TO CHECKOUT"
          color: ORANGE

      - executeFunction:
          name: functions.cartPage.tapContinueToCheckoutBtn
      - executeFunction:
          name: functions.checkoutPage.assertPageLoaded

      #---------------------------------------------------------------------------------------------
      # STEP 9: VALIDATE PRODUCT DETAILS -----------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 9: VALIDATE PRODUCT DETAILS"
          color: ORANGE

      - sleep:
          duration: 5000

      - executeFunction:
          name: mx.flows.od.review-order.validateProductDetails
          params:
            - name: productName
              string: ${purchase_5282_product_name}
            - name: expectedProductPrice
              string: ${purchase_5282_product_price}
            - name: expectedProductQuantity
              string: ${purchase_5282_product_quantity}

      - executeFunction:
          name: functions.checkoutPage.validateItemDetails

      #---------------------------------------------------------------------------------------------
      # STEP 10: ADD AN INVALID COUPON -------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 10: ADD AN INVALID COUPON"
          color: ORANGE

      - executeFunction:
          name: mx.functions.review-order.applyCoupon
          params:
            - name: promoCode
              string: 'mx.data.purchase-015.invalidCoupon'

      #---------------------------------------------------------------------------------------------
      # STEP 11: VERIFY ERROR MESSAGE --------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 11: VERIFY ERROR MESSAGE"
          color: ORANGE

      - executeFunction:
          name: mx.functions.add-address-form.assertCouponErrorsDisplayed

      #---------------------------------------------------------------------------------------------
      # STEPS 12 & 13: OPEN WALLET (12) AND SELECT PAY AT STORE (13) -------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEPS 12 & 13: OPEN WALLET (12) AND SELECT PAY AT STORE (13)"
          color: ORANGE

      - executeFunction:
          name: functions.checkoutPage.selectPaymentMethod
          params:
            - name: payment
              string: data.paymentMethod.payAtStore

      - executeFunction:
          name: functions.checkoutPage.validatePayAtStore

      #---------------------------------------------------------------------------------------------
      # STEP 14: CLEAR PHONE NUMBER FIELD ----------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 14: CLEAR PHONE NUMBER FIELD"
          color: ORANGE

      - executeFunction:
          name: mx.functions.review-order.enterCellphoneNumber
          params:
            - name: userPhoneNumber
              string: mx.data.purchase-user-data.invalidPhoneNumber

      - executeFunction:
          name: mx.functions.review-order.assertIncompleteCellphoneNumberErrorMessageDisplayed

      - executeFunction:
          name: mx.functions.review-order.enterCellphoneNumber
          params:
            - name: userPhoneNumber
              string: ""

      #---------------------------------------------------------------------------------------------
      # STEP 15: PLACE ORDER -----------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 15: PLACE ORDER"
          color: ORANGE

      - executeFunction:
          name: functions.checkoutPage.tapPlaceOrderButton

      #---------------------------------------------------------------------------------------------
      # STEP 16: VALIDATE ERROR IS DISPLAYED -------------------------------------------------------
      #---------------------------------------------------------------------------------------------

      - log:
          message: "STEP 16: VALIDATE ERROR IS DISPLAYED"
          color: ORANGE

      - executeFunction:
          name: mx.functions.review-order.assertReviewFieldErrorMessageIsDisplayed

      #---------------------------------------------------------------------------------------------
      # STEP 17: ADD PHONE NUMBER ------------------------------------------------------------------
      #---------------------------------------------------------------------------------------------
      - log:
          message: "STEP 17: ADD PHONE NUMBER"
          color: ORANGE

      # In iOS is necessary to enter text twice due to unexpected app behaviour
      - enterText:
          identifier: mx.mappings.review-order.phoneNumberInputField
          string: mx.data.purchase-user-data.invalidPhoneNumber
          clickFirst: true
          clearField: true

      - executeFunction:
          name: mx.functions.review-order.enterCellphoneNumber
          params:
            - name: userPhoneNumber
              string: mx.data.purchase-user-data.userPhoneNumber

      - executeFunction:
          name: mx.functions.review-order.assertIncompleteCellphoneNumberErrorMessageNotDisplayed

      ## TODO Remove when issue is solved
      - if:
          condition: WALLET_ISSUE_WORKAROUND == true
          then:
            - log:
                message: "SKIPPING STEPS 18-22 DUE TO WALLET ISSUE"
                color: ORANGE

          else:
            #---------------------------------------------------------------------------------------------
            # STEPS 18 & 19: OPEN WALLET (18) AND SELECT VALE CARD (19) ----------------------------------
            #---------------------------------------------------------------------------------------------
            - log:
                message: "STEPS 18 & 19: OPEN WALLET (18) AND SELECT VALE CARD (19)"
                color: ORANGE

            - scroll:
                direction: up
                untilIdentifier: mx.mappings.review-order.payment-section.editPaymentMethod

            - click:
                identifier: mx.mappings.review-order.payment-section.editPaymentMethod

            ## TODO Change to select vale card
            - executeFunction:
                name: mx.functions.wallet.tapAddPaymentMethod
            - executeFunction:
                name: mx.flows.od.wallet.addDebitOrCreditCardWithInvalidData
                params:
                  - name: cardNumber
                    string: mx.data.purchase-015.cardNumber
                  - name: expirationDate
                    string: mx.data.purchase-015.cardExpirationDate
                  - name: cardCVV
                    string: mx.data.purchase-015.invalidCardCVV

            #---------------------------------------------------------------------------------------------
            # STEP 20: ADD INVALID CVV -------------------------------------------------------------------
            #---------------------------------------------------------------------------------------------
            - log:
                message: "STEP 20: ADD INVALID CVV"
                color: ORANGE

            #---------------------------------------------------------------------------------------------
            # STEP 21: PLACE ORDER -----------------------------------------------------------------------
            #---------------------------------------------------------------------------------------------
            - log:
                message: "STEP 21: PLACE ORDER"
                color: ORANGE

            #- executeFunction:
               # name: functions.checkoutPage.tapPlaceOrderButton

            #---------------------------------------------------------------------------------------------
            # STEP 22: VALIDATE ERROR IS DISPLAYED -------------------------------------------------------
            #---------------------------------------------------------------------------------------------

            - log:
                message: "STEP 22: VALIDATE ERROR IS DISPLAYED"
                color: ORANGE

            - executeFunction:
                name: mx.functions.review-order.assertReviewFieldErrorMessageIsDisplayed
 
    #---------------------------------------------------------------------------------------------
    # END ----------------------------------------------------------------------------------------
    #---------------------------------------------------------------------------------------------
      - storeIn:
          key: MMP_5282_SUCCESSFUL_EXECUTION
          value: true

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
#   A F T E R   S C E N A R I O
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: After
    after: true
    flow:
      - log: R2_SUBFLOW_AFTER ### [[ 游릭 Flow Identifier: AFTER 游릭 ]] ###

      - if:
          condition: ${MMP_5282_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "Main Failed."
                color: RED
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: GREEN_BOLD
      - log: "AFTER SCENARIO ENDED"
  