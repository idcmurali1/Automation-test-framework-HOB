#======================================================================================================================
#    AUTHOR: Francisco Javier Ramírez Hernández (vn53vq4)
#   CREATED: Apr/23/2024
#  REVISION: ---
#
#  Copyright © 2024 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: qaa-dev-phase-ea-production-ios-015 #qaa-ea-sanity-production-ios-015, qaa-ea-sanity-production-ios
  #testCaseId: MXMOB-1648 

scenarios:
#######################################################################################################################
#
#   CONFLUENCE TRACKING DASHBOARD:
#     https://confluence.walmart.com/display/MXGECMEX/MXMOB-AT-QAA%3A+Test+Suite%3A+GlassMX+-+EA+-+Sanity+-+Production+-+iOS
#
#   JIRA AUTOMATION TC:
#     https://jira.walmart.com/browse/MXMOB-1648
#
#   JIRA MANUAL TC:
#     https://jira.walmart.com/browse/MXMOB-1591
#
#   FLAGS USED: N/A
#
#######################################################################################################################

  - name: Before
    before: true
    flow:
      - executeFunction:
          name: mx.squad-reporting.setTestCaseName
          params:
            - name: testCaseName
              string: GMX_EA_Sanity_PROD_iOS_015
      - log:
          message: "WORKAROUND: RELAUNCHING APP TO FIX ISSUE REGARDING INTERNAL APP FLAGS"
          color: YELLOW
      - storeIn:
          key: EA_015_SUCCESSFUL_EXECUTION
          value: false
      - log: "BEFORE SCENARIO END"

  #####################################################################################################################

  - name: Main
    flow:
      - log: "TEST START: QAA - EA - PRODUCTION SANITY - EA-015"

      # STEP 1: NAVIGATE THROUGH ONBOARDING AND SELECT EA BANNER - EA HOME IS DISPLAYED.
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 1: NAVIGATE THROUGH ONBOARDING AND SELECT EA BANNER."
            - name: squadNames
              string: CORE | QAA

      - executeFunction:
          name: mx.flows.global.onboarding.navigateToHomeAsGuestUser
          params:
            - name: zipCode
              string: mx.data.qaa.sanity.ea-015.zipCode
            - name: banner
              string: 'EA'

  # --------------------------------------------------------------------------------------------------------------------
      # STEP 2: NAVIGATE TO ACCOUNT AND LOGIN
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 2: NAVIGATE TO ACCOUNT PAGE AND CREATE A NEW ACCOUNT."
            - name: squadNames
              string: CUSTOMER | QAA
      
      - executeFunction:
          name: mx.flows.od.login.navigateToAccountAndLogin
          params:
            - name: userEmail
              string: mx.data.qaa.sanity.ea-015.userEmail
            - name: userPassword
              string: mx.data.qaa.sanity.ea-015.userPassword
            - name: userName
              string: mx.data.qaa.sanity.ea-015.userNameiOS
  
  #--------------------------------------------------------------------------------------------------------------------
      ## STEP 3: Search for a restricted Product
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 3: SEARCH FOR A RESTRICTED PRODUCT"
            - name: squadNames
              string: CUSTOMER | QAA
      
      - executeFunction:
          name: mx.functions.bottom-menu.tapHome
      
      - executeFunction:
          name: mx.flows.ea.search.performSuccessfulSearch
          params:
            - name: searchTerm
              string: mx.data.qaa.sanity.ea-015.searchTerm1
              
  #--------------------------------------------------------------------------------------------------------------------
  
      ## STEP 4: OPEN THE PRODUCT DESCRIPTION PAGE (PDP)
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 4: OPEN THE PRODUCT DESCRIPTION PAGE (PDP)"
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.slp.openProductDetailsByName
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-015.productName1

  #--------------------------------------------------------------------------------------------------------------------
      ## STEP 5: ADD PRODUCT TO CART
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 5: ADD PRODUCT TO CART"
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - sleep:
          duration: 4000
      
      - executeFunction:
          name: mx.functions.pdp.getPrice # <- RETURNED ${returnedProductPrice}
      
      - storeIn:
          key: product1Price
          value: ${returnedProductPrice}
      
      - sleep:
          duration: 3000
      
      - executeFunction:
          name: mx.functions.pdp.addToCart
      
      - executeFunction:
          name: mx.functions.pdp.assertAddedToCart
      
      - executeFunction:
          name: mx.functions.pdp.tapClose
    
  #--------------------------------------------------------------------------------------------------------------------

      - storeIn:
          key: EA_015_IS_CART_EMPTY
          value: false
      
  #--------------------------------------------------------------------------------------------------------------------
      ## STEP 6: SEARCH FOR A NOT-RESTRICTED PRODUCT AND ADD IT TO CART
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 6: SEARCH FOR A NOT-RESTRICTED PRODUCT AND ADD IT TO CART"
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.bottom-menu.tapHome
      
      - executeFunction:
          name: mx.flows.ea.search.performSuccessfulSearch
          params:
            - name: searchTerm
              string: mx.data.qaa.sanity.ea-015.searchTerm2
      
      - executeFunction:
          name: mx.functions.slp.openProductDetailsByName
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-015.productName2
      
      - sleep:
          duration: 4000
      
      - executeFunction:
          name: mx.functions.pdp.getPrice # <- RETURNED ${returnedProductPrice}
      
      - storeIn:
          key: product2Price
          value: ${returnedProductPrice}
      
      - executeFunction:
          name: mx.functions.pdp.addToCart
      
      - executeFunction:
          name: mx.functions.pdp.assertAddedToCart

      - executeFunction:
          name: mx.functions.pdp.tapClose

  #--------------------------------------------------------------------------------------------------------------------
      ## STEP 7: NAVIGATE TO CART
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 7: NAVIGATE TO CART"
            - name: squadNames
              string: PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon
      
      - executeFunction:
          name: mx.functions.cart.assertCartNotEmpty
          
      - executeFunction:
          name: mx.functions.cart.tapExpandProductsDetailsView
      
      - executeFunction:
          name: mx.functions.ea.cart.assertProductListed
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-015.productName1
      
      - executeFunction:
          name: mx.functions.ea.cart.assertProductUnitPrice
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-015.productName1
            - name: expectedUnitPrice
              string: ${product1Price}
  
      - executeFunction:
          name: mx.functions.ea.cart.assertProductListed
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-015.productName2
            - name: direction
              string: down
      
      - executeFunction:
          name: mx.functions.ea.cart.assertProductUnitPrice
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-015.productName2
            - name: expectedUnitPrice
              string: ${product2Price}

  #--------------------------------------------------------------------------------------------------------------------
      ## STEP 8: CLICK TO CONTINUE
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 8: NAVIGATE TO CART"
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.ea.cart.tapContinue

      - executeFunction:
          name: mx.functions.ea.review-order.assertPageDisplayed
  
  # --------------------------------------------------------------------------------------------------------------------
      # STEP 9: CLICK ON ADD PAYMENT METHOD AND ASSERT RESTRICTION MESSAGE
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "9: CLICK ON ADD PAYMENT METHOD AND ASSERT RESTRICTION MESSAGE"
            - name: squadNames
              string: PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.ea.review-order.scrollDownToSection
          params:
            - name: sectionOption
              string: 'Payment'
      
      - executeFunction:
          name: mx.functions.ea.review-order.tapAddOrChangePaymentMethodButton
      - executeFunction:
          name: mx.functions.ea.payment.assertPageDisplayed
      - executeFunction:
          name: mx.functions.ea.payment.selectInStorePaymentMethod
      - sleep:
          duration: 5000
      - executeFunction:
          name: mx.functions.ea.payment.assertRestrictionMessage
  
  # --------------------------------------------------------------------------------------------------------------------
      # STEP 10: CLOSE PAYMENT PAGE AND VALIDATE RESTRICTION MESSAGE IS DISPLAYED
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "10: CLOSE PAYMENT PAGE AND VALIDATE RESTRICTION MESSAGE IS DISPLAYED"
            - name: squadNames
              string: PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.ea.payment.tapCloseButton
      
      - executeFunction:
          name: mx.functions.ea.review-order.tapBack
      
      - executeFunction:
          name: mx.functions.ea.review-order.almost-done-popup.exitPayment
    
    #--------------------------------------------------------------------------------------------------------------------
      ## STEP 11: DELETE RESTRICTED PRODUCT
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "11: DELETE RESTRICTED PRODUCT"
            - name: squadNames
              string: PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.ea.cart.assertPageDisplayed
 
      - scroll:
          direction: up
          scrollLimit: 1
          wait: 1000
      
      - executeFunction:
          name: mx.functions.cart.tapExpandProductsDetailsView

      - executeFunction:
          name: mx.functions.ea.cart.deleteProductByName
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-015.productName1

    #--------------------------------------------------------------------------------------------------------------------
      ## STEP 12-13: VERIFY PRODUCT DETAILS AND TOTALS
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "12-13: VERIFY PRODUCT DETAILS AND TOTALS IN CART SCREEN"
            - name: squadNames
              string: PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.ea.cart.assertProductListed
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-015.productName2
            - name: direction
              string: down
     
      - executeFunction:
          name: mx.functions.ea.cart.assertProductUnitPrice
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-015.productName2
            - name: expectedUnitPrice
              string: ${product2Price}
      
      - executeFunction:
          name: mx.functions.ea.cart.assertProductsCountInSubtotalLabel
          params:
            - name: expectedProductsCount
              string: mx.data.qaa.sanity.ea-015.productFinalCount
      
      - executeFunction:
          name: mx.functions.ea.cart.assertSubtotal
          params:
            - name: expectedSubtotal
              string: ${product2Price}
      
      - scroll:
          direction: down
          scrollLimit: 1
          wait: 1000
      
      - executeFunction:
          name: mx.functions.ea.cart.getDisplayedDeliveryFee # <-- RETURNS : ${returnedDeliveryFee}
      
      - arithmetic:
          expression: ${product2Price} + ${returnedDeliveryFee}
          storeIn: tc_estimatedTotal
          numberOfDecimalPlaces: 2
      
      - executeFunction:
          name: mx.functions.cart.assertDeliveryFee
          params:
            - name: deliveryFee
              string: ${returnedDeliveryFee}

      - executeFunction:
          name: mx.functions.ea.cart.assertEstimatedTotalFromButton
          params:
            - name: expectedEstimatedTotal
              string: ${tc_estimatedTotal}
      
    #--------------------------------------------------------------------------------------------------------------------
      ## STEP 14: CLICK ON CONTINUE
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "14: CLICK ON CONTINUE"
            - name: squadNames
              string: PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.ea.cart.tapContinue

      - executeFunction:
          name: mx.functions.ea.review-order.assertPageDisplayed

    #--------------------------------------------------------------------------------------------------------------------
      ## STEP 15: REVIEW ORDER ASSERTIONS
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "15: REVIEW ORDER ASSERTIONS"
            - name: squadNames
              string: PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.ea.review-order.assertDeliveryMethod
          params:
            - name: expectedDeliveryMethod
              string: mx.data.qaa.sanity.ea-015.deliveryMethod
      
      - executeFunction:
          name: mx.functions.ea.review-order.getSingleDeliveryDate # <- RETURNS: ${returnedDeliveryDate}

      - storeIn:
          key: tc_reviewOrderDeliverySingleDate
          value: ${returnedDeliveryDate}
      
      - executeFunction:
          name: mx.functions.ea.review-order.assertHomeAddressName
          params:
            - name: expectedHomeAddressName
              string: mx.data.qaa.sanity.ea-015.addressNameiOS
      
      - executeFunction:
          name: mx.functions.ea.review-order.assertHomeAddressByFullString
          params:
            - name: addressFullString
              string: mx.data.qaa.sanity.ea-015.fullStringAddressiOS
      
      - executeFunction:
          name: mx.functions.ea.review-order.assertProductsCountInDeliveryDetailsSection
          params:
            - name: expectedProductsCount
              string: mx.data.qaa.sanity.ea-015.productFinalCount
      
      - executeFunction:
          name: mx.functions.ea.review-order.openProductsDetailsPopup
      
      - executeFunction:
          name: mx.functions.ea.review-order.products-details-popup.assertProductListed
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-015.productName2
      
      - executeFunction:
          name: mx.functions.ea.review-order.products-details-popup.tapClose
    
    #--------------------------------------------------------------------------------------------------------------------
      ## STEP 16: SELECT IN-STORE PAYMENT METHOD 
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "16: SELECT IN-STORE PAYMENT METHOD "
            - name: squadNames
              string: PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.ea.review-order.scrollDownToSection
          params:
            - name: sectionOption
              string: 'Payment'
      
      - executeFunction:
          name: mx.flows.ea.review-order.selectInStorePaymentMethod
    
    #--------------------------------------------------------------------------------------------------------------------
      ## STEP 17: FINAL REVIEW ORDER ASSERTIONS
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "17: FINAL REVIEW ORDER ASSERTIONS"
            - name: squadNames
              string: PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.ea.review-order.scrollDownToSection
          params:
            - name: sectionOption
              string: 'Totals'
      
      - executeFunction:
          name: mx.functions.ea.review-order.assertProductsCountInSubtotalLabel
          params:
            - name: expectedProductsCount
              string: mx.data.qaa.sanity.ea-015.productFinalCount

      - executeFunction:
          name: mx.functions.ea.review-order.assertSubtotal
          params:
            - name: expectedSubtotal
              string: ${product2Price}
            
      - executeFunction:
          name: mx.functions.ea.review-order.assertDeliveryFee
          params:
            - name: expectedDeliveryFee
              string: ${returnedDeliveryFee}
    
      - executeFunction:
          name: mx.functions.ea.review-order.assertEstimatedTotalFromButton
          params:
            - name: expectedEstimatedTotal
              string: ${tc_estimatedTotal}
      
      - executeFunction:
          name: mx.functions.ea.review-order.assertEstimatedTotalFromDetailsSection
          params:
            - name: expectedEstimatedTotal
              string: ${tc_estimatedTotal}

    #--------------------------------------------------------------------------------------------------------------------
      ## STEP 18: GET BACK TO CART AND DELETE ALL PRODUCTS
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "18: GET BACK TO CART AND DELETE ALL PRODUCTS"
            - name: squadNames
              string: PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.ea.review-order.tapBack

      - executeFunction:
          name: mx.functions.ea.review-order.almost-done-popup.exitPayment
      
      - executeFunction:
          name: mx.functions.ea.cart.emptyCart
      
      - executeFunction:
          name: mx.functions.ea.cart.assertCartIsEmpty
  #--------------------------------------------------------------------------------------------------------------------

      - storeIn:
          key: EA_015_SUCCESSFUL_EXECUTION
          value: true
      
      - storeIn:
          key: EA_015_IS_CART_EMPTY
          value: true

      - log: "TEST END: QAA - EA - PRODUCTION SANITY - EA-015"

  #####################################################################################################################

  - name: After
    after: true
    flow:
      - executeFunction:
          name: mx.squad-reporting.logTestCaseFailure
          params:
            - name: testCaseExecutionStatus
              string: ${EA_015_SUCCESSFUL_EXECUTION}
      - if:
          condition: ${EA_015_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "Main Failed: Verifying if there's data to reset for the next execution..."
                color: CYAN
            # Empty Cart if not Empty.
            - if:
                condition: ${EA_015_IS_CART_EMPTY} == false
                then:
                  - log:
                      message: "Products remained in Cart, deleting products..."
                      color: CYAN
                  - executeFunction:
                      name: mx.flows.ea.after-scenario-exclusive.openCartAndDeleteAllProducts
                else:
                  - log:
                      message: "No Products were left in Cart, no need to empty it..."
                      color: CYAN
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: CYAN

      - log: "AFTER SCENARIO END"