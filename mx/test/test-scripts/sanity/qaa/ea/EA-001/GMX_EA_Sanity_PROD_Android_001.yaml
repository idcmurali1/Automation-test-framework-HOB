#======================================================================================================================
#  AUTHOR: Gustavo Antonio López Cambambia (vn53g21)
#  CREATED: Oct/23/2023
#  REVISION: ---
#
#  Copyright © 2023 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: qaa-ea-sanity-production-android-001, qaa-ea-sanity-production-android
  testCaseId: MXMOB-1580
  debug: true

scenarios:

#######################################################################################################################
#
#  CONFLUENCE TRACKING DASHBOARD:
#    https://confluence.walmart.com/display/MXGECMEX/MXMOB-QAA%3A+Tracking%3A+Test+Suite%3A+GlassMX+-+EA+-+Sanity+-+Production+-+Android
#
#  JIRA AUTOMATION TC:
#    https://jira.walmart.com/browse/MXMOB-1580
#
#  JIRA MANUAL TC:
#    https://jira.walmart.com/browse/MXMOB-1605
#
#  FLAGS USED: N/A
#
#######################################################################################################################

  - name: Main
    flow:
      - log: "TEST START: QAA - EA - PRODUCTION SANITY - OD-001"

      #----------------------------------------------------------------------------------------------------------------
      - log: "STEP 1: Navigate through Onboarding as guest user and switch to the EA"
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 1: Navigate through Onboarding as guest user and switch to the EA"
            - name: squadNames
              string: CORE | QAA
      
      - executeFunction:
          name: mx.flows.global.onboarding.navigateToHomeAsGuestUser
          params:
            - name: banner
              string: EA
            - name: zipCode
              string: mx.data.qaa.sanity.ea-001.zipCode

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 2: Search Product"
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.flows.ea.search.performSuccessfulSearch
          params:
            - name: searchTerm
              string: mx.data.qaa.sanity.ea-001.firstProduct

      - executeFunction:
          name: mx.flows.ea.sort-and-filter.addSoldByFilterWithOptionFromSLP
          params:
            - name: soldByOption
              string: 'ByWalmart'

      - executeFunction:
          name: mx.functions.ea.slp.getProductPrice
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.firstProduct

      - storeIn:
          key: firstProductPrice
          value: ${returnedPrice}

      - if:
         condition: ${returnedDiscountAmount} != 0.00
         then:
           - storeIn:
               key: firstDiscountAmount
               value: ${returnedDiscountAmount}
           - storeIn:
               key: firstOriginalPrice
               value: ${returnedOriginalPrice}
           - storeIn:
               key: firstProductDiscount
               value: 'true'
         else: 
           - storeIn:
                key: firstProductDiscount
                value: 'false'
           - storeIn:
               key: firstDiscountAmount
               value: '0.00'

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 3: Open the product description page (PDP)"
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.ea.slp.openProductDetailsByName
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.firstProduct

      - sleep:
          duration: 3000

      - executeFunction:
          name: mx.functions.ea.pdp.assertPageDisplayed

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 4: Add product to Cart"
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.pdp.addToCart

      - executeFunction:
          name: mx.functions.ea.pdp.assertAddedToCart

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 5: Close PDP"
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.pdp.tapClose

      - executeFunction:
          name: mx.functions.ea.slp.assertPageDisplayed

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 6: Search Product"
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.flows.ea.search.performSuccessfulSearch
          params:
            - name: searchTerm
              string: mx.data.qaa.sanity.ea-001.secondProduct

      - executeFunction:
          name: mx.flows.ea.sort-and-filter.addSoldByFilterWithOptionFromSLP
          params:
            - name: soldByOption
              string: 'ByWalmart'

      - executeFunction:
          name: mx.functions.ea.slp.getProductPrice
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.secondProduct

      - storeIn:
          key: secondProductPrice
          value: ${returnedPrice}

      - if:
         condition: ${returnedDiscountAmount} != 0.00
         then:
           - storeIn:
               key: secondDiscountAmount
               value: ${returnedDiscountAmount}
           - storeIn:
               key: secondOriginalPrice
               value: ${returnedOriginalPrice}
           - storeIn:
               key: secondProductDiscount
               value: 'true'
         else: 
           - storeIn:
                key: secondProductDiscount
                value: 'false'
           - storeIn:
               key: secondDiscountAmount
               value: '0.00'

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 7: Open the product description page (PDP)"
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.ea.slp.openProductDetailsByName
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.secondProduct

      - sleep:
          duration: 3000

      - executeFunction:
          name: mx.functions.ea.pdp.assertPageDisplayed

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 8: Add product to Cart"
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.pdp.addToCart

      - executeFunction:
          name: mx.functions.ea.pdp.assertAddedToCart

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 9: Close PDP"
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.pdp.tapClose

      - executeFunction:
          name: mx.functions.ea.slp.assertPageDisplayed

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 10: Go to Cart"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.top-menu.tapCartIcon

      - executeFunction:
          name: mx.functions.utils.closeBlackPopupIfDisplayed

      - executeFunction:
          name: mx.functions.ea.cart.assertPageDisplayed

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 11: Validate Product Details compared vs PDP"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.cart.assertProductListed
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.firstProduct
            - name: direction
              string: down

      - executeFunction:
          name: mx.functions.ea.cart.assertProductUnitPrice
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.firstProduct
            - name: expectedUnitPrice
              string: ${firstProductPrice}

      - if:
          condition: ${firstProductDiscount} == true
          then:
            - executeFunction:
                name: mx.functions.ea.cart.assertProductOriginalPrice
                params:
                  - name: productName
                    string: mx.data.qaa.sanity.ea-001.firstProduct
                  - name: expectedOriginalPrice
                    string: ${firstOriginalPrice}

      - executeFunction:
          name: mx.functions.ea.cart.assertProductListed
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.secondProduct
            - name: direction
              string: down

      - executeFunction:
          name: mx.functions.ea.cart.assertProductUnitPrice
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.secondProduct
            - name: expectedUnitPrice
              string: ${secondProductPrice}

      - if:
          condition: ${secondProductDiscount} == true
          then:
            - executeFunction:
                name: mx.functions.ea.cart.assertProductOriginalPrice
                params:
                  - name: productName
                    string: mx.data.qaa.sanity.ea-001.secondProduct
                  - name: expectedOriginalPrice
                    string: ${secondOriginalPrice}

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 12: Validate Cart Totals"
            - name: squadNames
              string: PURCHASE | QAA

      - if:
          condition: ${secondProductDiscount} == true || ${firstProductDiscount} == true
          then:
            - executeFunction:
                name: mx.functions.ea.cart.assertProductsCountInSubtotalLabelIfDiscountExist
                params:
                  - name: expectedProductsCount
                    string: mx.data.qaa.sanity.ea-001.totalProductsExpected
          else:
            - executeFunction:
                name: mx.functions.ea.cart.assertProductsCountInSubtotalLabel
                params:
                  - name: expectedProductsCount
                    string: mx.data.qaa.sanity.ea-001.totalProductsExpected

      - arithmetic:
          expression: ${firstProductPrice} + ${secondProductPrice}
          storeIn: firstAndSecondPrices
          numberOfDecimalPlaces: 2

      - storeIn:
          key: subtotalAmmount
          value: ${firstAndSecondPrices}

      - scroll:
          direction: down
          untilIdentifier: mx.mappings.ea.cart.subtotalValue
          position: center
          timeout: 500
          scrollLimit: 3

      - executeFunction:
          name: mx.functions.ea.cart.assertSubtotal
          params:
            - name: expectedSubtotal
              string: ${subtotalAmmount}

      - executeFunction:
          name: mx.functions.ea.cart.assertDeliveryFee
          params:
            - name: expectedDeliveryFee
              string: mx.data.qaa.sanity.ea-001.deliveryFee

      - arithmetic:
          expression: ${subtotalAmmount} + ${expectedDeliveryFee}
          storeIn: estimatedTotal
          numberOfDecimalPlaces: 2

      - executeFunction:
          name: mx.functions.ea.cart.assertEstimatedTotalFromDetailsSection
          params:
            - name: expectedEstimatedTotal
              string: ${estimatedTotal}

      - executeFunction:
          name: mx.functions.ea.cart.assertEstimatedTotalFromButton
          params:
            - name: expectedEstimatedTotal
              string: ${estimatedTotal}

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 13: Continue purchase"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.cart.tapContinue

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 14: Create new Account"  
            - name: squadNames
              string: CUSTOMER | QAA

      - executeFunction:
         name: mx.functions.ea.login.assertPageDisplayed

      - executeFunction:
          name: mx.flows.od.login.createAccountFromLoginPopup
          params:
            - name: userFirstName
              string: mx.data.qaa.sanity.ea-001.userFirstName
            - name: userLastName
              string: mx.data.qaa.sanity.ea-001.userLastName
            - name: userPassword
              string: mx.data.qaa.sanity.ea-001.userPassword
            - name: testCaseNum
              string: mx.data.qaa.sanity.ea-001.testCaseNum

      - sleep:
          duration: 5000

      - if:
          identifier:
            present:
              - identifier: mx.mappings.ea.add-and-edit-address-form.closeButton
          then:
              - executeFunction:
                  name: mx.functions.ea.add-and-edit-address-form.tapClose

      - storeIn:
          key: EA_001_IS_CART_EMPTY
          value: "false"

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 15: Validate Products are still displayed and the Estimated Total didn't change"
            - name: squadNames
              string: PURCHASE | QAA

      - scroll:
          direction: up
          scrollLimit: 3
          wait: 500

      - executeFunction:
          name: mx.functions.ea.cart.assertProductListed
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.firstProduct
            - name: direction
              string: down

      - executeFunction:
          name: mx.functions.ea.cart.assertProductUnitPrice
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.firstProduct
            - name: expectedUnitPrice
              string: ${firstProductPrice}

      - if:
          condition: ${firstProductDiscount} == true
          then:
            - executeFunction:
                name: mx.functions.ea.cart.assertProductOriginalPrice
                params:
                  - name: productName
                    string: mx.data.qaa.sanity.ea-001.firstProduct
                  - name: expectedOriginalPrice
                    string: ${firstOriginalPrice}

      - executeFunction:
          name: mx.functions.ea.cart.assertProductListed
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.secondProduct
            - name: direction
              string: down

      - executeFunction:
          name: mx.functions.ea.cart.assertProductUnitPrice
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.secondProduct
            - name: expectedUnitPrice
              string: ${secondProductPrice}

      - if:
          condition: ${secondProductDiscount} == true
          then:
            - executeFunction:
                name: mx.functions.ea.cart.assertProductOriginalPrice
                params:
                  - name: productName
                    string: mx.data.qaa.sanity.ea-001.secondProduct
                  - name: expectedOriginalPrice
                    string: ${secondOriginalPrice}

      - if:
          condition: ${secondProductDiscount} == true || ${firstProductDiscount} == true
          then:
            - executeFunction:
                name: mx.functions.ea.cart.assertProductsCountInSubtotalLabelIfDiscountExist
                params:
                  - name: expectedProductsCount
                    string: mx.data.qaa.sanity.ea-001.totalProductsExpected
          else:
            - executeFunction:
                name: mx.functions.ea.cart.assertProductsCountInSubtotalLabel
                params:
                  - name: expectedProductsCount
                    string: mx.data.qaa.sanity.ea-001.totalProductsExpected

      - scroll:
          direction: down
          untilIdentifier: mx.mappings.ea.cart.subtotalValue
          position: center
          timeout: 500
          scrollLimit: 3

      - executeFunction:
          name: mx.functions.ea.cart.assertSubtotal
          params:
            - name: expectedSubtotal
              string: ${subtotalAmmount}

      - executeFunction:
          name: mx.functions.ea.cart.assertDeliveryFee
          params:
            - name: expectedDeliveryFee
              string: mx.data.qaa.sanity.ea-001.deliveryFee

      - scroll:
          direction: down
          untilIdentifier: mx.mappings.ea.cart.estimatedTotalInDetailsSection
          position: center
          timeout: 500
          scrollLimit: 3

      - executeFunction:
          name: mx.functions.ea.cart.assertEstimatedTotalFromDetailsSection
          params:
            - name: expectedEstimatedTotal
              string: ${estimatedTotal}

      - executeFunction:
          name: mx.functions.ea.cart.assertEstimatedTotalFromButton
          params:
            - name: expectedEstimatedTotal
              string: ${estimatedTotal}   

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 16: Select Pickup ('Prefiero Pickup' button)"
            - name: squadNames
              string: PURCHASE | QAA

      - scroll:
          direction: up
          scrollLimit: 3
          wait: 500

      - executeFunction:
          name: mx.functions.ea.cart.tapSwitchToPickupDeliveryButton

      - sleep:
          duration: 3000

      - executeFunction:
          name: mx.functions.ea.store-selector-popup.assertPopupDisplayed

      - executeFunction:
          name: mx.functions.ea.store-selector-popup.enterZipCode
          params:
            - name: zipCode
              string: mx.data.qaa.sanity.ea-001.secondZipCode

      - sleep:
          duration: 3000

      - executeFunction:
          name: mx.functions.ea.store-selector-popup.selectStoreByStoreName
          params:
            - name: storeName
              string: mx.data.qaa.sanity.ea-001.secondStoreName

      - executeFunction:
          name: mx.functions.store-selector-popup.getSelectedStoreAddress

      - executeFunction:
          name: mx.functions.ea.store-selector-popup.tapSave

      - sleep:
          duration: 3000

      - executeFunction:
          name: mx.functions.ea.cart.getSingleDeliveryDate    #${returnedDeliveryDate} --> Returned value

      - storeIn:
          key: cartReturnedDeliveryDate
          value: ${returnedDeliveryDate} 

      - executeFunction:
          name: mx.functions.ea.cart.assertPageDisplayed

      - executeFunction:
          name: mx.functions.ea.cart.assertPickupDeliveryIsSelected

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 17 - Validate Delivery Fee is not charged"
            - name: squadNames
              string: PURCHASE | QAA

      - scroll:
          direction: down
          scrollLimit: 3
          wait: 500

      - executeFunction:
          name: mx.functions.ea.cart.assertDeliveryFeeNotCharged

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 18 - Validate Estimated Total is updated correctly"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.cart.assertEstimatedTotalFromDetailsSection
          params:
            - name: expectedEstimatedTotal
              string: ${subtotalAmmount}

      - executeFunction:
          name: mx.functions.ea.cart.assertEstimatedTotalFromButton
          params:
            - name: expectedEstimatedTotal
              string: ${subtotalAmmount}

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 19 - Continue to Review Order"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.cart.tapContinue

      - sleep:
          duration: 3000

      - executeFunction:
          name: mx.functions.ea.review-order.assertPageDisplayed

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 19 - Continue to Review Order"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.review-order.assertDeliveryMethod
          params:
            - name: expectedDeliveryMethod
              string: PickupDelivery

      - executeFunction:
          name: mx.functions.ea.review-order.assertStoreAddressByFullString
          params:
            - name: addressFullString
              string: ${returnedStoreAddress}

      - storeIn:
          key: pickupPersonFirstName
          value: mx.data.qaa.sanity.ea-001.userFirstName

      - storeIn:
          key: pickupPersonLastName
          value: mx.data.qaa.sanity.ea-001.userLastName

      - storeIn:
          key: pickupPersonName
          value: ${pickupPersonFirstName} ${pickupPersonLastName}

      - executeFunction:
          name: mx.functions.ea.review-order.assertPickupPerson

      - executeFunction:
          name: mx.functions.ea.review-order.openProductsDetailsPopup

      - executeFunction:
          name: mx.functions.ea.review-order.products-details-popup.assertPopupDisplayed

      - executeFunction:
          name: mx.functions.ea.review-order.products-details-popup.assertProductsCount
          params:
            - name: expectedProductsCount
              string: 2

      - executeFunction:
          name: mx.functions.ea.review-order.products-details-popup.assertProductListed
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.firstProduct

      - executeFunction:
          name: mx.functions.ea.review-order.products-details-popup.assertProductListed
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.secondProduct

      - executeFunction:
          name: mx.functions.ea.review-order.products-details-popup.tapClose

      - executeFunction:
         name: mx.functions.ea.review-order.assertProductsCountInDeliveryDetailsSection

      #----------------------------------------------------------------------------------------------------------------
      - log: "STEP 21 - Add a delivery instructions"
      - log:
          message: "Skipped because we don't have the functionality yet"
          color: YELLOW

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 22 - Select In-Store Payment method"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.review-order.scrollDownToSection
          params:
            - name: sectionOption
              string: "Payment"

      - executeFunction:
          name: mx.functions.ea.review-order.tapAddOrChangePaymentMethodButton

      - executeFunction:
          name: mx.functions.ea.payment.assertPageDisplayed

      - executeFunction:
          name: mx.functions.ea.payment.selectInStorePaymentMethod

      - executeFunction:
          name: mx.functions.ea.payment.tapContinueButton

      - sleep:
          duration: 3000

      - if:
          identifier:
            present:
              - identifier: mx.mappings.ea.payment.continueButton
          then:
            - executeFunction:
                name: mx.functions.ea.payment.tapContinueButton

      - scroll:
          direction: up
          scrollLimit: 4
          wait: 500

      - executeFunction:
          name: mx.functions.ea.review-order.getSingleDeliveryDate #${returnedDeliveryDate}-->Redurned value

      - storeIn:
          key: singleDeliveryDate
          value: ${returnedDeliveryDate}

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 23 - Add a valid phone number"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.review-order.scrollDownToSection
          params:
            - name: sectionOption
              string: "PhoneNumber"

      - executeFunction:
          name: mx.functions.ea.review-order.enterCellphoneNumber
          params:
            - name: userPhoneNumber
              string: mx.data.qaa.sanity.ea-001.cellphoneNumber

      #----------------------------------------------------------------------------------------------------------------
      - log: "STEP 24 - Place Order"
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 24 - Place Order"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.review-order.tapPlaceOrder

      - sleep:
          duration: 5000

      - storeIn:
          key: EA_001_IS_CART_EMPTY
          value: "true"

      - executeFunction:
          name: mx.functions.ea.order-confirmation.assertPageDisplayed

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 25 - Validate Order Confirmation"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.order-confirmation.getOrderNumber #${returnedOrderNumber} ---> Returned value

      - storeIn:
          key: orderNumber
          value: ${returnedOrderNumber}

      - executeFunction:
          name: mx.flows.ea.order-confirmation.assertConfirmationForPickupDelivery
          params:
            - name: expectedTotal
              string: ${subtotalAmmount}
            - name: expectedDeliveryDate
              string: ${singleDeliveryDate}
            - name: expectedProductsCount
              string: ${expectedProductsCount}
            - name: addressFullString
              string: ${returnedStoreAddress}

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 26 - Click 'Descrubrir más productos'"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.order-confirmation.tapFindMoreProducts

      - sleep:
          duration: 10000

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 27 - Navigate to Account and open orders history."
            - name: squadNames
              string: POST-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.bottom-menu.tapAccount

      - executeFunction:
          name: mx.functions.ea.account.assertPageDisplayed

      - executeFunction:
          name: mx.functions.ea.account.openOrdersHistory

      - executeFunction:
          name: mx.functions.ea.orders-history.assertPageDisplayed

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 28 - Verify Order in Orders History"
            - name: squadNames
              string: POST-PURCHASE | QAA

      # Order Displayed Assertion...
      - executeFunction:
          name: mx.functions.ea.orders-history.assertOrderDisplayed
          params:
            - name: orderNumber
              string: ${orderNumber}

      - executeFunction:
          name: mx.functions.ea.orders-history.assertOrderTotal
          params:
            - name: expectedTotal
              string: ${subtotalAmmount}

      - executeFunction:
          name: mx.functions.ea.orders-history.assertOrderDeliveryMethod
          params:
            - name: orderNumber
              string: ${orderNumber}
            - name: expectedDeliveryMethod
              string: PickupDelivery

      - executeFunction:
          name: mx.flows.ea.orders-history.assertOrder
          params:
            - name: orderNumber
              string: ${orderNumber}
            - name: expectedDeliveryMethod
              string: PickupDelivery
            - name: expectedTotal
              string: ${subtotalAmmount}
            - name: isMultipleDelivery
              string: 'false'
            - name: expectedOrderStatus
              string: mx.data.qaa.sanity.ea-001.expectedOrderStatus
            - name: expectedDeliveryDate
              string: ${returnedDeliveryDate}
            - name: expectedProductsCount
              string: mx.data.qaa.sanity.ea-001.totalProductsExpected

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 29 - Open Order Details and validate correct information"
            - name: squadNames
              string: POST-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.ea.orders-history.openOrder
          params:
            - name: orderNumber
              string: ${orderNumber}

      - sleep:
          duration: 3000

      - executeFunction:
          name: mx.flows.ea.order-details.assertDetailsForPickupDelivery
          params:
            - name: expectedOrderNumber
              string: ${orderNumber}
            - name: expectedOrderedDate
              string: ${returnedOrderedDate}
            - name: expectedOrderStatus
              string: mx.data.qaa.sanity.ea-001.expectedOrderStatus
            - name: expectedDeliveryDate
              string: ${returnedDeliveryDate}
            - name: expectedStoreName
              string: mx.data.qaa.sanity.ea-001.finalStoreName
            - name: addressFullString
              string: mx.data.qaa.sanity.ea-001.storeAddressForOrderDetails

      - executeFunction:
          name: mx.functions.ea.order-details.expandProductsDetailsIfNotExpandedForSingleDelivery

      - sleep:
          duration: 2000

      - executeFunction:
          name: mx.functions.utils.positionElementToTheCenter
          params:
            - name: elementToPositionCenter
              string: mx.mappings.ea.order-details.collapseProductDetailsSectionButton

      - executeFunction:
          name: mx.functions.ea.order-details.assertProductDisplayed
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.secondProduct

      - if:
          condition: ${secondProductDiscount} == true
          then:
            - storeIn:
                key: secondProductPrice
                value: ${secondOriginalPrice}

      - executeFunction:
          name: mx.functions.ea.order-details.assertProductUnitPrice
          params:
            - name: expectedUnitPrice
              string: ${secondProductPrice}

      - executeFunction:
          name: mx.functions.ea.order-details.assertProductOrderedQuantity
          params:
            - name: expectedQuantity
              string: 1

      - scroll:
          direction: down
          scrollLimit: 5

      - executeFunction:
          name: mx.functions.ea.order-details.assertProductDisplayed
          params:
            - name: productName
              string: mx.data.qaa.sanity.ea-001.firstProduct

      - if:
          condition: ${firstProductDiscount} == true
          then:
            - storeIn:
                key: firstProductPrice
                value: ${firstOriginalPrice}

      - executeFunction:
          name: mx.functions.ea.order-details.assertProductUnitPrice
          params:
            - name: expectedUnitPrice
              string: ${firstProductPrice}

      - executeFunction:
          name: mx.functions.ea.order-details.assertProductOrderedQuantity
          params:
            - name: expectedQuantity
              string: 1

      - scroll:
          direction: down
          scrollLimit: 2

      - arithmetic:
          expression: ${firstProductPrice} + ${secondProductPrice}
          storeIn: orderDetailsSubTotal

      - executeFunction:
          name: mx.functions.ea.order-details.assertSubtotal
          params:
            - name: expectedSubtotal
              string: ${orderDetailsSubTotal}

      - if:
          condition: ${secondProductDiscount} == true || ${firstProductDiscount} == true
          then:
            - arithmetic:
                expression: ${firstDiscountAmount} + ${secondDiscountAmount}
                storeIn: expectedDiscount
            - executeFunction:
                name: mx.functions.ea.order-details.assertDiscount
                params:
                  - name: expectedDiscount
                    string: ${expectedDiscount}
          else:
            - executeFunction:
                name: mx.functions.ea.order-details.assertDiscount
                params:
                  - name: expectedDiscount
                    string: '0.00'

      - executeFunction:
          name: mx.functions.ea.order-details.assertDeliveryDiscount
          params:
            - name: expectedDeliveryDiscount
              string: '0.00'

      - executeFunction:
          name: mx.functions.ea.order-details.assertDeliveryFee
          params:
            - name: expectedDeliveryFee
              string: '0.00'

      - executeFunction:
          name: mx.functions.ea.order-details.assertTotal
          params:
            - name: expectedTotal
              string: ${firstAndSecondPrices}

      - scroll:
          direction: down
          scrollLimit: 1

      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 30 - Cancel Order"
            - name: squadNames
              string: POST-PURCHASE | QAA

      - executeFunction:
          name: mx.flows.ea.order-details.cancelOrderWithSetOption

      - storeIn:
          key: EA_001_SUCCESSFUL_EXECUTION
          value: true

      - log: "TEST END: QAA - EA - PRODUCTION SANITY - EA-001"

  #####################################################################################################################

  - name: Before
    before: true
    flow:
      - log: "BEFORE SCENARIO START: Initial Config..."
      - executeFunction:
          name: mx.squad-reporting.setTestCaseName
          params:
            - name: testCaseName
              string: GMX_EA_Sanity_PROD_Android_001
      - log:
          message: "WORKAROUND: RELAUNCHING APP TO FIX ISSUE REGARDING INTERNAL APP FLAGS"
          color: YELLOW
      - executeFunction:
          name: mx.functions.utils.relaunchApp
      - storeIn:
          key: selectedStore
          value: mx.data.qaa.sanity.ea-001.storeName
      - storeIn:
          key: EA_001_IS_CART_EMPTY
          value: "true"
      - storeIn:
          key: EA_001_SUCCESSFUL_EXECUTION
          value: "false"
      - log: "BEFORE SCENARIO END"

  #####################################################################################################################

  - name: After
    after: true
    flow:
      - log: "AFTER SCENARIO START: Test Data Reset..."
      - if:
          condition: ${EA_001_SUCCESSFUL_EXECUTION} != true
          then:
            - if:
                condition: ${EA_001_IS_CART_EMPTY} == false
                then:
                  - executeFunction:
                      name: mx.flows.ea.after-scenario-exclusive.relaunchAndNavigateToHomePage
                  - executeFunction:
                      name: mx.flows.ea.after-scenario-exclusive.navigateToAccountAndLoginIfNotLogged
                      params:
                        - name: userEmail
                          string:  ${returnedUniqueEmail}
                        - name: userPassword
                          string: mx.data.qaa.sanity.ea-001.user.password
                  - executeFunction:
                      name: mx.functions.ea.bottom-menu.tapHome
                  - executeFunction:
                      name: mx.flows.ea.after-scenario-exclusive.openCartAndDeleteAllProducts
                else:
                  - log:
                      message: "No Products were left in Cart, no need to empty it..."
                      color: CYAN
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: CYAN
      - log: "AFTER SCENARIO END"