#======================================================================================================================
#    AUTHOR: Octavio Cabrales Zárate (vn53g23), Rodrigo Pacheco C. (vn53p0i)
#   CREATED: Jun/09/2023
#  REVISION: ---
#
#  Copyright © 2023 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: qaa-od-sanity-production-android-018, qaa-od-sanity-production-android
  testCaseId: MXMOB-1355

scenarios:
#######################################################################################################################
#
#  CONFLUENCE TRACKING DASHBOARD:
#    https://confluence.walmart.com/display/MXGECMEX/MXMOB-QAA%3A+Tracking%3A+Test+Suite%3A+GlassMX+-+OD+-+Sanity+-+Production+-+Android
#
#  JIRA AUTOMATION TC:
#    https://jira.walmart.com/browse/MXMOB-1355
#
#  JIRA MANUAL TC:
#    https://jira.walmart.com/browse/MXMOB-1952
#
#######################################################################################################################
#
#   - Flags used:
#
#       ${ORDER_DETAILS_AND_HISTORY_DELIVERY_SLOT_ASSERTION_WORKAROUND}  -  Values: [true | false]
#           Turns on/off the execution of the workaround to perform (or not) the delivery slot assertions on 
#           order-details and orders-history pages due to an error that displays a different time slot from the selected 
#           during the booking phase.
#
#       ${IOS_LOGIN_AS_REGISTERED_USER_WORKAROUND}  -  Values: [true | false]
#           Turns on/off the execution of the workaround to log in after finishing the onboarding steps due to iOS not
#           having the login button inside the onboarding aside from Android. Turn on to log in in Account page after
#           the onboarding steps, turn off to log in inside the onboarding as usual.
#
#       ${ASSERT_DELIVERY_SLOT_IN_CART}  -  Values: [true | false]
#           If set to 'true', the flow will perform assertion for the Delivery Slot in Cart page.
#           If set to 'false' or not set at all, it will perform the Delivery Slot assertion as expected.
#  
#       ${ASSERT_DELIVERY_SLOT_IN_REVIEW_ORDER}  -  Values: [true | false]
#           If set to 'true', the flow will perform assertion for the Delivery Slot in Review Order page.
#           If set to 'false' or not set at all, it will perform the Delivery Slot assertion as expected.
#  
#       ${ASSERT_DELIVERY_SLOT_IN_ORDER_CONFIRMATION}  -  Values: [true | false]
#           If set to 'true', the flow will perform assertion for the Delivery Slot in Order Confirmation page.
#           If set to 'false' or not set at all, it will perform the Delivery Slot assertion as expected.
#  
#       ${ASSERT_DELIVERY_SLOT_IN_ORDERS_HISTORY}  -  Values: [true | false]
#           If set to 'true', the flow will perform assertion for the Delivery Slot in Orders History page.
#           If set to 'false' or not set at all, it will perform the Delivery Slot assertion as expected.
#  
#       ${ASSERT_DELIVERY_SLOT_IN_ORDER_DETAILS}  -  Values: [true | false]
#           If set to 'true', the flow will perform assertion for the Delivery Slot in Order Details page.
#           If set to 'false' or not set at all, it will perform the Delivery Slot assertion as expected.
#
#======================================================================================================================

  - name: Main
    flow:
      - log: "TEST START: ${__SQUAD_REPORTING_TEST_CASE_NAME}"

      ## STEP 1: OPEN APP AND COMPLETE ONBOARDING AS GUEST - PRE-HOME SCREEN IS DISPLAYED
      ## STEP 2: SELECT OD BANNER - HOME SCREEN IS DISPLAYED
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEPS 1-2: LAUNCH AND COMPLETE ONBOARDING AS GUEST - SELECT OD BANNER.'
            - name: squadNames
              string: CORE | QAA

      - executeFunction:
          name: mx.flows.global.onboarding.navigateToHomeAsGuestUser
          params:
            - name: zipCode
              string: mx.data.qaa.sanity.od-018.zipCode
            - name: banner
              string: OD

  #--------------------------------------------------------------------------------------------------------------------

      ## STEP 3: GO TO PROFILE SCREEN AND LOGIN - USER INFORMATION SHOULD BE LOADED ON ACCOUNT PAGE
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 3: GO TO PROFILE SCREEN AND LOGIN.'
            - name: squadNames
              string: CUSTOMER | QAA

      - executeFunction:
          name: mx.flows.od.login.navigateToAccountAndLogin
          params:
            - name: userEmail
              string: mx.data.qaa.sanity.od-018.userEmail
            - name: userPassword
              string: mx.data.qaa.sanity.od-018.userPassword
            - name: userName
              string: mx.data.qaa.sanity.od-018.userName

  # Changing store.....................................................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'Step 3 (A): Changing store (if necessary)...'
            - name: squadNames
              string: PRE-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.home.scrollUpToLocationBanner
      - if:
          identifier:
            present:
              - identifier: mx.mappings.delivery-method-selector.expandLocationBanner
          then:
            - click:
                identifier: mx.mappings.delivery-method-selector.expandLocationBanner
            - click:
                identifier: mx.mappings.delivery-method-selector.pickupButton
            - if:
                identifier:
                  present:
                    - identifier: mx.mappings.delivery-method-selector.selectedStore # <--Selected Store--${selectedStore}--Set in 'Before' 
                then:
                  - click:
                      identifier: mx.mappings.delivery-method-selector.collapseLocationBanner
                  - log: "Desired Store already selected, execution will continue..."
                else:
                  - log: "Desired Store not selected, changing store..."
                  - click:
                      identifier: mx.mappings.delivery-method-selector.pickupStoreSelectorButton
                  - executeFunction:
                      name: mx.functions.store-selector-popup.assertPageDisplayed
                  - executeFunction:
                      name: mx.flows.od.store-selector-popup.quickChangeStoreFromPopup
                      params:
                        - name: zipCode
                          string: mx.data.qaa.sanity.od-018.zipCode
                        - name: storeName
                          string: mx.data.qaa.sanity.od-018.storeName
                  - sleep:
                      duration: 3000
                  - click:
                      identifier: mx.mappings.delivery-method-selector.collapseLocationBanner
          else:
            - if:
                identifier:
                  present:
                    - identifier: mx.mappings.home.selectedStoreButton # <--Selected Store--${selectedStore}--Set in 'Before' Scenario.
                then:
                  - log: "Desired Store already selected, execution will continue..."
                else:
                  - log: "Desired Store not selected, changing store..."
                  - executeFunction:
                      name: mx.functions.home.tapStoreSelector
                  - executeFunction:
                      name: mx.functions.store-selector-popup.assertPageDisplayed
                  - executeFunction:
                      name: mx.flows.od.store-selector-popup.quickChangeStoreFromPopup
                      params:
                        - name: zipCode
                          string: mx.data.qaa.sanity.od-018.zipCode
                        - name: storeName
                          string: mx.data.qaa.sanity.od-018.storeName
    
  #--------------------------------------------------------------------------------------------------------------------

      ## STEP 4: SEARCH FOR A PIECES PRODUCT - SLP SHOULD SHOW
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 4: SEARCH FOR A PIECES PRODUCT.'
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.flows.od.search.performSuccessfulSearch
          params:
            - name: searchTerm
              string: mx.data.qaa.sanity.od-018.searchTerm1

  #--------------------------------------------------------------------------------------------------------------------

      ## STEP 5: ADD FIRST PRODUCT TO FAVORITES FROM SLP - PRODUCT SHOULD BE ADDED CORRECTLY
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 5: ADD FIRST PRODUCT TO FAVORITES FROM SLP.'
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.flows.od.list.markProductAsFavoriteWithoutSpecialBadgesInSLP
          params:
            - name: previousList
              string: 'null'
      - storeIn:
          key: qaa_od018_product_1_name
          value: ${returnedProductName}
          # [VARIABLE] Product Name 1 saved in ${qaa_od018_product_1_name}
      - storeIn:
          key: OD_018_IS_LIST_EMPTY
          value: false

  #--------------------------------------------------------------------------------------------------------------------

      ## STEP 6: GO TO DEPARTMENT/SUBDEPARTMENT - SUBDEPARTMENTS SHOULD BE SHOWN CORRECTLY
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 6: GO TO DEPARTMENT/SUBDEPARTMENT.'
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - log: "Searching for a second product..."
      - executeFunction:
          name: mx.functions.bottom-menu.tapDepartments
      - executeFunction:
          name: mx.flows.od.taxonomy.openDepartment
          params:
            - name: L1
              string: mx.data.qaa.sanity.od-018.departmentL1
            - name: L2
              string: mx.data.qaa.sanity.od-018.departmentL2
            - name: L3
              string: mx.data.qaa.sanity.od-018.departmentL3

  #--------------------------------------------------------------------------------------------------------------------

      ## STEP 7: ADD PRODUCT TO FAVORITES FROM SUBDEPARTMENTS (PIECES) - PRODUCT SHOULD BE ADDED CORRECTLY
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 7: ADD PRODUCT TO FAVORITES FROM SUBDEPARTMENTS (PIECES).'
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.flows.od.list.markProductAsFavoriteWithoutSpecialBadgesInPLP
          params:
            - name: previousList
              string: 'null'
      - storeIn:
          key: qaa_od018_product_2_name
          value: ${returnedProductName}
          # [VARIABLE] Product Name 2 saved in ${qaa_od018_product_2_name}

  #--------------------------------------------------------------------------------------------------------------------

      ## STEP 8: OPEN PDP - PRODUCT DETAILS SHOULD BE DISPLAYED
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 8: Searching for a third product (pieces) and open PDP.'
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.flows.od.search.performSuccessfulSearch
          params:
            - name: searchTerm
              string: mx.data.qaa.sanity.od-018.searchTerm2
      - executeFunction:
          name: mx.functions.slp.openPDPWithoutSpecialBadges
          params:
            - name: previousList
              string: 'null'
      - storeIn:
          key: qaa_od018_product_3_name
          value: ${returnedProductName}
          # [VARIABLE] Product Name 3 saved in ${qaa_od018_product_3_name}
      
  # Opening PDP........................................................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'Step 8 (A): Opening PDP...'
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.pdp.assertPageDisplayed
      - executeFunction:
          name: mx.functions.pdp.assertCorrectProductDisplayed
          params:
            - name: expectedProductName
              string: ${qaa_od018_product_3_name}

  #--------------------------------------------------------------------------------------------------------------------

      ## STEP 9: ADD PRODUCT TO FAVORITES FROM PDP - PRODUCT SHOULD BE ADDED CORRECTLY
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 9: ADD PRODUCT TO FAVORITES FROM PDP.'
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.pdp.markAsFavorite

  #--------------------------------------------------------------------------------------------------------------------

      ## STEP 10: GO TO MY ITEMS - ORDER AGAIN AND LISTS SHOULD SHOW
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 10: GO TO MY ITEMS.'
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.pdp.tapClose
      - executeFunction:
          name: mx.functions.bottom-menu.tapProductsAndLists
      - executeFunction:
          name: mx.functions.utils.closeBlackPopupIfDisplayed
      - executeFunction:
          name: mx.functions.products-and-lists.assertPageDisplayed

  #--------------------------------------------------------------------------------------------------------------------

      ## STEP 11: GO TO LISTS - FAVORITES LIST SHOULD BE DISPLAYED
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 11: GO TO LISTS.'
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.products-and-lists.tapLists
      - executeFunction:
          name: mx.functions.lists.assertListDisplayed
          params:
            - name: listName
              string: mx.data.qaa.sanity.od-018.myFavoritesListName

  #--------------------------------------------------------------------------------------------------------------------
      
      ## STEP 12: OPEN MY FAVORITES LIST - VERIFY THE ADDED PRODUCTS EXIST
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 12: OPEN MY FAVORITES LIST.'
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.lists.openFavoritesList
      - executeFunction:
          name: mx.functions.list.assertPageDisplayed
      - executeFunction:
          name: mx.functions.list.assertCorrectListOpened
          params:
            - name: expectedListName
              string: mx.data.qaa.sanity.od-018.myFavoritesListName

  # Verifying all products were added to the favorites list............................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'Step 12 (A): Verifying all products were added to the favorites list...'
            - name: squadNames
              string: PRE-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.list.assertProductListed
          params:
            - name: productName
              string: ${qaa_od018_product_1_name}
      - executeFunction:
          name: mx.functions.list.assertProductListed
          params:
            - name: productName
              string: ${qaa_od018_product_2_name}
      - executeFunction:
          name: mx.functions.list.assertProductListed
          params:
            - name: productName
              string: ${qaa_od018_product_3_name}

  #--------------------------------------------------------------------------------------------------------------------
    
      ## STEP 13: REMOVE PRODUCT 3 FROM THE FAVORITES LIST - VERIFY PRODUCT WAS REMOVED
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 13: REMOVE PRODUCT 3 FROM THE FAVORITES LIST."
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.flows.od.list.deleteProductFromList
          params:
            - name: productName
              string: ${qaa_od018_product_3_name}

  #--------------------------------------------------------------------------------------------------------------------
    
      ## STEP 14: CLOSE AND RE-OPEN FAVORITES LIST - PREVIOUSLY REMOVED PRODUCT REMAINS DELETED
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 14: CLOSE AND RE-OPEN FAVORITES LIST."
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.list.tapBack
      - executeFunction:
          name: mx.functions.utils.closeBlackPopupIfDisplayed
      - executeFunction:
          name: mx.functions.lists.assertPageDisplayed
      - executeFunction:
          name: mx.functions.lists.openFavoritesList
      - executeFunction:
          name: mx.functions.list.assertPageDisplayed
      - executeFunction:
          name: mx.functions.list.assertCorrectListOpened
          params:
            - name: expectedListName
              string: mx.data.qaa.sanity.od-018.myFavoritesListName
      - executeFunction:
          name: mx.functions.list.assertProductNotListed
          params:
            - name: productName
              string: ${qaa_od018_product_3_name}

  #--------------------------------------------------------------------------------------------------------------------
    
      ## STEP 15: ADD ALL PRODUCTS TO CART (PRODUCTS 1 AND 2) - CART COUNTER SHOULD BE UPDATED
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 15: ADD ALL PRODUCTS TO CART (PRODUCTS 1 AND 2)."
            - name: squadNames
              string: PRE-PURCHASE | QAA

  # Product 1 interactions.............................................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Step 15 (A): Product 1 interactions..."
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.list.addProductToCart
          params:
            - name: productName
              string: ${qaa_od018_product_1_name}
      - storeIn:
          key: OD_018_IS_CART_EMPTY
          value: false
      - executeFunction:
          name: mx.functions.list.assertProductAddedToCart
      - executeFunction:
          name: mx.functions.list.increaseProductQuantityBy
          params:
            - name: quantity
              string: mx.data.qaa.sanity.od-018.increaseQuantity
      - executeFunction:
          name: mx.functions.list.decreaseProductQuantityBy
          params:
            - name: quantity
              string: mx.data.qaa.sanity.od-018.decreaseQuantity
      - executeFunction:
          name: mx.functions.list.getProductPrice
      - storeIn:
          key: qaa_od018_product_1_price
          value: ${returnedProductPrice}
          # [VARIABLE] Price of product 1 saved in ${qaa_od018_product_1_price}
      - executeFunction:
          name: mx.functions.list.getProductQuantityAsPieces
      - storeIn:
          key: qaa_od018_product_1_added_quantity
          value: ${returnedProductQuantityAsPieces}
          # [VARIABLE] Added quantity of product 1 saved in ${qaa_od018_product_1_added_quantity}
      - arithmetic:
          expression: ${qaa_od018_product_1_price} * ${qaa_od018_product_1_added_quantity}
          numberOfDecimalPlaces: 2
          storeIn: qaa_od018_product_1_subtotal
          # [VARIABLE] Subtotal price of product 1 saved in ${qaa_od018_product_1_subtotal}

  # Product 2 interactions.............................................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Step 15 (B): Product 2 interactions..."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.list.addProductToCart
          params:
            - name: productName
              string: ${qaa_od018_product_2_name}
      - executeFunction:
          name: mx.functions.list.assertProductAddedToCart
      - executeFunction:
          name: mx.functions.list.increaseProductQuantityBy
          params:
            - name: quantity
              string: mx.data.qaa.sanity.od-018.increaseQuantity
      - executeFunction:
          name: mx.functions.list.getProductPrice
      - storeIn:
          key: qaa_od018_product_2_price
          value: ${returnedProductPrice}
          # [VARIABLE] Price of product 2 saved in ${qaa_od018_product_2_price}
      - executeFunction:
          name: mx.functions.list.getProductQuantityAsPieces
      - storeIn:
          key: qaa_od018_product_2_added_quantity
          value: ${returnedProductQuantityAsPieces}
          # [VARIABLE] Added quantity of product 2 saved in ${qaa_od018_product_2_added_quantity}
      - arithmetic:
          expression: ${qaa_od018_product_2_price} * ${qaa_od018_product_2_added_quantity}
          numberOfDecimalPlaces: 2
          storeIn: qaa_od018_product_2_subtotal
          # [VARIABLE] Subtotal price of product 2 saved in ${qaa_od018_product_2_subtotal}
      
  # Getting the total quantity of products added to cart...............................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Step 15 (C): Getting the total quantity of products added to cart..."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      - arithmetic:
          expression: ${qaa_od018_product_1_added_quantity} + ${qaa_od018_product_2_added_quantity}
          storeIn: qaa_od018_total_products_count
          # [VARIABLE] Total products count saved in ${qaa_od018_total_products_count}
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: ${qaa_od018_total_products_count}
    
  # Validating Estimated total on Favorites list.......................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Step 15 (D): Validating Estimated total on Favorites list..."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      - arithmetic:
          expression: ${qaa_od018_product_1_price} + ${qaa_od018_product_2_price}
          numberOfDecimalPlaces: 2
          storeIn: qaa_od018_favorites_list_estimated_total
          # [VARIABLE] Estimated Total from Favorites list saved in ${qaa_od018_favorites_list_estimated_total}
      - executeFunction:
          name: mx.functions.list.assertEstimatedTotal
          params:
            - name: expectedEstimatedTotal
              string: ${qaa_od018_favorites_list_estimated_total}

  #--------------------------------------------------------------------------------------------------------------------
      
      ## STEP 16: GO TO CART - VALIDATE PRODUCTS WERE ADDED AND CART VALIDATIONS
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 16: GO TO CART."
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon
      - executeFunction:
          name: mx.functions.utils.closeBlackPopupIfDisplayed
      - executeFunction:
          name: mx.functions.cart.assertPageDisplayed
      - executeFunction:
          name: mx.functions.cart.assertProductsCountInSubtotalLabel
          params:
            - name: expectedProductsCount
              string: ${qaa_od018_total_products_count}
      
  # Product 1 assertions...............................................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Step 16 (A): Product 1 assertions..."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions #--[RETURNS]--${returnedProductType}-->
          params:
            - name: productName
              string: ${qaa_od018_product_1_name}
            - name: productType
              string: 'null'
            - name: expectedQuantity
              string: ${qaa_od018_product_1_added_quantity}
            - name: expectedWeightQuantity
              string: 'null'
            - name: expectedUnitPrice
              string: ${qaa_od018_product_1_price}
            - name: expectedSubtotal
              string: ${qaa_od018_product_1_subtotal}
      - storeIn:
          key: qaa_od018_product_1_type
          value: ${returnedProductType}
          # [VARIABLE] Type of product 1 saved in ${qaa_od018_product_1_type}
      
  # Product 2 assertions...............................................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Step 16 (B): Product 2 assertions..."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.cart.quickPerformProductAssertions #--[RETURNS]--${returnedProductType}-->
          params:
            - name: productName
              string: ${qaa_od018_product_2_name}
            - name: productType
              string: 'null'
            - name: expectedQuantity
              string: ${qaa_od018_product_2_added_quantity}
            - name: expectedWeightQuantity
              string: 'null'
            - name: expectedUnitPrice
              string: ${qaa_od018_product_2_price}
            - name: expectedSubtotal
              string: ${qaa_od018_product_2_subtotal}
      - storeIn:
          key: qaa_od018_product_2_type
          value: ${returnedProductType}
          # [VARIABLE] Type of product 2 saved in ${qaa_od018_product_2_type}

  #--------------------------------------------------------------------------------------------------------------------
    
      ## STEP 17: CLICK ON 'RESERVAR HORARIO' - RESERVE-SLOT PAGE IS DISPLAYED
      ## STEP 18: CLICK THE HOME DELIVERY METHOD TAB AND SELECT DAY AND TIME SLOTS - FINAL CART ASSERTIONS
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEPS 17-18: RESERVE TIME SLOT (HOME DELIVERY)"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.flows.od.cart.reserveSlot
          params:
            - name: deliveryMethod
              string: mx.data.qaa.sanity.od-018.deliveryMethod
            - name: addressName
              string: mx.data.qaa.sanity.od-018.userAddressName
            - name: deliveryPlaceAction
              string: 'Change'
            - name: slotDate
              string: 'dayAfterTomorrow'
            - name: slotTime
              string: 'lastAvailable'
      
  # Retrieving Home Delivery Address data for future validations.......................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Steps 17-18 (A): Retrieving Home Delivery Address data for future validations..."
            - name: squadNames
              string: PURCHASE | QAA
      - storeIn:
          key: qaa_od018_selected_user_address_street_name
          value: ${returnedStreetName}
          # [VARIABLE] Street name from selected address saved in ${qaa_od018_selected_user_address_street_name}
      - storeIn:
          key: qaa_od018_selected_user_address_exterior_number
          value: ${returnedExteriorNumber}
          # [VARIABLE] Exterior Number from selected address saved in ${qaa_od018_selected_user_address_exterior_number}
      - storeIn:
          key: qaa_od018_selected_user_address_city
          value: ${returnedCity}
          # [VARIABLE] City from selected address saved in ${qaa_od018_selected_user_address_city}
      - storeIn:
          key: qaa_od018_selected_user_address_state
          value: ${returnedState}
          # [VARIABLE] State from selected address saved in ${qaa_od018_selected_user_address_state}
      - storeIn:
          key: qaa_od018_selected_user_address_zip_code
          value: ${returnedZipCode}
          # [VARIABLE] Zip Code from selected address saved in ${qaa_od018_selected_user_address_zip_code}
      
  # Retrieving values for totals Assertions............................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Steps 17-18 (B): Retrieving values for totals Assertions..."
            - name: squadNames
              string: PURCHASE | QAA
      - storeIn:
          key: qaa_od018_delivery_fee
          value: mx.data.qaa.sanity.od-018.deliveryFee # <-- Business rule
          # [VARIABLE] Delivery fee saved in ${qaa_od018_delivery_fee}
      - arithmetic:
          expression: ${qaa_od018_product_1_subtotal} + ${qaa_od018_product_2_subtotal}
          numberOfDecimalPlaces: 2
          storeIn: qaa_od018_subtotal
          # [VARIABLE] Cart subtotal saved in ${qaa_od018_subtotal}
      - arithmetic:
          expression: ${qaa_od018_subtotal} + ${qaa_od018_delivery_fee}
          numberOfDecimalPlaces: 2
          storeIn: qaa_od018_total
          # [VARIABLE] Cart estimated total saved in ${qaa_od018_total}
      
  # Validating totals and continuing to Review-Order...................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Steps 17-18 (C): Validating totals and continuing to Review-Order..."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.cart.assertTotals # --RETURNS--${returnedEstimatedTotal}-->
          params:
            - name: expectedDeliveryFee
              string: ${qaa_od018_delivery_fee}
            - name: expectedSubtotal
              string: ${qaa_od018_subtotal}
      - executeFunction:
          name: mx.functions.cart.tapContinue
      - executeFunction:
          name: mx.functions.missing-something.continueWithoutSelectionIfPageDisplayed
      - executeFunction:
          name: mx.functions.review-order.assertPageDisplayed

  #--------------------------------------------------------------------------------------------------------------------
    
      ## STEP 19: CLICK ON CONTINUE BUTTON AND OPEN REVIEW ORDER PAGE - INITIAL REVIEW-ORDER ASSERTIONS
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 19: CLICK ON CONTINUE BUTTON AND OPEN REVIEW ORDER PAGE."
            - name: squadNames
              string: PURCHASE | QAA

  # Running Delivery Information Assertions............................................................................
      - log: "Running Delivery Information Assertions..."
      - executeFunction:
          name: mx.flows.od.review-order.assertDeliveryInformation
          params:
            - name: deliveryMethod
              string: mx.data.qaa.sanity.od-018.deliveryMethod
            - name: expectedDaySlot
              string: ${returnedSelectedDaySlot}
            - name: expectedTimeSlot
              string: ${returnedSelectedTimeSlot}
            - name: expectedStoreOrHomeName
              string: mx.data.qaa.sanity.od-018.userAddressName
            - name: expectedStoreOrHomeAddress
              string: 'null'
            - name: expectedUserStreet
              string: ${qaa_od018_selected_user_address_street_name}
            - name: expectedUserExteriorNumber
              string: ${qaa_od018_selected_user_address_exterior_number}
            - name: expectedUserCity
              string: ${qaa_od018_selected_user_address_city}
            - name: expectedUserState
              string: ${qaa_od018_selected_user_address_state}
            - name: expectedUserZipCode
              string: ${qaa_od018_selected_user_address_zip_code}
      
  # Test Order Disclaimer..............................................................................................
      - log: "Test Order Disclaimer..."
      - executeFunction:
          name: mx.flows.od.review-order.enterTestOrderDisclaimer

  #--------------------------------------------------------------------------------------------------------------------
      
      ## STEP 20: SELECT PAY AT DELIVERY - PAYMENT METHOD SHOULD BE UPDATED AND FINAL REVIEW-ORDER ASSERTIONS
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 20: SELECT PAY AT DELIVERY."
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.review-order.scrollDownToSection
          params:
            - name: sectionName
              string: Pago
      - executeFunction:
          name: mx.flows.od.review-order.selectPayAtDeliveryMethodIfNotSelected
          params:
            - name: payAtDeliveryOption
              string: mx.data.qaa.sanity.od-018.payAtDeliveryFormat
      - executeFunction:
          name: mx.functions.review-order.scrollDownToSection
          params:
            - name: sectionName
              string: "Número telefónico"
      - executeFunction:
          name: mx.flows.od.review-order.enterCellphoneNumber
          params:
            - name: userPhoneNumber
              string: mx.data.qaa.sanity.od-018.userPhoneNumber
      - executeFunction:
          name: mx.functions.review-order.scrollDownToSection
          params:
            - name: sectionName
              string: Total
      - executeFunction:
          name: mx.flows.od.review-order.assertTotalsInformation
          params:
            - name: expectedSubtotalProductsCount
              string: ${qaa_od018_total_products_count}
            - name: expectedSubtotal
              string: ${qaa_od018_subtotal}
            - name: assertDeliveryFee
              string: 'true'
            - name: expectedDeliveryFee
              string: ${qaa_od018_delivery_fee}

  #--------------------------------------------------------------------------------------------------------------------

      ## STEP 21: PLACE ORDER - ORDER CONFIRMATION ASSERTIONS
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 21: PLACE ORDER."
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.review-order.tapPlaceOrder
      - storeIn:
          key: qaa_od018_ordered_date
          value: ${returnedOrderedDate}
          # [VARIABLE] Ordered Date saved in ${qaa_od018_ordered_date}
      - storeIn:
          key: OD_018_IS_CART_EMPTY
          value: true
      - sleep:
          duration: 10000

  # Running Confirmation Page Assertions...............................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Step 21 (A): Running Confirmation Page Assertions..."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.order-confirmation.assertConfirmation
          params:
            - name: expectedTotal
              string: ${qaa_od018_total}
            - name: expectedDaySlot
              string: ${returnedSelectedDaySlot}
            - name: expectedTimeSlot
              string: ${returnedSelectedTimeSlot}
            - name: expectedProductsCount
              string: ${qaa_od018_total_products_count}
            - name: expectedDeliveryMethod
              string: mx.data.qaa.sanity.od-018.deliveryMethod
            - name: expectedHomeAddressName
              string: mx.data.qaa.sanity.od-018.userAddressName
            - name: expectedUserStreet
              string: ${qaa_od018_selected_user_address_street_name}
            - name: expectedUserExteriorNumber
              string: ${qaa_od018_selected_user_address_exterior_number}
            - name: expectedUserCity
              string: ${qaa_od018_selected_user_address_city}
            - name: expectedUserState
              string: ${qaa_od018_selected_user_address_state}
            - name: expectedUserZipCode
              string: ${qaa_od018_selected_user_address_zip_code}

      - executeFunction:
          name: mx.functions.order-confirmation.getOrderNumber
      - storeIn:
          key: qaa_od018_order_number
          value: ${returnedOrderNumber}
          # [VARIABLE] Order number saved in ${qaa_od018_order_number}"

  #--------------------------------------------------------------------------------------------------------------------

      ## STEP 22: GO TO ORDERS HISTORY - ORDERS-HISTORY ASSERTIONS
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 22: GO TO ORDERS HISTORY."
            - name: squadNames
              string: CUSTOMER | QAA
      - executeFunction:
          name: mx.functions.order-confirmation.tapFindMoreProducts
      - sleep:
          duration: 5000
      - executeFunction:
          name: mx.functions.bottom-menu.tapAccount
      - executeFunction:
          name: mx.functions.account.assertPageDisplayed
      - executeFunction:
          name: mx.functions.account.openOrdersHistory

  # Running Orders History assertions..................................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Step 22 (A): Running Orders History assertions..."
            - name: squadNames
              string: POST-PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.orders-history.assertOrder
          params:
            - name: orderNumber
              string: ${qaa_od018_order_number}
            - name: expectedDeliveryMethod
              string: mx.data.qaa.sanity.od-018.deliveryMethod
            - name: expectedTotal
              string: ${qaa_od018_total}
            - name: expectedBanner
              string: mx.data.qaa.sanity.od-018.storeBanner
            - name: expectedDaySlot
              string: ${returnedSelectedDaySlot}
            - name: expectedTimeSlot
              string: ${returnedSelectedTimeSlot}
            - name: expectedOrderStatus
              string: mx.data.qaa.sanity.od-018.expectedOrderStatus
            - name: expectedProductsCount
              string: mx.data.qaa.sanity.od-018.differentProductsCount

  #--------------------------------------------------------------------------------------------------------------------
      
      ## STEP 23: OPEN ORDER DETAILS OF THE PREVIOUSLY PLACED ORDER - VALIDATE DETAILS ARE AS PLACED
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 23: OPEN ORDER DETAILS OF THE PREVIOUSLY PLACED ORDER."
            - name: squadNames
              string: POST-PURCHASE | QAA

      - sleep:
          duration: 5000
      - executeFunction:
          name: mx.functions.orders-history.openOrder
          params:
            - name: orderNumber
              string: ${qaa_od018_order_number}

    # Performing Order Details assertions..............................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Step 23 (A): Performing Order Details assertions..."
            - name: squadNames
              string: POST-PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.order-details.assertDetailsWithoutAddressAndTotalsInformation
          params:
            - name: orderNumber
              string: ${qaa_od018_order_number}
            - name: expectedOrderedDate
              string: ${qaa_od018_ordered_date}
            - name: expectedDeliveryMethod
              string: mx.data.qaa.sanity.od-018.deliveryMethod
            - name: expectedOrderStatus
              string: mx.data.qaa.sanity.od-018.expectedOrderStatus
            - name: expectedBanner
              string: mx.data.qaa.sanity.od-018.storeBanner
            - name: expectedDaySlot
              string: ${returnedSelectedDaySlot}
            - name: expectedTimeSlot
              string: ${returnedSelectedTimeSlot}
            - name: expectedProductsCount
              string: mx.data.qaa.sanity.od-018.differentProductsCount

  # Performing Order Details - Home Delivery assertions................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Step 23 (B): Performing Order Details - Home Delivery assertions..."
            - name: squadNames
              string: POST-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.order-details.assertHomeDeliveryAddressName
          params:
            - name: expectedHomeAddressName
              string: mx.data.qaa.sanity.od-018.userAddressName
      - executeFunction:
          name: mx.functions.order-details.assertHomeDeliveryAddressByIndividualValues
          params:
            - name: streetName
              string: ${qaa_od018_selected_user_address_street_name}
            - name: exteriorNumber
              string: ${qaa_od018_selected_user_address_exterior_number}
            - name: city
              string: ${qaa_od018_selected_user_address_city}
            - name: state
              string: ${qaa_od018_selected_user_address_state}
            - name: zipCode
              string: ${qaa_od018_selected_user_address_zip_code}
      
  # Performing assertions for Product 1................................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Step 23 (C): Performing assertions for Product 1..."
            - name: squadNames
              string: POST-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.order-details.expandProductsDetailsIfNotExpanded
      - executeFunction:
          name: mx.flows.od.order-details.assertProductDetails
          params:
            - name: productName
              string: ${qaa_od018_product_1_name}
            - name: expectedPrice
              string: ${qaa_od018_product_1_price}
            - name: expectedSubtotal
              string: ${qaa_od018_product_1_subtotal}
            - name: productType
              string: ${qaa_od018_product_1_type}
            - name: expectedOrderedQuantityAsPieces
              string: ${qaa_od018_product_1_added_quantity}

  # Performing assertions for Product 2................................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Step 23 (D): Performing assertions for Product 2..."
            - name: squadNames
              string: POST-PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.order-details.assertProductDetails
          params:
            - name: productName
              string: ${qaa_od018_product_2_name}
            - name: expectedPrice
              string: ${qaa_od018_product_2_price}
            - name: expectedSubtotal
              string: ${qaa_od018_product_2_subtotal}
            - name: productType
              string: ${qaa_od018_product_2_type}
            - name: expectedOrderedQuantityAsPieces
              string: ${qaa_od018_product_2_added_quantity}

  # Performing Totals assertions.......................................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Step 23 (E): Performing Totals Assertions..."
            - name: squadNames
              string: POST-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.order-details.scrollToBottom
      - executeFunction:
          name: mx.flows.od.order-details.assertTotals
          params:
            - name: expectedPaymentMethod
              string: mx.data.qaa.sanity.od-018.orderDetailsPaymentMethod
            - name: expectedDeliveryFee
              string: ${qaa_od018_delivery_fee}
            - name: expectedSubtotal
              string: ${qaa_od018_subtotal}

  #--------------------------------------------------------------------------------------------------------------------
      
      ## STEP 24: GO TO MY ITEMS AND SELECT THE LISTS TAB - FAVORITES LIST SHOULD BE DISPLAYED
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 24: GO TO MY ITEMS AND SELECT THE LISTS TAB."
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.order-details.tapBack
      - executeFunction:
          name: mx.functions.orders-history.tapBack
      - executeFunction:
          name: mx.functions.bottom-menu.tapProductsAndLists
      - executeFunction:
          name: mx.functions.bottom-menu.tapProductsAndLists
      - executeFunction:
          name: mx.functions.products-and-lists.tapLists
      - executeFunction:
          name: mx.functions.lists.assertListDisplayed
          params:
            - name: listName
              string: mx.data.qaa.sanity.od-018.myFavoritesListName

  #--------------------------------------------------------------------------------------------------------------------

      ## STEP 25: OPEN FAVORITES LIST - PRODUCTS ADDED SHOULD BE LISTED
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 25: OPEN FAVORITES LIST."
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.lists.openFavoritesList
      - executeFunction:
          name: mx.functions.list.assertPageDisplayed
      - executeFunction:
          name: mx.functions.list.assertCorrectListOpened
          params:
            - name: expectedListName
              string: mx.data.qaa.sanity.od-018.myFavoritesListName

  # Validating Favorite Products displayed.............................................................................
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "Step 25 (A): Validating Favorite Products displayed..."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.list.assertProductListed
          params:
            - name: productName
              string: ${qaa_od018_product_1_name}
      - executeFunction:
          name: mx.functions.list.assertProductListed
          params:
            - name: productName
              string: ${qaa_od018_product_2_name}

  #--------------------------------------------------------------------------------------------------------------------
      
      ## STEP 26: EMPTY FAVORITES LIST - PRODUCTS SHOULD BE CORRECTLY DELETED FROM FAVORITES LIST
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 26: EMPTY FAVORITES LIST."
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.list.emptyList
      - executeFunction:
          name: mx.functions.list.assertListIsEmpty
      - storeIn:
          key: OD_018_IS_LIST_EMPTY
          value: true

  #--------------------------------------------------------------------------------------------------------------------
      
      ## STEP 27: CLOSE AND RE-OPEN FAVORITES LIST - FAVORITES LIST SHOULD REMAIN EMPTY
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 27: CLOSE AND RE-OPEN FAVORITES LIST."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.list.tapBack
      - executeFunction:
          name: mx.functions.lists.assertListDisplayed
          params:
            - name: listName
              string: mx.data.qaa.sanity.od-018.myFavoritesListName
      - executeFunction:
          name: mx.functions.lists.openFavoritesList
      - executeFunction:
          name: mx.functions.list.assertPageDisplayed
      - executeFunction:
          name: mx.functions.list.assertCorrectListOpened
          params:
            - name: expectedListName
              string: mx.data.qaa.sanity.od-018.myFavoritesListName
      - executeFunction:
          name: mx.functions.list.assertListIsEmpty

  #--------------------------------------------------------------------------------------------------------------------

      - storeIn:
          key: OD_018_SUCCESSFUL_EXECUTION
          value: true

      - log: "TEST END: ${__SQUAD_REPORTING_TEST_CASE_NAME}"

  #####################################################################################################################

  - name: Before
    before: true
    flow:
      - log: "BEFORE SCENARIO START: Initial Config..."

      - executeFunction:
          name: mx.squad-reporting.setTestCaseName
          params:
            - name: testCaseName
              string: GMX_OD_Sanity_PROD_Android_018

      - log:
          message: "WORKAROUND: RELAUNCHING APP TO FIX ISSUE REGARDING INTERNAL APP FLAGS"
          color: YELLOW
      - executeFunction:
          name: mx.functions.utils.relaunchApp
      - storeIn:
          key: selectedStore
          value: mx.data.qaa.sanity.od-018.storeName
      - storeIn:
          key: OD_018_IS_LIST_EMPTY
          value: true
      - storeIn:
          key: OD_018_IS_CART_EMPTY
          value: true
      - storeIn:
          key: OD_018_SUCCESSFUL_EXECUTION
          value: false
      - log: "BEFORE SCENARIO END"

  #####################################################################################################################

  - name: After
    after: true
    flow:
      - log: "AFTER SCENARIO START: Test Data Reset..."

      - executeFunction:
          name: mx.squad-reporting.logTestCaseFailure
          params:
            - name: testCaseExecutionStatus
              string: ${OD_018_SUCCESSFUL_EXECUTION}

      - if:
          condition: ${OD_018_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "Main Failed: Resetting data for the next execution if necessary..."
                color: CYAN
            - executeFunction:
                name: mx.flows.od.after-scenario-exclusive.emptyFavoritesListAndCart
                params:
                  - name: userEmail
                    string: mx.data.qaa.sanity.od-018.userEmail
                  - name: userPassword
                    string: mx.data.qaa.sanity.od-018.userPassword
                  - name: isListEmpty
                    string: ${OD_018_IS_LIST_EMPTY}
                  - name: isCartEmpty
                    string: ${OD_018_IS_CART_EMPTY}
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: CYAN
      - log: "AFTER SCENARIO END"
