#======================================================================================================================
#    AUTHOR: Isis Rojas Tolentino (vn53dge)
#   CREATED: Jun/22/2023
#  REVISION: ---
#
#  Copyright © 2023 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: qaa-od-sanity-production-android-017, qaa-od-sanity-production-android
  testCaseId: MXMOB-1356

scenarios:

  #####################################################################################################################
  #
  # TEST CASE DESCRIPTION:
  #
  #   Main Objectives:
  #     - Create a new account.
  #     - Add two products, one should be OOS when store/address had been changed.
  #     - Add two addresses, set just one as favorite.
  #     - Pay Order at Delivery.
  #     - Verify product prices changing between stores/addresses.
  #
  # Flags Used:
  #   N/A
  #
  #####################################################################################################################
  #
  #  PRE-REQUISITES:
  #
  #   - Identify a product available in Store A but not in Store B.
  #   - Identify a product available in multiple stores.
  #
  #######################################################################################################################

  - name: Main
    flow:
      - log: 
          message: "TEST START: QAA - OD - PRODUCTION SANITY - OD-017"
          color: CYAN

    # STEP 1-2: Navigate through Onboarding and select OD Banner ------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 1-2: LAUNCH AND LOGIN IN ONBOARDING SCREEN - SELECT OD BANNER."
            - name: squadNames
              string: CORE | QAA
      - executeFunction:
          name: mx.flows.global.onboarding.navigateToHomeAsGuestUser
          params:
            - name: zipCode
              string: mx.data.e2e-regression.qaa.od-017.zipCodeA
            - name: banner
              string: "OD"

    # Changing store...................................................................................................
      - log: "Changing store (if necessary)..."
      - executeFunction:
          name: mx.functions.home.scrollUpToLocationBanner
      - executeFunction:
          name: mx.functions.delivery-method-selector.expandSelectorIfCollapsed
      - executeFunction:
          name: mx.functions.delivery-method-selector.tapPickupButtonIfNotSelected
      - if:
          identifier:
            present:
              - identifier: mx.mappings.delivery-method-selector.selectedStore # <--Selected Store--${selectedStore}--Set in 'Before' 
          then:
            - log:
                message: "Desired Store already selected, execution will continue..."
                color: GREEN_BOLD
          else:
            - log:
                message: "Desired Store not selected, changing store..."
                color: GREEN_BOLD
            - executeFunction:
                name: mx.functions.delivery-method-selector.tapStoreSelector
            - executeFunction:
                name: mx.functions.store-selector-popup.assertPageDisplayed
            - executeFunction:
                name: mx.flows.od.store-selector-popup.quickChangeStoreFromPopup
                params:
                  - name: zipCode
                    string: mx.data.e2e-regression.qaa.od-017.zipCodeA
                  - name: storeName
                    string: mx.data.e2e-regression.qaa.od-017.nameStoreA
            - sleep:
                duration: 3000
      - executeFunction:
          name: mx.functions.delivery-method-selector.closeSelectorIfExpanded

    # STEP 3: Perform a search ----------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 3: PERFORM A SEARCH."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.search.performSuccessfulSearch
          params: 
            - name: searchTerm
              string: mx.data.e2e-regression.qaa.od-017.productSearch1

    # STEP 4: Add product to cart -------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 4: ADD PRODUCT TO CART.'
            - name: squadNames
              string: PRE-PURCHASE | QAA

      # PRODUCT 1 .....................................................................................................
      - executeFunction:
          name: mx.flows.od.add-to-cart.addProductToCartByNameInSLP
          params:
            - name: productName
              string: mx.data.e2e-regression.qaa.od-017.productName1
            - name: direction
              string: 'down'
      - sleep:
          duration: 4000
      - executeFunction:
          name: mx.functions.slp.getProductPrice
          params:
            - name: productName
              string: mx.data.e2e-regression.qaa.od-017.productName1
      - storeIn:
          key: var_product1_price  # Unit price of Product 1  
          value: ${returnedPrice}
      - executeFunction:
          name: mx.functions.slp.getProductType
          params:
            - name: productName
              string: mx.data.e2e-regression.qaa.od-017.productName1
      - storeIn:
          key: qaa_od017_product_type_1
          value: ${returnedProductType}

    # STEP 5: Perform a search ----------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 5: PERFORM A SEARCH."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.search.performSuccessfulSearch
          params: 
            - name: searchTerm
              string: mx.data.e2e-regression.qaa.od-017.productSearch2

    # STEP 6: Add product to cart -------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 6: ADD PRODUCTS TO CART.'
            - name: squadNames
              string: PRE-PURCHASE | QAA

      # PRODUCT 2 .....................................................................................................
      - executeFunction:
          name: mx.flows.od.add-to-cart.addProductToCartByNameInSLP
          params:
            - name: productName
              string: mx.data.e2e-regression.qaa.od-017.productName2
            - name: direction
              string: 'down'
      - sleep:
          duration: 4000
      - executeFunction:
          name: mx.functions.slp.getProductPrice
          params:
            - name: productName
              string: mx.data.e2e-regression.qaa.od-017.productName2
      - storeIn:
          key: var_product2_price  # Unit price of Product 2  
          value: ${returnedPrice}
      - executeFunction:
          name: mx.functions.slp.getProductType
          params:
            - name: productName
              string: mx.data.e2e-regression.qaa.od-017.productName2
      - storeIn:
          key: qaa_od017_product_type_2
          value: ${returnedProductType}

      # Cart Badge Quantity Validation ................................................................................
      - storeIn:
          key: var_product1_quantity
          value: mx.data.e2e-regression.qaa.od-017.quantityProduct1
      - storeIn:
          key: var_product2_quantity
          value: mx.data.e2e-regression.qaa.od-017.quantityProduct2
      - arithmetic:
          expression: ${var_product1_quantity} + ${var_product2_quantity}
          storeIn: var_cartBadge_expectedQuantity
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: ${var_cartBadge_expectedQuantity}

    # STEP 7: Open cart and assert products and quantities are correct ------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 7: OPEN CART.'
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon
      - executeFunction:
          name: mx.functions.cart.assertPageDisplayed
      - executeFunction:
          name: mx.functions.cart.assertCartNotEmpty

      # PRODUCT1 ......................................................................................................
      - executeNode:
          file: mx/test/helpers/utils/calculateProductSubtotal.js
          args:
            - value: ${var_product1_price}
            - value: ${var_product1_quantity}
            - value: "false"
          getResponse:
            storeIn: var_product1_subtotal # Subtotal for Product 1
      - executeFunction:
          name: mx.flows.od.cart.performProductAssertions
          params:
            - name: productName
              string: mx.data.e2e-regression.qaa.od-017.productName1
            - name: productListed
              string: "listed"
            - name: availability
              string: "available"
            - name: expectedQuantity
              string: ${var_product1_quantity}
            - name: expectedWeightQuantity
              string: "null"
            - name: expectedUnitPrice
              string: ${var_product1_price}
            - name: expectedSubtotal
              string: ${var_product1_subtotal}
    
      # PRODUCT2 ......................................................................................................
      - executeNode:
          file: mx/test/helpers/utils/calculateProductSubtotal.js
          args:
            - value: ${var_product2_price}
            - value: ${var_product2_quantity}
            - value: "false"
          getResponse:
            storeIn: var_product2_subtotal # Subtotal for Product 2
      - executeFunction:
          name: mx.flows.od.cart.performProductAssertions
          params:
            - name: productName
              string: mx.data.e2e-regression.qaa.od-017.productName2
            - name: productListed
              string: "listed"
            - name: availability
              string: "available"
            - name: expectedQuantity
              string: ${var_product2_quantity}
            - name: expectedWeightQuantity
              string: "null"
            - name: expectedUnitPrice
              string: ${var_product2_price}
            - name: expectedSubtotal
              string: ${var_product2_subtotal}

    # STEP 8-9: Hit Continuar button and create account ---------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 8-9: HIT CONTINUAR BUTTON AND CREATE ACCOUNT."
            - name: squadNames
              string: CUSTOMER | QAA
      - executeFunction:
          name: mx.functions.cart.tapContinue
      - executeFunction:
          name: mx.functions.login.assertPageDisplayed
      # Create Account ................................................................................................
      - executeFunction:
          name: mx.flows.od.login.createAccountFromLoginPopup
          params:
            - name: userFirstName
              string: mx.data.e2e-regression.qaa.od-017.userFirstName
            - name: userLastName
              string: mx.data.e2e-regression.qaa.od-017.userLastName
            - name: userPassword
              string: mx.data.e2e-regression.qaa.od-017.userPassword
            - name: testCaseNum
              string: '017'
      - executeFunction:
          name: mx.functions.oos.assertPageDisplayed
      - executeFunction:
          name: mx.functions.oos.closePopupIfDisplayed

    # STEP 10-11: Select "Pickup" and select new store -------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 10-11: SELECT PICKUP DELIVERY AND SELECT NEW STORE."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.cart.tapReserveSlot
      - executeFunction:
          name: mx.functions.reserve-slot.address-message-popup.closePopupIfDisplayed
      - executeFunction:
          name: mx.functions.reserve-slot.assertPageDisplayed
      - executeFunction:
          name: mx.functions.reserve-slot.tapPickupDeliveryMethod
      - executeFunction:
          name: mx.functions.reserve-slot.tapChange
      - executeFunction:
          name: mx.functions.store-selector-popup.assertPageDisplayed
      - executeFunction:
          name: mx.functions.store-selector-popup.enterZipCode
          params:
            - name: zipCode
              string: mx.data.e2e-regression.qaa.od-017.zipCodeB
      - executeFunction:
          name: mx.functions.utils.waitUntilMappingDisappear
          params:
            - name: mapping
              string: mx.mappings.store-selector-popup.loadingSpinner
      - executeFunction:
          name: mx.functions.store-selector-popup.selectStore
          params:
            - name: storeName
              string: mx.data.e2e-regression.qaa.od-017.nameStoreB
      - executeFunction:
          name: mx.functions.store-selector-popup.tapSave
      - executeFunction:
          name: mx.functions.oos.deleteAllOOSProducts
      - executeFunction:
          name: mx.functions.reserve-slot.assertSelectedStore
          params:
            - name: storeName
              string: mx.data.e2e-regression.qaa.od-017.nameStoreB

    # STEP 12: Select time slot ---------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 12: SELECT ANY AVAILABLE SLOT."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.reserve-slot.selectDayAfterTomorrowSlot
      - executeFunction:
          name: mx.functions.reserve-slot.selectLastAvailableTimeSlot
      - executeFunction:
          name: mx.functions.reserve-slot.getSelectedDaySlot
      - executeFunction:
          name: mx.functions.reserve-slot.getSelectedTimeSlot
      - executeFunction:
          name: mx.functions.reserve-slot.tapReserve
      - executeFunction:
          name: mx.functions.cart.assertPageDisplayed
      - executeFunction:
          name: mx.functions.cart.assertProductNotListed
          params:
            - name: productName
              string: mx.data.e2e-regression.qaa.od-017.productName1
      - executeFunction:
            name: mx.functions.cart.assertProductListed
            params:
              - name: productName
                string: mx.data.e2e-regression.qaa.od-017.productName2
    # Price changes between stores, retrieving udated product price after store change. 
      - executeFunction:
          name: mx.functions.cart.getProductPrice
          params:
            - name: productName
              string: mx.data.e2e-regression.qaa.od-017.productName2
      - storeIn:
          key: var_product2_updated_price
          value: ${returnedProductPrice}
      - executeFunction:
          name: mx.functions.cart.assertEstimatedTotalFromDetailsSection
          params:
            - name: expectedEstimatedTotal
              string: ${var_product2_updated_price}
      - executeFunction:
          name: mx.functions.cart.assertEstimatedTotalFromBottom
          params:
            - name: expectedEstimatedTotal
              string: ${var_product2_updated_price}
      - executeFunction:
          name: mx.functions.utils.getDeliverySlot
          params:
            - name: forPage
              string: 'Cart'
            - name: selectedDaySlot
              string: ${returnedSelectedDaySlot}
            - name: selectedTimeSlot
              string: ${returnedSelectedTimeSlot}
      - executeFunction:
          name: mx.functions.order-confirmation.assertDeliverySlot
          params:
            - name: expectedDeliverySlot
              string: ${returnedDeliverySlot}

    # STEP 13: Continue Checkout and Asserts Order Review screen is displayed -----------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 13: CONTINUE TO CHECKOUT AND ASSERTS ORDER REVIEW SCREEN IS DISPLAYED"
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.cart.tapContinue
      - executeFunction:
          name: mx.functions.review-order.assertPageDisplayed
      - executeFunction:
          name: mx.functions.review-order.assertDeliveryMethod
          params:
            - name: expectedDeliveryMethod
              string: PickupDelivery
      - executeFunction:
          name: mx.functions.utils.getDeliverySlot 
          params:
            - name: forPage
              string: 'ReviewOrder'
            - name: selectedDaySlot
              string: ${returnedSelectedDaySlot}
            - name: selectedTimeSlot
              string: ${returnedSelectedTimeSlot}
      - executeFunction:
          name: mx.functions.review-order.assertDeliverySlot
          params:
            - name: deliverySlot
              string: ${returnedDeliverySlot}

    # STEP 14: Go to Profile screen and select Addresses --------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 14: GO TO PROFILE SCREEN AND SELECT ADDRESSES"
            - name: squadNames
              string: CUSTOMER | QAA
      - executeFunction:
          name: mx.functions.review-order.tapBack
      - executeFunction:
          name: mx.functions.review-order.almost-done-popup.tapExitPayment
      - executeFunction:
          name: mx.functions.cart.tapBack
      - executeFunction:
          name: mx.functions.bottom-menu.tapAccount
      - executeFunction:
          name: mx.functions.account.assertUserLogged
          params:
            - name: userName
              string: mx.data.e2e-regression.qaa.od-017.userFirstName
      - executeFunction:
          name: mx.functions.account.openAddresses

    # STEP 15: Add new Address as Favorite ----------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 15: ADD A NEW ADDRESS AS FAVORITE"
            - name: squadNames
              string: CUSTOMER | QAA
      - executeFunction:
          name: mx.functions.addresses.assertPageDisplayed
      - executeFunction:
          name: mx.functions.addresses.tapAddAddress
      - executeFunction:
          name: mx.flows.od.addresses.addHomeDeliveryAddressFromPopup
          params:
            - name: userFirstName
              string: mx.data.e2e-regression.qaa.od-017.userFirstName
            - name: userLastName
              string: mx.data.e2e-regression.qaa.od-017.userLastName
            - name: userStreet
              string: mx.data.e2e-regression.qaa.od-017.userStreet
            - name: userExteriorNumber
              string: mx.data.e2e-regression.qaa.od-017.userExteriorNumber
            - name: userInteriorNumber
              string: 'null'
            - name: userZipCode
              string: mx.data.e2e-regression.qaa.od-017.zipCodeB
            - name: userNeighborhood
              string: mx.data.e2e-regression.qaa.od-017.userNeighborhood
            - name: expectedUserState
              string: mx.data.e2e-regression.qaa.od-017.userState
            - name: expectedUserCity
              string: mx.data.e2e-regression.qaa.od-017.userCity
            - name: expectedUserMunicipality
              string: mx.data.e2e-regression.qaa.od-017.userMunicipality
            - name: userPhoneNumber
              string: mx.data.e2e-regression.qaa.od-017.userPhoneNumber
            - name: markAsFavorite
              string: 'true'

      # Assert New address is added ...................................................................................
      - executeFunction:
          name: mx.functions.addresses.tapBack
      - executeFunction:
          name: mx.functions.account.openAddresses
      - executeFunction:
          name: mx.functions.addresses.assertAddressByIndividualValues
          params:
            - name: userFullName
              string: mx.data.e2e-regression.qaa.od-017.userFullName
            - name: expectedStreetName
              string: mx.data.e2e-regression.qaa.od-017.userStreet
            - name: expectedExteriorNumber
              string: mx.data.e2e-regression.qaa.od-017.userExteriorNumber
            - name: expectedCity
              string: mx.data.e2e-regression.qaa.od-017.userCity
            - name: expectedState
              string: mx.data.e2e-regression.qaa.od-017.userState
            - name: expectedZipCode
              string: mx.data.e2e-regression.qaa.od-017.zipCodeB

    # STEP 16: Add new Address without marked as Favorite -------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 16: ADD A NEW ADDRESS WITHOUT MARKING IT AS FAVORITE"
            - name: squadNames
              string: CUSTOMER | QAA
      - executeFunction:
          name: mx.functions.addresses.tapAddAddress
      - executeFunction:
          name: mx.flows.od.addresses.addHomeDeliveryAddressFromPopup
          params:
            - name: userFirstName
              string: mx.data.e2e-regression.qaa.od-017.userFirstName2
            - name: userLastName
              string: mx.data.e2e-regression.qaa.od-017.userLastName2
            - name: userStreet
              string: mx.data.e2e-regression.qaa.od-017.userStreet2
            - name: userExteriorNumber
              string: mx.data.e2e-regression.qaa.od-017.userExteriorNumber2
            - name: userInteriorNumber
              string: 'null'
            - name: userZipCode
              string: mx.data.e2e-regression.qaa.od-017.zipCodeB
            - name: userNeighborhood
              string: mx.data.e2e-regression.qaa.od-017.userNeighborhood2
            - name: expectedUserState
              string: mx.data.e2e-regression.qaa.od-017.userState2
            - name: expectedUserCity
              string: mx.data.e2e-regression.qaa.od-017.userCity2
            - name: expectedUserMunicipality
              string: mx.data.e2e-regression.qaa.od-017.userMunicipality2
            - name: userPhoneNumber
              string: mx.data.e2e-regression.qaa.od-017.userPhoneNumber
            - name: markAsFavorite
              string: 'false'

      # Assert New address is added ...................................................................................
      - executeFunction:
          name: mx.functions.addresses.tapBack
      - executeFunction:
          name: mx.functions.account.openAddresses
      - executeFunction:
          name: mx.functions.addresses.assertAddressByIndividualValues
          params:
            - name: userFullName
              string: mx.data.e2e-regression.qaa.od-017.userFullName2
            - name: expectedStreetName
              string: mx.data.e2e-regression.qaa.od-017.userStreet2
            - name: expectedExteriorNumber
              string: mx.data.e2e-regression.qaa.od-017.userExteriorNumber2
            - name: expectedCity
              string: mx.data.e2e-regression.qaa.od-017.userCity2
            - name: expectedState
              string: mx.data.e2e-regression.qaa.od-017.userState2
            - name: expectedZipCode
              string: mx.data.e2e-regression.qaa.od-017.zipCodeB

      # Validating Address 1 is marked as favorite ....................................................................
      - executeFunction:
          name: mx.functions.addresses.assertAddressIsMarkedAsFavorite
          params:
            - name: userFullName
              string: mx.data.e2e-regression.qaa.od-017.userFullName

      # Validating Address 2 is not marked as favorite ................................................................
      - executeFunction:
          name: mx.functions.addresses.assertAddressIsNotMarkedAsFavorite
          params:
            - name: userFullName
              string: mx.data.e2e-regression.qaa.od-017.userFullName2

    # STEP 17: Go to cart and perform assertions ----------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 17: GO TO CART AND PERFORM ASSERTIONS."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.addresses.tapBack
      - executeFunction:
          name: mx.functions.bottom-menu.tapHome
      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon
      - executeFunction:
          name: mx.functions.cart.assertPageDisplayed
      - executeFunction:
          name: mx.functions.cart.assertCartNotEmpty
      - executeFunction:
          name: mx.functions.cart.assertProductQuantityAsPieces
          params:
            - name: productName
              string: mx.data.e2e-regression.qaa.od-017.productName2
            - name: quantity
              string: mx.data.e2e-regression.qaa.od-017.quantityProduct2

    # STEP 18-20: Reserve slot, select home delivery and select first address added -----------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 18-20: RESERVE SLOT, SELECT HOME DELIVERY AND SELECT FIRST ADDRESS ADDED."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.cart.reserveSlot
          params:
            - name: deliveryMethod
              string: 'HomeDelivery'
            - name: addressName
              string: mx.data.e2e-regression.qaa.od-017.userFullName
            - name: deliveryPlaceAction
              string: 'Change'
            - name: slotDate
              string: 'dayAfterTomorrow'
            - name: slotTime
              string: 'lastAvailable'
      - executeFunction:
          name: mx.flows.od.cart.assertHomeSlotSelected
          params:
            - name: deliverySlot
              string: ${returnedDeliverySlot}
            - name: expectedUserStreet
              string: mx.data.e2e-regression.qaa.od-017.userStreet
            - name: expectedUserExteriorNumber
              string: mx.data.e2e-regression.qaa.od-017.userExteriorNumber
            - name: expectedDeliveryFee
              string: ${returnedDeliveryFee}

    # STEP 21: Continue Checkout --------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 21: CONTINUE TO CHECKOUT"
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.cart.tapContinue
      - executeFunction:
          name: mx.functions.missing-something.continueWithoutSelectionIfPageDisplayed 
      - executeFunction:
          name: mx.functions.review-order.assertPageDisplayed
      - executeFunction:
          name: mx.functions.review-order.assertDeliveryMethod
          params:
            - name: expectedDeliveryMethod
              string: 'HomeDelivery'
      - executeFunction:
          name: mx.functions.review-order.assertHomeDeliveryAddressByIndividualValues
          params:
            - name: streetName
              string: mx.data.e2e-regression.qaa.od-017.userStreet
            - name: exteriorNumber
              string: mx.data.e2e-regression.qaa.od-017.userExteriorNumber
            - name: city
              string: mx.data.e2e-regression.qaa.od-017.userCity
            - name: state
              string: mx.data.e2e-regression.qaa.od-017.userState
            - name: zipCode
              string: mx.data.e2e-regression.qaa.od-017.zipCodeB
      - scroll:
          direction: down
          untilIdentifier: mx.mappings.review-order.deliveryFeeValue
      - executeFunction:
          name: mx.functions.review-order.assertDeliveryFee
          params:
            - name: deliveryFee
              string: ${returnedDeliveryFee}

    # STEP 22-23: Get back to cart and change shipping details ---------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 22-23: GET BACK TO CART AND CHANGE SHIPPING DETAILS"
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.review-order.tapBack
      - executeFunction:
          name: mx.functions.review-order.almost-done-popup.tapExitPayment
          
    # STEP 24: Select Home Delivery and select the second address added --------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 24: SELECT HOME DELIVERY AND SELECT SECOND ADDRESS ADDED."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.cart.assertPageDisplayed
      - executeFunction:
          name: mx.flows.od.cart.reserveSlot
          params:
            - name: deliveryMethod
              string: 'HomeDelivery'
            - name: addressName
              string: mx.data.e2e-regression.qaa.od-017.userFullName2
            - name: deliveryPlaceAction
              string: 'Change'
            - name: slotDate
              string: 'dayAfterTomorrow'
            - name: slotTime
              string: 'lastAvailable'
      # Assert second address is selected .............................................................................
      - executeFunction:
          name: mx.flows.od.cart.assertHomeSlotSelected
          params:
            - name: deliverySlot
              string: ${returnedDeliverySlot}
            - name: expectedUserStreet
              string: mx.data.e2e-regression.qaa.od-017.userStreet2
            - name: expectedUserExteriorNumber
              string: mx.data.e2e-regression.qaa.od-017.userExteriorNumber2
            - name: expectedDeliveryFee
              string: ${returnedDeliveryFee}
      - executeFunction:
          name: mx.functions.cart.getProductPrice
          params:
            - name: productName
              string: mx.data.e2e-regression.qaa.od-017.productName2
      - storeIn:
          key: var_product2_final_price
          value: ${returnedProductPrice}

    # STEP 25-26: Continue checkout and select pay at delivery --------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 25-26: CONTINUE TO CHECKOUT AND SELECT PAY AT DELIVERY."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.cart.tapContinue
      - executeFunction:
          name: mx.functions.missing-something.continueWithoutSelectionIfPageDisplayed
      - executeFunction:
          name: mx.functions.review-order.assertPageDisplayed
      - executeFunction:
          name: mx.functions.review-order.assertDeliveryMethod
          params:
            - name: expectedDeliveryMethod
              string: "HomeDelivery"
      - executeFunction:
          name: mx.functions.review-order.assertHomeDeliveryAddressByIndividualValues
          params:
            - name: streetName
              string: mx.data.e2e-regression.qaa.od-017.userStreet2
            - name: exteriorNumber
              string: mx.data.e2e-regression.qaa.od-017.userExteriorNumber2
            - name: city
              string: mx.data.e2e-regression.qaa.od-017.userCity2
            - name: state
              string: mx.data.e2e-regression.qaa.od-017.userState2
            - name: zipCode
              string: mx.data.e2e-regression.qaa.od-017.zipCodeB
      # Select Pay At Delivery ........................................................................................
      - executeFunction:
          name: mx.functions.review-order.scrollDownToSection
          params:
            - name: sectionName
              string: "Pago"
      - executeFunction:
          name: mx.flows.od.review-order.forceSelectPayAtDeliveryMethod
          params:
            - name: payAtDeliveryOption
              string: cash
      - executeFunction:
          name: mx.functions.utils.scrollToTop
          params:
            - name: elementAtTheTop
              string: mx.mappings.review-order.deliveryHeaderContainer
      # This function adds the delivery message to the Walmart team so they do not deliver the products................
      - executeFunction:
          name: mx.flows.od.review-order.enterTestOrderDisclaimer
      - executeFunction:
          name: mx.functions.review-order.scrollDownToSection
          params:          
            - name: sectionName
              string: "Número telefónico"
      - executeFunction:
          name: mx.functions.review-order.enterCellphoneNumber
          params:
            - name: userPhoneNumber
              string: mx.data.e2e-regression.qaa.od-017.userPhoneNumber
      - scroll:
          direction: down
          untilIdentifier: mx.mappings.review-order.subtotalTitle
      - executeFunction:
          name: mx.functions.review-order.assertDeliveryFee
          params:
            - name: deliveryFee
              string: ${returnedDeliveryFee}
      - arithmetic:
          expression: ${var_product2_final_price} + ${returnedDeliveryFee}
          storeIn: qaa_od017_total
      - executeFunction:
          name: mx.functions.review-order.assertEstimatedTotalFromButton
          params:
            - name: estimatedTotalFromButton
              string: ${qaa_od017_total}
          
    # STEP 27: Place order and execute assertions for order-confirmation ----------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 27: PLACE ORDER AND PERFORM ASSERTIONS FOR ORDER CONFIRMATION"
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.review-order.tapPlaceOrder
      - storeIn:
          key: qaa_od017_ordered_date
          value: ${returnedOrderedDate}
      - sleep:
          duration: 5000
      # Order Confirmation Assertions .................................................................................
      - executeFunction:
          name: mx.functions.order-confirmation.assertPageDisplayed
      - executeFunction:
          name: mx.functions.order-confirmation.getOrderNumber
      - storeIn:
          key: qaa_od017_order_number
          value: ${returnedOrderNumber}
          # [VARIABLE] Order number saved in ${qaa_od017_order_number}"
      - executeFunction:
          name: mx.functions.order-confirmation.assertDeliveryMethod
          params:
            - name: expectedDeliveryMethod
              string: "HomeDelivery"
      - executeFunction:
          name: mx.functions.order-confirmation.assertHomeDeliveryAddressName
          params:
            - name: expectedHomeAddressName
              string: mx.data.e2e-regression.qaa.od-017.userFullName2
      - executeFunction:
          name: mx.functions.order-confirmation.assertHomeDeliveryAddressByIndividualValues
          params:
            - name: streetName
              string: mx.data.e2e-regression.qaa.od-017.userStreet2
            - name: exteriorNumber
              string: mx.data.e2e-regression.qaa.od-017.userExteriorNumber2
            - name: city
              string: mx.data.e2e-regression.qaa.od-017.userCity2
            - name: state
              string: mx.data.e2e-regression.qaa.od-017.userState2
            - name: zipCode
              string: mx.data.e2e-regression.qaa.od-017.zipCodeB
      - executeFunction:
          name: mx.functions.utils.getDeliverySlot
          params:
            - name: forPage
              string: 'OrderConfirmation'
            - name: selectedDaySlot
              string: ${returnedSelectedDaySlot}
            - name: selectedTimeSlot
              string: ${returnedSelectedTimeSlot}
      - executeFunction:
          name: mx.functions.order-confirmation.assertDeliverySlot
          params:
            - name: expectedDeliverySlot
              string: ${returnedDeliverySlot}

    # STEP 28: Hit find more products and assert home page is displayed -----------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 28: HIT 'DESCUBRIR MAS PRODUCTOS' BUTTON."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.order-confirmation.tapFindMoreProducts
      - executeFunction:
          name:  mx.functions.bottom-menu.tapHome
      - executeFunction:
          name: mx.functions.home.assertPageDisplayed

    # STEP 29: Go to Profile screen and select "Pedidos" --------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 29: GO TO PROFILE AND SELECT 'PEDIDOS'"
            - name: squadNames
              string: POST-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.bottom-menu.tapAccount
      - sleep:
          duration: 10000
      - executeFunction:
          name: mx.functions.account.assertPageDisplayed
      - executeFunction:
          name: mx.functions.account.openOrdersHistory
      - executeFunction:
          name: mx.flows.od.orders-history.assertOrder
          params:
            - name: orderNumber
              string: ${qaa_od017_order_number}
            - name: expectedDeliveryMethod
              string: mx.data.e2e-regression.qaa.od-017.deliveryMethod
            - name: expectedTotal
              string: ${qaa_od017_total}
            - name: expectedBanner
              string: mx.data.e2e-regression.qaa.od-017.banner
            - name: expectedDaySlot
              string: ${returnedSelectedDaySlot}
            - name: expectedTimeSlot
              string: ${returnedSelectedTimeSlot}
            - name: expectedOrderStatus
              string: mx.data.e2e-regression.qaa.od-017.expectedOrderStatus
            - name: expectedProductsCount
              string: mx.data.e2e-regression.qaa.od-017.differentProductsCount

   # STEP 30: Select the newest placed order and perform order assertions --------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 30: SELECT THE NEWEST PLACED ORDER"
            - name: squadNames
              string: POST-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.orders-history.openOrder
          params:
            - name: orderNumber
              string: ${qaa_od017_order_number}
      - storeIn:
          key: qaa_od017_subtotal
          value: ${var_product2_final_price}
      - storeIn:
          key: var_product2_subtotal
          value: ${var_product2_updated_price}
      - executeFunction:
          name: mx.flows.od.order-details.assertOrderDetails
          params:
            - name: expectedOrderNumber
              string: ${qaa_od017_order_number}
            - name: expectedDeliveryMethod
              string: mx.data.e2e-regression.qaa.od-017.deliveryMethod
            - name: expectedOrderStatus
              string: mx.data.e2e-regression.qaa.od-017.expectedOrderStatus
            - name: expectedBanner
              string: mx.data.e2e-regression.qaa.od-017.banner
            - name: expectedDaySlot
              string: ${returnedSelectedDaySlot}
            - name: expectedTimeSlot
              string: ${returnedSelectedTimeSlot}
            # Address assertions ......................................................................................
            - name: expectedHomeAddressName
              string: mx.data.e2e-regression.qaa.od-017.userFullName2
            - name: expectedUserStreet
              string: mx.data.e2e-regression.qaa.od-017.userStreet2
            - name: expectedUserExteriorNumber
              string: mx.data.e2e-regression.qaa.od-017.userExteriorNumber2
            - name: expectedUserCity
              string: mx.data.e2e-regression.qaa.od-017.userCity2
            - name: expectedUserState
              string: mx.data.e2e-regression.qaa.od-017.userState2
            - name: expectedUserZipCode
              string: mx.data.e2e-regression.qaa.od-017.zipCodeB
            # Order assertions ........................................................................................
            - name: expectedProductsCount
              string: mx.data.e2e-regression.qaa.od-017.differentProductsCount
            - name: expectedPaymentMethod
              string: mx.data.e2e-regression.qaa.od-017.orderDetailsPaymentMethod
            - name: expectedSubtotal
              string: ${qaa_od017_subtotal}
            - name: assertDiscount
              string: 'false'
            - name: expectedDeliveryFee
              string: ${returnedDeliveryFee}
            - name: expectedTotal
              string: ${qaa_od017_total}
            - name: expectedOrderedDate
              string: ${qaa_od017_ordered_date}
      
      # Product 1 assertions ..........................................................................................
      - executeFunction:
          name: mx.functions.utils.scrollToTop
          params:
            - name: elementAtTheTop
              string: mx.mappings.order-details.orderNumber
      - executeFunction:
          name: mx.functions.order-details.expandProductsDetailsIfNotExpanded
      - sleep:
          duration: 3000
      - executeFunction:
          name: mx.flows.od.order-details.assertProductDetails
          params:
            - name: productName
              string: mx.data.e2e-regression.qaa.od-017.productName2
            - name: expectedPrice
              string: ${var_product2_updated_price}
            - name: expectedSubtotal
              string: ${var_product2_subtotal}
            - name: productType
              string: ${qaa_od017_product_type_2}
            - name: expectedOrderedQuantityAsPieces
              string: mx.data.e2e-regression.qaa.od-017.quantityProduct2

      - storeIn:
          key: OD_017_SUCCESSFUL_EXECUTION
          value: true

      - log: END OF TEST - QAA - OD - PRODUCTION SANITY - OD-017

  #####################################################################################################################

  - name: Before
    before: true
    flow:
      - log: "BEFORE SCENARIO START: Initial Config..."
      - executeFunction:
          name: mx.squad-reporting.setTestCaseName
          params:
            - name: testCaseName
              string: GMX_OD_Sanity_PROD_Android_017
      - executeFunction:
          name: mx.functions.utils.relaunchApp
      - storeIn:
          key: OD_017_SUCCESSFUL_EXECUTION
          value: false
      - storeIn:
          key: selectedStore
          value: mx.data.e2e-regression.qaa.od-017.nameStoreA
      - log: "BEFORE SCENARIO END"

  #####################################################################################################################

  - name: After
    after: true
    flow:
      - log: "AFTER SCENARIO START: Test Data Reset..."
      - executeFunction:
          name: mx.squad-reporting.logTestCaseFailure
          params:
            - name: testCaseExecutionStatus
              string: ${OD_017_SUCCESSFUL_EXECUTION}
      - if:
          condition: ${OD_017_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "No need to reset data (Account Creation)."
                color: CYAN
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
      - log: "AFTER SCENARIO END"