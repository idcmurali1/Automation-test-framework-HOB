#======================================================================================================================
#    AUTHOR: Isis Rojas Tolentino (vn53dge)
#   CREATED: Jun/9/2023
#  REVISION: ---
#
#  Copyright © 2023 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: qaa-od-sanity-production-android-011, qaa-od-sanity-production-android
  testCaseId: MXMOB-1362

scenarios:

  #####################################################################################################################
  #
  #  CONFLUENCE TRACKING DASHBOARD:
  #    https://confluence.walmart.com/display/MXGECMEX/MXMOB-QAA%3A+Tracking%3A+Test+Suite%3A+GlassMX+-+OD+-+Sanity+-+Production+-+Android
  #
  #  JIRA AUTOMATION TC:
  #    https://jira.walmart.com/browse/MXMOB-1362
  #
  #  JIRA MANUAL TC:
  #    https://jira.walmart.com/browse/MXMOB-1943
  #
  # Flags Used:
  #       ${ASSERT_DELIVERY_SLOT_IN_CART}  -  Values: [true | false]
  #       ${ASSERT_DELIVERY_SLOT_IN_REVIEW_ORDER}  -  Values: [true | false]  
  #       ${ASSERT_DELIVERY_SLOT_IN_ORDER_CONFIRMATION}  -  Values: [true | false]
  #       ${ASSERT_DELIVERY_SLOT_IN_ORDERS_HISTORY}  -  Values: [true | false]
  #       ${ASSERT_DELIVERY_SLOT_IN_ORDER_DETAILS}  -  Values: [true | false]
  #####################################################################################################################

  - name: Main
    flow:
      - log: 
          message: "TEST START: QAA - OD - PRODUCTION SANITY - OD-011"
          color: CYAN

    # STEP 1-2: Navigate through Onboarding and select OD Banner ----------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 1-2: NAVIGATE ONBOARDING AND SELECT OD BANNER."
            - name: squadNames
              string: CORE | QAA
      - executeFunction:
          name: mx.flows.global.onboarding.navigateToHomeAsGuestUser
          params:
            - name: zipCode
              string: mx.data.qaa.sanity.od-011.zipCode
            - name: banner
              string: "OD"
    
    # STEP 3: Go to Profile screen and Create and account -------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 3: GO TO PROFILE SCREEN AND CREATE ACCOUNT."
            - name: squadNames
              string: CUSTOMER | QAA
      - executeFunction:
          name: mx.functions.bottom-menu.tapAccount
      - executeFunction:
          name: mx.functions.account.tapLogin
      - executeFunction:
          name: mx.flows.od.login.createAccountFromLoginPopup
          params:
            - name: userFirstName
              string: mx.data.qaa.sanity.od-011.userFirstName
            - name: userLastName
              string: mx.data.qaa.sanity.od-011.userLastName
            - name: userPassword
              string: mx.data.qaa.sanity.od-011.userPassword
            - name: testCaseNum
              string: '011'
      - storeIn:
          key: qaa_od011_user_email
          value: ${returnedUniqueEmail}
      - executeFunction:
          name: mx.functions.account.assertUserLogged
          params:
            - name: userName
              string: mx.data.qaa.sanity.od-011.userFirstName

    # STEP 4: Go to Personal Information section and assert user information is correct -------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 4: GO TO PERSONAL INFORMATION SECTION AND PERFORM ASSERTION."
            - name: squadNames
              string: CUSTOMER | QAA
      - executeFunction:
          name: mx.functions.account.openPersonalInformation
      - executeFunction:
          name: mx.functions.personal-information.assertUserName
          params:
            - name: userFirstName
              string: mx.data.qaa.sanity.od-011.userFirstName
      - executeFunction:
          name: mx.functions.personal-information.assertEmail
          params:
            - name: userEmail
              string: ${qaa_od011_user_email}
      - goBack: true
      - executeFunction:
          name: mx.functions.bottom-menu.tapHome

  # Changing store.....................................................................................................
      - executeFunction:
          name: mx.functions.home.scrollUpToLocationBanner
      - if:
          identifier:
            present:
              - identifier: mx.mappings.delivery-method-selector.expandLocationBanner
          then:
            - executeFunction:
                name: mx.functions.delivery-method-selector.expandSelector
            - executeFunction:
                name: mx.functions.delivery-method-selector.tapPickupButtonIfNotSelected
            - executeFunction:
                name: mx.flows.od.delivery-method-selector.changeStoreFromSelector
                params:
                  - name: zipCode
                    string: mx.data.qaa.sanity.od-011.zipCode
                  - name: storeName
                    string: mx.data.qaa.sanity.od-011.storeName
            - executeFunction:
                name: mx.functions.delivery-method-selector.closeSelector
          else:
            - log: "Selecting store: '${selectedStore}'..."
            - executeFunction:
                name: mx.functions.home.tapStoreSelector
            - executeFunction:
                name: mx.functions.store-selector-popup.assertPageDisplayed
            - executeFunction:
                name: mx.flows.od.store-selector-popup.quickChangeStoreFromPopup
                params:
                  - name: zipCode
                    string: mx.data.qaa.sanity.od-011.zipCode
                  - name: storeName
                    string: mx.data.qaa.sanity.od-011.storeName

    # STEP 5: Perform a search ----------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 5: PERFORM A SEARCH."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      - executeFunction:
          name: mx.flows.od.search.performSuccessfulSearch
          params:
            - name: searchTerm
              string: mx.data.qaa.sanity.od-011.productSearch
      - executeFunction:
          name: mx.functions.slp.getProductNameBetweenPriceRange
          params:
            - name: minPrice
              string: "1499"
            - name: maxPrice
              string: "3000"
      - storeIn:
          key: original_product_price
          value: ${returnedOriginalPrice}

    # STEP 6-7: Add product to cart and increase product quantity to exceed delivery threshold ------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 6-7: ADD PRODUCT TO CART AND ICREASE PRODUCT QUANTITY TO EXCEED DELIVERY THRESHOLD.'
            - name: squadNames
              string: PRE-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.slp.addProductToCart
          params:
            - name: productName
              string: ${returnedProductNameBetweenPriceRange}
      - storeIn:
          key: var_product1_price  # Product 1 price
          value: ${returnedProductPriceBetweenPriceRange}
      - sleep:
          duration: 5000
      - executeFunction:
          name: mx.functions.slp.increaseProductQuantityToExceedHomeDeliveryThreshold
          params:
            - name: productName
              string: ${returnedProductNameBetweenPriceRange}
      - executeFunction:
          name: mx.functions.slp.getProductQuantityAsPieces # --RETURNS--${returnedProductPieces}-->  
          params:
            - name: productName
              string: ${returnedProductNameBetweenPriceRange}
      - storeIn:
          key: var_product1_quantity
          value: ${returnedProductPieces}
      # Cart Badge Quantity Validation ................................................................................
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: ${var_product1_quantity}

    # STEP 8: Open cart and assert products and quantities are correct ------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 8: OPEN CART AND PERFORM PRODUCT ASSERTIONS.'
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon
      - executeFunction:
          name: mx.functions.cart.assertPageDisplayed
      - executeFunction:
          name: mx.functions.cart.assertCartNotEmpty
      - storeIn:
          key: var_product1_subtotal
          value: ${returnedSummarySubtotal}
      - executeFunction:
          name: mx.functions.cart.assertProductQuantityAsPieces
          params:
            - name: productName
              string: ${returnedProductNameBetweenPriceRange}
            - name: expectedQuantity
              string: ${var_product1_quantity}

    # STEP 9-10: Reserve time slot and delivery method ----------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 9-10: RESERVE TIME SLOT AND PICKUP DELIVERY METHOD."
            - name: squadNames
              string: PURCHASE | QAA  
      - executeFunction:
          name: mx.flows.od.cart.reserveSlot
          params:
            - name: deliveryMethod
              string: 'PickupDelivery'
            - name: deliveryPlaceAction
              string: 'Maintain'
            - name: slotDate
              string: 'lastAvailable'
            - name: slotTime
              string: 'lastAvailable'
            - name: storeName
              string: 'WM Tepeyac'

    # STEP 11: Continue to Checkout -----------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 11: CONTINUE TO CHECKOUT."
            - name: squadNames
              string: PURCHASE | QAA
      - sleep:
          duration: 3000
      - executeFunction:
          name: mx.functions.cart.tapContinue
      - sleep:
          duration: 3000
      - executeFunction:
          name: mx.functions.review-order.assertPageDisplayed

    # STEP 12: Add new payment method and assert pay at delivery not available ----------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 12: ADD NEW PAYMENT METHOD AND ASSERT PAY AT DELIVERY NOT AVAILABLE."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.review-order.scrollDownToSection
          params:
            - name: sectionName
              string: "Pago"
      - executeFunction:
          name: mx.functions.review-order.payment-section.tapChangePaymentMethod
      - executeFunction:
          name: mx.functions.payment.assertPageDisplayed
      - executeFunction:
          name: mx.functions.payment.scrollDownToPayAtDelivery
      - executeFunction:
          name: mx.functions.payment.assertPayAtDeliveryNotAvailable
      - executeFunction:
          name: mx.functions.payment.tapClose
      - executeFunction:
          name: mx.functions.utils.scrollToTop
          params:
            - name: elementAtTheTop
              string: mx.mappings.review-order.deliveryHeaderContainer
      - executeFunction:
          name: mx.functions.review-order.assertPageDisplayed

    # STEP 13-14: Go back to cart, search product exceeded pay at delivery and decrease quantity ----------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 13-14: GO BACK TO CART, SEARCH PRODUCT EXCEEDED PAY AT DELIVERY THRESHOLD AND DECREASE QUANTITY."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.review-order.tapBack
      - executeFunction:
          name: mx.functions.review-order.almost-done-popup.tapExitPayment
      - executeFunction:
          name: mx.functions.cart.assertPageDisplayed
      - executeFunction:
          name: mx.functions.cart.tapBack
      - executeFunction:
          name: mx.functions.slp.scrollDownToProductByName
          params:
            - name: productName
              string: ${returnedProductNameBetweenPriceRange}
      - executeFunction:
          name: mx.functions.slp.assertProductDisplayed
          params:
            - name: productName
              string: ${returnedProductNameBetweenPriceRange}
      - executeFunction:
          name: mx.functions.slp.decreaseProductQuantityBy
          params:
            - name: productName
              string: ${returnedProductNameBetweenPriceRange}
            - name: quantity
              string: "1"
      - executeFunction:
          name: mx.functions.slp.getProductQuantityAsPieces
          params:
            - name: productName
              string: ${returnedProductNameBetweenPriceRange}
      - storeIn:
          key: var_product1_quantity
          value: ${returnedProductPieces}
      # Cart Badge Quantity Validation ................................................................................
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: ${var_product1_quantity}
      - executeNode:
          file: mx/test/helpers/utils/calculateProductSubtotal.js
          args:
            - value: ${var_product1_quantity}
            - value: ${var_product1_price}
            - value: "false"
          getResponse:
            storeIn: var_product1_subtotal

      - executeNode:
          file: mx/test/helpers/utils/numberToNumberWithComa.js
          args:
            - value: ${var_product1_subtotal}
          getResponse:
            storeIn: varTC_cart_total
            
    # STEP 15: Open cart and assert product quantities ----------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 15: OPEN CART AND ASSERT PRODUCT QUANTITIES.'
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon
      - executeFunction:
          name: mx.functions.cart.assertPageDisplayed
      - executeFunction:
          name: mx.flows.od.cart.performProductAssertions
          params:
            - name: productName
              string: ${returnedProductNameBetweenPriceRange}
            - name: productListed
              string: "listed"
            - name: availability
              string: "available"
            - name: expectedQuantity
              string: "1"
            - name: expectedWeightQuantity
              string: "null"
            - name: expectedUnitPrice
              string: ${var_product1_price}
            - name: expectedSubtotal
              string: ${var_product1_subtotal}

    # STEP 16-17: Continue to checkout and select pay at delivery ---------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 16-17: CONTINUE TO CHECKOUT AND SELECT PAY AT DELIVERY."
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.cart.tapContinue
      - executeFunction:
          name: mx.functions.missing-something.continueWithoutSelectionIfPageDisplayed
      - executeFunction:
          name: mx.functions.review-order.assertPageDisplayed
      - executeFunction:
          name: mx.functions.utils.scrollToTop
          params:
            - name: elementAtTheTop
              string: mx.mappings.review-order.deliveryHeaderContainer
      - executeFunction:
          name: mx.functions.review-order.assertDeliveryMethod
          params:
            - name: expectedDeliveryMethod
              string: mx.data.qaa.sanity.od-011.deliveryMethod
      - executeFunction:
          name: mx.functions.review-order.scrollDownToSection
          params:          
            - name: sectionName
              string: "Pago"
      - executeFunction:
          name: mx.flows.od.review-order.forceSelectPayAtDeliveryMethod
          params:
            - name: payAtDeliveryOption
              string: cash

    # STEP 18: Place order and execute assertions for order-confirmation ----------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 18: PLACE ORDER AND PERFORM ASSERTIONS FOR ORDER CONFIRMATION"
            - name: squadNames
              string: PURCHASE | QAA
      - executeFunction:
          name: mx.functions.utils.scrollToTop
      # This function adds the delivery message to the Walmart team so they do not deliver the products.
      - executeFunction:
          name: mx.flows.od.review-order.enterTestOrderDisclaimer
      - executeFunction:
          name: mx.functions.review-order.scrollDownToSection
          params:          
            - name: sectionName
              string: "Número telefónico"
      - executeFunction:
          name: mx.functions.review-order.enterCellphoneNumber
          params:
            - name: userPhoneNumber
              string: mx.data.qaa.sanity.od-011.userPhoneNumber
      - executeFunction:
          name: mx.functions.review-order.assertEstimatedTotalFromButton
          params:
            - name: estimatedTotalFromButton
              string: ${varTC_cart_total}
      - executeFunction:
          name: mx.functions.review-order.tapPlaceOrder
      - executeNode:
          file: mx/test/helpers/utils/getTodaysDateAsStringForAssertion.js
          getResponse:
            storeIn: varTC_OrderDate
      - sleep:
          duration: 5000

      # Order Confirmation Assertions .................................................................................
      - executeFunction:
          name: mx.functions.order-confirmation.assertPageDisplayed
      - executeFunction:
          name: mx.functions.order-confirmation.getOrderNumber
      - storeIn:
          key: qaa_od011_order_number
          value: ${returnedOrderNumber}
          # [VARIABLE] Order number saved in ${qaa_od011_order_number}"
      - executeFunction:
          name: mx.functions.order-confirmation.assertDeliveryMethod
          params:
            - name: expectedDeliveryMethod
              string: mx.data.qaa.sanity.od-011.deliveryMethod
      - storeIn:
          key: qaa_od011_total
          value: ${var_product1_subtotal}

    # STEP 19: Hit find more products and assert home page is displayed -----------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 19: HIT 'DESCUBRIR MAS PRODUCTOS' BUTTON."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.order-confirmation.tapFindMoreProducts
      - executeFunction:
          name:  mx.functions.bottom-menu.tapHome
      - executeFunction:
          name: mx.functions.home.assertPageLoaded

    # STEP 20: Go to Profile screen and select "Pedidos" --------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 20: GO TO PROFILE AND SELECT 'PEDIDOS'"
            - name: squadNames
              string: POST-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.bottom-menu.tapAccount
      - sleep:
          duration: 10000
      - executeFunction:
          name: mx.functions.account.assertPageDisplayed
      - executeFunction:
          name: mx.functions.account.openOrdersHistory
      - executeFunction:
          name: mx.flows.od.orders-history.assertOrder
          params:
            - name: orderNumber
              string: ${qaa_od011_order_number}
            - name: expectedDeliveryMethod
              string: mx.data.qaa.sanity.od-011.deliveryMethod
            - name: expectedTotal
              string: ${qaa_od011_total}
            - name: expectedBanner
              string: mx.data.qaa.sanity.od-011.banner
            - name: expectedDaySlot
              string: ${returnedSelectedDaySlot}
            - name: expectedTimeSlot
              string: ${returnedSelectedTimeSlot}
            - name: expectedOrderStatus
              string: mx.data.qaa.sanity.od-011.expectedOrderStatus
            - name: expectedProductsCount
              string: mx.data.qaa.sanity.od-011.differentProductsCount

    # STEP 21: Select the newest placed order and perform order assertions --------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 21: SELECT THE NEWEST PLACED ORDER."
            - name: squadNames
              string: POST-PURCHASE | QAA
      - executeFunction:
          name: mx.functions.orders-history.openOrder
          params:
            - name: orderNumber
              string: ${qaa_od011_order_number}
      - sleep:
          duration: 5000
      - scroll:
          direction: down
          untilIdentifier: mx.mappings.order-details.discountValue
      - executeFunction:
          name: mx.functions.order-details.getDiscountFromTotalsSection #--[RETURNS]--${returnedDiscount}-->
      - arithmetic:
          expression: ${var_product1_subtotal} + ${returnedDiscount} * (-1))# This is because the discount value contains the minus sign.
          numberOfDecimalPlaces: 2
          storeIn: updatedSubtotal
      - scroll:
          direction: up
          scrollLimit: 2
              
      - executeFunction:
          name: mx.flows.od.order-details.assertOrderDetailsWithoutDeliveryLocationAssertion
          params:
            - name: orderNumber
              string: ${qaa_od011_order_number}
            - name: expectedOrderedDate
              string: ${varTC_OrderDate}
            - name: expectedDeliveryMethod
              string: mx.data.qaa.sanity.od-011.deliveryMethod
            - name: expectedOrderStatus
              string: mx.data.qaa.sanity.od-011.expectedOrderStatus
            - name: expectedBanner
              string: mx.data.qaa.sanity.od-011.banner
            - name: expectedDaySlot
              string: ${returnedSelectedDaySlot}
            - name: expectedTimeSlot
              string: ${returnedSelectedTimeSlot}
            - name: expectedProductsCount
              string: mx.data.qaa.sanity.od-011.differentProductsCount
            - name: expectedPaymentMethod
              string: PayAtDelivery
            - name: expectedSubtotal
              string: ${updatedSubtotal}
            - name: assertDiscount
              string: false
            - name: expectedDeliveryFee
              string: "0.00"
            - name: expectedTotal
              string: ${qaa_od011_total}

      # Product Assertions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
      - executeFunction:
          name: mx.flows.od.order-details.assertProductDetails
          params:
            - name: productName
              string: ${returnedProductNameBetweenPriceRange}
            - name: expectedPrice
              string: ${original_product_price}
            - name: expectedSubtotal
              string: ${var_product1_price}
            - name: productType
              string: Pieces
            - name: expectedOrderedQuantityAsPieces
              string: "1"

      - storeIn:
          key: OD_011_SUCCESSFUL_EXECUTION
          value: true

      - log: "TEST END: QAA - OD - PRODUCTION SANITY - OD-011"

  #####################################################################################################################

  - name: Before
    before: true
    flow:
      - log: "BEFORE SCENARIO START: Initial Config..."
      - executeFunction:
          name: mx.squad-reporting.setTestCaseName
          params:
            - name: testCaseName
              string: GMX_OD_Sanity_PROD_Android_011
      - executeFunction:
          name: mx.functions.utils.relaunchApp
      - storeIn:
          key: OD_011_SUCCESSFUL_EXECUTION
          value: false
      - log: "BEFORE SCENARIO END"

  #####################################################################################################################

  - name: After
    after: true
    flow:
      - log: "AFTER SCENARIO START: Test Data Reset..."
      - executeFunction:
          name: mx.squad-reporting.logTestCaseFailure
          params:
            - name: testCaseExecutionStatus
              string: ${OD_011_SUCCESSFUL_EXECUTION}
      - if:
          condition: ${OD_011_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "No need to reset data (Account Creation)."
                color: CYAN
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
      - log: "AFTER SCENARIO END"

