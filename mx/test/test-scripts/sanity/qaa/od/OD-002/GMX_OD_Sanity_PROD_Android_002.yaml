#======================================================================================================================
#    AUTHOR: Francisco Ramirez (vn53vq4)
#   CREATED: May/09/2023
#  REVISION: ---
#
#  Copyright © 2023 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: qaa-od-sanity-production-android-002, qaa-od-sanity-production-android
  testCaseId: MXMOB-1371
  
scenarios:
#######################################################################################################################
#
#  CONFLUENCE TRACKING DASHBOARD:
#    https://confluence.walmart.com/display/MXGECMEX/MXMOB-QAA%3A+Tracking%3A+Test+Suite%3A+GlassMX+-+OD+-+Sanity+-+Production+-+Android
#
#  JIRA MANUAL TC:
#    https://jira.walmart.com/browse/MXMOB-1934
#
#  JIRA AUTOMATION TC:
#    https://jira.walmart.com/browse/MXMOB-1371
#
#---------------------------------------------------------------------------------------------------------------------

  - name: Main
    flow:
      - log: "TEST START: QAA - OD - PRODUCTION SANITY - OD-002"

      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 1-2: LAUNCH AND LOGIN IN ONBOARDING SCREEN - SELECT OD BANNER."
            - name: squadNames
              string: CORE | QAA
      
      - executeFunction:
          name: mx.flows.global.onboarding.navigateToHomeAsGuestUser
          params:
            - name: zipCode
              string: mx.data.e2e-regression.od-002.zipCode
            - name: banner
              string: "OD"
              
      #----------------------------------------------------------------------------------------------------------------
      - executeFunction: 
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 3: Select store and search for products to add to cart."
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.delivery-method-selector.expandSelectorIfCollapsed

      - executeFunction:
          name: mx.functions.delivery-method-selector.tapStoreSelector
      
      - executeFunction:
          name: mx.functions.store-selector-popup.enterZipCode
          params:
            - name: zipCode
              string: "11220"
      
      - executeFunction:
          name: mx.functions.store-selector-popup.selectStoreByPosition
          params:
            - name: storeIndex
              string: "0" # Toreo
      
      #----------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 4: NAVIGATE THROUGH DEPARTMENTS AND ADD PRODUCTS TO CART."
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.bottom-menu.tapDepartments
      
      - executeFunction:
          name: mx.functions.departments.selectDepartment 
          params:
            - name: departmentName
              string: mx.data.e2e-regression.od-002.departmentName

      - executeFunction:
          name: mx.functions.department-l1-l2.assertPageDisplayed
      
      - executeFunction:
          name: mx.functions.department-l1-l2.scrollDownToSection
          params:
            - name: sectionName
              string: mx.functions.department-l1-l2.section-carousel.sectionName

      - executeFunction:
          name: mx.functions.department-l1-l2.section-carousel.addProductToCart
          params:
            - name: productName
              string: mx.data.e2e-regression.od-002.productName1

      - executeFunction:
          name: mx.functions.department-l1-l2.section-carousel.getProductPrice
          params:
            - name: productName
              string: mx.data.e2e-regression.od-002.productName1

      - storeIn:
          key: product1Price
          value: ${price}

      #---------------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 5: SEARCH PRODUCTS."
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.bottom-menu.tapHome
      
      - executeFunction:
          name: mx.functions.top-menu.enterSearchTerm
          params:
            - name: searchTerm
              string: mx.data.e2e-regression.od-002.productSearch1

      - executeFunction:
          name: mx.functions.top-menu.tapSearchInKeyboard

      - executeFunction:
          name: mx.functions.missing-something.continueWithoutSelectionIfPageDisplayed

      #---------------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 6.A: ADD PRODUCTS TO CART."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.slp.addProductToCart
          params:
            - name: productName
              string: mx.data.e2e-regression.od-002.productName2
      
      - executeFunction:
          name: mx.functions.slp.getProductPrice
          params:
            - name: productName
              string: mx.data.e2e-regression.od-002.productName2

      - storeIn:
          key: product2Price
          value: ${returnedPrice}
      
      #---------------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 6.B: SEARCH PRODUCTS."
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.top-menu.enterSearchTerm
          params:
            - name: searchTerm
              string: mx.data.e2e-regression.od-002.productSearch2

      - executeFunction:
          name: mx.functions.top-menu.tapSearchInKeyboard
      
      - executeFunction:
          name: mx.functions.delivery-methods-info-popup.dismissPopupIfDisplayed
      
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 6.C: ADD PRODUCTS TO CART."
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.slp.addProductToCart
          params:
            - name: productName
              string: mx.data.e2e-regression.od-002.productName3
      
      - executeFunction:
          name: mx.functions.slp.getProductPrice
          params:
            - name: productName
              string: mx.data.e2e-regression.od-002.productName3

      - storeIn:
          key: product3Price
          value: ${returnedPrice}

      #---------------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 7: GO TO CART."
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: "3"

      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon
      
      - executeFunction:
          name: mx.functions.cart.assertPageDisplayed
      
      - executeFunction:
          name: mx.functions.cart.assertCartNotEmpty
      
      - sleep:
          duration: 3000

      - executeFunction:
                name: mx.functions.utils.closeBlackPopupIfDisplayed    
      
      - executeFunction:
          name: mx.functions.cart.assertProductListed
          params:
            - name: productName
              string: mx.data.e2e-regression.od-002.productName1
      
      - executeFunction:
          name: mx.functions.cart.assertProductListed
          params:
            - name: productName
              string: mx.data.e2e-regression.od-002.productName2
      
      - executeFunction:
          name: mx.functions.cart.assertProductListed
          params:
            - name: productName
              string: mx.data.e2e-regression.od-002.productName3
     
      - executeFunction:
          name: mx.functions.cart.assertProductsCountInSubtotalLabel
          params:
            - name: expectedProductsCount
              string: "3"
      
      #---------------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 8: Continue to Login from Cart"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.cart.tapContinue
      
      #---------------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 9: LOGIN EXISTING ACCOUNT FROM CART POP-UP."
            - name: squadNames
              string: PURCHASE | QAA
      
      - executeFunction:
          name: mx.flows.od.login.loginFromPopup
          params:
            - name: userEmail
              string: mx.data.e2e-regression.od-002.login.userEmailAndroid
            - name: userPassword
              string: mx.data.e2e-regression.od-002.login.userPassword

      - executeFunction:
          name: mx.functions.missing-something.continueWithoutSelectionIfPageDisplayed

      - executeFunction:
          name: mx.functions.reserve-slot.address-message-popup.closePopupIfDisplayed

      #---------------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 10-11: SELECT HOME DELIVERY AND SELECT ANY AVAILABLE SLOT."
            - name: squadNames
              string: PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.reserve-slot.assertPageDisplayed      
      
      - executeFunction:
          name: mx.functions.reserve-slot.tapHomeDeliveryMethod
    
      - executeFunction:
          name: mx.functions.reserve-slot.selectDayAfterTomorrowSlot
      
      - executeFunction:
          name: mx.functions.reserve-slot.selectFirstAvailableTimeSlot
      
      - executeFunction:
          name: mx.functions.reserve-slot.tapSaveAddressIfDisplayed

      #---------------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 12: OPEN REVIEW ORDER PAGE."
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
           name: mx.functions.reserve-slot.tapReserve
      
      #---------------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 13.A: SELECT PAY AT DELIVERY."
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.review-order.scrollDownToSection
          params:
            - name: sectionName
              string: Pago

      - executeFunction:
          name: mx.flows.od.review-order.forceSelectPayAtDeliveryMethod
          params:
            - name: payAtDeliveryOption
              string: "cash"
      
      - executeFunction:
          name: mx.functions.review-order.scrollUpToSection
          params:
            - name: sectionName
              string: "Comentarios generales"

      - executeFunction:
          name: mx.functions.review-order.tapAddDeliveryInstructions
      
      - executeFunction:
          name: mx.functions.general-comments-pop-up.enterTestOrderDisclaimer

      - executeFunction:
          name: mx.functions.general-comments-pop-up.tapSave
      
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 13.B: PERFORM REVIEW-ORDER VALIDATIONS."
            - name: squadNames
              string: PURCHASE | QAA
          
      - executeFunction:
          name: mx.functions.review-order.scrollDownToSection
          params:
            - name: sectionName
              string: "Número telefónico"
      
      - executeFunction:
          name: mx.functions.review-order.enterCellphoneNumber
          params:
            - name: userPhoneNumber
              string: mx.data.e2e-regression.od-002.review-order.cellphoneNumber
      
      - executeFunction:
          name: mx.functions.review-order.scrollDownToSection
          params:
            - name: sectionName
              string: "Subtotal"

       #---------------------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 14: PLACE ORDER."
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.review-order.tapPlaceOrder
      
      - executeFunction:
          name: mx.functions.order-confirmation.assertPageDisplayed

      - executeFunction:
          name: mx.functions.order-confirmation.assertDeliveryMethod
          params:
            - name: expectedDeliveryMethod
              string: "HomeDelivery"
      
      #---------------------------------------------------------------------------------------------------------------------
      - executeFunction: #---------------------------------------------------------------------------------------------
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 15: Hit Discover more Products button..."
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.order-confirmation.tapFindMoreProducts
      
      - executeFunction:
          name: mx.functions.bottom-menu.tapHome
          
      - storeIn:
          key: OD_002_SUCCESSFUL_EXECUTION
          value: true
  
  #####################################################################################################################

  - name: Before
    before: true
    flow:
      - log: "BEFORE SCENARIO START: Initial Config..."
      - executeFunction:
          name: mx.squad-reporting.setTestCaseName
          params:
            - name: testCaseName
              string: GMX_OD_Sanity_PROD_Android_002
      - log: 
          message: "WORKAROUND: RELAUNCHING APP TO FIX ISSUE REGARDING INTERNAL APP FLAGS"
          color: YELLOW
      - executeFunction:
          name: mx.functions.utils.relaunchApp
      - storeIn:
          key: OD_002_SUCCESSFUL_EXECUTION
          value: false
      - log: "BEFORE SCENARIO END"
  
  #####################################################################################################################

  - name: After
    after: true
    flow:
      - log: "AFTER SCENARIO START: Test Data Reset..."
      - executeFunction:
          name: mx.squad-reporting.logTestCaseFailure
          params:
            - name: testCaseExecutionStatus
              string: ${OD_002_SUCCESSFUL_EXECUTION}

      - if:
          condition: ${OD_002_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "Main Failed: Resetting data for the next execution..."
                color: CYAN
            - executeFunction:
                name: mx.functions.utils.relaunchApp
            - executeFunction:
                name: mx.functions.login.closePopupIfDisplayed
            - executeFunction:
                name: mx.functions.prehome.tapODBanner
            - executeFunction:
                name: mx.functions.home.assertPageDisplayed
            - executeFunction:
                name: mx.functions.utils.closeBlackPopupIfDisplayed    
            - executeFunction:
                name: mx.functions.top-menu.tapCartIcon
            - executeFunction:
                name: mx.functions.utils.closeBlackPopupIfDisplayed
            - executeFunction:
                name: mx.functions.cart.assertPageDisplayed
            - executeFunction:
                name: mx.functions.cart.emptyCart
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run show correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: CYAN
      - log: "AFTER SCENARIO END"