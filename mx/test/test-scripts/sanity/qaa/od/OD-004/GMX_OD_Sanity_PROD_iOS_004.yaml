#======================================================================================================================
#  AUTHOR: Gustavo Antonio López Cambambia (vn53g21)
#  CREATED: May/10/2023
#  REVISION: ---
#
#  Copyright © 2023 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: batch-1-qaa-od-sanity-production-ios-004, batch-1-qaa-od-sanity-production-ios
  testCaseId: MXMOB-1389

scenarios:

#######################################################################################################################
#
#   CONFLUENCE TRACKING DASHBOARD:
#     https://confluence.walmart.com/display/MXGECMEX/MXMOB-QAA%3A+Tracking%3A+Test+Suite%3A+GlassMX+-+OD+-+Sanity+-+Production+-+iOS
#
#   JIRA AUTOMATION TC:
#     https://jira.walmart.com/browse/MXMOB-1389
#
#   JIRA MANUAL TC:
#     https://jira.walmart.com/browse/MXMOB-1936
#
#   FLAGS USED: N/A
#
#######################################################################################################################

  - name: Main
    flow:
      - log:
          message: TEST START - E2E REGRESSION - OD-004
          color: CYAN
 
    ## STEP 1-2: NAVIGATE ONBOARDING TO HOME
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 1-2: NAVIGATE ONBOARDING TO HOME"
            - name: squadNames
              string: CORE | QAA
 
      # Navigate through onboarding to home as guest user.
      - executeFunction:
          name: mx.flows.global.onboarding.navigateToHomeAsGuestUser
          params:
            - name: zipCode
              string: mx.data.e2e-regression.od-004.zipCode
            - name: banner
              string: mx.data.e2e-regression.od-004.banner
 
    ## STEP 3: LOGIN AS REGISTERED USER VIA ACCOUNT PAGE.
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 3: LOGIN AS REGISTERED USER VIA ACCOUNT PAGE."
            - name: squadNames
              string: CUSTOMER | QAA
      
      - executeFunction:
          name: mx.flows.od.login.navigateToAccountAndLogin
          params:
            - name: userEmail
              string: mx.data.e2e-regression.od-004.userEmail
            - name: userPassword
              string: mx.data.e2e-regression.od-004.userPassword
            - name: userName
              string: mx.data.e2e-regression.od-004.userName
 
    ## STEP 4: ADDING PRODUCT FROM HOME PAGE.
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 4: ADDING PRODUCT FROM HOME PAGE."
            - name: squadNames
              string: PRE-PURCHASE | QAA
 
      - executeFunction:
          name: mx.functions.bottom-menu.tapHome

      - executeFunction:
          name: mx.functions.delivery-method-selector.tapStoreSelector

      - sleep:
          duration: 4000

      - executeFunction:
          name: mx.functions.store-selector-popup.enterZipCode
          params:
            - name: zipCode
              string: mx.data.e2e-regression.od-004.zipCode

      - sleep:
          duration: 4000

      - executeFunction:
          name: mx.functions.store-selector-popup.selectStore
          params:
            - name: storeName
              string: mx.data.e2e-regression.od-004.storeName

      - executeFunction:
          name: mx.functions.store-selector-popup.tapSave

      - executeFunction:
          name: mx.functions.delivery-method-selector.closeSelectorIfExpanded
 
      - log:
          message: Finding product on Home Page
          color: CYAN
      
      - executeFunction:
          name: mx.functions.home.assertPageLoaded

      - executeFunction: 
          name: mx.functions.home.scrollDownToMostPopularSection
      
      - sleep:
          duration: 2000

      - scroll:
          direction: down
          untilIdentifier: mx.mappings.home.carousel.titleContainer
          position: center
          scrollLimit: 8

      - executeFunction:
          name: mx.functions.home.getCarouselName

      - executeFunction:
          name: mx.functions.pdp.carousel.openFirstAvailablePDPListed
          params:
            - name: carouselName
              string: ${returnedCarouselName}

      - sleep:
          duration: 4000
              
      - executeFunction:
          name: mx.functions.pdp.assertPageDisplayed

      - executeFunction:
          name: mx.functions.pdp.getProductNameHelper

      - storeIn:
          key: returnedFirstProductName
          value: ${returnedProductName}
 
      - executeFunction: 
          name: mx.functions.pdp.addToCart
 
      - executeFunction:
          name: mx.functions.pdp.assertAddedToCart

      - storeIn:
          key: OD_004_IS_CART_EMPTY
          value: false
 
      - executeFunction:
          name: mx.functions.pdp.tapClose
 
      - executeFunction:
          name: mx.functions.home.carousel.assertProductAddedToCart
          params:
            - name: productName
              string: ${returnedFirstProductName}
 
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: mx.data.e2e-regression.od-004.home.firstQuantityOnCart

      - log:
          message: "Searching second carrousel and product"
          color: CYAN
      
      - executeFunction: 
          name: mx.functions.home.scrollDownToCarousel
          params:
            - name: carouselName
              string: mx.data.e2e-regression.od-004.home.carouselName2
 
      - executeFunction:
          name: mx.functions.pdp.carousel.openFirstAvailablePDPListed
          params:
            - name: carouselName
              string: mx.data.e2e-regression.od-004.home.carouselName2

      - sleep:
          duration: 4000
              
      - executeFunction:
          name: mx.functions.pdp.assertPageDisplayed

      - executeFunction:
          name: mx.functions.pdp.getProductNameHelper

      - storeIn:
          key: returnedSecondProductName
          value: ${returnedProductName}
 
      - executeFunction: 
          name: mx.functions.pdp.addToCart
 
      - executeFunction:
          name: mx.functions.pdp.assertAddedToCart
 
      - executeFunction:
          name: mx.functions.pdp.tapClose
 
      - executeFunction:
          name: mx.functions.home.carousel.assertProductAddedToCart
          params:
            - name: productName
              string: ${returnedSecondProductName}
 
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: mx.data.e2e-regression.od-004.home.secondQuantityOnCart

    ## STEP 4.1: ADDING FUTURE OOS PRODUCT FROM SEARCH PAGE.
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 4.1: ADDING FUTURE OOS PRODUCT FROM SEARCH PAGE."
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.flows.od.search.performSuccessfulSearch
          params:
            - name: searchTerm
              string: mx.data.e2e-regression.od-004.search.searchTermOosProduct

      - executeFunction:
          name: mx.functions.slp.openProductDetailsByName
          params:
            - name: productName
              string: mx.data.e2e-regression.od-004.search.searchTermOosProduct

      - sleep:
          duration: 4000

      - executeFunction:
          name: mx.functions.pdp.assertPageDisplayed

      - executeFunction:
          name: mx.functions.pdp.getProductNameHelper

      - storeIn:
          key: returnedOosProductName
          value: ${returnedProductName} 

      - executeFunction:
          name: mx.functions.pdp.addToCart

      - executeFunction:
          name: mx.functions.pdp.assertAddedToCart

      - executeFunction:
          name: mx.functions.pdp.tapClose
                      
    ## STEP 5: OPENING CART
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 5: OPENING CART"
            - name: squadNames
              string: PURCHASE | QAA
 
      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon

      - executeFunction:
          name: mx.functions.utils.closeBlackPopupIfDisplayed
 
      - executeFunction:
          name: mx.functions.cart.assertPageDisplayed
 
      - executeFunction:
          name: mx.functions.cart.assertCartNotEmpty
 
      - executeFunction:
          name: mx.functions.cart.assertProductListed
          params:
            - name: productName
              string: ${returnedFirstProductName}

    ## STEP 6: HIT "Reservar un horario"
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 6: HIT 'Reservar un horario'"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.cart.tapReserveSlot

      - sleep:
          duration: 3000

      - executeFunction:
          name: mx.functions.reserve-slot.assertPageDisplayed
      
    ## STEP 7: SELECT "Envio a domicilio" AND SELECT A DELIVERY ADDRESS
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 7: SELECT 'Envio a domicilio' AND SELECT A DELIVERY ADDRESS"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.reserve-slot.tapHomeDeliveryMethod

      - executeFunction:
          name: mx.functions.reserve-slot.address-message-popup.closePopupIfDisplayed

      - executeFunction:
          name: mx.functions.reserve-slot.tapChange

      - executeFunction:
          name: mx.functions.address-selector-popup.assertPageDisplayed

      - executeFunction:
          name: mx.functions.address-selector-popup.selectAddressByPosition
          params:
            - name: addressPosition
              string: mx.data.e2e-regression.od-004.firstAddressPosition
      
      - executeFunction:
          name: mx.functions.address-selector-popup.tapSave

    ## STEP 8: HIT "Eliminar y continuar" button
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 8: HIT 'Eliminar y continuar' button"
            - name: squadNames
              string: PURCHASE | QAA

      - sleep:
          duration: 40000

      - executeFunction:
          name: mx.functions.oos.assertPageDisplayed

      - executeFunction:
          name: mx.functions.oos.tapDeleteLinkByProductName
          params:
            - name: productNameOOS
              string: ${returnedOosProductName}

      - executeFunction:
          name: mx.functions.reserve-slot.tapPickupDeliveryMethod

      - executeFunction:
          name: mx.functions.reserve-slot.tapChange

      - executeFunction:
          name: mx.functions.store-selector-popup.selectFirstODStore

      - executeFunction:
          name: mx.functions.store-selector-popup.tapSave

      - if:
          identifier:
            present:
              - identifier: mx.mappings.oos.pageTitle
          then:
            - executeFunction:
                name: mx.functions.oos.tapDeleteLinkByProductName
                params:
                  - name: productNameOOS
                    string: ${returnedOosProductName}

    ## STEP 9: SELECT TIME SLOT
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 9: SELECT TIME SLOT"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.reserve-slot.selectDayAfterTomorrowSlot

      - executeFunction:
          name: mx.functions.reserve-slot.selectLastAvailableTimeSlot

      - executeFunction:
          name: mx.functions.reserve-slot.getSelectedDaySlot
          #${returnedSelectedDaySlot}

      - executeFunction:
          name: mx.functions.reserve-slot.getSelectedTimeSlot
          #${returnedSelectedTimeSlot}

      - executeFunction:
          name: mx.functions.utils.getDeliverySlot
          params:
            - name: forPage
              string: 'Cart'
            - name: selectedDaySlot
              string: ${returnedSelectedDaySlot}
            - name: selectedTimeSlot
              string: ${returnedSelectedTimeSlot}

      - executeFunction:
          name: mx.functions.reserve-slot.getSelectedStore
          #${returnedStoreName} 

      - executeFunction:
          name: mx.functions.reserve-slot.tapReserve

      - executeFunction:
          name: mx.functions.cart.getDeliveryMethod
          #${cartDeliveryMethodDisplayed}

      - executeFunction:
          name: mx.flows.od.cart.assertDeliveryMethodSlot
          params:
            - name: deliveryMethod
              string: 'PickupDelivery'
            - name: deliverySlot
              string: ${returnedDeliverySlot}
            - name: userShortAddress
              string: ${userShortAddress}
            - name: expectedDeliveryFee
              string: ${deliveryFeeTcOd004}
      
      - executeFunction:
          name: mx.functions.cart.getProductPrice
          params:
            - name: productName
              string: ${returnedFirstProductName}

      - storeIn:
          key: returnedFirstProductPrice
          value: ${returnedProductPrice}

      - executeFunction:
          name: mx.functions.cart.getProductPrice
          params:
            - name: productName
              string: ${returnedSecondProductName}

      - storeIn:
          key: returnedSecondProductPrice
          value: ${returnedProductPrice}

      - arithmetic:
          expression: ${returnedFirstProductPrice} + ${returnedSecondProductPrice}
          numberOfDecimalPlaces: 2
          storeIn: cartEstimatedTotal

      - executeNode:
          file: mx/test/helpers/utils/numberToNumberWithComa.js
          args:
            - value: ${cartEstimatedTotal}
          getResponse:
            storeIn: expectedEstimatedTotal
      
      - executeFunction:
          name: mx.functions.cart.assertEstimatedTotalFromDetailsSection
          params:
            - name: expectedEstimatedTotal
              string: ${expectedEstimatedTotal}
      
      - executeFunction:
          name: mx.functions.cart.assertEstimatedTotalFromBottom
          params:
            - name: expectedEstimatedTotal
              string: ${cartEstimatedTotal}

      - executeFunction:
          name: mx.functions.cart.assertProductNotListed
          params:
            - name: productName
              string: ${productNameOOS}
      
    ## STEP 10: CONTINUE CHECKOUT
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 10: CONTINUE CHECKOUT"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.cart.tapContinue

      - executeFunction:
          name: mx.functions.missing-something.continueWithoutSelectionIfPageDisplayed

      - executeFunction:
          name: mx.functions.review-order.assertPageDisplayed
          params:
            - name: userDeliveryAddress
              string: ${returnedStoreName}

    ## STEP 11: GO TO PAYMENT METHODS AND SELECT A 'PAY AT DELIVERY - CASH'
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 11: GO TO PAYMENT METHODS AND SELECT A 'PAY AT DELIVERY - CASH'"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.review-order.tapAddDeliveryInstructions

      - executeFunction:
          name: mx.functions.general-comments-pop-up.assertPageDisplayed

      - executeFunction:
          name: mx.functions.general-comments-pop-up.enterTestOrderDisclaimer

      - executeFunction:
          name: mx.functions.general-comments-pop-up.tapSave

      - executeFunction:
          name: mx.functions.review-order.scrollDownToWallet

      - executeFunction:
          name: mx.flows.od.review-order.forceSelectPayAtDeliveryMethod
          params:
            - name: payAtDeliveryOption
              string: mx.data.e2e-regression.od-004.review-order.payAtDeliveryMethod

      - executeFunction:
          name: mx.functions.review-order.scrollDownToSection
          params:
            - name: sectionName
              string: mx.data.e2e-regression.od-004.review-order.enterPhoneNumberSection

      - executeFunction:
          name: mx.functions.review-order.enterCellphoneNumber
          params:
            - name: userPhoneNumber
              string: mx.data.e2e-regression.od-004.review-order.cellphoneNumber

    ## STEP 12: PLACE ORDER
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 12: PLACE ORDER"
            - name: squadNames
              string: PURCHASE | QAA

      - executeFunction:
          name: mx.functions.review-order.tapPlaceOrder

      - executeFunction:
          name: mx.functions.utils.closeRateWalmartPopupIfDisplayed

      - storeIn:
          key: OD_004_IS_CART_EMPTY
          value: true

      - executeFunction:
          name: mx.functions.order-confirmation.assertDeliveryMethod
          params:
            - name: expectedDeliveryMethod
              string: PickupDelivery

      - executeFunction:
          name: mx.functions.order-confirmation.getOrderNumber

    ## STEP 13: HIT "DESCUBRIR MAS PRODUCTOS" BUTTON
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 13: HIT 'DESCUBRIR MAS PRODUCTOS' BUTTON"
            - name: squadNames
              string: CUSTOMER | QAA

      - executeFunction:
          name: mx.functions.order-confirmation.tapFindMoreProducts

      - executeFunction:
          name: mx.functions.home.scrollUpToLocationBanner

      - executeFunction:
          name: mx.functions.home.assertPageDisplayed

    ## STEP 14: GO TO PROFILE SCREEN AND SELECT "PEDIDOS"
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 14: GO TO PROFILE SCREEN AND SELECT 'PEDIDOS'"
            - name: squadNames
              string: POST-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.bottom-menu.tapAccount

      - executeFunction:
          name: mx.functions.account.tapTrackOrder

    ## STEP 15: SELECT THE NEWEST PLACE ORDER
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 15: SELECT THE NEWEST PLACE ORDER"
            - name: squadNames
              string: POST-PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.orders-history.tapOrderDetailsByPosition
          params:
            - name: position
              string: mx.data.e2e-regression.od-004.order-history.lastOrder

      - executeFunction:
          name: mx.functions.order-details.assertCorrectOrderDisplayed
          params:
            - name: expectedOrderNumber
              string: ${returnedOrderNumber}

      - executeFunction:
          name: mx.functions.order-details.expandProductsDetailsIfNotExpanded

      - executeFunction:
          name: mx.functions.order-details.findProductInPage
          params:
            - name: productName
              string: ${returnedFirstProductName}

      - executeFunction:
          name: mx.functions.order-details.assertProductSubtotal
          params:
            - name: productName
              string: ${returnedFirstProductName}
            - name: expectedSubtotal
              string: ${returnedFirstProductPrice}

      - executeFunction:
          name: mx.functions.order-details.findProductInPage
          params:
            - name: productName
              string: ${returnedSecondProductName}

      - executeFunction:
          name: mx.functions.order-details.assertProductSubtotal
          params:
            - name: productName
              string: ${returnedSecondProductName}
            - name: expectedSubtotal
              string: ${returnedSecondProductPrice}

      - executeFunction:
          name: mx.functions.order-details.scrollToBottom

      - executeFunction:
          name: mx.functions.order-details.assertTotal
          params:
            - name: expectedTotal
              string: ${cartEstimatedTotal}

      #----------------------------------------------------------------------------------------------------------------

      - storeIn:
          key: OD_004_SUCCESSFUL_EXECUTION
          value: true

      - log: "TEST END: QAA - OD - PRODUCTION SANITY - OD-004"

  #####################################################################################################################

  - name: Before
    before: true
    flow:
      - log: "BEFORE SCENARIO START: Initial Config..."
      - executeFunction:
          name: mx.squad-reporting.setTestCaseName
          params:
            - name: testCaseName
              string: GMX_OD_Sanity_PROD_iOS_004
      - if:
          condition: ${APP_PLATFORM} == 'android'
          then:
            - log:
                message: "WORKAROUND: RELAUNCHING APP TO FIX ISSUE REGARDING INTERNAL APP FLAGS"
                color: YELLOW
            - executeFunction:
                name: mx.functions.utils.relaunchApp
      - storeIn:
          key: OD_004_SUCCESSFUL_EXECUTION
          value: false
      - log: "BEFORE SCENARIO END"

#####################################################################################################################

  - name: After
    after: true
    flow:
      - log: "AFTER SCENARIO START: Test Data Reset..."
      - executeFunction:
          name: mx.squad-reporting.logTestCaseFailure
          params:
            - name: testCaseExecutionStatus
              string: ${OD_004_SUCCESSFUL_EXECUTION}
      - if:
          condition: ${OD_004_SUCCESSFUL_EXECUTION} != true
          then:
            - executeFunction:
                name: mx.flows.od.after-scenario-exclusive.emptyCart
                params:
                  - name: userEmail
                    string: mx.data.e2e-regression.od-004.userEmail
                  - name: userPassword
                    string: mx.data.e2e-regression.od-004.userPassword
                  - name: isCartEmpty
                    string: ${OD_004_IS_CART_EMPTY}
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: CYAN
      - log: "AFTER SCENARIO END"