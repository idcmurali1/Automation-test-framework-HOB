#======================================================================================================================
#    AUTHOR: Osmar Juárez (vn56dce)
#   CREATED: Apr/29/2024
#  REVISION: ---
#
#  Copyright © 2024 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: prepurchase-od-smoke-production-ios-1127, prepurchase-od-smoke-production-ios
  testCaseId: MMS-3105

#######################################################################################################################
#
#  TEST CASE TITLE: 
#    Verify that a guest and a user can add and remove items from cart (PDP, SLP)
#
#  CONFLUENCE TRACKING DASHBOARD:
#    https://confluence.walmart.com/display/MXGECMEX/GlassMX+-+OD+-+Smoke+-+Production+-+iOS 
#
#  JIRA AUTOMATION TC:
#    https://jira.walmart.com/browse/MMS-3105 
#
#  JIRA MANUAL TC:
#    https://jira.walmart.com/browse/MMS-1127
#
#######################################################################################################################

scenarios:
  # BEFORE HOOK #######################################################################################################
  - name: Before
    before: true
    flow:
      - log: "BEFORE SCENARIO START: Initial Config..."
      
      - executeFunction:
          name: mx.squad-reporting.setTestCaseName
          params:
            - name: testCaseName
              string: GMX_OD_Smoke_PROD_PrePurchase_iOS_1127

      # setting GMX_PP_APP_NAME variable for user email
      - if:
          condition: ${BUNDLE_ID} == 'com.walmartmexico.WalmartMG.qa'
          then:
            - storeIn:
                key: GMX_PP_APP_NAME
                value: ''
          else:
            - storeIn:
                key: GMX_PP_APP_NAME
                value: '_bodega'
      - storeIn:
          key: MMS_1127_SUCCESSFUL_EXECUTION
          value: false
      - storeIn:
          key: MMS_1127_IS_CART_EMPTY
          value: true
      - log: "BEFORE SCENARIO END"

  # MAIN HOOK #########################################################################################################
  - name: Main
    platform: ios
    flow:
      - log: "TEST START: ${__SQUAD_REPORTING_TEST_CASE_NAME}"

      # STEPS 1-2 ------------------------------------------------------------------------------------------------------
      - log:
         message: "STEPS 1-2: (1) OPEN WALMART APP AND COMPLETE ONBOARDING. (2) OPEN THE OD BANNER."
         color: ORANGE

      - executeFunction:
          name: mx.flows.global.onboarding.navigateToHomeAsGuestUser
          params:
            - name: zipCode
              string: mx.data.qaa.smoke.od.prepurchase-1127.zipCode
            - name: banner
              string: 'OD'
      
      # STEP 3 ---------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 3: FROM THE HERO POV, TAP ON THE CTA BUTTON OF THE FIRST CARD THAT APPEARS.'
            - name: squadNames
              string: PRE-PURCHASE | QAA

      - executeFunction:
          name: mx.flows.od.home.openPlpFromPromotionCarousel

      # STEP 4 ---------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: 'STEP 4: ONCE IN THE PLP ADD THE FIRST AVAILABLE ITEM TO CART.'
            - name: squadNames
              string: PRE-PURCHASE | QAA

      # set indexProduct parameter for addToCartButton mapping iOS 
      - storeIn:
          key: indexProduct
          value: '1'
      - executeFunction:
          name: mx.functions.utils.searchItemInPage
          params:
            - name: elementToFind
              string: mx.mappings.department-l3.addToCartButton # PARAM --${indexProduct}--
            - name: direction
              string: "down"
      - executeFunction:
          name: mx.functions.department-l3.addProductToCartByIndex # PARAM --${indexProduct}--
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: '1'

      # STEPS 5-6 ------------------------------------------------------------------------------------------------------
      - log:
         message: "STEPS 5-6: (5) KILL THE APP. (6) RE-OPEN THE APP AND SELECT THE OD BANNER."
         color: ORANGE

      - executeFunction:
          name: mx.functions.utils.relaunchApp
          params:
            - name: bundleId
              string: ${BUNDLE_ID}
      - executeFunction:
          name: mx.functions.prehome.tapODBanner
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: '1'

      # STEP 7 ---------------------------------------------------------------------------------------------------------
      - log:
         message: "STEP 7: LOG IN BY GOING TO 'Cuenta' > 'Iniciar sesión'"
         color: ORANGE
      - executeFunction:
          name: mx.flows.od.login.navigateToAccountAndLogin
          params:
            - name: userEmail
              string: mx.data.qaa.smoke.od.prepurchase-1127.userEmail
            - name: userPassword
              string: mx.data.qaa.smoke.od.prepurchase-1127.userPassword
            - name: userName
              string: mx.data.qaa.smoke.od.prepurchase-1127.userFirstName
      - storeIn:
          key: MMS_1127_IS_CART_EMPTY
          value: false
          
      # STEP 8 ---------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 8: GO BACK TO HOME BY TAPPING 'Inicio' IN THE NAVBAR."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.bottom-menu.tapHome
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: '1'
      - executeFunction:
          name: mx.functions.delivery-method-selector.closeSelectorIfExpanded
      
      # STEP 9 ---------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 9: SCROLL DOWN AND TAP FIRST CATEGORY CARD FROM THE HUBSPOKE."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.utils.searchItemInPage
          params:
            - name: elementToFind
              string: mx.mappings.home.categoryHubspokeModuleView
            - name: direction
              string: "down"
      - executeFunction:
          name: mx.functions.home.tapCategoryHubspokeByIndex
          params:
            - name: categoryIndex
              string: '4'
      - executeFunction:
          name: mx.functions.home.plp.assertPageDisplayed

      # STEP 10 --------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 10: ONCE IN THE PLP ADD 2 OF THE FIRST AVAILABLE ITEMS TO CART."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      
      - executeFunction:
          name: mx.functions.utils.searchItemInPage
          params:
            - name: elementToFind
              string: mx.mappings.department-l3.addToCartButton # PARAM --${indexProduct}--
            - name: direction
              string: "down"
      - executeFunction:
         name: mx.functions.department-l3.getProductNameByIndex # RETURN: --${displayedProductName}--
         params:
           - name: productIndex
             string: '1'
      - storeIn:
          key: MMS_1127_PRODUCT_NAME_2
          value: ${displayedProductName}
       # add first product
      - executeFunction:
          name: mx.functions.department-l3.addProductToCartByIndex # PARAM --${indexProduct}--
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: '2'
      - executeFunction:
          name: mx.functions.department-l3.addProductToCartByIndex
          params:
            - name: indexProduct
              string: '2'
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: '3'

      # STEPS 11-12 ----------------------------------------------------------------------------------------------------
      - log:
         message: "STEPS 11-12: (11) KILL THE APP. (12) RE-OPEN THE APP AND SELECT THE OD BANNER."
         color: ORANGE
      
      - executeFunction:
          name: mx.functions.utils.relaunchApp
          params:
            - name: bundleId
              string: ${BUNDLE_ID}
      - executeFunction:
          name: mx.functions.prehome.tapODBanner
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: '3'
      
      # STEP 13 -------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 13: DELETE 1 OF THE 2 ITEMS THAT WERE ADDED FROM THE CART."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon
      - executeFunction:
          name: mx.functions.cart.assertCartNotEmpty
      - executeFunction:
          name: mx.functions.cart.deleteAvailableProduct  
          params:
            - name: productName
              string: ${MMS_1127_PRODUCT_NAME_2}
      - executeFunction:
          name: mx.functions.cart.assertProductsCountInSubtotalLabel
          params:
            - name: expectedProductsCount
              string: '2'

      # STEP 14 -------------------------------------------------------------------------------------------------------
      - log:
         message: "STEP 14: LOG OUT BY GOOING TO 'Cuenta' > 'Cerrar sesión'."
         color: ORANGE
      
      - executeFunction:
          name: mx.functions.cart.tapBack
      - executeFunction:
          name: mx.functions.bottom-menu.tapAccount
      - executeFunction:
          name: mx.functions.account.tapLogout
      - executeFunction:
          name: mx.functions.account.assertUserNotLogged
      
      # STEP 15 -------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 15:  TAP 'Inicio'."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.bottom-menu.tapHome
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: '0'
      - executeFunction:
          name: mx.functions.delivery-method-selector.closeSelectorIfExpanded

       # STEP 16 -------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 16: SCROLL DOWN TO THE BOTTOM OF THE HOME AND TAP MARQUEE DISPLAY AD COMPONENT."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - log:
          message: "[INFO] IF MARQUEE DISPLAY AD IS PRESENT IT WILL BE OPENED."
          color: YELLOW
      - executeFunction:
          name: mx.functions.home.scrollUntilMarqueeDisplayAdIsPresent # RETURN --${isMarqueeDisplayAdPresent}--
      - if:
         condition: ${isMarqueeDisplayAdPresent} == true
         then:
            - executeFunction:
                name: mx.functions.home.openBottomDisplayAd
            - executeFunction:
                name: mx.functions.home.plp.assertPageDisplayed

            # STEP 17 (If step 16)-------------------------------------------------------------------------------------
            - executeFunction:
                name: mx.squad-reporting.setTestCaseStep
                params:
                  - name: step
                    string: "STEP 17: ONCE IN THE PLP ADD THE FIRST AVAILABLE ITEM TO CART."
                  - name: squadNames
                    string: PRE-PURCHASE | QAA
            
            - storeIn:
                key: indexProduct
                value: '1'
            - executeFunction:
                name: mx.functions.utils.searchItemInPage
                params:
                  - name: elementToFind
                    string: mx.mappings.department-l3.addToCartButton
                  - name: direction
                    string: "down"
            - executeFunction:
                name: mx.functions.department-l3.addProductToCartByIndex       
            - executeFunction:
                name: mx.functions.top-menu.assertCartQuantity
                params:
                  - name: expectedQuantity
                    string: '1'
         else:
           - log:
              message: "[INFO] STEP 17 SKIPPED: MARQUEE DISPLAY AD IS NOT PRESENT."
              color: YELLOW
      
      # STEP 18 ---------------------------------------------------------------------------------------------------------
      - log:
         message: "STEP 18: LOG IN BY GOING TO 'Cuenta' > 'Iniciar sesión' USING THE SAME ACCOUNT USED BEFORE."
         color: ORANGE

      - executeFunction:
          name: mx.flows.od.login.navigateToAccountAndLogin
          params:
            - name: userEmail
              string: mx.data.qaa.smoke.od.prepurchase-1127.userEmail
            - name: userPassword
              string: mx.data.qaa.smoke.od.prepurchase-1127.userPassword
            - name: userName
              string: mx.data.qaa.smoke.od.prepurchase-1127.userFirstName
      
      # STEP 19 -------------------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 19: TAP 'Inicio'."
            - name: squadNames
              string: PRE-PURCHASE | QAA
      
      - if:
          condition: ${isMarqueeDisplayAdPresent} == false
          then:
            - storeIn:
                key: EXPECTED_FINAL_CART_QUANTITY
                value: '2'
          else:
            - storeIn:
                key: EXPECTED_FINAL_CART_QUANTITY
                value: '3'
      - executeFunction:
          name: mx.functions.bottom-menu.tapHome
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: ${EXPECTED_FINAL_CART_QUANTITY}
      
      # STEP 20 -------------------------------------------------------------------------------------------------------
      - log:
         message: "STEP 20: OPEN CART AND DELETE ALL ITEMS FROM CART."
         color: ORANGE
      
      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon
      - executeFunction:
          name: mx.functions.cart.assertCartNotEmpty
      - executeFunction:
          name: mx.functions.cart.emptyCart
      - executeFunction:
          name: mx.functions.cart.assertCartIsEmpty

      # End main -------------------------------------------------------------------------------------------------------
      - storeIn:
          key: MMS_1127_SUCCESSFUL_EXECUTION
          value: true

      - log: "TEST END: ${__SQUAD_REPORTING_TEST_CASE_NAME}"

  # AFTER HOOK #########################################################################################################
  - name: After
    after: true
    flow:
      - log: "AFTER SCENARIO START: After Configs..."
      
      - executeFunction:
          name: mx.squad-reporting.logTestCaseFailure
          params:
            - name: testCaseExecutionStatus
              string: ${MMS_1127_SUCCESSFUL_EXECUTION} 

      - if:
          condition: ${MMS_1127_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "Main Failed. Resseting data for next execution."
                color: RED
            - if:
                condition: ${MMS_1127_IS_CART_EMPTY} == false
                then: 
                  - executeFunction:
                      name: mx.flows.od.after-scenario-exclusive.relaunchAndNavigateToHomePage
                  - executeFunction:
                      name: mx.flows.od.after-scenario-exclusive.navigateToAccountAndLoginIfNotLogged
                  - executeFunction:
                      name: mx.functions.bottom-menu.tapHome
                  - executeFunction:
                      name: mx.flows.od.after-scenario-exclusive.emptyCart
                      params:
                        - name: userEmail
                          string: mx.data.qaa.smoke.od.prepurchase-1127.userEmail
                        - name: userPassword
                          string: mx.data.qaa.smoke.od.prepurchase-1127.userPassword
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: GREEN_BOLD
      - log: "AFTER SCENARIO END"
  