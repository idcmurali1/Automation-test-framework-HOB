#======================================================================================================================
#    AUTHOR: Osmar Ju치rez (vn56dce)
#   CREATED: Nov/20/2024
#  REVISION: ---
#
#  Copyright 춸 2024 Walmart. All rights reserved.
#======================================================================================================================
#######################################################################################################################
#
#  TEST CASE TITLE: 
#    [Home][AdjustableBanner][HeroPOV][Hubspokes] - Verify that a guest user can see and access to different componets from home.
#
#  CONFLUENCE TRACKING DASHBOARD:
#    https://confluence.walmart.com/display/MXGECMEX/GlassMX+-+OD+-+Smoke+-+Production+-+Android 
#
#  JIRA AUTOMATION TC:
#    https://jira.walmart.com/browse/MMS-4937
#
#  JIRA MANUAL TC:
#    https://jira.walmart.com/browse/MMS-1127
#
#######################################################################################################################

  
general:
  tags: prepurchase-walmart-ea-smoke-production-android-1127, prepurchase-walmart-ea-smoke-production-android,
        prepurchase-bodega-ea-smoke-production-android-1127, prepurchase-bodega-ea-smoke-production-android
  testCaseId: MMS-4937
  
scenarios:

  # BEFORE HOOK #######################################################################################################
  - name: Before
    before: true
    flow:
      - log: R2_SUBFLOW_BEFORE ### [[ 游릭 Flow Identifier: BEFORE 游릭 ]] ###

      - executeFunction:
          name: functions.utils.setMarketInfo

      - storeIn:
          key: MMS_1127_SUCCESSFUL_EXECUTION
          value: false
      - storeIn:
          key: IS_HERO_POV_PRESENT
          value: false
      - storeIn:
          key: IS_HUBSPOKE_PRESENT
          value: false
      - log: "BEFORE SCENARIO END"

  # MAIN HOOK #########################################################################################################
  - name: Main
    platform: android
    flow:
      - log: R2_SUBFLOW_MAIN ### [[ 游릭 Flow Identifier: MAIN 游릭 ]] ###

      # STEPS 1-2 ------------------------------------------------------------------------------------------------------
      - log:
         message: "STEPS 1-2: (1) OPEN WALMART APP AND COMPLETE ONBOARDING. (2) OPEN THE EA BANNER."
         color: ORANGE

      - executeFunction:
          name: functions.onboardingToHomePage.usingPostalCode
          params:
            - name: PostalCode
              string: mx.prepurchase.onboarding.userPostalCode
            - name: ShoppingExperience
              string: mx.prepurchase.onboarding.onlineExclusiveStore
          
      # STEP 3 ---------------------------------------------------------------------------------------------------------
      - log:
         message: "STEP 3: OPEN ANY ADJUSTABLE BANNER OR CATEGORY DISPLAYED IN HOME UNTIL FIND A HEROPOV OR HUBSPOKE."
         color: ORANGE
      - loop:
          begin: 0
          end: 7
          storeIndex: iHomeScroll
          mode: increment
          flow:
            - log:
                message: "Loop: Scroll number {${iHomeScroll}} in home until some adjustable banner, category, or triple pack"
                color: PURPLE
            - numberOfChildElements:
                identifier: mx.mappings.home.pageContainer
                storeIn: numberOfAdCardsDisplayedInHome
                filterBy: mx.mappings.home.adjustableBannerOrTriplePackOrCategoriesCardsView
            - if:
                condition: "${numberOfAdCardsDisplayedInHome} == 0"
                then: 
                  - scroll:
                     direction: down
                     withinIdentifier: mx.mappings.home.pageContainer
                else:
                  - loop:
                      begin: 0
                      end: ${numberOfAdCardsDisplayedInHome}
                      storeIndex: iAd
                      mode: increment
                      flow:
                        - log:
                            message: "Loop: Opening {${iAd}} adjustable banner to look for a HeroPOV or Hubspoke"
                            color: PURPLE
                        - if:
                            condition: "(${IS_HERO_POV_PRESENT} && ${IS_HUBSPOKE_PRESENT})"
                            then:
                              - break: true
                        - try:
                            flow:
                              - click:
                                  identifier: mx.mappings.home.adjustableBannerOrTriplePackOrCategoriesCardsView
                                  index: ${iAd}
                              - executeFunction:
                                 name: mx.functions.utils.findFirstTempoModuleInPage  # RETURN: --${moduleNameFounded}
                            catch:
                              flow:
                                - log:
                                   message: <TRY-CATCH> Something went wrong trying to open adjustable banner or validating if a Tempo module was present.
                                   color: YELLOW
                        - if:
                            condition: ${moduleNameFounded} == null
                            then:
                              - log:
                                  message: No Tempo module was founded [HeroPov | Hubspoke].
                                  color: YELLOW_BOLD
                          
                        - if:
                            condition: "(${moduleNameFounded} == 'HeroPOV' && !${IS_HERO_POV_PRESENT})"
                            then:
                              - storeIn:
                                  key: IS_HERO_POV_PRESENT
                                  value: true
                              - executeFunction:
                                  name: mx.functions.home.promotions-carousel.tapCTAButton
                              - executeFunction:
                                  name: mx.functions.home.plp.assertPageDisplayed
                              - executeFunction:
                                  name: mx.functions.utils.searchItemInPage
                                  params:
                                    - name: elementToFind
                                      string: mx.mappings.department-l3.addToCartButton
                                    - name: direction
                                      string: "down"
                              - executeFunction:
                                  name: mx.functions.department-l3.addProductToCartByIndex
                                  params:
                                    - name: indexProduct
                                      string: '0'
                              - log: 
                                  message: "[OK] Assertion success: HeroPOV configured as expected"
                                  color: GREEN_BOLD
                              - goBack: true
                              - if: 
                                  identifier:
                                    notPresent:
                                      - identifier: mx.mappings.home.promotionsCarouselContainer
                                  then:
                                      - executeFunction:
                                          name: mx.functions.bottom-menu.tapHome
                              - try:
                                  flow:
                                    - executeFunction:
                                        name: mx.functions.utils.findFirstTempoModuleInPage  # RETURN: --${moduleNameFounded}
                                  catch:
                                    flow:
                                      - log:
                                          message: <TRY-CATCH> Something went wrong trying to open adjustable banner or validating if a Tempo module was present.
                                          color: YELLOW
                        - if:
                            condition: "(${moduleNameFounded} == 'Hubspoke' && !${IS_HUBSPOKE_PRESENT})"
                            then:
                              - storeIn:
                                  key: IS_HUBSPOKE_PRESENT
                                  value: true                              
                              - executeFunction:
                                  name: mx.functions.home.tapCategoryHubspokeByIndex
                                  params:
                                    - name: categoryIndex
                                      string: '0'
                              - executeFunction:
                                  name: mx.functions.home.plp.assertPageDisplayed
                              - executeFunction:
                                  name: mx.functions.utils.searchItemInPage
                                  params:
                                    - name: elementToFind
                                      string: mx.mappings.department-l3.addToCartButton
                                    - name: direction
                                      string: "down"
                              - executeFunction:
                                  name: mx.functions.department-l3.addProductToCartByIndex
                                  params:
                                    - name: indexProduct
                                      string: '0'
                              - log: 
                                  message: "[OK] Assertion success: Hubspoke configured as expected"
                                  color: GREEN_BOLD

                        # NOTE: There is a current issue in Android sometimes when you return back from any adjustable banner 
                        #       or Ad opened from home the defult back screen is to Deparments screen. This issue will be 
                        #       addressed soon but it is out of scope of this TC.
                        - if: 
                           identifier:
                              present:
                                - identifier: mx.mappings.departments.pageTitle
                           then:
                              - executeFunction:
                                  name: mx.functions.bottom-menu.tapHome
                        - if: 
                           identifier:
                             notPresent:
                               - identifier: mx.mappings.home.adjustableBannerView
                           then:
                              - goBack: true
                        - if: 
                           identifier:
                             notPresent:
                               - identifier: mx.mappings.home.adjustableBannerView
                           then:
                              - executeFunction:
                                  name: mx.functions.bottom-menu.tapHome
            - if:
                condition: "(${IS_HERO_POV_PRESENT} && ${IS_HUBSPOKE_PRESENT})"
                then:
                  - log:
                      message: "Assertion success for: HeroPOV-[OK] && Hubspoke-[OK]"
                      color: GREEN_BOLD
                  - break: true
                else:
                  - scroll:
                      direction: down
                      withinIdentifier: mx.mappings.home.pageContainer
                  - scroll:
                      direction: down
                      withinIdentifier: mx.mappings.home.pageContainer
                  - scroll:
                      direction: down
                      withinIdentifier: mx.mappings.home.pageContainer
                 
      # End main -------------------------------------------------------------------------------------------------------
      - if:
          condition: "(${IS_HERO_POV_PRESENT} && ${IS_HUBSPOKE_PRESENT})"
          then:
            - storeIn:
                key: MMS_1127_SUCCESSFUL_EXECUTION
                value: true

  # AFTER HOOK #########################################################################################################
  - name: After
    after: true
    flow:
      - log: R2_SUBFLOW_AFTER ### [[ 游릭 Flow Identifier: AFTER 游릭 ]] ###
    
      - if:
          condition: ${MMS_1127_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "Main Failed. No need to reset data for next execution. [Guest User]"
                color: RED
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: GREEN_BOLD
      - log: "AFTER SCENARIO END"
  