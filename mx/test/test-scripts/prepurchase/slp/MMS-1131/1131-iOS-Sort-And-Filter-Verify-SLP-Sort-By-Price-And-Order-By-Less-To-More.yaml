#======================================================================================================================
#   AUTHOR: Fernanda Peruyero (vn54e7a)
#   CREATED: Oct/22/2024
#   REVISION: ---
#
#  Copyright 춸 2024 Walmart. All rights reserved.
#======================================================================================================================

general: 
  tags: prepurchase-walmart-ea-smoke-production-ios-1131, prepurchase-walmart-ea-smoke-production-ios,
        prepurchase-bodega-ea-smoke-production-ios-1131, prepurchase-bodega-ea-smoke-production-ios
  testCaseId: MMS-4795

#######################################################################################################################
#
#   TEST CASE TITLE: 
#    [Sort and Filter] - Verify that list of items can be filtered by "price" and sort it with "order by" from SLP
#
#   CONFLUENCE TRACKING DASHBOARD:
#    https://confluence.walmart.com/display/MXGECMEX/MX+Mobile+-+Test+Suite+-+MX-PrePurchase+-+EA+-+Smoke+-+Production 
#
#  JIRA AUTOMATION TC:
#    https://jira.walmart.com/browse/MMS-4795 
#
#  JIRA MANUAL TC:
#    https://jira.walmart.com/browse/MMS-1131
#
########################################################################################################################

scenarios:

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
#   B E F O R E   S C E N A R I O
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: Before
    before: true
    flow:

       - log: R2_SUBFLOW_BEFORE ### [[ 游릭 Flow Identifier: BEFORE 游릭 ]] ###
            
       - executeFunction:
          name: functions.utils.setMarketInfo

    # setting GMX_PP_APP_NAME variable for user email
       - if:
          condition: ${BUNDLE_ID} == 'com.walmartmexico.WalmartMG.qa'
          then:
            - storeIn:
                key: GMX_PP_APP_NAME
                value: ''
          else:
            - storeIn:
                key: GMX_PP_APP_NAME
                value: '_bodega'

       - storeIn:
          key: MMS_1131_SUCCESSFUL_EXECUTION
          value: false

       - log: "BEFORE SCENARIO END"

 # * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
#   M A I N   S C E N A R I O
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: Main
    platform: ios
    flow:

      - log: R2_SUBFLOW_MAIN ### [[ 游릭 Flow Identifier: MAIN 游릭 ]] ###
 
    # STEPS 1-2 ------------------------------------------------------------------------------------------------------
      - log:
         message: "STEPS 1-2: (1) OPEN APP AND COMPLETE ONBOARDING. (2) OPEN THE EA BANNER."
         color: ORANGE

      - executeFunction:
          name: functions.onboardingToHomePage.usingPostalCode
          params:
            - name: PostalCode
              string: mx.prepurchase.onboarding.userPostalCode
            - name: ShoppingExperience
              string: mx.prepurchase.onboarding.onlineExclusiveStore
      
   # STEP 3: Login from Profile Screen ----------------------------------------------------------------------------------
      - log:
         message: "STEP 3: LOGIN FROM PROFILE SCREEN"
         color: ORANGE

      - executeFunction:
          name: functions.global.tapAccountBtn

      - executeFunction:
          name: functions.accountPage.tapSignInBtn
      
      - executeFunction:
          name: functions.loginPage.userAuthentication
          params:
            - name: userEmail
              string: mx.data.qaa.prepurchase-1131.userEmail
            - name: userPassword
              string: mx.prepurchase.login.userPassword

      - executeFunction:
          name: functions.accountPage.assertUserLoggedInSuccessfully 

    # STEP 4: Search for an item by entering the product keyword/name into the search field on the top of the screen ----
      - log:
         message: "STEP 4: SEARCH FOR AN ITEM BY ENTERING THE PRODUCT KEYWORD/NAME INTO THE SEARCH FIELD ON THE TOP OF THE SCREEN."
         color: ORANGE
    
      - executeFunction:
          name: functions.global.tapShopBtn

      - executeFunction:
          name: functions.searchField.enterText # <-- ${searchText}
          params:
            - name: searchText
              string: mx.data.qaa.prepurchase-1131.searchText

      - executeFunction:
          name: mx.functions.slp.assertResultsDisplayed

    # STEP 5: Tap "Precio" --------------------------------------------------------------------------------------------------
      - log:
         message: "STEP 5: TAP 'PRECIO'"
         color: ORANGE

      - executeFunction:
          name: functions.searchResultPage.tapOnPriceFilterButton
    
      - executeFunction:
          name: mx.functions.price-filter.price-filter-bottom-sheet.assertBottomSheetDisplayed
     
    # STEP 6: Move the slider from the end to around halfway -----------------------------------------------------------------
      - log:
         message: "STEP 6: MOVE THE SLIDER FROM THE END TO AROUND HALFWAY."
         color: ORANGE

      - executeFunction: 
          name: mx.functions.price-filter.price-filter-bottom-sheet.moveRightSliderKnob
          params:
            - name: xValue
              string: mx.data.qaa.prepurchase-1131.xValue

      - storeIn:
          key: selectedPriceRange
          value: ${returnedSelectedPriceRange}

      - executeNode:
          file: mx/test/helpers/utils/stringReplaceAll.js
          args:
            - value: ${returnedSelectedPriceRange}
            - value: " - "
            - value: "-"
          getResponse:
            storeIn: selectedPriceRange
    
        # STEP 7: Ver resultados  ----------------------------------------------------------------------------------------------------  
      - executeFunction: 
          name: mx.functions.price-filter.price-filter-bottom-sheet.tapSeeResults
      
      - executeFunction:
          name: mx.functions.slp.assertSelectedPriceRange
          params:
            - name: selectedPriceRange
              string: ${selectedPriceRange}
     
    # STEP 8: Tap 'Ordenar y Filtrar' ---------------------------------------------------------------------------------------------        
      - executeFunction: 
          name: functions.searchPage.navigateToSortAndFilterPage

      - executeFunction:
          name: mx.functions.sort-and-filter.sort-and-filter-popup.assertPopupDisplayed

    # STEP 9: Open the "Ordenar por" section by tapping the arrow -------------------------------------------------
      - executeFunction:
          name: functions.searchPage.sortAndFliterPage.srollDownToOrderByFilter
      - executeFunction:
          name: functions.searchPage.sortAndFliterPage.expandOrderBy
    
    # STEP 10: Select "Precio menor a mayor" ------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.functions.sort-and-filter.sort-and-filter-popup.selectSortByOption
          params: 
            - name: sortByOption
              string: mx.data.qaa.prepurchase-1131.sortByFilter
    
    # STEP 10.1: Tap "Ver resultados" ---------------------------------------------------------------------------------------------
      - executeFunction:
          name: functions.searchPage.sortAndFliterPage.tapOnSubmitButton

      - executeFunction:
          name: mx.functions.slp.assertPricesFromLowToHigh
          params:
            - name: numOfProductsToCompare
              string: mx.data.qaa.prepurchase-1131.numOfProductsToCompare
        
    # STEP 11: Tap "Ordenar y Filtrar" --------------------------------------------------------------------------------------------
      - executeFunction:
          name: mx.functions.slp.scrollToTop

      - executeFunction: 
          name: functions.searchPage.navigateToSortAndFilterPage

      - executeFunction:
          name: mx.functions.sort-and-filter.sort-and-filter-popup.assertPopupDisplayed

    # STEP 12: Tap "Eliminar todo" from the section ----------------------------------------------------------------------------------     
      - executeFunction:
          name: mx.functions.sort-and-filter.sort-and-filter-popup.tapEraseAll

    # STEP 12.1: Tap "Ver resultados" ------------------------------------------------------------------------------------------------
      - executeFunction:
          name: functions.searchPage.sortAndFliterPage.tapOnSubmitButton
 
    # End main -------------------------------------------------------------------------------------------------------
      - storeIn:
          key: MMS_1131_SUCCESSFUL_EXECUTION
          value: true
      
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
#   A F T E R   S C E N A R I O
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: After
    after: true
    flow:
      - log: R2_SUBFLOW_AFTER ### [[ 游릭 Flow Identifier: AFTER 游릭 ]] ###

      - if:
          condition: ${MMS_1131_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "Main Failed."
                color: RED
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: GREEN_BOLD
      - log: "AFTER SCENARIO ENDED"
  