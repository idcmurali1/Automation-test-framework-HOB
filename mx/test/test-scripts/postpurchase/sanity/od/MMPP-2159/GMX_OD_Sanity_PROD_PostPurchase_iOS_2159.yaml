#======================================================================================================================
#    AUTHOR: Isis Tolentino (vn53dge)
#   CREATED: May/27/2024
#  REVISION: ---
#
#  Copyright © 2024 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: qaa-postpurchase-od-sanity-production-ios-2159, qaa-postpurchase-od-sanity-production-ios
  testCaseId: MMPP-2216

scenarios:
#######################################################################################################################
#
#  CONFLUENCE TRACKING DASHBOARD:
#    https://confluence.walmart.com/display/MXGECMEX/GlassMX+-+OD+-+Sanity+-+Production+-+iOS
#
#  JIRA AUTOMATION TC:
#    https://jira.walmart.com/browse/MMPP-2216
#
#  JIRA MANUAL TC:
#    https://jira.walmart.com/browse/MMPP-2159
#
#######################################################################################################################

  
  # BEFORE SCENARIO ###################################################################################################
  - name: Before
    before: true
    flow:
      - log: "BEFORE SCENARIO START: Initial Config..."
      
      - executeFunction:
          name: mx.squad-reporting.setTestCaseName
          params:
            - name: testCaseName
              string: GMX_OD_Sanity_PROD_PostPurchase_iOS_2159

      - storeIn:
          key: MMPP_2159_SUCCESSFUL_EXECUTION
          value: false
      - log: "BEFORE SCENARIO END"

  # MAIN SCENARIO #####################################################################################################
  - name: Main
    platform: ios
    flow:
      - log: "TEST START: GMX_OD_Sanity_PROD_PostPurchase_iOS_2159"

      # STEP 1: Navigate through Onboarding and select OD Banner ------------------------------------------------------
      - log:
         message: "STEPS 1: Navigate through Onboarding and select OD Banner."
         color: YELLOW

      - executeFunction:
          name: mx.flows.global.onboarding.navigateToHomeAsGuestUser
          params:
            - name: zipCode
              string: mx.data.qaa.sanity.od.postpurchase-2159.zipCode
            - name: banner
              string: "OD"

      # STEP 2-3: Login from Profile ----------------------------------------------------------------------------------
      - log:
         message: "STEP 2-3: Login from Profile."
         color: YELLOW

      - executeFunction:
          name: mx.flows.od.login.navigateToAccountAndLogin
          params:
            - name: userEmail
              string: mx.data.qaa.sanity.od.postpurchase-2159.userEmail
            - name: userPassword
              string: mx.data.qaa.sanity.od.postpurchase-2159.userPassword
            - name: userName
              string: mx.data.qaa.sanity.od.postpurchase-2159.userFirstName

    # STEP 4: Select Pedidos option. ----------------------------------------------------------------------------------
      - log:
         message: "STEP 4: Select Pedidos option."
         color: YELLOW

      - executeFunction:
          name: mx.functions.account.openOrdersHistory

      # STEP 5: Validate orders history list. -------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 5: Validate order history list."
            - name: squadNames
              string: POST-PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.orders-history.assertPageDisplayed
      - executeFunction:
          name: mx.functions.orders-history.assertOrdersHistoryListDisplayed
      - executeFunction:
          name: mx.functions.orders-history.assertCancelledOrderDisplayed

      # STEP 6: Validate  reorder button is displayed in an order. ----------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 6: Validate  reorder button is displayed in an order."
            - name: squadNames
              string: POST-PURCHASE | QAA
      
      - executeFunction:
          name: mx.functions.orders-history.tapOrderDetailsByPosition
          params:
            - name: position
              string: '1'
      - executeFunction:
          name: mx.functions.order-details.assertOrderDetailsDisplayed
      - executeFunction:
          name: mx.functions.order-details.expandProductsDetailsIfNotExpanded
      - executeFunction:
          name: mx.functions.order-details.getProductNameByIndex #PARAM:--${productIndex}-- #--RETURNS--${returnedProductName}-->
          params:
            - name: productIndex
              string: '1'
      - executeFunction:
          name: mx.functions.order-details.getProductQuantity #--RETURNS--${returnedProductQuantity}-->
      - executeFunction:
          name: mx.functions.order-details.assertReorderButtonDisplayed

      # STEP 7: Select Reorder button. --------------------------------------------------------------------------------
      - executeFunction:
          name: mx.squad-reporting.setTestCaseStep
          params:
            - name: step
              string: "STEP 7: Select Reorder button."
            - name: squadNames
              string: POST-PURCHASE | QAA

      - executeFunction:
          name: mx.functions.order-details.tapReorderButton
      - sleep:
          duration: 6000
      - executeFunction:
          name: mx.functions.cart.assertCertainProduct
          params:
            - name: productName
              string: ${returnedProductName}
      - executeFunction:
          name: mx.functions.cart.assertProductQuantityAsPieces
          params:
            - name: productName
              string: ${returnedProductName}
            - name: expectedQuantity
              string: ${returnedProductQuantity}

      # STEP 8: Complete order with all the products in the cart ------------------------------------------------------
      - log:
         message: "STEP 8: Complete order with all the products in the cart."
         color: YELLOW

      - storeIn:
          key: MMPP_2159_IS_CART_EMPTY
          value: false
      - executeFunction:
          name: mx.functions.cart.tapReserveSlot
      - executeFunction:
          name: mx.functions.reserve-slot.address-message-popup.closePopupIfDisplayed
      - executeFunction:
          name: mx.functions.reserve-slot.tapPickupDeliveryMethod
      - executeFunction:
          name: mx.functions.reserve-slot.selectLastAvailableDateSlot
      - executeFunction:
          name: mx.functions.reserve-slot.selectLastAvailableTimeSlot
      - executeFunction:
          name: mx.functions.reserve-slot.tapReserve
      - executeFunction:
          name: mx.functions.cart.tapContinue
      - executeFunction:
          name: mx.functions.review-order.scrollDownToSection
          params:          
            - name: sectionName
              string: "Método de pago"
      - executeFunction:
          name: mx.flows.od.review-order.forceSelectPayAtDeliveryMethod
          params:
            - name: payAtDeliveryOption
              string: cash
      - executeFunction:
          name: mx.functions.review-order.enterCellphoneNumber
          params:
            - name: userPhoneNumber
              string: mx.data.qaa.sanity.od.postpurchase-2159.phoneNumber
      - executeFunction:
          name: mx.functions.review-order.tapPlaceOrder
      - executeFunction:
          name: mx.functions.utils.closeRateWalmartPopupIfDisplayed
      - executeFunction:
          name: mx.functions.order-confirmation.tapFindMoreProducts
      - storeIn:
          key: MMPP_2159_IS_CART_EMPTY
          value: true
      - executeFunction:
          name:  mx.functions.bottom-menu.tapHome
      - executeFunction:
          name: mx.functions.bottom-menu.tapAccount
      - sleep:
          duration: 10000
      - executeFunction:
          name: mx.functions.account.assertPageDisplayed
      - executeFunction:
          name: mx.functions.account.openOrdersHistory
      - executeFunction:
          name: mx.functions.orders-history.tapOrderDetailsByPosition
          params:
            - name: position
              string: '1'
      - executeFunction:
          name: mx.flows.od.order-details.cancelOrderWithSetOption
      - executeFunction:
          name: mx.functions.order-details.tapBack

      # STEP 9: Logout ------------------------------------------------------------------------------------------------
      - log:
         message: "STEP 9: Logout."
         color: YELLOW
      
      - executeFunction:
          name: mx.functions.orders-history.tapBack
      - executeFunction:
          name: mx.functions.bottom-menu.tapAccount
      - executeFunction:
          name: mx.functions.account.tapLogout
      - executeFunction:
          name: mx.functions.account.assertUserNotLogged

      # End main ------------------------------------------------------------------------------------------------------
      - storeIn:
          key: MMPP_2159_SUCCESSFUL_EXECUTION
          value: true

      - log: "TEST END: GMX_OD_Sanity_PROD_PostPurchase_iOS_2159"

  # AFTER SCENARIO ####################################################################################################
  - name: After
    after: true
    flow:
      - log: "AFTER SCENARIO START: After Configs..."
      
      - executeFunction:
          name: mx.squad-reporting.logTestCaseFailure
          params:
            - name: testCaseExecutionStatus
              string: ${MMPP_2159_SUCCESSFUL_EXECUTION} 

      - if:
          condition: ${MMPP_2159_SUCCESSFUL_EXECUTION} != true
          then:
            - log:
                message: "Main Failed. Resseting data for next execution."
                color: RED
            - if:
                condition: ${MMPP_2159_IS_CART_EMPTY} == false
                then: 
                  - executeFunction:
                      name: mx.flows.od.after-scenario-exclusive.relaunchAndNavigateToHomePage
                  - executeFunction:
                      name: mx.flows.od.after-scenario-exclusive.navigateToAccountAndLoginIfNotLogged
                      params:
                        - name: userEmail
                          string: mx.data.qaa.sanity.od.postpurchase-2159.userEmail
                        - name: userPassword
                          string: mx.data.qaa.sanity.od.postpurchase-2159.userPassword
                  - executeFunction:
                      name: mx.functions.bottom-menu.tapHome
                  - executeFunction:
                      name: mx.flows.od.after-scenario-exclusive.emptyCart
            - failTest:
                message: "Main Scenario Failed: the After Scenario will propagate the failure to ensure SauceLabs run shows correct execution status."
          else:
            - log:
                message: "Main Scenario ended Successfully, no need to reset data."
                color: GREEN_BOLD
      - log: "AFTER SCENARIO END"