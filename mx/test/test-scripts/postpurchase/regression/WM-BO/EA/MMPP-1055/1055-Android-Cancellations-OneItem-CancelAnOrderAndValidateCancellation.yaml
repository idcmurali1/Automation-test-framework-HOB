#======================================================================================================================
#  AUTHOR: Isis Tolentino (vn53dge)
#  CREATED: Nov/28/2024
#  REVISION: ---
#  JIRA MANUAL TEST CASE: MMPP-1055
#  JIRA AUTOMATED TEST CASE: MMPP-3187
#  FLOW: Navigate to EA Banner, Cancel an Order and Validate Cancellation.
#
#  Copyright 춸 2024 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: postpurchase-walmart-ea-sanity-production-android-1055, postpurchase-walmart-ea-sanity-production-android, 
        postpurchase-bodega-ea-sanity-production-android-1055, postpurchase-bodega-ea-sanity-production-android

  testCaseId: MMPP-3187

scenarios:

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
#   B E F O R E   S C E N A R I O
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: Before
    before: true
    flow:

      - log: R2_SUBFLOW_BEFORE ### [[ 游릭 Flow Identifier: BEFORE 游릭 ]] ###

      - executeFunction:
          name: functions.utils.setMarketInfo
      
      - storeIn:
          key: MMPP_1055_SUCCESSFUL_EXECUTION
          value: false

      - storeIn:
          key: varTC_ORDER_CREATED
          value: false

      - log: BEFORE SCENARIO END

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
#   M A I N   S C E N A R I O
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *  

  - name: Main
    flow:

      - log: R2_SUBFLOW_MAIN ### [[ 游릭 Flow Identifier: MAIN 游릭 ]] ###
      
      # STEP 1 ---------------------------------------------------------------------------------------------------------
      - log:
         message: "STEP 1: OPEN APP, COMPLETE ONBOARDING AND SELECT BANNER."
         color: ORANGE
      
      - executeFunction:
          name: functions.onboardingToHomePage.usingPostalCode
          params:
            - name: PostalCode
              string: mx.postpurchase.onboarding.userPostalCode
            - name: ShoppingExperience
              string: mx.postpurchase.onboarding.onlineExclusiveStore

      # STEPS 2-4 ------------------------------------------------------------------------------------------------------
      - log:
         message: "STEPS 2-4: (2-3) OPEN ACCOUNT AND SELECT SIGNIN. (4) LOGIN."
         color: ORANGE

      - executeFunction:
          name: functions.global.tapAccountBtn
      - executeFunction:
          name: functions.accountPage.tapSignInBtn
      - executeFunction:
          name: functions.loginPage.userAuthentication
          params:
            - name: userEmail
              string: mx.postpurchase.1055.userAccount_android.email
            - name: userPassword
              string: mx.postpurchase.1055.userAccount_android.password
      
    # EXTRA STEP: CREATE AN ORDER --------------------------------------------------------------------------------------
      - log:
         message: "EXTRA STEP: CREATE AN ORDER."
         color: ORANGE

      - executeFunction:
          name: functions.global.tapShopBtn
      - executeFunction: # Clear cart in case previous run failed and left products in the cart...
          name: functions.cartPage.clearCart
      - executeFunction:
          name: mx.flows.od.order-creation.quickOrderCreation # RETURNS --> ${returnedOrderInfo}

    # STEPS 5-6 --------------------------------------------------------------------------------------------------------
      - log:
         message: "STEPS 5-6: (5) SELECT 'PEDIDOS' OPTION. (6) VALIDATE ORDER HISTORY LIST."
         color: ORANGE

      - executeFunction:
          name: functions.thankYouPage.tapOnContinueShoppingButton
      - executeFunction:
          name: functions.accountPage.navigateToOrderHistoryPage
      - executeFunction:
          name: functions.orderHistoryPage.isPageDisplayed

    # STEPS 7 ----------------------------------------------------------------------------------------------------------
      - log:
         message: "STEP 7: Select new or recent order with status 'Recibido' and perform validations."
         color: ORANGE

      - executeFunction:
          name: mx.flows.od.orders-history.assertOrderInformation
          params:
            - name: orderInfo
              string: ${returnedOrderInfo}
    
    
    # STEPS 8-9 --------------------------------------------------------------------------------------------------------
      - log:
         message: "STEPS 8-9: (8) SELECT 'VER DETALLES' BUTTON. (9) VALIDATE ORDER DETAILS."
         color: ORANGE

      - executeFunction:
          name: mx.functions.orders-history.tapOrderDetailsByPosition
          params:
            - name: position
              string: "1"
      - executeFunction:
          name: mx.flows.od.order-details.assertOrderInformation
          params:
            - name: orderInfo
              string: ${returnedOrderInfo}

    # STEPS 10-13 ------------------------------------------------------------------------------------------------------
      - log:
         message: "STEPS 10-13: (10-12)CANCEL ORDER. (13) VALIDATE ORDER CANCELED."
         color: ORANGE

      - executeFunction:
          name: mx.flows.od.order-details.cancelOrder
          params:
            - name: performValidation
              string: 'true'
      - storeIn:
          key: varTC_ORDER_CANCELLED
          value: true

    # STEPS 14-15 ------------------------------------------------------------------------------------------------------
      - log:
         message: "STEPS 14-15: (14) BACK TO PROFILE/ACCOUNT. (15) LOGOUT."
         color: ORANGE

      - executeFunction:
          name: mx.functions.utils.navigateToDeepLink.Account
      - sleep:
          duration: 5000
      - executeFunction:
          name: mx.functions.account.tapLogout

      - storeIn:
          key: varTC_SUCCESSFUL_EXECUTION
          value: true

# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
#   A F T E R   S C E N A R I O
# * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

  - name: After
    after: true
    flow:
      - log: R2_SUBFLOW_AFTER

      # Cancel Order if not cancelled already in the additional step in main scenario...
      - if:
          condition: ${varTC_ORDER_CREATED} && !${varTC_ORDER_CANCELLED}
          then:
            - executeFunction:
                name: mx.functions.utils.navigateToDeepLink.OrderDetails # <-- ${orderNumber}
            - executeFunction:
                name: mx.flows.od.order-details.cancelOrder

      # If execution not successful, fail the after scenario too, to ensure correct success/failure status in reports...
      - if:
          condition: '!${varTC_SUCCESSFUL_EXECUTION}'
          then:
            - failTest:
                message: "FAILED EXECUTION: Main Scenario failed: After Scenario will propagate the failure to show correct execution status."
          else:
            - log:
                message: "SUCCESSFUL EXECUTION"
                color: GREEN_BOLD

      - log: AFTER SCENARIO END
