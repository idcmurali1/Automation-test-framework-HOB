#======================================================================================================================
#  AUTHOR: Gustavo Antonio López Cambambia (vn53g21)
#  CREATED: Feb/01/2023
#  REVISION: ---
#
#  Copyright © 2023 Walmart. All rights reserved.
#======================================================================================================================

general:
  tags: qaa-od-e2e-regression-staging-004

scenarios:

  #--------------------------------------------------------------------------------------------------------------------
  - name: Main
    flow:
      - log:
          message: TEST START - E2E REGRESSION - OD-004
          color: CYAN
 
     ## STEP 1: PRE-HOME SHOULD BE SHOWN AND STEP 2: HOME SCREEN IS DISPLAYED.
      - log:
          message: "STEP 1: PRE-HOME SHOULD BE SHOWN AND STEP 2: HOME SCREEN IS DISPLAYED."
          color: CYAN
 
      # Navigate through onboarding to home as guest user.
      - executeFunction:
          name: mx.flows.global.onboarding.navigateToHomeAsGuestUser
          params:
            - name: zipCode
              string: mx.data.e2e-regression.od-004.zipCode
            - name: banner
              string: mx.data.e2e-regression.od-004.banner
 
    ## STEP 3: LOGIN AS REGISTERED USER VIA ACCOUNT PAGE.
      - log:
          message: "STEP 3: LOGIN AS REGISTERED USER VIA ACCOUNT PAGE."
          color: CYAN
      
      - executeFunction:
          name: mx.flows.od.login.navigateToAccountAndLogin
          params:
            - name: userEmail
              string: mx.data.e2e-regression.od-004.userEmail
            - name: userPassword
              string: mx.data.e2e-regression.od-004.userPassword
            - name: userName
              string: mx.data.e2e-regression.od-004.userName
 
    ## STEP 4: ADDING PRODUCT FROM HOME PAGE.
      - log:
          message: "STEP 4: ADDING PRODUCT FROM HOME PAGE."
          color: CYAN
 
      - executeFunction:
          name: mx.functions.bottom-menu.tapHome
 
      - log:
          message: Finding product on Home Page
          color: CYAN
      
      - executeFunction: 
          name: mx.functions.home.scrollDownToCarousel
          params:
            - name: carouselName
              string: mx.data.e2e-regression.od-004.home.carouselName1
 
      - executeFunction:
          name: mx.functions.home.carousel.openProductDetailsByName
          params:
            - name: productName
              string: mx.data.e2e-regression.od-004.home.carouselName1.productName1
            - name: carouselName
              string: mx.data.e2e-regression.od-004.home.carouselName1
              
      - executeFunction:
          name: mx.functions.pdp.assertPageDisplayed
 
      - executeFunction:
          name: mx.functions.pdp.assertCorrectProductDisplayed
          params:
            - name: expectedProductName
              string: mx.data.e2e-regression.od-004.home.carouselName1.productName1
 
      - executeFunction: 
          name: mx.functions.pdp.addToCart
 
      - executeFunction:
          name: mx.functions.pdp.assertAddedToCart
 
      - executeFunction:
          name: mx.functions.pdp.tapClose
 
      - executeFunction:
          name: mx.functions.home.carousel.assertProductAddedToCart
          params:
            - name: productName
              string: mx.data.e2e-regression.od-004.home.carouselName1.productName1
 
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: mx.data.e2e-regression.od-004.home.firstQuantityOnCart
 
    ## STEP 4.1: ADDING FUTURE OOS PRODUCT FROM HOME PAGE.
      - log:
          message: "STEP 4.1: ADDING FUTURE OOS PRODUCT FROM HOME PAGE."
          color: CYAN
 
      - log:
          message: Finding product on Home Page
          color: CYAN
      
      - executeFunction: 
          name: mx.functions.home.scrollDownToCarousel
          params:
            - name: carouselName
              string: mx.data.e2e-regression.od-004.home.carouselName2
 
      - executeFunction:
          name: mx.functions.home.openProductDetailsByName
          params:
            - name: productName
              string: mx.data.e2e-regression.od-004.home.carouselName2.productName2
              
      - executeFunction:
          name: mx.functions.pdp.assertPageDisplayed
 
      - executeFunction:
          name: mx.functions.pdp.assertCorrectProductDisplayed
          params:
            - name: expectedProductName
              string: mx.data.e2e-regression.od-004.home.carouselName2.productName2
 
      - executeFunction: 
          name: mx.functions.pdp.addToCart
 
      - executeFunction:
          name: mx.functions.pdp.assertAddedToCart
 
      - executeFunction:
          name: mx.functions.pdp.tapClose
 
      - executeFunction:
          name: mx.functions.home.carousel.assertProductAddedToCart
          params:
            - name: productName
              string: mx.data.e2e-regression.od-004.home.carouselName2.productName2
 
      - executeFunction:
          name: mx.functions.top-menu.assertCartQuantity
          params:
            - name: expectedQuantity
              string: mx.data.e2e-regression.od-004.home.secondQuantityOnCart
                      
    ## STEP 5: OPENING CART
      - log:
          message: "STEP 5: OPENING CART."
          color: CYAN
 
      - executeFunction:
          name: mx.functions.top-menu.tapCartIcon
 
      - executeFunction:
          name: mx.functions.cart.assertPageDisplayed
 
      - executeFunction:
          name: mx.functions.cart.assertCartNotEmpty
 
      - executeFunction:
          name: mx.functions.cart.assertProductListed
          params:
            - name: productName
              string: mx.data.e2e-regression.od-004.home.carouselName1.productName1

    ## STEP 6: HIT "Reservar un horario"
      - log:
          message: "STEP 6: HIT 'Reservar un horario'"
          color: CYAN

      - executeFunction:
          name: mx.functions.cart.tapReserveSlot

      - executeFunction:
          name: mx.functions.reserve-slot.assertPageDisplayed
      
      ## STEP 7: SELECT "Envio a domicilio" AND SELECT A DELIVERY ADDRESS
      - log:
          message: "STEP 7: SELECT 'Envio a domicilio' AND SELECT A DELIVERY ADDRESS'"
          color: CYAN

      - executeFunction:
          name: mx.functions.reserve-slot.tapHomeDeliveryMethod

      - executeFunction:
          name: mx.functions.reserve-slot.address-message-popup.assertPopupDisplayed

      - executeFunction:
          name: mx.functions.reserve-slot.address-message-popup.tapClose

      - executeFunction:
          name: mx.functions.reserve-slot.assertThereAreAvailableDateSlots

      - executeFunction:
          name: mx.functions.reserve-slot.assertThereAreAvailableTimeSlots

      - executeFunction:
          name: mx.functions.reserve-slot.tapChange

      - executeFunction:
          name: mx.functions.address-selector-popup.assertPageDisplayed

      - executeFunction:
          name: mx.functions.address-selector-popup.selectAddressByPosition
          params:
            - name: addressPosition
              string: mx.data.e2e-regression.od-004.firstAddressPosition

      - executeFunction:
          name: mx.functions.address-selector-popup.getSelectedAddress

      - executeFunction:
          name: mx.functions.address-selector-popup.getSelectedAddressName

      - executeNode:
          file: mx/test/helpers/reserve-slot/getShortAddress.js
          args:
            - value: ${returnedDeliveryAddress}
          getResponse:
            storeIn: userShortAddress

      - executeFunction:
          name: mx.functions.address-selector-popup.selectAddressByName
          params:
            - name: addressName
              string: ${returnedAddressName}
      
      - executeFunction:
          name: mx.functions.address-selector-popup.tapSave

      ## STEP 8: HIT "Eliminar y continuar" button
      - log:
          message: "STEP 8: HIT 'Eliminar y continuar' button"
          color: CYAN

      - executeFunction:
          name: mx.functions.oos.assertPageDisplayed

      - executeFunction:
          name: mx.functions.oos.tapDeleteLinkByProductName
          params:
            - name: productNameOOS
              string: mx.data.e2e-regression.od-004.home.carouselName2.productName2

      ## STEP 9: SELECT TIME SLOT
      - log:
          message: "STEP 9: SELECT TIME SLOT"
          color: CYAN
      
      - executeFunction:
          name: mx.functions.reserve-slot.assertSelectedAddress
          params:
            - name: expectedUserAddress
              string: ${returnedDeliveryAddress}

      - executeFunction:
          name: mx.functions.reserve-slot.selectFirstAvailableDateSlot

      - executeFunction:
          name: mx.functions.reserve-slot.selectFirstAvailableTimeSlot

      - executeFunction:
          name: mx.functions.reserve-slot.getSelectedDaySlot

      - executeFunction:
          name: mx.functions.reserve-slot.getSelectedTimeSlot

      - executeFunction:
          name: mx.functions.utils.getDeliverySlot
          params:
            - name: forPage
              string: 'Cart'
            - name: selectedDaySlot
              string: ${returnedSelectedDaySlot}
            - name: selectedTimeSlot
              string: ${returnedSelectedTimeSlot}

      - executeFunction:
          name: mx.functions.reserve-slot.tapReserve

      - executeFunction:
          name: mx.functions.cart.getDeliveryMethod

      - executeFunction:
          name: mx.functions.cart.getDeliveryFee

      - storeIn:
          key: deliveryFeeTcOd004
          value: ${returnedDeliveryFee}
      
      - executeFunction:
          name: mx.functions.cart.assertDeliveryFee
          params:
            - name: deliveryFee
              string: ${deliveryFeeTcOd004}

      - executeFunction:
          name: mx.flows.od.cart.assertDeliveryMethodSlot
          params:
            - name: deliveryMethod
              string: 'HomeDelivery'
            - name: deliverySlot
              string: ${returnedDeliverySlot}
            - name: userShortAddress
              string: ${userShortAddress}
            - name: expectedDeliveryFee
              string: ${deliveryFeeTcOd004}
      
      - executeFunction:
          name: mx.functions.cart.getProductPrice
          params:
            - name: productName
              string: mx.data.e2e-regression.od-004.home.carouselName1.productName1

      - storeIn:
          key: productPrice
          value: ${returnedProductPrice}
      
      - executeFunction:
          name: mx.functions.cart.assertSubtotal
          params:
            - name: expectedSubtotal
              string: ${productPrice}

      - arithmetic:
          expression: ${expectedSubtotal} + ${deliveryFee}
          numberOfDecimalPlaces: 2
          storeIn: cartEstimatedTotal
          # [VARIABLE] Cart estimated total saved in ${cartEstimatedTotal}

      - executeNode:
          file: mx/test/helpers/utils/numberToNumberWithComa.js
          args:
            - value: ${cartEstimatedTotal}
          getResponse:
            storeIn: expectedEstimatedTotal
      
      - executeFunction:
          name: mx.functions.cart.assertEstimatedTotalFromDetailsSection
          params:
            - name: expectedEstimatedTotal
              string: ${expectedEstimatedTotal}
      
      - executeFunction:
          name: mx.functions.cart.assertEstimatedTotalFromBottom
          params:
            - name: totalBottom
              string: ${cartEstimatedTotal}

      - executeFunction:
          name: mx.functions.cart.assertProductNotListed
          params:
            - name: productName
              string: mx.data.e2e-regression.od-004.home.carouselName2.productName2
      
      ## STEP 10: CONTINUE CHECKOUT
      - log:
          message: "STEP 10: CONTINUE CHECKOUT"
          color: CYAN

      - executeFunction:
          name: mx.functions.cart.tapContinue

      - executeFunction:
          name: mx.functions.review-order.assertPageDisplayed
          params:
            - name: userDeliveryAddress
              string: ${returnedAddress}

      ## STEP 11: GO TO PAYMENT METHODS AND SELECT A CREDIT CARD
      - log:
          message: "STEP 11: GO TO PAYMENT METHODS AND SELECT A CREDIT CARD"
          color: CYAN

      - executeFunction:
          name: mx.functions.review-order.scrollDownToWallet

      - executeFunction:
          name: mx.functions.review-order.payment-section.tapChangePaymentMethod

      - executeFunction:
          name: mx.functions.payment.tapNextCard

      - executeFunction:
          name: mx.functions.payment.selectUnchekedCard

      - sleep:
          duration: 5000

      - executeFunction:
          name: mx.functions.payment.assertChekedCard

      - executeFunction:
          name: mx.functions.payment.tapContinue

      - executeFunction:
          name: mx.functions.review-order.payment-section.enterCVV
          params:
            - name: cvv
              string: mx.data.e2e-regression.od-004.review-order.cvv

      ## STEP 12: PLACE ORDER
      - log:
          message: "12: PLACE ORDER"
          color: CYAN

      - executeFunction:
          name: mx.functions.review-order.tapPlaceOrder

      - executeFunction:
          name: mx.functions.order-confirmation.assertDeliveryMethod
          params:
            - name: expectedDeliveryMethod
              string: HomeDelivery

      - executeFunction:
          name: mx.functions.order-confirmation.assertHomeDeliveryAddressName
          params:
            - name: expectedHomeAddressName
              string: ${returnedAddressName}

      - executeFunction:
          name: mx.functions.order-confirmation.assertHomeDeliveryAddress
          params:
            - name: expectedHomeAddress
              string: ${returnedDeliveryAddress}

      - executeFunction:
          name: mx.functions.order-confirmation.getOrderNumber

      ## STEP 13: HIT "DESCUBRIR MAS PRODUCTOS" BUTTON
      - log:
          message: "STEP 13: HIT 'DESCUBRIR MAS PRODUCTOS' BUTTON"
          color: CYAN

      - executeFunction:
          name: mx.functions.order-confirmation.tapFindMoreProducts

      - executeFunction:
          name: mx.functions.home.scrollUpToLocationBanner

      - executeFunction:
          name: mx.functions.home.assertPageLoaded

      ## STEP 14: GO TO PROFILE SCREEN AND SELECT "PEDIDOS"
      - log:
          message: "14: GO TO PROFILE SCREEN AND SELECT 'PEDIDOS'"
          color: CYAN

      - executeFunction:
          name: mx.functions.bottom-menu.tapAccount

      - executeFunction:
          name: mx.functions.account.tapTrackOrder

      ## STEP 15: SELECT THE NEWEST PLACE ORDER
      - log:
          message: "15: SELECT THE NEWEST PLACE ORDER'"
          color: CYAN
      
      - executeFunction:
          name: mx.functions.orders-history.tapOrderDetailsByPosition
          params:
            - name: position
              string: mx.data.e2e-regression.od-004.order-history.lastOrder

      - executeFunction:
          name: mx.functions.order-details.assertCorrectOrderDisplayed
          params:
            - name: expectedOrderNumber
              string: ${returnedOrderNumber}
