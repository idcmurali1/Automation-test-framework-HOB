#======================================================================================================================
#    AUTHOR: Francisco Javier Ramírez Hernández (vn53vq4)
#   CREATED: January/31/2023
#  REVISION: ---
#
#  Copyright © 2023 Walmart. All rights reserved.
#======================================================================================================================

functions:

#----------------------------------------------------------------------------------------------------------------------

  # DESCRIPTION: This flow navigates through the Onboarding pages in case they appear and selects the given banner in
  #     the Pre Home page to land on the Home page.
  #
  # PARAMS:
  #     ${zipCode}  [Mandatory]
  #         ZIP Code to be used in the Onboarding Page. If set to 'null', the flow will use the current device location.
  #
  #     ${banner}   [Mandatory]
  #         Banner to be selected in the Pre Home Page. Options: [ OD | EA ]
  #
  # AUTHOR: Sergio Fernandez (vn0t1qt)
  # EDITOR: Sergio Fernandez (vn0t1qt), Rodrigo Pacheco (vn53p0i), Osmar Juárez (vn56dce)
  - name: mx.flows.global.onboarding.navigateToHomeAsGuestUser
    platform: android
    flow:
      - executeFunction:
          name: mx.functions.onboarding.isOnboardingDisplayed
      - if:
          condition: ${returnedIsDisplayed} == true
          then:
              - log:
                  message: "Onboarding Displayed, flow will navigate through..."
                  color: GREEN_BOLD
              - executeFunction:
                  name: mx.functions.onboarding.tapContinueAsGuest
              - executeFunction:
                  name: mx.functions.onboarding.dismissOrderDiscountUpdatesIfDisplayed
              - executeFunction:
                  name: mx.functions.onboarding.assertAllowLocationPageIsDisplayed
              - if:
                  condition: ${zipCode} == null
                  then:
                    - log:
                        message: "ZIP code not provided, flow will continue using current location."
                        color: GREEN_BOLD
                    - executeFunction:
                        name: mx.functions.onboarding.tapContinue
                    - executeFunction:
                        name: mx.functions.onboarding.location-popup.dismissPopupIfDisplayed
                  else:
                    - executeFunction:
                        name: mx.functions.onboarding.tapEnableWithZipCode
                    - executeFunction:
                        name: mx.functions.onboarding.location.assertEnterZipCodePageDisplayed
                    - executeFunction:
                        name: mx.functions.onboarding.location.enterZipCode
                        params:
                          - name: zipCode
                            string: ${zipCode}
                    - executeFunction:
                        name: mx.functions.onboarding.location.tapSearch
      - executeFunction:
          name: mx.functions.prehome.assertPageDisplayed
      - if:
          condition: ${banner} != 'OD' && ${banner} != 'od' && ${banner} != 'EA' && ${banner} != 'ea'
          then:
            - failTest:
                message: "Flow Failure: Incorrect Banner Provided: '${banner}'"
      - if:
          condition: ${banner} == 'OD' || ${banner} == 'od'
          then:
            - executeFunction:
                name: mx.functions.prehome.tapODBanner
            - if:
                condition: ${APP_PACKAGE} == 'com.mx.walmart.bodega.debug' || ${GLASS_ENV} == 'staging'
                then:
                  - executeFunction:
                        name: mx.functions.home.shopping-experience-popup.acceptExperienceIfDisplayed
            - executeFunction:
                name: mx.functions.onboarding.dismissOrderDiscountUpdatesIfDisplayed
            - try:
                flow:
                  - executeFunction:
                      name: mx.functions.delivery-method-selector.closeSelectorIfExpanded
                catch:
                  flow:
                    - log:
                       message: "[WARN] 'mx.functions.delivery-method-selector.closeSelectorIfExpanded' throws an error. Probably GIC was closed automatically as expected in Android"
                       color: YELLOW
                    - log:
                       message: "Retry 'mx.functions.delivery-method-selector.closeSelectorIfExpanded'"
                       color: YELLOW
                    - executeFunction:
                        name: mx.functions.delivery-method-selector.closeSelectorIfExpanded
            - executeFunction:
                name: mx.functions.utils.closeBlackPopupIfDisplayed
            - executeFunction:
                name: mx.functions.home.assertPageLoaded
      - if:
          condition: ${banner} == 'EA' || ${banner} == 'ea'
          then:
            - executeFunction:
                name: mx.functions.prehome.tapEABanner
            - if:
                condition: ${APP_PACKAGE} == 'com.mx.walmart.bodega.debug'
                then:
                  - executeFunction:
                        name: mx.functions.home.shopping-experience-popup.acceptExperienceIfDisplayed
            - executeFunction:
                name: mx.functions.home.assertPageLoaded
      - log:
          message: "End flow: global.onboarding.navigateToHomeAsGuestUser"
          color: BLUE
