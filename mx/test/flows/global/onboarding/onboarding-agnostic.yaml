#======================================================================================================================
#    AUTHOR: Francisco Javier Ramírez Hernández (vn53vq4)
#   CREATED: January/31/2023
#  REVISION: ---
#
#  Copyright © 2023 Walmart. All rights reserved.
#======================================================================================================================

functions:

#----------------------------------------------------------------------------------------------------------------------

  # Description: This function completes the onboarding as a registered user.
  # Param ${userEmail}            [Mandatory]  User email.
  # Param ${userPassword}         [Mandatory]  User Password.
  # Param ${banner}               [Mandatory]  Banner to be selected in the Pre Home Page. (Input: [ OD | EA ])
  # Param ${zipCode}              [Optional]   ZIP Code to be used in the Onboarding Page. If not provided, or set to 
  #                                            to 'null' the flow will use the current device location.
  - name: mx.flows.global.onboarding.navigateOnboardingToHomeAsRegisteredUser
    flow: 
      - executeFunction:
          name: mx.functions.onboarding.isOnboardingDisplayed
      - if:
          condition: ${returnedIsDisplayed} == true
          then:
            - log:
                message: "Onboarding displayed, flow will navigate through."
                color: CYAN
            - executeFunction:
                name: mx.functions.onboarding.tapLogin
            - executeFunction:
                name: mx.flows.od.login.loginFromPopup
          else:
            - failTest:
                message: "Onboarding not displayed."
      - if:
          condition: ${APP_PLATFORM} == 'ios'
          then:
            - executeFunction:
                name: mx.functions.onboarding.tapEnableLater
            - if:
                condition: ${zipCode} == null
                then:
                  - log:
                      message: "ZIP code not provided, flow will continue using current location."
                      color: CYAN
                  - executeFunction:
                      name: mx.functions.onboarding.tapContinue
                  - executeFunction:
                      name: mx.functions.onboarding.location-popup.tapAllowWhileUsingApp
                else:
                  - executeFunction:
                      name: mx.functions.onboarding.tapEnableWithZipCode
                  - executeFunction:
                      name: mx.functions.onboarding.location.assertEnterZipCodePageDisplayed
                  - executeFunction:
                      name: mx.functions.onboarding.location.enterZipCode
                  - executeFunction:
                      name: mx.functions.onboarding.location.tapSearch
            - executeFunction:
                name: mx.functions.customized-buy-experience.assertPageDisplayed
            - executeFunction:
                name: mx.functions.customized-buy-experience.tapContinue
            - executeFunction:
                name: mx.functions.customized-buy-experience-popup.assertPopupDisplayed
            - executeFunction:
                name: mx.functions.customized-buy-experience.tapDontAllow
      - if:
          condition: ${APP_PLATFORM} == 'android'
          then:
            - sleep:
                duration: 5000
            - if:
                condition: ${zipCode} == null
                then:
                  - log:
                      message: "ZIP code not provided, flow will continue using current location."
                      color: CYAN
                  - executeFunction:
                      name: mx.functions.onboarding.tapContinue
                  - executeFunction:
                      name: mx.functions.onboarding.location-popup.tapAllowWhileUsingApp
                else:
                  - executeFunction:
                      name: mx.functions.onboarding.tapEnableWithZipCode
                  - executeFunction:
                      name: mx.functions.onboarding.location.enterZipCode
                  - executeFunction:
                      name: mx.functions.onboarding.location.tapSearch
      - executeFunction:
          name: mx.functions.prehome.assertPageDisplayed
      - if:
          condition: ${banner} == 'OD'
          then:
            - executeFunction:
                name: mx.functions.prehome.tapODBanner
            - if:
                condition: ${APP_PLATFORM} == 'android'
                then:
                  - executeFunction:
                      name: mx.functions.customized-buy-experience-popup.dismissPopupIfDisplayed
                  - try:
                      flow:
                        - executeFunction:
                           name: mx.functions.delivery-method-selector.closeSelectorIfExpanded
                      catch:
                        flow:
                          - log:
                             message: "[WARN] 'mx.functions.delivery-method-selector.closeSelectorIfExpanded' throws an error. Probably GIC was closed automatically as expected in Android."
                             color: YELLOW
                          - log:
                             message: "Retry 'mx.functions.delivery-method-selector.closeSelectorIfExpanded'"
                             color: YELLOW
                          - executeFunction:
                             name: mx.functions.delivery-method-selector.closeSelectorIfExpanded
                else:
                  - executeFunction:
                     name: mx.functions.delivery-method-selector.closeSelectorIfExpanded
            - executeFunction:
                name: mx.functions.utils.closeBlackPopupIfDisplayed
            - executeFunction:
                name: mx.functions.home.assertPageLoaded
          else:
            - if:
                condition: ${banner} == 'EA'
                then:
                - executeFunction:
                    name: mx.functions.prehome.tapEABanner
                - log: "EA Home Page has not been coded yet."
                # TODO: Code for EA Automation not yet started.
      - log:
          message: "End flow: global.onboarding.navigateOnboardingToHomeAsRegisteredUser"
          color: BLUE