#======================================================================================================================
#    AUTHOR: Rodrigo Pacheco Cámara (vn53p0i)
#   CREATED: Mar/23/2023
#  REVISION: ---
#
#  Copyright © 2023 Walmart. All rights reserved.
#======================================================================================================================

functions:

#----------------------------------------------------------------------------------------------------------------------

  # Description:          This flow changes the store to the one specified on parameter from the delivery method selector
  #                           selector and clicks save.
  # REQUIREMENT:          Use a zip code that makes the desired store appear first on the list.
  # Params: ${zipCode}    [Mandatory]  Desired zip code to enter when opening the store selector popup.
  #         ${storeName}  [Mandatory]  Name of the store you want to switch to.
  #
  # AUTHOR: Rodrigo Pacheco (vn53p0i)
  - name: mx.flows.od.delivery-method-selector.changeStoreFromSelector
    platform: android
    flow:
      - log:
          message: "ZipCode: ${zipCode}"
          color: CYAN
      - log:
          message: "Store Name: ${storeName}"
          color: CYAN
      - storeIn:
          key: selectedStore
          value: ${storeName}
      - if:
          identifier:
            present:
              - identifier: mx.mappings.delivery-method-selector.selectedStore # <--PARAM--${selectedStore}
          then:
            - log: "Desired Store already selected, execution will continue..."
          else:
            - log: "Desired Store not selected, changing store..."
            - click:
                identifier: mx.mappings.delivery-method-selector.pickupStoreSelectorButton
            - executeFunction:
                name: mx.functions.store-selector-popup.assertPageDisplayed
            - executeFunction:
                name: mx.flows.od.store-selector-popup.quickChangeStoreFromPopup
                params:
                  - name: zipCode
                    string: ${zipCode}
                  - name: storeName
                    string: ${storeName}
            - sleep:
                duration: 3000
      - log:
          message: "End flow: delivery-method-selector.changeStoreFromSelector"
          color: BLUE

#----------------------------------------------------------------------------------------------------------------------

  # PARAMS:
  #     ${zipCode}    [Mandatory]  ZIP Code to search the Store to be selected.
  #     ${storeName}  [Mandatory]  Name of the Store to be selected.
  # RETURNS:
  #   ${returnedSelectedStoreAddress}  The Address of the selected store (raw string).
  #
  # AUTHOR: Sergio Fernandez (vn0t1qt)
  - name: mx.flows.od.delivery-method-selector.changeCurrentStore
    platform: android
    flow:
      - log:
          message: "ZIP Code: '${zipCode}'"
          color: CYAN
      - log:
          message: "Store Name: '${storeName}'"
          color: CYAN
      # Expand the Delivery Method Selector and open the Store Selector...
      - executeFunction:
          name: mx.functions.delivery-method-selector.expandSelector
      - executeFunction:
          name: mx.functions.delivery-method-selector.assertSelectorDisplayed
      - executeFunction:
          name: mx.functions.delivery-method-selector.tapPickupButtonIfNotSelected
      - executeFunction:
          name: mx.functions.delivery-method-selector.selection-options.tapChangeStoreButton
      - executeFunction:
          name: mx.functions.store-selector-popup.assertPageDisplayed
      - executeFunction:
          name: mx.functions.store-selector-popup.enterZipCode # <--PARAM--${zipCode}--
      - executeFunction:
          name: mx.functions.utils.waitUntilMappingDisappear
          params:
            - name: mapping
              string: mx.mappings.store-selector-popup.loadingSpinner
      - executeFunction:
          name: mx.functions.store-selector-popup.selectStore  # <--PARAM--${storeName}--
      - executeFunction:
          name: mx.functions.store-selector-popup.getSelectedStoreAddress
      - storeIn:
          key: returnedSelectedStoreAddress # --RETURNS-->
          value: ${returnedStoreAddress}
      - executeFunction:
          name: mx.functions.store-selector-popup.tapSave
      - executeFunction:
          name: mx.functions.delivery-method-selector.closeSelectorIfExpanded
      - log:
          message: "Selected Store Address: '${returnedSelectedStoreAddress}'"
          color: CYAN
      - log:
          message: "End flow: mx.flows.od.delivery-method-selector.changeCurrentStore"
          color: BLUE

#----------------------------------------------------------------------------------------------------------------------

  # PARAMS:
  #   ${storeName}  [Mandatory]  Name of the Store to be selected.
  # RETURNS:
  #   ${returnedSelectedStoreAddress}  The Address of the selected store (raw string).
  #
  # AUTHOR: Sergio Fernandez (vn0t1qt)
  - name: mx.flows.od.delivery-method-selector.changeCurrentStore.useCurrentLocation
    platform: android
    flow:
      - log:
          message: "Store Name: '${storeName}'"
          color: CYAN
      - executeFunction:
          name: mx.functions.delivery-method-selector.expandSelector
      - executeFunction:
          name: mx.functions.delivery-method-selector.assertSelectorDisplayed
      - executeFunction:
          name: mx.functions.delivery-method-selector.tapPickupButtonIfNotSelected
      - executeFunction:
          name: mx.functions.delivery-method-selector.selection-options.tapChangeStoreButton
      - executeFunction:
          name: mx.functions.store-selector-popup.assertPageDisplayed
      - executeFunction:
          name: mx.functions.store-selector-popup.tapUseCurrentLocation
      - if:
          identifier:
            present:
              - identifier: mx.mappings.store-selector-popup.location-permission-popup.allowWhileAppIsInUse
            timeout: 5000
          then:
            - click:
                identifier: mx.mappings.store-selector-popup.location-permission-popup.allowWhileAppIsInUse
      - executeFunction:
          name: mx.functions.utils.waitUntilMappingDisappear
          params:
            - name: mapping
              string: mx.mappings.store-selector-popup.loadingSpinner
      - executeFunction:
          name: mx.functions.store-selector-popup.selectStore  # <--PARAM--${storeName}--
      - executeFunction:
          name: mx.functions.store-selector-popup.getSelectedStoreAddress
      - storeIn:
          key: returnedSelectedStoreAddress # --RETURNS-->
          value: ${returnedStoreAddress}
      - executeFunction:
          name: mx.functions.store-selector-popup.tapSave
      - executeFunction:
          name: mx.functions.delivery-method-selector.closeSelectorIfExpanded
      - log:
          message: "Selected Store Address: '${returnedSelectedStoreAddress}'"
          color: CYAN
      - log:
          message: 'End flow: mx.flows.od.delivery-method-selector.changeCurrentStore.useCurrentLocation'
          color: BLUE
